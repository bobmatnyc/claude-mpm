<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude MPM Dashboard QA Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 20px;
            background: #f5f7fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-header h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .test-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4299e1;
        }
        
        .test-result {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            font-family: monospace;
        }
        
        .test-pass {
            background: #c6f6d5;
            border-left: 4px solid #38a169;
            color: #1a202c;
        }
        
        .test-fail {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            color: #1a202c;
        }
        
        .test-info {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
            color: #1a202c;
        }
        
        .test-controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 8px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #3182ce;
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }
        
        .dashboard-iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üöÄ Claude MPM Dashboard QA Test Suite</h1>
            <p>Comprehensive testing of dashboard functionality</p>
        </div>
        
        <div class="test-controls">
            <button id="start-tests" class="btn">Start QA Tests</button>
            <button id="clear-results" class="btn">Clear Results</button>
            <button id="open-dashboard" class="btn">Open Dashboard</button>
        </div>
        
        <div class="summary-stats" id="summary-stats" style="display: none;">
            <div class="stat">
                <div class="stat-value" id="total-tests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="passed-tests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="failed-tests">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="success-rate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>
        
        <!-- Test Results Sections -->
        <div class="test-section">
            <h3>üîå Connection Status Tests</h3>
            <div id="connection-tests"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Event Display Tests</h3>
            <div id="event-tests"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç Module Viewer Tests</h3>
            <div id="module-tests"></div>
        </div>
        
        <div class="test-section">
            <h3>üìë Tab Functionality Tests</h3>
            <div id="tab-tests"></div>
        </div>
        
        <div class="test-section">
            <h3>üéØ Session Management Tests</h3>
            <div id="session-tests"></div>
        </div>
        
        <div class="test-section">
            <h3>üî¨ HUD Visualization Tests</h3>
            <div id="hud-tests"></div>
        </div>
        
        <!-- Dashboard iframe for testing -->
        <div class="test-section" id="dashboard-section" style="display: none;">
            <h3>üì± Dashboard Testing Window</h3>
            <iframe id="dashboard-iframe" class="dashboard-iframe" src="http://localhost:8765/templates/index.html?autoconnect=true&port=8765"></iframe>
        </div>
    </div>

    <script>
        class DashboardQATest {
            constructor() {
                this.socket = null;
                this.testResults = {
                    connection: [],
                    events: [],
                    modules: [],
                    tabs: [],
                    sessions: [],
                    hud: []
                };
                this.testStats = {
                    total: 0,
                    passed: 0,
                    failed: 0
                };
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                document.getElementById('start-tests').addEventListener('click', () => this.runAllTests());
                document.getElementById('clear-results').addEventListener('click', () => this.clearResults());
                document.getElementById('open-dashboard').addEventListener('click', () => this.openDashboard());
            }
            
            async runAllTests() {
                this.clearResults();
                this.log('info', 'connection', 'üöÄ Starting comprehensive QA tests...');
                
                try {
                    // Connection tests
                    await this.testSocketConnection();
                    
                    // Event tests
                    await this.testEventGeneration();
                    await this.testEventReception();
                    
                    // Dashboard integration tests
                    await this.testDashboardIntegration();
                    
                    // Summary
                    this.updateSummary();
                    this.generateTestReport();
                    
                } catch (error) {
                    this.log('fail', 'connection', `Test suite error: ${error.message}`);
                }
            }
            
            async testSocketConnection() {
                this.log('info', 'connection', 'üîå Testing Socket.IO connection...');
                
                try {
                    this.socket = io('http://localhost:8765', {
                        autoConnect: true,
                        reconnection: true,
                        timeout: 10000
                    });
                    
                    // Test connection establishment
                    const connected = await this.waitForConnection();
                    if (connected) {
                        this.log('pass', 'connection', '‚úÖ Socket.IO connection established');
                        this.testStats.passed++;
                    } else {
                        this.log('fail', 'connection', '‚ùå Socket.IO connection failed');
                        this.testStats.failed++;
                    }
                    
                    // Test status events
                    this.socket.on('status', (data) => {
                        this.log('pass', 'connection', `‚úÖ Received status event: ${data.server}`);
                        this.testStats.passed++;
                    });
                    
                    this.socket.on('welcome', (data) => {
                        this.log('pass', 'connection', `‚úÖ Received welcome event: ${data.message}`);
                        this.testStats.passed++;
                    });
                    
                    this.testStats.total += 3;
                    
                } catch (error) {
                    this.log('fail', 'connection', `‚ùå Connection test failed: ${error.message}`);
                    this.testStats.failed++;
                    this.testStats.total++;
                }
            }
            
            async testEventGeneration() {
                this.log('info', 'events', 'üì§ Testing event generation...');
                
                const testEvents = [
                    {
                        type: 'hook.pre_tool',
                        timestamp: new Date().toISOString(),
                        data: {
                            tool_name: 'Read',
                            session_id: 'qa_test_session',
                            agent_type: 'qa'
                        }
                    },
                    {
                        type: 'hook.post_tool',
                        timestamp: new Date().toISOString(),
                        data: {
                            tool_name: 'Write',
                            session_id: 'qa_test_session',
                            agent_type: 'qa',
                            file_path: '/test/file.py'
                        }
                    },
                    {
                        type: 'agent.delegation',
                        timestamp: new Date().toISOString(),
                        data: {
                            agent_type: 'engineer',
                            task: 'QA test task',
                            session_id: 'qa_test_session'
                        }
                    }
                ];
                
                let emitted = 0;
                for (const event of testEvents) {
                    try {
                        if (this.socket && this.socket.connected) {
                            this.socket.emit('claude_event', event);
                            emitted++;
                            await this.delay(100);
                        }
                    } catch (error) {
                        this.log('fail', 'events', `‚ùå Failed to emit event: ${error.message}`);
                    }
                }
                
                if (emitted === testEvents.length) {
                    this.log('pass', 'events', `‚úÖ Successfully emitted ${emitted} test events`);
                    this.testStats.passed++;
                } else {
                    this.log('fail', 'events', `‚ùå Only emitted ${emitted}/${testEvents.length} events`);
                    this.testStats.failed++;
                }
                
                this.testStats.total++;
            }
            
            async testEventReception() {
                this.log('info', 'events', 'üì• Testing event reception...');
                
                let receivedEvents = 0;
                
                const eventHandler = (data) => {
                    receivedEvents++;
                    this.log('info', 'events', `üì• Received event: ${data.type || 'unknown'}`);
                };
                
                this.socket.on('claude_event', eventHandler);
                this.socket.on('history', (data) => {
                    if (data && data.events) {
                        this.log('pass', 'events', `‚úÖ Received history with ${data.events.length} events`);
                        this.testStats.passed++;
                    } else {
                        this.log('fail', 'events', '‚ùå Invalid history format received');
                        this.testStats.failed++;
                    }
                });
                
                // Wait a bit for events
                await this.delay(2000);
                
                if (receivedEvents > 0) {
                    this.log('pass', 'events', `‚úÖ Event reception working (${receivedEvents} events)`);
                    this.testStats.passed++;
                } else {
                    this.log('fail', 'events', '‚ùå No events received from server');
                    this.testStats.failed++;
                }
                
                this.testStats.total += 2;
            }
            
            async testDashboardIntegration() {
                this.log('info', 'modules', 'üì± Testing dashboard integration...');
                
                // Test dashboard accessibility
                try {
                    const response = await fetch('http://localhost:8765/templates/index.html');
                    if (response.ok) {
                        this.log('pass', 'modules', '‚úÖ Dashboard HTML accessible');
                        this.testStats.passed++;
                    } else {
                        this.log('fail', 'modules', `‚ùå Dashboard not accessible: ${response.status}`);
                        this.testStats.failed++;
                    }
                } catch (error) {
                    this.log('fail', 'modules', `‚ùå Dashboard fetch failed: ${error.message}`);
                    this.testStats.failed++;
                }
                
                // Test static assets
                try {
                    const cssResponse = await fetch('http://localhost:8765/static/css/dashboard.css');
                    if (cssResponse.ok) {
                        this.log('pass', 'modules', '‚úÖ Dashboard CSS accessible');
                        this.testStats.passed++;
                    } else {
                        this.log('fail', 'modules', '‚ùå Dashboard CSS not accessible');
                        this.testStats.failed++;
                    }
                } catch (error) {
                    this.log('fail', 'modules', `‚ùå CSS fetch failed: ${error.message}`);
                    this.testStats.failed++;
                }
                
                // Test JavaScript modules
                try {
                    const jsResponse = await fetch('http://localhost:8765/static/js/dashboard.js');
                    if (jsResponse.ok) {
                        this.log('pass', 'modules', '‚úÖ Dashboard JS accessible');
                        this.testStats.passed++;
                    } else {
                        this.log('fail', 'modules', '‚ùå Dashboard JS not accessible');
                        this.testStats.failed++;
                    }
                } catch (error) {
                    this.log('fail', 'modules', `‚ùå JS fetch failed: ${error.message}`);
                    this.testStats.failed++;
                }
                
                this.testStats.total += 3;
            }
            
            async waitForConnection() {
                return new Promise((resolve) => {
                    const timeout = setTimeout(() => resolve(false), 10000);
                    
                    this.socket.on('connect', () => {
                        clearTimeout(timeout);
                        resolve(true);
                    });
                    
                    this.socket.on('connect_error', () => {
                        clearTimeout(timeout);
                        resolve(false);
                    });
                });
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            log(type, category, message) {
                const container = document.getElementById(`${category === 'connection' ? 'connection' : 
                                                         category === 'events' ? 'event' :
                                                         category === 'modules' ? 'module' :
                                                         category === 'tabs' ? 'tab' :
                                                         category === 'sessions' ? 'session' : 'hud'}-tests`);
                
                const result = document.createElement('div');
                result.className = `test-result test-${type}`;
                result.textContent = message;
                
                if (container) {
                    container.appendChild(result);
                    container.scrollTop = container.scrollHeight;
                }
                
                console.log(`[${category.toUpperCase()}] ${message}`);
            }
            
            clearResults() {
                const containers = ['connection-tests', 'event-tests', 'module-tests', 'tab-tests', 'session-tests', 'hud-tests'];
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                
                this.testStats = { total: 0, passed: 0, failed: 0 };
                document.getElementById('summary-stats').style.display = 'none';
            }
            
            openDashboard() {
                const section = document.getElementById('dashboard-section');
                const iframe = document.getElementById('dashboard-iframe');
                
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
                
                if (section.style.display === 'block') {
                    iframe.src = iframe.src + '&t=' + Date.now(); // Force refresh
                    this.log('info', 'modules', 'üì± Dashboard opened in test window');
                }
            }
            
            updateSummary() {
                const stats = document.getElementById('summary-stats');
                const successRate = this.testStats.total > 0 ? 
                    Math.round((this.testStats.passed / this.testStats.total) * 100) : 0;
                
                document.getElementById('total-tests').textContent = this.testStats.total;
                document.getElementById('passed-tests').textContent = this.testStats.passed;
                document.getElementById('failed-tests').textContent = this.testStats.failed;
                document.getElementById('success-rate').textContent = `${successRate}%`;
                
                stats.style.display = 'flex';
            }
            
            generateTestReport() {
                const report = {
                    timestamp: new Date().toISOString(),
                    summary: this.testStats,
                    successRate: this.testStats.total > 0 ? 
                        Math.round((this.testStats.passed / this.testStats.total) * 100) : 0,
                    userAgent: navigator.userAgent,
                    testEnvironment: {
                        socketIO: typeof io !== 'undefined',
                        browser: this.getBrowserInfo()
                    }
                };
                
                console.log('üéâ QA Test Report:', report);
                this.log('info', 'connection', `üéâ Test completed: ${report.successRate}% success rate`);
                
                // Save to localStorage for later retrieval
                localStorage.setItem('qa_test_report', JSON.stringify(report));
            }
            
            getBrowserInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                return 'Unknown';
            }
        }
        
        // Initialize QA test suite when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.qaTest = new DashboardQATest();
            console.log('üöÄ Dashboard QA Test Suite ready');
        });
    </script>
</body>
</html>