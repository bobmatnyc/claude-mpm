<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUD Existing Events Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .hud-container {
            height: 600px;
            background: #1e1e1e;
            border: 2px solid #444;
            border-radius: 8px;
            position: relative;
        }
        button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #38a169;
        }
        .status {
            background: #2d3748;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .event-count {
            font-weight: bold;
            color: #48bb78;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ HUD Existing Events Test</h1>
        
        <div class="test-section">
            <h2>Test Configuration</h2>
            <p>This test simulates the HUD processing existing events when activated.</p>
            
            <button onclick="initializeTest()">Initialize Test</button>
            <button onclick="loadMockEvents()">Load Mock Events</button>
            <button onclick="activateHUD()">Activate HUD</button>
            <button onclick="clearVisualization()">Clear</button>
            
            <div class="status" id="status">Status: Ready to test</div>
        </div>
        
        <div class="test-section">
            <h2>HUD Visualization</h2>
            <div class="hud-container" id="hud-cytoscape"></div>
        </div>
        
        <div class="test-section">
            <h2>Event Summary</h2>
            <div id="event-summary">No events loaded</div>
        </div>
    </div>

    <!-- Load HUD components -->
    <script src="/Users/masa/Projects/claude-mpm/src/claude_mpm/web/static/js/components/hud-library-loader.js"></script>
    <script src="/Users/masa/Projects/claude-mpm/src/claude_mpm/web/static/js/components/hud-visualizer.js"></script>
    <script src="/Users/masa/Projects/claude-mpm/src/claude_mpm/web/static/js/components/event-viewer.js"></script>

    <script>
        // Test variables
        let hudVisualizer = null;
        let mockEventViewer = null;
        let mockEvents = [];

        // Mock events that simulate real dashboard events
        function generateMockEvents() {
            const sessionId = 'test-session-' + Date.now();
            const baseTime = Date.now() - (60000 * 30); // 30 minutes ago
            
            return [
                {
                    timestamp: new Date(baseTime).toISOString(),
                    type: 'session',
                    subtype: 'started',
                    session_id: sessionId,
                    data: { session_id: sessionId }
                },
                {
                    timestamp: new Date(baseTime + 1000).toISOString(),
                    type: 'hook',
                    subtype: 'user_prompt',
                    hook_event_name: 'hook',
                    session_id: sessionId,
                    data: { 
                        session_id: sessionId,
                        prompt_preview: 'Update the HUD visualization to parse and display existing events'
                    }
                },
                {
                    timestamp: new Date(baseTime + 2000).toISOString(),
                    type: 'hook',
                    subtype: 'claude_response',
                    hook_event_name: 'hook',
                    session_id: sessionId,
                    data: { session_id: sessionId }
                },
                {
                    timestamp: new Date(baseTime + 3000).toISOString(),
                    type: 'agent',
                    subtype: 'loaded',
                    session_id: sessionId,
                    data: { 
                        session_id: sessionId,
                        agent_type: 'Engineer',
                        agent_name: 'Engineer Agent'
                    }
                },
                {
                    timestamp: new Date(baseTime + 4000).toISOString(),
                    type: 'hook',
                    subtype: 'pre_tool',
                    hook_event_name: 'hook',
                    session_id: sessionId,
                    data: { 
                        session_id: sessionId,
                        tool_name: 'Read',
                        operation_type: 'file_read'
                    }
                },
                {
                    timestamp: new Date(baseTime + 5000).toISOString(),
                    type: 'hook',
                    subtype: 'pre_tool',
                    hook_event_name: 'hook',
                    session_id: sessionId,
                    data: { 
                        session_id: sessionId,
                        tool_name: 'Edit',
                        operation_type: 'file_edit'
                    }
                },
                {
                    timestamp: new Date(baseTime + 6000).toISOString(),
                    type: 'todo',
                    subtype: 'updated',
                    session_id: sessionId,
                    data: { 
                        session_id: sessionId,
                        todos: [
                            { content: 'Add getFilteredEvents method', status: 'completed' },
                            { content: 'Update HUD visualization', status: 'in_progress' }
                        ]
                    }
                }
            ];
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('ðŸ”§ Test Status:', message);
        }

        function updateEventSummary() {
            const summary = document.getElementById('event-summary');
            if (mockEvents.length === 0) {
                summary.innerHTML = 'No events loaded';
                return;
            }

            const eventTypes = {};
            mockEvents.forEach(event => {
                const type = event.type + (event.subtype ? '.' + event.subtype : '');
                eventTypes[type] = (eventTypes[type] || 0) + 1;
            });

            const typeList = Object.entries(eventTypes)
                .map(([type, count]) => `<li>${type}: <span class="event-count">${count}</span></li>`)
                .join('');

            summary.innerHTML = `
                <p><strong>Total Events:</strong> <span class="event-count">${mockEvents.length}</span></p>
                <p><strong>Event Types:</strong></p>
                <ul>${typeList}</ul>
            `;
        }

        function initializeTest() {
            updateStatus('Initializing HUD test environment...');
            
            try {
                // Initialize HUD visualizer
                hudVisualizer = new HUDVisualizer();
                hudVisualizer.initialize();
                
                // Create mock event viewer
                mockEventViewer = {
                    events: [],
                    filteredEvents: [],
                    getAllEvents: function() {
                        return this.events;
                    },
                    getFilteredEvents: function() {
                        return this.filteredEvents;
                    }
                };
                
                updateStatus('Test environment initialized successfully');
            } catch (error) {
                updateStatus('Error initializing test: ' + error.message);
                console.error('Initialization error:', error);
            }
        }

        function loadMockEvents() {
            if (!mockEventViewer) {
                updateStatus('Error: Initialize test first');
                return;
            }
            
            updateStatus('Loading mock events...');
            
            mockEvents = generateMockEvents();
            mockEventViewer.events = mockEvents;
            mockEventViewer.filteredEvents = mockEvents;
            
            updateEventSummary();
            updateStatus(`Loaded ${mockEvents.length} mock events`);
        }

        async function activateHUD() {
            if (!hudVisualizer || !mockEventViewer) {
                updateStatus('Error: Initialize test and load events first');
                return;
            }
            
            updateStatus('Activating HUD and processing existing events...');
            
            try {
                // Activate HUD (this will load libraries)
                await hudVisualizer.activate();
                
                // Process existing events
                if (mockEvents.length > 0) {
                    hudVisualizer.processExistingEvents(mockEvents);
                    updateStatus(`HUD activated and processed ${mockEvents.length} existing events`);
                } else {
                    updateStatus('HUD activated but no events to process');
                }
            } catch (error) {
                updateStatus('Error activating HUD: ' + error.message);
                console.error('HUD activation error:', error);
            }
        }

        function clearVisualization() {
            if (hudVisualizer) {
                hudVisualizer.clear();
                updateStatus('Visualization cleared');
            }
        }

        // Auto-initialize on page load
        window.addEventListener('load', () => {
            updateStatus('Page loaded - ready for testing');
        });
    </script>
</body>
</html>