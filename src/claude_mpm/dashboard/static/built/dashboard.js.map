{"version":3,"file":"dashboard.js","sources":["../js/components/agent-hierarchy.js","../js/components/build-tracker.js","../js/dashboard.js"],"sourcesContent":["/**\n * Agent Hierarchy Component\n * \n * Displays agents in a hierarchical tree structure with PM at the top level.\n * Shows subagents as children of the PM that spawned them, tracking delegation\n * relationships from Task tool calls.\n * \n * WHY: Provides clear visualization of agent delegation relationships, making it\n * easier to understand the flow of work through PM and subagent delegations.\n * \n * DESIGN DECISION: Uses tree-based visualization with expand/collapse functionality\n * to handle complex delegation chains while maintaining performance with large\n * event streams. Separates hierarchy building from rendering for flexibility.\n */\n\nclass AgentHierarchy {\n    constructor(agentInference, eventViewer) {\n        this.agentInference = agentInference;\n        this.eventViewer = eventViewer;\n        \n        // Hierarchy state\n        this.state = {\n            // Tree structure with PM nodes at root\n            hierarchyTree: null,\n            // Map of agent ID to node for quick lookups\n            nodeMap: new Map(),\n            // Expanded state for tree nodes\n            expandedNodes: new Set(),\n            // Currently selected node\n            selectedNode: null\n        };\n        \n        // Default expand all nodes initially\n        this.expandAll = true;\n        \n        // Set up event listeners\n        this.setupEventListeners();\n        \n        console.log('Agent hierarchy component initialized');\n    }\n    \n    /**\n     * Set up event listeners for safe interaction\n     */\n    setupEventListeners() {\n        // Use event delegation for toggle node clicks to avoid undefined dashboard errors\n        document.addEventListener('click', (event) => {\n            const toggleTarget = event.target.closest('[data-toggle-node]');\n            if (toggleTarget && window.dashboard && window.dashboard.agentHierarchy) {\n                const nodeId = toggleTarget.dataset.toggleNode;\n                window.dashboard.agentHierarchy.toggleNode(nodeId);\n            }\n        });\n    }\n    \n    /**\n     * Build hierarchical structure from events\n     * @returns {Object} Tree structure with PM at root\n     */\n    buildHierarchy() {\n        // Process agent inference first\n        this.agentInference.processAgentInference();\n        \n        // Get PM delegations and events\n        const pmDelegations = this.agentInference.getPMDelegations();\n        const events = this.eventViewer.events;\n        const eventAgentMap = this.agentInference.getEventAgentMap();\n        \n        // Create root PM nodes\n        const mainPM = {\n            id: 'pm_main',\n            type: 'pm',\n            name: 'PM (Main Session)',\n            children: [],\n            events: [],\n            eventCount: 0,\n            status: 'active',\n            startTime: null,\n            endTime: null,\n            expanded: true\n        };\n        \n        // Map to store multiple implied PM groups\n        const impliedPMGroups = new Map();\n        \n        // Clear node map\n        this.state.nodeMap.clear();\n        this.state.nodeMap.set(mainPM.id, mainPM);\n        \n        // Track which agents have been added\n        const processedAgents = new Set();\n        \n        // Process explicit PM delegations\n        for (const [delegationId, delegation] of pmDelegations) {\n            const agentNode = {\n                id: delegationId,\n                type: 'subagent',\n                name: delegation.agentName,\n                delegationContext: this.extractDelegationContext(delegation.pmCall),\n                children: [], // Subagents could theoretically delegate to others\n                events: delegation.agentEvents,\n                eventCount: delegation.agentEvents.length,\n                status: delegation.endIndex ? 'completed' : 'active',\n                startTime: delegation.timestamp,\n                endTime: delegation.endIndex ? events[delegation.endIndex]?.timestamp : null,\n                startIndex: delegation.startIndex,\n                endIndex: delegation.endIndex,\n                expanded: this.expandAll || this.state.expandedNodes.has(delegationId)\n            };\n            \n            mainPM.children.push(agentNode);\n            this.state.nodeMap.set(delegationId, agentNode);\n            processedAgents.add(delegation.agentName);\n            \n            // Update main PM stats\n            mainPM.eventCount++;\n            if (!mainPM.startTime || new Date(delegation.timestamp) < new Date(mainPM.startTime)) {\n                mainPM.startTime = delegation.timestamp;\n            }\n            if (delegation.endIndex && events[delegation.endIndex]) {\n                const endTime = events[delegation.endIndex].timestamp;\n                if (!mainPM.endTime || new Date(endTime) > new Date(mainPM.endTime)) {\n                    mainPM.endTime = endTime;\n                }\n            }\n        }\n        \n        // Get orphan subagent groups from agent inference\n        const orphanGroups = this.agentInference.getOrphanGroups();\n        \n        // Create implied PM nodes for each orphan group\n        let impliedPMCounter = 1;\n        for (const [groupingKey, orphans] of orphanGroups) {\n            // Create an implied PM node for this group\n            const impliedPM = {\n                id: `pm_implied_${groupingKey}`,\n                type: 'pm',\n                name: `PM (Implied #${impliedPMCounter})`,\n                children: [],\n                events: [],\n                eventCount: 0,\n                status: 'inferred',\n                startTime: null,\n                endTime: null,\n                expanded: true,\n                isImplied: true,\n                tooltip: 'Inferred PM - Subagents started without explicit PM delegation'\n            };\n            \n            impliedPMGroups.set(groupingKey, impliedPM);\n            this.state.nodeMap.set(impliedPM.id, impliedPM);\n            impliedPMCounter++;\n            \n            // Group orphan events by agent name within this implied PM\n            const agentEventGroups = new Map();\n            \n            for (const orphan of orphans) {\n                // Find all events for this orphan agent\n                const agentEvents = [];\n                events.forEach((event, index) => {\n                    const inference = eventAgentMap.get(index);\n                    if (inference && inference.agentName === orphan.agentName) {\n                        // Check if this event is orphaned (not in any PM delegation)\n                        let isOrphan = true;\n                        for (const [_, delegation] of pmDelegations) {\n                            if (delegation.agentEvents.some(e => e.eventIndex === index)) {\n                                isOrphan = false;\n                                break;\n                            }\n                        }\n                        \n                        if (isOrphan) {\n                            agentEvents.push({\n                                eventIndex: index,\n                                event: event,\n                                inference: inference\n                            });\n                        }\n                    }\n                });\n                \n                if (agentEvents.length > 0) {\n                    if (!agentEventGroups.has(orphan.agentName)) {\n                        agentEventGroups.set(orphan.agentName, []);\n                    }\n                    agentEventGroups.get(orphan.agentName).push(...agentEvents);\n                }\n            }\n            \n            // Create subagent nodes for each agent in this implied PM group\n            for (const [agentName, agentEvents] of agentEventGroups) {\n                if (agentEvents.length === 0) continue;\n                \n                const firstEvent = agentEvents[0].event;\n                const lastEvent = agentEvents[agentEvents.length - 1].event;\n                \n                const agentNode = {\n                    id: `implied_agent_${groupingKey}_${agentName}`,\n                    type: 'subagent',\n                    name: agentName,\n                    delegationContext: 'Orphan agent - no explicit PM delegation found',\n                    children: [],\n                    events: agentEvents,\n                    eventCount: agentEvents.length,\n                    status: 'inferred',\n                    startTime: firstEvent.timestamp,\n                    endTime: lastEvent.timestamp,\n                    startIndex: agentEvents[0].eventIndex,\n                    endIndex: agentEvents[agentEvents.length - 1].eventIndex,\n                    expanded: this.expandAll,\n                    isImplied: true,\n                    tooltip: 'This agent was spawned without an explicit PM Task delegation'\n                };\n                \n                impliedPM.children.push(agentNode);\n                this.state.nodeMap.set(agentNode.id, agentNode);\n                \n                // Update implied PM stats\n                impliedPM.eventCount += agentEvents.length;\n                if (!impliedPM.startTime || new Date(firstEvent.timestamp) < new Date(impliedPM.startTime)) {\n                    impliedPM.startTime = firstEvent.timestamp;\n                }\n                if (!impliedPM.endTime || new Date(lastEvent.timestamp) > new Date(impliedPM.endTime)) {\n                    impliedPM.endTime = lastEvent.timestamp;\n                }\n            }\n        }\n        \n        // Also find completely orphaned subagent events (not caught by SubagentStart)\n        const uncategorizedOrphans = [];\n        events.forEach((event, index) => {\n            const inference = eventAgentMap.get(index);\n            if (inference && inference.type === 'subagent') {\n                // Check if this agent is already in a PM delegation or implied PM\n                let isOrphan = true;\n                \n                // Check explicit delegations\n                for (const [_, delegation] of pmDelegations) {\n                    if (delegation.agentEvents.some(e => e.eventIndex === index)) {\n                        isOrphan = false;\n                        break;\n                    }\n                }\n                \n                // Check implied PMs\n                if (isOrphan) {\n                    for (const [_, impliedPM] of impliedPMGroups) {\n                        for (const child of impliedPM.children) {\n                            if (child.events.some(e => e.eventIndex === index)) {\n                                isOrphan = false;\n                                break;\n                            }\n                        }\n                        if (!isOrphan) break;\n                    }\n                }\n                \n                if (isOrphan) {\n                    uncategorizedOrphans.push({\n                        eventIndex: index,\n                        event: event,\n                        inference: inference\n                    });\n                }\n            }\n        });\n        \n        // If there are uncategorized orphans, create a generic implied PM for them\n        if (uncategorizedOrphans.length > 0) {\n            const genericImpliedPM = {\n                id: 'pm_implied_generic',\n                type: 'pm',\n                name: 'PM (Implied - Uncategorized)',\n                children: [],\n                events: [],\n                eventCount: 0,\n                status: 'inferred',\n                startTime: null,\n                endTime: null,\n                expanded: true,\n                isImplied: true,\n                tooltip: 'Orphan agents without clear grouping'\n            };\n            \n            // Group by agent name\n            const agentGroups = new Map();\n            for (const orphan of uncategorizedOrphans) {\n                const agentName = orphan.inference.agentName;\n                if (!agentGroups.has(agentName)) {\n                    agentGroups.set(agentName, []);\n                }\n                agentGroups.get(agentName).push(orphan);\n            }\n            \n            // Create nodes for each agent\n            for (const [agentName, agentEvents] of agentGroups) {\n                const firstEvent = agentEvents[0].event;\n                const lastEvent = agentEvents[agentEvents.length - 1].event;\n                \n                const agentNode = {\n                    id: `implied_generic_${agentName}`,\n                    type: 'subagent',\n                    name: agentName,\n                    delegationContext: 'Uncategorized orphan agent',\n                    children: [],\n                    events: agentEvents,\n                    eventCount: agentEvents.length,\n                    status: 'inferred',\n                    startTime: firstEvent.timestamp,\n                    endTime: lastEvent.timestamp,\n                    startIndex: agentEvents[0].eventIndex,\n                    endIndex: agentEvents[agentEvents.length - 1].eventIndex,\n                    expanded: this.expandAll,\n                    isImplied: true\n                };\n                \n                genericImpliedPM.children.push(agentNode);\n                this.state.nodeMap.set(agentNode.id, agentNode);\n                genericImpliedPM.eventCount += agentEvents.length;\n                \n                if (!genericImpliedPM.startTime || new Date(firstEvent.timestamp) < new Date(genericImpliedPM.startTime)) {\n                    genericImpliedPM.startTime = firstEvent.timestamp;\n                }\n                if (!genericImpliedPM.endTime || new Date(lastEvent.timestamp) > new Date(genericImpliedPM.endTime)) {\n                    genericImpliedPM.endTime = lastEvent.timestamp;\n                }\n            }\n            \n            if (genericImpliedPM.children.length > 0) {\n                impliedPMGroups.set('generic', genericImpliedPM);\n                this.state.nodeMap.set(genericImpliedPM.id, genericImpliedPM);\n            }\n        }\n        \n        // Count PM's own events (not delegated)\n        let pmOwnEvents = 0;\n        events.forEach((event, index) => {\n            const inference = eventAgentMap.get(index);\n            if (inference && inference.type === 'main_agent') {\n                pmOwnEvents++;\n                mainPM.events.push({\n                    eventIndex: index,\n                    event: event,\n                    inference: inference\n                });\n            }\n        });\n        mainPM.eventCount += pmOwnEvents;\n        \n        // Update PM status based on children\n        if (mainPM.children.length > 0) {\n            const hasActive = mainPM.children.some(child => child.status === 'active');\n            mainPM.status = hasActive ? 'active' : 'completed';\n        }\n        \n        // Build final tree structure\n        const tree = {\n            roots: []\n        };\n        \n        // Only add PMs that have content\n        if (mainPM.eventCount > 0 || mainPM.children.length > 0) {\n            tree.roots.push(mainPM);\n        }\n        \n        // Add all implied PM groups that have content\n        for (const [_, impliedPM] of impliedPMGroups) {\n            if (impliedPM.children.length > 0) {\n                tree.roots.push(impliedPM);\n            }\n        }\n        \n        this.state.hierarchyTree = tree;\n        \n        console.log('Hierarchy built:', {\n            mainPM: {\n                children: mainPM.children.length,\n                events: mainPM.eventCount,\n                ownEvents: pmOwnEvents\n            },\n            impliedPMGroups: impliedPMGroups.size,\n            totalImpliedAgents: Array.from(impliedPMGroups.values())\n                .reduce((sum, pm) => sum + pm.children.length, 0)\n        });\n        \n        return tree;\n    }\n    \n    /**\n     * Extract delegation context from PM Task call\n     * @param {Object} pmCall - The PM's Task tool call event\n     * @returns {string} Description of what was delegated\n     */\n    extractDelegationContext(pmCall) {\n        if (!pmCall) return 'Unknown delegation';\n        \n        // Try to extract task description from tool parameters\n        const params = pmCall.tool_parameters || pmCall.data?.tool_parameters || {};\n        const task = params.task || params.request || params.description;\n        \n        if (task) {\n            // Truncate long tasks\n            const maxLength = 100;\n            if (task.length > maxLength) {\n                return task.substring(0, maxLength) + '...';\n            }\n            return task;\n        }\n        \n        // Fallback to tool input\n        const toolInput = pmCall.tool_input || pmCall.data?.tool_input;\n        if (toolInput && typeof toolInput === 'string') {\n            const maxLength = 100;\n            if (toolInput.length > maxLength) {\n                return toolInput.substring(0, maxLength) + '...';\n            }\n            return toolInput;\n        }\n        \n        return 'Task delegation';\n    }\n    \n    /**\n     * Render the hierarchy tree to HTML\n     * @param {Object} filters - Optional filters for display\n     * @returns {string} HTML string for the hierarchy\n     */\n    render(filters = {}) {\n        const tree = this.state.hierarchyTree || this.buildHierarchy();\n        \n        if (!tree.roots || tree.roots.length === 0) {\n            return '<div class=\"agent-hierarchy-empty\">No agent activity detected</div>';\n        }\n        \n        // Apply filters if provided\n        const filteredTree = this.applyFilters(tree, filters);\n        \n        // Generate HTML\n        const html = filteredTree.roots.map(root => this.renderNode(root, 0)).join('');\n        \n        return `<div class=\"agent-hierarchy\">${html}</div>`;\n    }\n    \n    /**\n     * Render a single node and its children\n     * @param {Object} node - Node to render\n     * @param {number} level - Indentation level\n     * @returns {string} HTML string for the node\n     */\n    renderNode(node, level) {\n        const isExpanded = node.expanded || this.state.expandedNodes.has(node.id);\n        const hasChildren = node.children && node.children.length > 0;\n        const isSelected = this.state.selectedNode === node.id;\n        \n        // Icon based on node type and status\n        const icon = this.getNodeIcon(node);\n        const expandIcon = hasChildren ? (isExpanded ? '▼' : '▶') : '&nbsp;&nbsp;';\n        \n        // Status color\n        const statusClass = this.getStatusClass(node.status);\n        \n        // Add special styling for implied nodes\n        const impliedClass = node.isImplied ? 'agent-node-implied' : '';\n        const tooltipAttr = node.tooltip ? `title=\"${this.escapeHtml(node.tooltip)}\"` : '';\n        \n        // Build node HTML\n        let html = `\n            <div class=\"agent-node agent-node-level-${level} ${isSelected ? 'agent-node-selected' : ''} ${impliedClass}\" \n                 data-node-id=\"${node.id}\" ${tooltipAttr}>\n                <div class=\"agent-node-header ${statusClass}\" \n                     data-toggle-node=\"${node.id}\" style=\"cursor: pointer\">\n                    <span class=\"agent-node-expand\">${expandIcon}</span>\n                    <span class=\"agent-node-icon\">${icon}</span>\n                    <span class=\"agent-node-name\">${this.escapeHtml(node.name)}</span>\n                    <span class=\"agent-node-stats\">\n                        <span class=\"agent-event-count\">${node.eventCount} events</span>\n                        ${node.status ? `<span class=\"agent-status\">${node.status}</span>` : ''}\n                    </span>\n                </div>\n        `;\n        \n        // Add details if expanded\n        if (isExpanded && (node.delegationContext || node.startTime)) {\n            html += '<div class=\"agent-node-details\">';\n            \n            if (node.delegationContext && node.delegationContext !== 'Unknown delegation') {\n                html += `\n                    <div class=\"agent-delegation-context\">\n                        <strong>Task:</strong> ${this.escapeHtml(node.delegationContext)}\n                    </div>\n                `;\n            }\n            \n            if (node.startTime) {\n                const duration = this.calculateDuration(node.startTime, node.endTime);\n                html += `\n                    <div class=\"agent-timing\">\n                        <span class=\"agent-time-start\">${this.formatTime(node.startTime)}</span>\n                        ${duration ? `<span class=\"agent-duration\">(${duration})</span>` : ''}\n                    </div>\n                `;\n            }\n            \n            html += '</div>';\n        }\n        \n        // Render children if expanded\n        if (isExpanded && hasChildren) {\n            html += '<div class=\"agent-node-children\">';\n            html += node.children.map(child => this.renderNode(child, level + 1)).join('');\n            html += '</div>';\n        }\n        \n        html += '</div>';\n        \n        return html;\n    }\n    \n    /**\n     * Get icon for node based on type and status\n     * @param {Object} node - Node to get icon for\n     * @returns {string} Icon HTML/emoji\n     */\n    getNodeIcon(node) {\n        if (node.type === 'pm') {\n            return node.isImplied ? '🔍' : '👔';\n        }\n        \n        // Map agent names to icons\n        const agentIcons = {\n            'Engineer Agent': '🔧',\n            'Research Agent': '🔍',\n            'QA Agent': '✅',\n            'Documentation Agent': '📝',\n            'Security Agent': '🔒',\n            'Ops Agent': '⚙️',\n            'Version Control Agent': '📦',\n            'Data Engineer Agent': '💾',\n            'Test Integration Agent': '🧪'\n        };\n        \n        return agentIcons[node.name] || '🤖';\n    }\n    \n    /**\n     * Get status class for styling\n     * @param {string} status - Node status\n     * @returns {string} CSS class name\n     */\n    getStatusClass(status) {\n        switch (status) {\n            case 'active':\n                return 'agent-status-active';\n            case 'completed':\n                return 'agent-status-completed';\n            case 'pending':\n                return 'agent-status-pending';\n            case 'inferred':\n                return 'agent-status-inferred';\n            default:\n                return 'agent-status-unknown';\n        }\n    }\n    \n    /**\n     * Toggle node expansion\n     * @param {string} nodeId - ID of node to toggle\n     */\n    toggleNode(nodeId) {\n        const node = this.state.nodeMap.get(nodeId);\n        if (!node) return;\n        \n        if (this.state.expandedNodes.has(nodeId)) {\n            this.state.expandedNodes.delete(nodeId);\n            node.expanded = false;\n        } else {\n            this.state.expandedNodes.add(nodeId);\n            node.expanded = true;\n        }\n        \n        // Trigger re-render\n        if (window.dashboard) {\n            window.dashboard.renderCurrentTab();\n        }\n    }\n    \n    /**\n     * Select a node\n     * @param {string} nodeId - ID of node to select\n     */\n    selectNode(nodeId) {\n        this.state.selectedNode = nodeId;\n        const node = this.state.nodeMap.get(nodeId);\n        \n        if (node) {\n            // Dispatch event for other components to react\n            const event = new CustomEvent('agentNodeSelected', {\n                detail: { node: node }\n            });\n            document.dispatchEvent(event);\n        }\n    }\n    \n    /**\n     * Apply filters to the tree\n     * @param {Object} tree - Tree to filter\n     * @param {Object} filters - Filter criteria\n     * @returns {Object} Filtered tree\n     */\n    applyFilters(tree, filters) {\n        if (!filters || Object.keys(filters).length === 0) {\n            return tree;\n        }\n        \n        // Clone tree structure for filtering\n        const filteredTree = {\n            roots: []\n        };\n        \n        for (const root of tree.roots) {\n            const filteredRoot = this.filterNode(root, filters);\n            if (filteredRoot) {\n                filteredTree.roots.push(filteredRoot);\n            }\n        }\n        \n        return filteredTree;\n    }\n    \n    /**\n     * Filter a single node and its children\n     * @param {Object} node - Node to filter\n     * @param {Object} filters - Filter criteria\n     * @returns {Object|null} Filtered node or null if filtered out\n     */\n    filterNode(node, filters) {\n        // Check if node matches filters\n        let matches = true;\n        \n        if (filters.searchText) {\n            const searchLower = filters.searchText.toLowerCase();\n            matches = matches && (\n                node.name.toLowerCase().includes(searchLower) ||\n                (node.delegationContext && node.delegationContext.toLowerCase().includes(searchLower))\n            );\n        }\n        \n        if (filters.agentType) {\n            matches = matches && node.name.includes(filters.agentType);\n        }\n        \n        if (filters.status) {\n            matches = matches && node.status === filters.status;\n        }\n        \n        // Filter children recursively\n        let filteredChildren = [];\n        if (node.children) {\n            for (const child of node.children) {\n                const filteredChild = this.filterNode(child, filters);\n                if (filteredChild) {\n                    filteredChildren.push(filteredChild);\n                }\n            }\n        }\n        \n        // Include node if it matches or has matching children\n        if (matches || filteredChildren.length > 0) {\n            return {\n                ...node,\n                children: filteredChildren\n            };\n        }\n        \n        return null;\n    }\n    \n    /**\n     * Format timestamp for display\n     * @param {string} timestamp - ISO timestamp\n     * @returns {string} Formatted time\n     */\n    formatTime(timestamp) {\n        if (!timestamp) return '';\n        const date = new Date(timestamp);\n        return date.toLocaleTimeString('en-US', {\n            hour: '2-digit',\n            minute: '2-digit',\n            second: '2-digit',\n            hour12: false\n        });\n    }\n    \n    /**\n     * Calculate duration between timestamps\n     * @param {string} start - Start timestamp\n     * @param {string} end - End timestamp\n     * @returns {string} Formatted duration\n     */\n    calculateDuration(start, end) {\n        if (!start || !end) return '';\n        \n        const startTime = new Date(start).getTime();\n        const endTime = new Date(end).getTime();\n        const duration = endTime - startTime;\n        \n        if (duration < 1000) {\n            return `${duration}ms`;\n        } else if (duration < 60000) {\n            return `${(duration / 1000).toFixed(1)}s`;\n        } else {\n            const minutes = Math.floor(duration / 60000);\n            const seconds = Math.floor((duration % 60000) / 1000);\n            return `${minutes}m ${seconds}s`;\n        }\n    }\n    \n    /**\n     * Escape HTML for safe rendering\n     * @param {string} text - Text to escape\n     * @returns {string} Escaped text\n     */\n    escapeHtml(text) {\n        if (!text) return '';\n        const div = document.createElement('div');\n        div.textContent = text;\n        return div.innerHTML;\n    }\n    \n    /**\n     * Update hierarchy when new events arrive\n     * @param {Array} events - New events\n     */\n    updateWithNewEvents(events) {\n        // Rebuild hierarchy with new events\n        this.buildHierarchy();\n    }\n    \n    /**\n     * Clear the hierarchy\n     */\n    clear() {\n        this.state.hierarchyTree = null;\n        this.state.nodeMap.clear();\n        this.state.expandedNodes.clear();\n        this.state.selectedNode = null;\n    }\n    \n    /**\n     * Expand all nodes\n     */\n    expandAllNodes() {\n        for (const [nodeId, node] of this.state.nodeMap) {\n            this.state.expandedNodes.add(nodeId);\n            node.expanded = true;\n        }\n        this.expandAll = true;\n    }\n    \n    /**\n     * Collapse all nodes\n     */\n    collapseAllNodes() {\n        this.state.expandedNodes.clear();\n        for (const [nodeId, node] of this.state.nodeMap) {\n            node.expanded = false;\n        }\n        this.expandAll = false;\n    }\n}\n\n// ES6 Module export\nexport { AgentHierarchy };\nexport default AgentHierarchy;","/**\n * Build Tracker Component\n * \n * WHY: Displays and manages version/build information for both MPM and Monitor UI,\n * providing users with clear visibility of the current system versions.\n * \n * DESIGN DECISION: Implemented as a standalone component that can be easily\n * integrated into the dashboard header, with automatic updates from SocketIO.\n */\n\nexport class BuildTracker {\n    constructor() {\n        this.element = null;\n        this.buildInfo = {\n            monitor: {\n                version: \"1.0.0\",\n                build: 1,\n                formatted_build: \"0001\",\n                full_version: \"v1.0.0-0001\"\n            },\n            mpm: {\n                version: \"unknown\",\n                build: \"unknown\",\n                full_version: \"v0.0.0\"\n            }\n        };\n        \n        // Socket client reference (will be set during initialization)\n        this.socketClient = null;\n        \n        // Initialize the component\n        this.init();\n    }\n    \n    /**\n     * Initialize the build tracker component\n     */\n    async init() {\n        console.log('Initializing BuildTracker component');\n        \n        // Try to load version.json for dashboard version\n        await this.loadDashboardVersion();\n        \n        this.createElements();\n        this.setupEventListeners();\n    }\n    \n    /**\n     * Load dashboard version from version.json if available\n     * \n     * WHY: Attempts to load the actual dashboard version from the \n     * version.json file created by the version management script.\n     * Falls back to defaults if file is not available.\n     */\n    async loadDashboardVersion() {\n        try {\n            // Try to fetch version.json from the dashboard root\n            const response = await fetch('/version.json');\n            if (response.ok) {\n                const versionData = await response.json();\n                \n                // Update monitor build info with loaded data\n                this.buildInfo.monitor = {\n                    version: versionData.version || \"1.0.0\",\n                    build: versionData.build || 1,\n                    formatted_build: versionData.formatted_build || \"0001\",\n                    full_version: versionData.full_version || \"v1.0.0-0001\"\n                };\n                \n                console.log('Loaded dashboard version:', this.buildInfo.monitor);\n            }\n        } catch (error) {\n            // Silently fall back to defaults if version.json not available\n            console.debug('Dashboard version.json not available, using defaults');\n        }\n    }\n    \n    /**\n     * Create the DOM elements for version display\n     * \n     * WHY: Creates a clean, unobtrusive version display that fits\n     * seamlessly into the dashboard header.\n     */\n    createElements() {\n        // Create container element\n        this.element = document.createElement('div');\n        this.element.className = 'version-display';\n        this.element.id = 'version-display';\n        \n        // Create MPM version element\n        const mpmVersion = document.createElement('span');\n        mpmVersion.className = 'version-item mpm-version';\n        mpmVersion.id = 'mpm-version';\n        mpmVersion.innerHTML = `\n            <span class=\"version-label\">MPM</span>\n            <span class=\"version-value\">v0.0.0</span>\n        `;\n        \n        // Create separator\n        const separator = document.createElement('span');\n        separator.className = 'version-separator';\n        separator.textContent = '|';\n        \n        // Create Monitor version element\n        const monitorVersion = document.createElement('span');\n        monitorVersion.className = 'version-item monitor-version';\n        monitorVersion.id = 'monitor-version';\n        monitorVersion.innerHTML = `\n            <span class=\"version-label\">Monitor</span>\n            <span class=\"version-value\">v1.0.0-0001</span>\n        `;\n        \n        // Assemble elements\n        this.element.appendChild(mpmVersion);\n        this.element.appendChild(separator);\n        this.element.appendChild(monitorVersion);\n        \n        // Add tooltip for detailed info\n        this.element.title = 'Click for detailed version information';\n    }\n    \n    /**\n     * Set the socket client for receiving updates\n     * \n     * @param {Object} socketClient - The Socket.IO client instance\n     */\n    setSocketClient(socketClient) {\n        this.socketClient = socketClient;\n        \n        // Listen for build info updates\n        if (this.socketClient && this.socketClient.socket) {\n            // Listen for welcome message with build info\n            this.socketClient.socket.on('welcome', (eventData) => {\n                // Handle both old format (direct) and new schema (nested in data)\n                const buildInfo = eventData.build_info || \n                                 (eventData.data && eventData.data.build_info);\n                if (buildInfo) {\n                    this.updateBuildInfo(buildInfo);\n                }\n            });\n            \n            // Listen for status updates with build info\n            this.socketClient.socket.on('status', (eventData) => {\n                // Handle both old format (direct) and new schema (nested in data)\n                const buildInfo = eventData.build_info || \n                                 (eventData.data && eventData.data.build_info);\n                if (buildInfo) {\n                    this.updateBuildInfo(buildInfo);\n                }\n            });\n            \n            // Listen for explicit build info updates\n            this.socketClient.socket.on('build_info', (data) => {\n                this.updateBuildInfo(data);\n            });\n        }\n    }\n    \n    /**\n     * Update the build information\n     * \n     * @param {Object} buildInfo - Build information from server\n     */\n    updateBuildInfo(buildInfo) {\n        console.log('Updating build info:', buildInfo);\n        \n        // Store the build info\n        this.buildInfo = buildInfo;\n        \n        // Update display\n        this.updateDisplay();\n    }\n    \n    /**\n     * Update the version display elements\n     * \n     * WHY: Keeps the UI in sync with the latest version information\n     * received from the server.\n     */\n    updateDisplay() {\n        // Update MPM version\n        const mpmElement = this.element.querySelector('.mpm-version .version-value');\n        if (mpmElement && this.buildInfo.mpm) {\n            const mpmVersion = this.buildInfo.mpm.full_version || \n                              `v${this.buildInfo.mpm.version}`;\n            mpmElement.textContent = mpmVersion;\n            \n            // Add build number to tooltip if available\n            if (this.buildInfo.mpm.build && this.buildInfo.mpm.build !== \"unknown\") {\n                mpmElement.parentElement.title = `MPM Build: ${this.buildInfo.mpm.build}`;\n            }\n        }\n        \n        // Update Monitor version\n        const monitorElement = this.element.querySelector('.monitor-version .version-value');\n        if (monitorElement && this.buildInfo.monitor) {\n            const monitorVersion = this.buildInfo.monitor.full_version || \n                                  `v${this.buildInfo.monitor.version}-${this.buildInfo.monitor.formatted_build}`;\n            monitorElement.textContent = monitorVersion;\n            \n            // Add last updated to tooltip if available\n            if (this.buildInfo.monitor.last_updated) {\n                const lastUpdated = new Date(this.buildInfo.monitor.last_updated).toLocaleString();\n                monitorElement.parentElement.title = `Monitor Build: ${this.buildInfo.monitor.formatted_build}\\nLast Updated: ${lastUpdated}`;\n            }\n        }\n    }\n    \n    /**\n     * Setup event listeners\n     * \n     * WHY: Allows users to interact with the version display for\n     * additional information or actions.\n     */\n    setupEventListeners() {\n        // Click handler for showing detailed version info\n        this.element.addEventListener('click', () => {\n            this.showDetailedInfo();\n        });\n    }\n    \n    /**\n     * Show detailed version information in a modal or alert\n     * \n     * WHY: Provides power users with detailed build and version\n     * information for debugging and support purposes.\n     */\n    showDetailedInfo() {\n        const info = [];\n        \n        // MPM information\n        if (this.buildInfo.mpm) {\n            info.push('=== MPM Framework ===');\n            info.push(`Version: ${this.buildInfo.mpm.version}`);\n            if (this.buildInfo.mpm.build && this.buildInfo.mpm.build !== \"unknown\") {\n                info.push(`Build: ${this.buildInfo.mpm.build}`);\n            }\n            info.push(`Full: ${this.buildInfo.mpm.full_version}`);\n        }\n        \n        info.push('');\n        \n        // Monitor information\n        if (this.buildInfo.monitor) {\n            info.push('=== Monitor UI ===');\n            info.push(`Version: ${this.buildInfo.monitor.version}`);\n            info.push(`Build: ${this.buildInfo.monitor.formatted_build} (${this.buildInfo.monitor.build})`);\n            info.push(`Full: ${this.buildInfo.monitor.full_version}`);\n            if (this.buildInfo.monitor.last_updated) {\n                const lastUpdated = new Date(this.buildInfo.monitor.last_updated).toLocaleString();\n                info.push(`Updated: ${lastUpdated}`);\n            }\n        }\n        \n        // Show in console and alert\n        console.log('Version Information:\\n' + info.join('\\n'));\n        \n        // Create a simple modal-like display\n        const modal = document.createElement('div');\n        modal.className = 'version-modal';\n        modal.innerHTML = `\n            <div class=\"version-modal-content\">\n                <h3>Version Information</h3>\n                <pre>${info.join('\\n')}</pre>\n                <button onclick=\"this.parentElement.parentElement.remove()\">Close</button>\n            </div>\n        `;\n        \n        // Add to body\n        document.body.appendChild(modal);\n        \n        // Auto-remove after 10 seconds\n        setTimeout(() => {\n            modal.remove();\n        }, 10000);\n    }\n    \n    /**\n     * Mount the component to a parent element\n     * \n     * @param {HTMLElement|string} parent - Parent element or selector\n     */\n    mount(parent) {\n        const parentElement = typeof parent === 'string' \n            ? document.querySelector(parent) \n            : parent;\n        \n        if (parentElement && this.element) {\n            parentElement.appendChild(this.element);\n            console.log('BuildTracker mounted to', parent);\n        } else {\n            console.error('Failed to mount BuildTracker: parent element not found');\n        }\n    }\n    \n    /**\n     * Get the component's DOM element\n     * \n     * @returns {HTMLElement} The component's root element\n     */\n    getElement() {\n        return this.element;\n    }\n    \n    /**\n     * Destroy the component and clean up\n     */\n    destroy() {\n        if (this.element && this.element.parentNode) {\n            this.element.parentNode.removeChild(this.element);\n        }\n        \n        // Clean up socket listeners\n        if (this.socketClient && this.socketClient.socket) {\n            this.socketClient.socket.off('welcome');\n            this.socketClient.socket.off('status');\n            this.socketClient.socket.off('build_info');\n        }\n        \n        this.element = null;\n        this.socketClient = null;\n    }\n}","/**\n * Refactored Dashboard Coordinator\n *\n * Main coordinator class that orchestrates all dashboard modules while maintaining\n * backward compatibility with the original dashboard interface.\n *\n * WHY: This refactored version breaks down the monolithic 4,133-line dashboard\n * into manageable, focused modules while preserving all existing functionality.\n * Each module handles a specific concern, improving maintainability and testability.\n *\n * DESIGN DECISION: Acts as a thin coordinator layer that initializes modules,\n * manages inter-module communication through events, and provides backward\n * compatibility for existing code that depends on the dashboard interface.\n */\n\n// ES6 Module imports\nimport { SocketManager } from '@components/socket-manager.js';\nimport { EventViewer } from '@components/event-viewer.js';\nimport { ModuleViewer } from '@components/module-viewer.js';\nimport { SessionManager } from '@components/session-manager.js';\nimport { AgentInference } from '@components/agent-inference.js';\nimport { AgentHierarchy } from '@components/agent-hierarchy.js';\nimport { UIStateManager } from '@components/ui-state-manager.js';\nimport { EventProcessor } from '@components/event-processor.js';\nimport { ExportManager } from '@components/export-manager.js';\nimport { WorkingDirectoryManager } from '@components/working-directory.js';\nimport { FileToolTracker } from '@components/file-tool-tracker.js';\nimport { BuildTracker } from '@components/build-tracker.js';\nclass Dashboard {\n    constructor() {\n        // Core components (existing)\n        this.eventViewer = null;\n        this.moduleViewer = null;\n        this.sessionManager = null;\n\n        // New modular components\n        this.socketManager = null;\n        this.agentInference = null;\n        this.agentHierarchy = null;\n        this.uiStateManager = null;\n        this.eventProcessor = null;\n        this.exportManager = null;\n        this.workingDirectoryManager = null;\n        this.fileToolTracker = null;\n        this.buildTracker = null;\n\n        // Initialize the dashboard\n        this.init();\n    }\n\n    /**\n     * Initialize the dashboard and all modules\n     */\n    init() {\n        console.log('Initializing refactored Claude MPM Dashboard...');\n\n        try {\n            // Initialize modules in dependency order\n            this.initializeSocketManager();\n            this.initializeCoreComponents();\n            this.initializeBuildTracker();\n            this.initializeAgentInference();\n            this.initializeAgentHierarchy();\n            this.initializeUIStateManager();\n            this.initializeWorkingDirectoryManager();\n            this.initializeFileToolTracker();\n            this.initializeEventProcessor();\n            this.initializeExportManager();\n\n            // Set up inter-module communication\n            this.setupModuleInteractions();\n\n            // Initialize from URL parameters\n            this.initializeFromURL();\n\n            console.log('Claude MPM Dashboard initialized successfully');\n        } catch (error) {\n            console.error('Error during dashboard initialization:', error);\n            // Re-throw to be caught by DOMContentLoaded handler\n            throw error;\n        }\n    }\n    \n    /**\n     * Validate that all critical components are initialized\n     * WHY: Ensures dashboard is in a valid state after initialization\n     */\n    validateInitialization() {\n        const criticalComponents = [\n            { name: 'socketManager', component: this.socketManager },\n            { name: 'eventViewer', component: this.eventViewer },\n            { name: 'agentHierarchy', component: this.agentHierarchy }\n        ];\n        \n        const missing = criticalComponents.filter(c => !c.component);\n        if (missing.length > 0) {\n            console.warn('Missing critical components:', missing.map(c => c.name));\n        } else {\n            console.log('All critical components initialized');\n        }\n    }\n\n    /**\n     * Post-initialization setup that requires window.dashboard to be set\n     * WHY: Some components need to reference window.dashboard but it's not available\n     * during constructor execution. This method is called after the Dashboard instance\n     * is assigned to window.dashboard, ensuring proper initialization order.\n     * \n     * DESIGN DECISION: Separate post-init phase prevents \"cannot read property of undefined\"\n     * errors when components try to access window.dashboard during construction.\n     */\n    postInit() {\n        try {\n            // Set global reference for agent hierarchy after dashboard is available\n            if (this.agentHierarchy) {\n                window.dashboard.agentHierarchy = this.agentHierarchy;\n                console.log('Agent hierarchy global reference set');\n            }\n            \n            // Initialize any other components that need window.dashboard\n            this.validateInitialization();\n        } catch (error) {\n            console.error('Error in dashboard postInit:', error);\n            // Continue execution - non-critical error\n        }\n    }\n\n    /**\n     * Initialize socket manager\n     */\n    initializeSocketManager() {\n        this.socketManager = new SocketManager();\n\n        // Set up connection controls\n        this.socketManager.setupConnectionControls();\n\n        // Backward compatibility\n        this.socketClient = this.socketManager.getSocketClient();\n        window.socketClient = this.socketClient;\n    }\n\n    /**\n     * Initialize core existing components\n     */\n    initializeCoreComponents() {\n        // Initialize existing components with socket client\n        this.eventViewer = new EventViewer('events-list', this.socketClient);\n        this.moduleViewer = new ModuleViewer();\n        this.sessionManager = new SessionManager(this.socketClient);\n\n        // Backward compatibility\n        window.eventViewer = this.eventViewer;\n        window.moduleViewer = this.moduleViewer;\n        window.sessionManager = this.sessionManager;\n    }\n\n    /**\n     * Initialize build tracker\n     */\n    initializeBuildTracker() {\n        this.buildTracker = new BuildTracker();\n        \n        // Set the socket client for receiving updates\n        this.buildTracker.setSocketClient(this.socketClient);\n        \n        // Mount to header - find the best location\n        const headerTitle = document.querySelector('.header-title');\n        if (headerTitle) {\n            // Insert after the title and status badge\n            this.buildTracker.mount(headerTitle);\n        } else {\n            console.warn('Could not find header-title element for build tracker');\n        }\n        \n        // Make available globally for debugging\n        window.buildTracker = this.buildTracker;\n    }\n\n    /**\n     * Initialize agent inference system\n     */\n    initializeAgentInference() {\n        this.agentInference = new AgentInference(this.eventViewer);\n        this.agentInference.initialize();\n    }\n    \n    /**\n     * Initialize agent hierarchy component\n     * WHY: Creates the agent hierarchy visualization component but defers global\n     * reference setting to postInit() to avoid initialization order issues.\n     */\n    initializeAgentHierarchy() {\n        try {\n            this.agentHierarchy = new AgentHierarchy(this.agentInference, this.eventViewer);\n            // Global reference will be set in postInit() after window.dashboard exists\n            console.log('Agent hierarchy component created');\n        } catch (error) {\n            console.error('Failed to initialize agent hierarchy:', error);\n            // Create a stub to prevent further errors\n            this.agentHierarchy = {\n                render: () => '<div class=\"error\">Agent hierarchy unavailable</div>',\n                expandAllNodes: () => {},\n                collapseAllNodes: () => {},\n                updateWithNewEvents: () => {}\n            };\n        }\n    }\n\n    /**\n     * Initialize UI state manager\n     */\n    initializeUIStateManager() {\n        this.uiStateManager = new UIStateManager();\n        this.setupTabFilters(); // Set up filters after UI state manager\n    }\n\n    /**\n     * Initialize working directory manager\n     */\n    initializeWorkingDirectoryManager() {\n        this.workingDirectoryManager = new WorkingDirectoryManager(this.socketManager);\n    }\n\n    /**\n     * Initialize file-tool tracker\n     */\n    initializeFileToolTracker() {\n        this.fileToolTracker = new FileToolTracker(this.agentInference, this.workingDirectoryManager);\n    }\n\n    /**\n     * Initialize event processor\n     */\n    initializeEventProcessor() {\n        this.eventProcessor = new EventProcessor(this.eventViewer, this.agentInference);\n    }\n\n\n    /**\n     * Initialize export manager\n     */\n    initializeExportManager() {\n        this.exportManager = new ExportManager(this.eventViewer);\n    }\n\n    /**\n     * Set up interactions between modules\n     */\n    setupModuleInteractions() {\n        // Socket events to update file operations and tool calls\n        this.socketManager.onEventUpdate((events) => {\n            this.fileToolTracker.updateFileOperations(events);\n            this.fileToolTracker.updateToolCalls(events);\n\n            // Process agent inference for new events\n            this.agentInference.processAgentInference();\n            \n            // Update agent hierarchy with new events\n            this.agentHierarchy.updateWithNewEvents(events);\n\n            // Auto-scroll events list if on events tab\n            if (this.uiStateManager.getCurrentTab() === 'events') {\n                this.exportManager.scrollListToBottom('events-list');\n            }\n\n            // Re-render current tab\n            this.renderCurrentTab();\n        });\n\n        // Connection status changes\n        this.socketManager.onConnectionStatusChange((status, type) => {\n            // Set up git branch listener when connected\n            if (type === 'connected') {\n                this.workingDirectoryManager.updateGitBranch(\n                    this.workingDirectoryManager.getCurrentWorkingDir()\n                );\n            }\n        });\n\n        // Tab changes\n        document.addEventListener('tabChanged', (e) => {\n            this.renderCurrentTab();\n            this.uiStateManager.updateTabNavigationItems();\n        });\n\n        // Events clearing\n        document.addEventListener('eventsClearing', () => {\n            this.fileToolTracker.clear();\n            this.agentInference.initialize();\n        });\n\n        // Card details requests\n        document.addEventListener('showCardDetails', (e) => {\n            this.showCardDetails(e.detail.tabName, e.detail.index);\n        });\n\n        // Session changes\n        document.addEventListener('sessionFilterChanged', (e) => {\n            console.log('Session filter changed, re-rendering current tab:', this.uiStateManager.getCurrentTab());\n            this.renderCurrentTab();\n        });\n    }\n\n    /**\n     * Set up tab filters\n     */\n    setupTabFilters() {\n        // Agents tab filters\n        const agentsSearchInput = document.getElementById('agents-search-input');\n        const agentsTypeFilter = document.getElementById('agents-type-filter');\n\n        if (agentsSearchInput) {\n            agentsSearchInput.addEventListener('input', () => {\n                if (this.uiStateManager.getCurrentTab() === 'agents') this.renderCurrentTab();\n            });\n        }\n\n        if (agentsTypeFilter) {\n            agentsTypeFilter.addEventListener('change', () => {\n                if (this.uiStateManager.getCurrentTab() === 'agents') this.renderCurrentTab();\n            });\n        }\n\n        // Tools tab filters\n        const toolsSearchInput = document.getElementById('tools-search-input');\n        const toolsTypeFilter = document.getElementById('tools-type-filter');\n\n        if (toolsSearchInput) {\n            toolsSearchInput.addEventListener('input', () => {\n                if (this.uiStateManager.getCurrentTab() === 'tools') this.renderCurrentTab();\n            });\n        }\n\n        if (toolsTypeFilter) {\n            toolsTypeFilter.addEventListener('change', () => {\n                if (this.uiStateManager.getCurrentTab() === 'tools') this.renderCurrentTab();\n            });\n        }\n\n        // Files tab filters\n        const filesSearchInput = document.getElementById('files-search-input');\n        const filesTypeFilter = document.getElementById('files-type-filter');\n\n        if (filesSearchInput) {\n            filesSearchInput.addEventListener('input', () => {\n                if (this.uiStateManager.getCurrentTab() === 'files') this.renderCurrentTab();\n            });\n        }\n\n        if (filesTypeFilter) {\n            filesTypeFilter.addEventListener('change', () => {\n                if (this.uiStateManager.getCurrentTab() === 'files') this.renderCurrentTab();\n            });\n        }\n    }\n\n    /**\n     * Initialize from URL parameters\n     */\n    initializeFromURL() {\n        const params = new URLSearchParams(window.location.search);\n        this.socketManager.initializeFromURL(params);\n    }\n\n    /**\n     * Render current tab content\n     */\n    renderCurrentTab() {\n        const currentTab = this.uiStateManager.getCurrentTab();\n\n        switch (currentTab) {\n            case 'events':\n                // Events tab is handled by EventViewer\n                break;\n            case 'activity':\n                // Trigger Activity tab rendering through the component\n                // Check if ActivityTree class is available (from built module)\n                if (window.ActivityTree && typeof window.ActivityTree === 'function') {\n                    // Create or get instance\n                    if (!window.activityTreeInstance) {\n                        console.log('Creating new ActivityTree instance...');\n                        window.activityTreeInstance = new window.ActivityTree();\n                    }\n                    \n                    // Initialize if needed and render\n                    if (window.activityTreeInstance) {\n                        if (!window.activityTreeInstance.initialized) {\n                            console.log('Initializing ActivityTree...');\n                            window.activityTreeInstance.initialize();\n                        }\n                        \n                        if (typeof window.activityTreeInstance.renderWhenVisible === 'function') {\n                            console.log('Dashboard triggering activity tree render...');\n                            window.activityTreeInstance.renderWhenVisible();\n                        }\n                    }\n                } else if (window.activityTree && typeof window.activityTree === 'function') {\n                    // Fallback to legacy approach if available\n                    const activityTreeInstance = window.activityTree();\n                    if (activityTreeInstance && typeof activityTreeInstance.renderWhenVisible === 'function') {\n                        console.log('Dashboard triggering activity tree render (legacy)...');\n                        activityTreeInstance.renderWhenVisible();\n                    }\n                } else {\n                    // Module not loaded yet, retry after a delay\n                    console.warn('Activity tree component not available, retrying in 100ms...');\n                    setTimeout(() => {\n                        if (this.currentTab === 'activity') {\n                            this.renderCurrentTab();\n                        }\n                    }, 100);\n                }\n                break;\n            case 'agents':\n                this.renderAgents();\n                break;\n            case 'tools':\n                this.renderTools();\n                break;\n            case 'files':\n                this.renderFiles();\n                break;\n        }\n\n        // Update selection UI if we have a selected card\n        const selectedCard = this.uiStateManager.getSelectedCard();\n        if (selectedCard.tab === currentTab) {\n            this.uiStateManager.updateCardSelectionUI();\n        }\n\n        // Update unified selection UI to maintain consistency\n        this.uiStateManager.updateUnifiedSelectionUI();\n    }\n\n    /**\n     * Render agents tab with hierarchical view\n     */\n    renderAgents() {\n        const agentsList = document.getElementById('agents-list');\n        if (!agentsList) return;\n        \n        // Get filter values\n        const searchText = document.getElementById('agents-search-input')?.value || '';\n        const agentType = document.getElementById('agents-type-filter')?.value || '';\n        \n        // Build filters object\n        const filters = {};\n        if (searchText) filters.searchText = searchText;\n        if (agentType) filters.agentType = agentType;\n        \n        // Generate hierarchical HTML\n        const hierarchyHTML = this.agentHierarchy.render(filters);\n        agentsList.innerHTML = hierarchyHTML;\n        \n        // Add expand/collapse all buttons if not present\n        this.addHierarchyControls();\n        \n        // Update filter dropdowns with available agent types\n        const uniqueInstances = this.agentInference.getUniqueAgentInstances();\n        this.updateAgentsFilterDropdowns(uniqueInstances);\n    }\n    \n    /**\n     * Add hierarchy control buttons\n     */\n    addHierarchyControls() {\n        const tabFilters = document.querySelector('#agents-tab .tab-filters');\n        if (!tabFilters) return;\n        \n        // Check if controls already exist\n        if (document.getElementById('hierarchy-controls')) return;\n        \n        // Create control buttons\n        const controls = document.createElement('div');\n        controls.id = 'hierarchy-controls';\n        controls.className = 'hierarchy-controls';\n        controls.innerHTML = `\n            <button data-action=\"expand-all\" \n                    class=\"hierarchy-btn hierarchy-expand-all\">\n                Expand All\n            </button>\n            <button data-action=\"collapse-all\" \n                    class=\"hierarchy-btn hierarchy-collapse-all\">\n                Collapse All\n            </button>\n        `;\n        \n        // Add safe event listeners\n        controls.addEventListener('click', (event) => {\n            const action = event.target.dataset.action;\n            if (action && window.dashboard && window.dashboard.agentHierarchy) {\n                if (action === 'expand-all') {\n                    window.dashboard.agentHierarchy.expandAllNodes();\n                    window.dashboard.renderAgents();\n                } else if (action === 'collapse-all') {\n                    window.dashboard.agentHierarchy.collapseAllNodes();\n                    window.dashboard.renderAgents();\n                }\n            }\n        });\n        \n        tabFilters.appendChild(controls);\n    }\n\n    /**\n     * Render tools tab with unique instance view (one row per unique tool call)\n     */\n    renderTools() {\n        const toolsList = document.getElementById('tools-list');\n        if (!toolsList) return;\n\n        const toolCalls = this.fileToolTracker.getToolCalls();\n        const toolCallsArray = Array.from(toolCalls.entries());\n        const uniqueToolInstances = this.eventProcessor.getUniqueToolInstances(toolCallsArray);\n        const toolHTML = this.eventProcessor.generateToolHTML(uniqueToolInstances);\n\n        toolsList.innerHTML = toolHTML;\n        this.exportManager.scrollListToBottom('tools-list');\n\n        // Update filter dropdowns\n        this.updateToolsFilterDropdowns(uniqueToolInstances);\n    }\n\n    /**\n     * Render files tab with unique instance view (one row per unique file)\n     */\n    renderFiles() {\n        const filesList = document.getElementById('files-list');\n        if (!filesList) return;\n\n        const fileOperations = this.fileToolTracker.getFileOperations();\n        const filesArray = Array.from(fileOperations.entries());\n        const uniqueFileInstances = this.eventProcessor.getUniqueFileInstances(filesArray);\n        const fileHTML = this.eventProcessor.generateFileHTML(uniqueFileInstances);\n\n        filesList.innerHTML = fileHTML;\n        this.exportManager.scrollListToBottom('files-list');\n\n        // Update filter dropdowns\n        this.updateFilesFilterDropdowns(filesArray);\n    }\n\n    /**\n     * Update agents filter dropdowns for unique instances\n     */\n    updateAgentsFilterDropdowns(uniqueInstances) {\n        const agentTypes = new Set();\n\n        // uniqueInstances is already an array of unique agent instances\n        uniqueInstances.forEach(instance => {\n            if (instance.agentName && instance.agentName !== 'Unknown') {\n                agentTypes.add(instance.agentName);\n            }\n        });\n\n        const sortedTypes = Array.from(agentTypes).filter(type => type && type.trim() !== '');\n        this.populateFilterDropdown('agents-type-filter', sortedTypes, 'All Agent Types');\n\n        // Debug log\n        if (sortedTypes.length > 0) {\n            console.log('Agent types found for filter:', sortedTypes);\n        } else {\n            console.log('No agent types found for filter. Instances:', uniqueInstances.length);\n        }\n    }\n\n    /**\n     * Update tools filter dropdowns\n     */\n    updateToolsFilterDropdowns(toolCallsArray) {\n        const toolNames = [...new Set(toolCallsArray.map(([key, toolCall]) => toolCall.tool_name))]\n            .filter(name => name);\n\n        this.populateFilterDropdown('tools-type-filter', toolNames, 'All Tools');\n    }\n\n    /**\n     * Update files filter dropdowns\n     */\n    updateFilesFilterDropdowns(filesArray) {\n        const operations = [...new Set(filesArray.flatMap(([path, data]) =>\n            data.operations.map(op => op.operation)\n        ))].filter(op => op);\n\n        this.populateFilterDropdown('files-type-filter', operations, 'All Operations');\n    }\n\n    /**\n     * Populate filter dropdown with values\n     */\n    populateFilterDropdown(selectId, values, allOption = 'All') {\n        const select = document.getElementById(selectId);\n        if (!select) return;\n\n        const currentValue = select.value;\n        const sortedValues = values.sort((a, b) => a.localeCompare(b));\n\n        // Clear existing options except the first \"All\" option\n        select.innerHTML = `<option value=\"\">${allOption}</option>`;\n\n        // Add sorted values\n        sortedValues.forEach(value => {\n            const option = document.createElement('option');\n            option.value = value;\n            option.textContent = value;\n            select.appendChild(option);\n        });\n\n        // Restore previous selection if it still exists\n        if (currentValue && sortedValues.includes(currentValue)) {\n            select.value = currentValue;\n        }\n    }\n\n    /**\n     * Show card details for specified tab and index\n     */\n    showCardDetails(tabName, index) {\n        switch (tabName) {\n            case 'events':\n                if (this.eventViewer) {\n                    this.eventViewer.showEventDetails(index);\n                }\n                break;\n            case 'agents':\n                this.showAgentDetailsByIndex(index);\n                break;\n            case 'tools':\n                this.showToolDetailsByIndex(index);\n                break;\n            case 'files':\n                this.showFileDetailsByIndex(index);\n                break;\n        }\n    }\n\n    /**\n     * Show agent details by index\n     */\n    showAgentDetailsByIndex(index) {\n        const events = this.eventProcessor.getFilteredEventsForTab('agents');\n\n        // Defensive checks\n        if (!events || !Array.isArray(events) || index < 0 || index >= events.length) {\n            console.warn('Dashboard: Invalid agent index or events array');\n            return;\n        }\n\n        const filteredSingleEvent = this.eventProcessor.applyAgentsFilters([events[index]]);\n\n        if (filteredSingleEvent.length > 0 && this.moduleViewer &&\n            typeof this.moduleViewer.showAgentEvent === 'function') {\n            const event = filteredSingleEvent[0];\n            this.moduleViewer.showAgentEvent(event, index);\n        }\n    }\n\n    /**\n     * Show agent instance details for unique instance view\n     * @param {string} instanceId - Agent instance ID\n     */\n    showAgentInstanceDetails(instanceId) {\n        const pmDelegations = this.agentInference.getPMDelegations();\n        const instance = pmDelegations.get(instanceId);\n\n        if (!instance) {\n            // Check if it's an implied delegation\n            const uniqueInstances = this.agentInference.getUniqueAgentInstances();\n            const impliedInstance = uniqueInstances.find(inst => inst.id === instanceId);\n\n            if (!impliedInstance) {\n                console.error('Agent instance not found:', instanceId);\n                return;\n            }\n\n            // For implied instances, show basic info\n            this.showImpliedAgentDetails(impliedInstance);\n            return;\n        }\n\n        // Show full PM delegation details\n        if (this.moduleViewer && typeof this.moduleViewer.showAgentInstance === 'function') {\n            this.moduleViewer.showAgentInstance(instance);\n        } else {\n            // Fallback: show in console or basic modal\n            console.log('Agent Instance Details:', {\n                id: instanceId,\n                agentName: instance.agentName,\n                type: 'PM Delegation',\n                eventCount: instance.agentEvents.length,\n                startTime: instance.timestamp,\n                pmCall: instance.pmCall\n            });\n        }\n    }\n\n    /**\n     * Show implied agent details (agents without explicit PM delegation)\n     * @param {Object} impliedInstance - Implied agent instance\n     */\n    showImpliedAgentDetails(impliedInstance) {\n        if (this.moduleViewer && typeof this.moduleViewer.showImpliedAgent === 'function') {\n            this.moduleViewer.showImpliedAgent(impliedInstance);\n        } else {\n            // Fallback: show in console or basic modal\n            console.log('Implied Agent Details:', {\n                id: impliedInstance.id,\n                agentName: impliedInstance.agentName,\n                type: 'Implied PM Delegation',\n                eventCount: impliedInstance.eventCount,\n                startTime: impliedInstance.timestamp,\n                note: 'No explicit PM call found - inferred from agent activity'\n            });\n        }\n    }\n\n    /**\n     * Show tool details by index\n     */\n    showToolDetailsByIndex(index) {\n        const toolCalls = this.fileToolTracker.getToolCalls();\n        const toolCallsArray = Array.from(toolCalls.entries());\n        const filteredToolCalls = this.eventProcessor.applyToolCallFilters(toolCallsArray);\n\n        if (index >= 0 && index < filteredToolCalls.length) {\n            const [toolCallKey] = filteredToolCalls[index];\n            this.showToolCallDetails(toolCallKey);\n        }\n    }\n\n    /**\n     * Show file details by index\n     */\n    showFileDetailsByIndex(index) {\n        const fileOperations = this.fileToolTracker.getFileOperations();\n        let filesArray = Array.from(fileOperations.entries());\n        filesArray = this.eventProcessor.applyFilesFilters(filesArray);\n\n        if (index >= 0 && index < filesArray.length) {\n            const [filePath] = filesArray[index];\n            this.showFileDetails(filePath);\n        }\n    }\n\n    /**\n     * Show tool call details\n     */\n    showToolCallDetails(toolCallKey) {\n        const toolCall = this.fileToolTracker.getToolCall(toolCallKey);\n        if (toolCall && this.moduleViewer) {\n            this.moduleViewer.showToolCall(toolCall, toolCallKey);\n        }\n    }\n\n    /**\n     * Show file details\n     */\n    showFileDetails(filePath) {\n        const fileData = this.fileToolTracker.getFileOperationsForFile(filePath);\n        if (fileData && this.moduleViewer) {\n            this.moduleViewer.showFileOperations(fileData, filePath);\n        }\n    }\n\n    // ====================================\n    // BACKWARD COMPATIBILITY METHODS\n    // ====================================\n\n    /**\n     * Switch tab (backward compatibility)\n     */\n    switchTab(tabName) {\n        this.uiStateManager.switchTab(tabName);\n    }\n\n    /**\n     * Select card (backward compatibility)\n     */\n    selectCard(tabName, index, type, data) {\n        this.uiStateManager.selectCard(tabName, index, type, data);\n    }\n\n    /**\n     * Clear events (backward compatibility)\n     */\n    clearEvents() {\n        this.exportManager.clearEvents();\n    }\n\n    /**\n     * Export events (backward compatibility)\n     */\n    exportEvents() {\n        this.exportManager.exportEvents();\n    }\n\n    /**\n     * Clear selection (backward compatibility)\n     */\n    clearSelection() {\n        this.uiStateManager.clearSelection();\n        if (this.eventViewer) {\n            this.eventViewer.clearSelection();\n        }\n        if (this.moduleViewer) {\n            this.moduleViewer.clear();\n        }\n    }\n\n\n    /**\n     * Get current working directory (backward compatibility)\n     */\n    get currentWorkingDir() {\n        return this.workingDirectoryManager.getCurrentWorkingDir();\n    }\n\n    /**\n     * Set current working directory (backward compatibility)\n     */\n    set currentWorkingDir(dir) {\n        this.workingDirectoryManager.setWorkingDirectory(dir);\n    }\n\n    /**\n     * Get current tab (backward compatibility)\n     */\n    get currentTab() {\n        return this.uiStateManager.getCurrentTab();\n    }\n\n    /**\n     * Get selected card (backward compatibility)\n     */\n    get selectedCard() {\n        return this.uiStateManager.getSelectedCard();\n    }\n\n    /**\n     * Get file operations (backward compatibility)\n     */\n    get fileOperations() {\n        return this.fileToolTracker.getFileOperations();\n    }\n\n    /**\n     * Get tool calls (backward compatibility)\n     */\n    get toolCalls() {\n        return this.fileToolTracker.getToolCalls();\n    }\n\n\n    /**\n     * Get tab navigation state (backward compatibility)\n     */\n    get tabNavigation() {\n        return this.uiStateManager ? this.uiStateManager.tabNavigation : null;\n    }\n}\n\n// Global functions for backward compatibility\nwindow.clearEvents = function() {\n    if (window.dashboard) {\n        window.dashboard.clearEvents();\n    }\n};\n\nwindow.exportEvents = function() {\n    if (window.dashboard) {\n        window.dashboard.exportEvents();\n    }\n};\n\nwindow.clearSelection = function() {\n    if (window.dashboard) {\n        window.dashboard.clearSelection();\n    }\n};\n\nwindow.switchTab = function(tabName) {\n    if (window.dashboard) {\n        window.dashboard.switchTab(tabName);\n    }\n};\n\n// File Viewer Modal Functions - REMOVED DUPLICATE (keeping the one at line 1553)\nwindow.showFileViewerModal = function(filePath, workingDir) {\n    // Use the dashboard's current working directory if not provided\n    if (!workingDir && window.dashboard && window.dashboard.currentWorkingDir) {\n        workingDir = window.dashboard.currentWorkingDir;\n    }\n\n    // Create modal if it doesn't exist\n    let modal = document.getElementById('file-viewer-modal');\n    if (!modal) {\n        modal = createFileViewerModal();\n        document.body.appendChild(modal);\n    }\n\n    // Update modal content\n    updateFileViewerModal(modal, filePath, workingDir);\n\n    // Show the modal as flex container\n    modal.style.display = 'flex';\n    document.body.style.overflow = 'hidden'; // Prevent background scrolling\n};\n\nwindow.hideFileViewerModal = function() {\n    const modal = document.getElementById('file-viewer-modal');\n    if (modal) {\n        modal.style.display = 'none';\n        document.body.style.overflow = ''; // Restore background scrolling\n    }\n};\n\nwindow.copyFileContent = function() {\n    const modal = document.getElementById('file-viewer-modal');\n    if (!modal) return;\n\n    const codeElement = modal.querySelector('.file-content-code');\n    if (!codeElement) return;\n\n    const text = codeElement.textContent;\n\n    if (navigator.clipboard && navigator.clipboard.writeText) {\n        navigator.clipboard.writeText(text).then(() => {\n            // Show brief feedback\n            const button = modal.querySelector('.file-content-copy');\n            const originalText = button.textContent;\n            button.textContent = '✅ Copied!';\n            setTimeout(() => {\n                button.textContent = originalText;\n            }, 2000);\n        }).catch(err => {\n            console.error('Failed to copy text:', err);\n        });\n    } else {\n        // Fallback for older browsers\n        const textarea = document.createElement('textarea');\n        textarea.value = text;\n        document.body.appendChild(textarea);\n        textarea.select();\n        document.execCommand('copy');\n        document.body.removeChild(textarea);\n\n        const button = modal.querySelector('.file-content-copy');\n        const originalText = button.textContent;\n        button.textContent = '✅ Copied!';\n        setTimeout(() => {\n            button.textContent = originalText;\n        }, 2000);\n    }\n};\n\nfunction createFileViewerModal() {\n    const modal = document.createElement('div');\n    modal.id = 'file-viewer-modal';\n    modal.className = 'modal file-viewer-modal';\n\n    modal.innerHTML = `\n        <div class=\"modal-content file-viewer-content\">\n            <div class=\"file-viewer-header\">\n                <h2 class=\"file-viewer-title\">\n                    <span class=\"file-viewer-icon\">📄</span>\n                    <span class=\"file-viewer-title-text\">File Viewer</span>\n                </h2>\n                <div class=\"file-viewer-meta\">\n                    <span class=\"file-viewer-file-path\"></span>\n                    <span class=\"file-viewer-file-size\"></span>\n                </div>\n                <button class=\"file-viewer-close\" onclick=\"hideFileViewerModal()\">\n                    <span>&times;</span>\n                </button>\n            </div>\n            <div class=\"file-viewer-body\">\n                <div class=\"file-viewer-loading\">\n                    <div class=\"loading-spinner\"></div>\n                    <span>Loading file content...</span>\n                </div>\n                <div class=\"file-viewer-error\" style=\"display: none;\">\n                    <div class=\"error-icon\">⚠️</div>\n                    <div class=\"error-message\"></div>\n                    <div class=\"error-suggestions\"></div>\n                </div>\n                <div class=\"file-viewer-content-area\" style=\"display: none;\">\n                    <div class=\"file-viewer-toolbar\">\n                        <div class=\"file-viewer-info\">\n                            <span class=\"file-extension\"></span>\n                            <span class=\"file-encoding\"></span>\n                        </div>\n                        <div class=\"file-viewer-actions\">\n                            <button class=\"file-content-copy\" onclick=\"copyFileContent()\">\n                                📋 Copy\n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"file-viewer-scroll-wrapper\">\n                        <pre class=\"file-content-display\"><code class=\"file-content-code\"></code></pre>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Close modal when clicking outside\n    modal.addEventListener('click', (e) => {\n        if (e.target === modal) {\n            hideFileViewerModal();\n        }\n    });\n\n    // Close modal with Escape key\n    document.addEventListener('keydown', (e) => {\n        if (e.key === 'Escape' && modal.style.display === 'flex') {\n            hideFileViewerModal();\n        }\n    });\n\n    return modal;\n}\n\nasync function updateFileViewerModal(modal, filePath, workingDir) {\n    // Update header info\n    const filePathElement = modal.querySelector('.file-viewer-file-path');\n    const fileSizeElement = modal.querySelector('.file-viewer-file-size');\n\n    filePathElement.textContent = filePath;\n    fileSizeElement.textContent = '';\n\n    // Show loading state\n    modal.querySelector('.file-viewer-loading').style.display = 'flex';\n    modal.querySelector('.file-viewer-error').style.display = 'none';\n    modal.querySelector('.file-viewer-content-area').style.display = 'none';\n\n    try {\n        // Get the Socket.IO client\n        const socket = window.socket || window.dashboard?.socketClient?.socket;\n        if (!socket) {\n            throw new Error('No socket connection available');\n        }\n\n        // Set up one-time listener for file content response\n        const responsePromise = new Promise((resolve, reject) => {\n            const responseHandler = (data) => {\n                if (data.file_path === filePath) {\n                    socket.off('file_content_response', responseHandler);\n                    if (data.success) {\n                        resolve(data);\n                    } else {\n                        reject(new Error(data.error || 'Failed to read file'));\n                    }\n                }\n            };\n\n            socket.on('file_content_response', responseHandler);\n\n            // Timeout after 10 seconds\n            setTimeout(() => {\n                socket.off('file_content_response', responseHandler);\n                reject(new Error('Request timeout'));\n            }, 10000);\n        });\n\n        // Send file read request\n        socket.emit('read_file', {\n            file_path: filePath,\n            working_dir: workingDir\n        });\n\n        console.log('📄 File viewer request sent:', {\n            filePath,\n            workingDir\n        });\n\n        // Wait for response\n        const result = await responsePromise;\n        console.log('📦 File content received:', result);\n\n        // Hide loading\n        modal.querySelector('.file-viewer-loading').style.display = 'none';\n\n        // Show successful content\n        displayFileContent(modal, result);\n\n    } catch (error) {\n        console.error('❌ Failed to fetch file content:', error);\n\n        modal.querySelector('.file-viewer-loading').style.display = 'none';\n\n        // Create detailed error message\n        let errorMessage = error.message || 'Unknown error occurred';\n        let suggestions = [];\n\n        if (error.message.includes('No socket connection')) {\n            errorMessage = 'Failed to connect to the monitoring server';\n            suggestions = [\n                'Check if the monitoring server is running',\n                'Verify the socket connection in the dashboard',\n                'Try refreshing the page and reconnecting'\n            ];\n        } else if (error.message.includes('timeout')) {\n            errorMessage = 'Request timed out';\n            suggestions = [\n                'The file may be too large to load quickly',\n                'Check your network connection',\n                'Try again in a few moments'\n            ];\n        } else if (error.message.includes('File does not exist')) {\n            errorMessage = 'File not found';\n            suggestions = [\n                'The file may have been moved or deleted',\n                'Check the file path spelling',\n                'Refresh the file list to see current files'\n            ];\n        } else if (error.message.includes('Access denied')) {\n            errorMessage = 'Access denied';\n            suggestions = [\n                'The file is outside the allowed directories',\n                'File access is restricted for security reasons'\n            ];\n        }\n\n        displayFileError(modal, {\n            error: errorMessage,\n            file_path: filePath,\n            working_dir: workingDir,\n            suggestions: suggestions\n        });\n    }\n}\n\nfunction displayFileContent(modal, result) {\n    console.log('📝 displayFileContent called with:', result);\n    const contentArea = modal.querySelector('.file-viewer-content-area');\n    const extensionElement = modal.querySelector('.file-extension');\n    const encodingElement = modal.querySelector('.file-encoding');\n    const fileSizeElement = modal.querySelector('.file-viewer-file-size');\n    const codeElement = modal.querySelector('.file-content-code');\n\n    // Update metadata\n    if (extensionElement) extensionElement.textContent = `Type: ${result.extension || 'unknown'}`;\n    if (encodingElement) encodingElement.textContent = `Encoding: ${result.encoding || 'unknown'}`;\n    if (fileSizeElement) fileSizeElement.textContent = `Size: ${formatFileSize(result.file_size)}`;\n\n    // Update content with basic syntax highlighting\n    if (codeElement && result.content) {\n        console.log('💡 Setting file content, length:', result.content.length);\n        codeElement.innerHTML = highlightCode(result.content, result.extension);\n\n        // Force scrolling to work by setting explicit heights\n        const wrapper = modal.querySelector('.file-viewer-scroll-wrapper');\n        if (wrapper) {\n            // Give it a moment for content to render\n            setTimeout(() => {\n                const modalContent = modal.querySelector('.modal-content');\n                const header = modal.querySelector('.file-viewer-header');\n                const toolbar = modal.querySelector('.file-viewer-toolbar');\n\n                const modalHeight = modalContent?.offsetHeight || 0;\n                const headerHeight = header?.offsetHeight || 0;\n                const toolbarHeight = toolbar?.offsetHeight || 0;\n\n                const availableHeight = modalHeight - headerHeight - toolbarHeight - 40; // 40px for padding\n\n                console.log('🎯 Setting file viewer scroll height:', {\n                    modalHeight,\n                    headerHeight,\n                    toolbarHeight,\n                    availableHeight\n                });\n\n                wrapper.style.maxHeight = `${availableHeight}px`;\n                wrapper.style.overflowY = 'auto';\n            }, 50);\n        }\n    } else {\n        console.warn('⚠️ Missing codeElement or file content');\n    }\n\n    // Show content area\n    if (contentArea) {\n        contentArea.style.display = 'block';\n        console.log('✅ File content area displayed');\n    }\n}\n\nfunction displayFileError(modal, result) {\n    const errorArea = modal.querySelector('.file-viewer-error');\n    const messageElement = modal.querySelector('.error-message');\n    const suggestionsElement = modal.querySelector('.error-suggestions');\n\n    let errorMessage = result.error || 'Unknown error occurred';\n\n    messageElement.innerHTML = `\n        <div class=\"error-main\">${errorMessage}</div>\n        ${result.file_path ? `<div class=\"error-file\">File: ${result.file_path}</div>` : ''}\n        ${result.working_dir ? `<div class=\"error-dir\">Working directory: ${result.working_dir}</div>` : ''}\n    `;\n\n    if (result.suggestions && result.suggestions.length > 0) {\n        suggestionsElement.innerHTML = `\n            <h4>Suggestions:</h4>\n            <ul>\n                ${result.suggestions.map(s => `<li>${s}</li>`).join('')}\n            </ul>\n        `;\n    } else {\n        suggestionsElement.innerHTML = '';\n    }\n\n    console.log('📋 Displaying file viewer error:', {\n        originalError: result.error,\n        processedMessage: errorMessage,\n        suggestions: result.suggestions\n    });\n\n    errorArea.style.display = 'block';\n}\n\nfunction highlightCode(code, extension) {\n    /**\n     * Apply basic syntax highlighting to code content\n     * WHY: Provides basic highlighting for common file types to improve readability.\n     * This is a simple implementation that can be enhanced with full syntax highlighting\n     * libraries like highlight.js or Prism.js if needed.\n     */\n\n    // Escape HTML entities first\n    const escaped = code\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;');\n\n    // Basic highlighting based on file extension\n    switch (extension) {\n        case '.js':\n        case '.jsx':\n        case '.ts':\n        case '.tsx':\n            return highlightJavaScript(escaped);\n        case '.py':\n            return highlightPython(escaped);\n        case '.json':\n            return highlightJSON(escaped);\n        case '.css':\n            return highlightCSS(escaped);\n        case '.html':\n        case '.htm':\n            return highlightHTML(escaped);\n        case '.md':\n        case '.markdown':\n            return highlightMarkdown(escaped);\n        default:\n            // Return with line numbers for plain text\n            return addLineNumbers(escaped);\n    }\n}\n\nfunction highlightJavaScript(code) {\n    return addLineNumbers(code\n        .replace(/\\b(function|const|let|var|if|else|for|while|return|import|export|class|extends)\\b/g, '<span class=\"keyword\">$1</span>')\n        .replace(/(\\/\\*[\\s\\S]*?\\*\\/|\\/\\/.*)/g, '<span class=\"comment\">$1</span>')\n        .replace(/('[^']*'|\"[^\"]*\"|`[^`]*`)/g, '<span class=\"string\">$1</span>')\n        .replace(/\\b(\\d+)\\b/g, '<span class=\"number\">$1</span>'));\n}\n\nfunction highlightPython(code) {\n    return addLineNumbers(code\n        .replace(/\\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|with)\\b/g, '<span class=\"keyword\">$1</span>')\n        .replace(/(#.*)/g, '<span class=\"comment\">$1</span>')\n        .replace(/('[^']*'|\"[^\"]*\"|\"\"\"[\\s\\S]*?\"\"\")/g, '<span class=\"string\">$1</span>')\n        .replace(/\\b(\\d+)\\b/g, '<span class=\"number\">$1</span>'));\n}\n\nfunction highlightJSON(code) {\n    return addLineNumbers(code\n        .replace(/(\"[\\w\\s]*\")\\s*:/g, '<span class=\"property\">$1</span>:')\n        .replace(/:\\s*(\".*?\")/g, ': <span class=\"string\">$1</span>')\n        .replace(/:\\s*(\\d+)/g, ': <span class=\"number\">$1</span>')\n        .replace(/:\\s*(true|false|null)/g, ': <span class=\"keyword\">$1</span>'));\n}\n\nfunction highlightCSS(code) {\n    return addLineNumbers(code\n        .replace(/([.#]?[\\w-]+)\\s*\\{/g, '<span class=\"selector\">$1</span> {')\n        .replace(/([\\w-]+)\\s*:/g, '<span class=\"property\">$1</span>:')\n        .replace(/:\\s*([^;]+);/g, ': <span class=\"value\">$1</span>;')\n        .replace(/(\\/\\*[\\s\\S]*?\\*\\/)/g, '<span class=\"comment\">$1</span>'));\n}\n\nfunction highlightHTML(code) {\n    return addLineNumbers(code\n        .replace(/(&lt;\\/?[\\w-]+)/g, '<span class=\"tag\">$1</span>')\n        .replace(/([\\w-]+)=(['\"][^'\"]*['\"])/g, '<span class=\"attribute\">$1</span>=<span class=\"string\">$2</span>')\n        .replace(/(&lt;!--[\\s\\S]*?--&gt;)/g, '<span class=\"comment\">$1</span>'));\n}\n\nfunction highlightMarkdown(code) {\n    return addLineNumbers(code\n        .replace(/^(#{1,6})\\s+(.*)$/gm, '<span class=\"header\">$1</span> <span class=\"header-text\">$2</span>')\n        .replace(/\\*\\*(.*?)\\*\\*/g, '<span class=\"bold\">**$1**</span>')\n        .replace(/\\*(.*?)\\*/g, '<span class=\"italic\">*$1*</span>')\n        .replace(/`([^`]+)`/g, '<span class=\"code\">`$1`</span>')\n        .replace(/^\\s*[-*+]\\s+(.*)$/gm, '<span class=\"list-marker\">•</span> $1'));\n}\n\nfunction addLineNumbers(code) {\n    const lines = code.split('\\n');\n    return lines.map((line, index) =>\n        `<span class=\"line-number\">${String(index + 1).padStart(3, ' ')}</span> ${line || ' '}`\n    ).join('\\n');\n}\n\nfunction formatFileSize(bytes) {\n    if (!bytes) return '0 B';\n    const k = 1024;\n    const sizes = ['B', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\n// Git Diff Modal Functions - restored from original dashboard\nwindow.showGitDiffModal = function(filePath, timestamp, workingDir) {\n    // Use the dashboard's current working directory if not provided\n    if (!workingDir && window.dashboard && window.dashboard.currentWorkingDir) {\n        workingDir = window.dashboard.currentWorkingDir;\n    }\n\n    // Create modal if it doesn't exist\n    let modal = document.getElementById('git-diff-modal');\n    if (!modal) {\n        modal = createGitDiffModal();\n        document.body.appendChild(modal);\n    }\n\n    // Update modal content\n    updateGitDiffModal(modal, filePath, timestamp, workingDir);\n\n    // Show the modal as flex container\n    modal.style.display = 'flex';\n    document.body.style.overflow = 'hidden'; // Prevent background scrolling\n};\n\nwindow.hideGitDiffModal = function() {\n    const modal = document.getElementById('git-diff-modal');\n    if (modal) {\n        modal.style.display = 'none';\n        document.body.style.overflow = ''; // Restore background scrolling\n    }\n};\n\nwindow.copyGitDiff = function() {\n    const modal = document.getElementById('git-diff-modal');\n    if (!modal) return;\n\n    const codeElement = modal.querySelector('.git-diff-code');\n    if (!codeElement) return;\n\n    const text = codeElement.textContent;\n\n    if (navigator.clipboard && navigator.clipboard.writeText) {\n        navigator.clipboard.writeText(text).then(() => {\n            // Show brief feedback\n            const button = modal.querySelector('.git-diff-copy');\n            const originalText = button.textContent;\n            button.textContent = '✅ Copied!';\n            setTimeout(() => {\n                button.textContent = originalText;\n            }, 2000);\n        }).catch(err => {\n            console.error('Failed to copy text:', err);\n        });\n    } else {\n        // Fallback for older browsers\n        const textarea = document.createElement('textarea');\n        textarea.value = text;\n        document.body.appendChild(textarea);\n        textarea.select();\n        document.execCommand('copy');\n        document.body.removeChild(textarea);\n\n        const button = modal.querySelector('.git-diff-copy');\n        const originalText = button.textContent;\n        button.textContent = '✅ Copied!';\n        setTimeout(() => {\n            button.textContent = originalText;\n        }, 2000);\n    }\n};\n\nfunction createGitDiffModal() {\n    const modal = document.createElement('div');\n    modal.id = 'git-diff-modal';\n    modal.className = 'modal git-diff-modal';\n\n    modal.innerHTML = `\n        <div class=\"modal-content git-diff-content\">\n            <div class=\"git-diff-header\">\n                <h2 class=\"git-diff-title\">\n                    <span class=\"git-diff-icon\">📋</span>\n                    <span class=\"git-diff-title-text\">Git Diff</span>\n                </h2>\n                <div class=\"git-diff-meta\">\n                    <span class=\"git-diff-file-path\"></span>\n                    <span class=\"git-diff-timestamp\"></span>\n                </div>\n                <button class=\"git-diff-close\" onclick=\"hideGitDiffModal()\">\n                    <span>&times;</span>\n                </button>\n            </div>\n            <div class=\"git-diff-body\">\n                <div class=\"git-diff-loading\">\n                    <div class=\"loading-spinner\"></div>\n                    <span>Loading git diff...</span>\n                </div>\n                <div class=\"git-diff-error\" style=\"display: none;\">\n                    <div class=\"error-icon\">⚠️</div>\n                    <div class=\"error-message\"></div>\n                    <div class=\"error-suggestions\"></div>\n                </div>\n                <div class=\"git-diff-content-area\" style=\"display: none;\">\n                    <div class=\"git-diff-toolbar\">\n                        <div class=\"git-diff-info\">\n                            <span class=\"commit-hash\"></span>\n                            <span class=\"diff-method\"></span>\n                        </div>\n                        <div class=\"git-diff-actions\">\n                            <button class=\"git-diff-copy\" onclick=\"copyGitDiff()\">\n                                📋 Copy\n                            </button>\n                        </div>\n                    </div>\n                    <div class=\"git-diff-scroll-wrapper\">\n                        <pre class=\"git-diff-display\"><code class=\"git-diff-code\"></code></pre>\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Close modal when clicking outside\n    modal.addEventListener('click', (e) => {\n        if (e.target === modal) {\n            hideGitDiffModal();\n        }\n    });\n\n    // Close modal with Escape key\n    document.addEventListener('keydown', (e) => {\n        if (e.key === 'Escape' && modal.style.display === 'flex') {\n            hideGitDiffModal();\n        }\n    });\n\n    return modal;\n}\n\nasync function updateGitDiffModal(modal, filePath, timestamp, workingDir) {\n    // Update header info\n    const filePathElement = modal.querySelector('.git-diff-file-path');\n    const timestampElement = modal.querySelector('.git-diff-timestamp');\n\n    filePathElement.textContent = filePath;\n    timestampElement.textContent = timestamp ? new Date(timestamp).toLocaleString() : 'Latest';\n\n    // Show loading state\n    modal.querySelector('.git-diff-loading').style.display = 'flex';\n    modal.querySelector('.git-diff-error').style.display = 'none';\n    modal.querySelector('.git-diff-content-area').style.display = 'none';\n\n    try {\n        // Get the Socket.IO server port with multiple fallbacks\n        let port = 8765; // Default fallback\n\n        // Try to get port from socketClient first\n        if (window.dashboard && window.dashboard.socketClient && window.dashboard.socketClient.port) {\n            port = window.dashboard.socketClient.port;\n        }\n        // Fallback to port input field if socketClient port is not available\n        else {\n            const portInput = document.getElementById('port-input');\n            if (portInput && portInput.value) {\n                port = portInput.value;\n            }\n        }\n\n        // Build URL parameters\n        const params = new URLSearchParams({\n            file: filePath\n        });\n\n        if (timestamp) {\n            params.append('timestamp', timestamp);\n        }\n        if (workingDir) {\n            params.append('working_dir', workingDir);\n        }\n\n        const requestUrl = `http://localhost:${port}/api/git-diff?${params}`;\n        console.log('🌐 Making git diff request to:', requestUrl);\n        console.log('📋 Git diff request parameters:', {\n            filePath,\n            timestamp,\n            workingDir,\n            urlParams: params.toString()\n        });\n\n        // Test server connectivity first\n        try {\n            const healthResponse = await fetch(`http://localhost:${port}/health`, {\n                method: 'GET',\n                headers: {\n                    'Accept': 'application/json',\n                    'Content-Type': 'application/json'\n                },\n                mode: 'cors'\n            });\n\n            if (!healthResponse.ok) {\n                throw new Error(`Server health check failed: ${healthResponse.status} ${healthResponse.statusText}`);\n            }\n\n            console.log('✅ Server health check passed');\n        } catch (healthError) {\n            throw new Error(`Cannot reach server at localhost:${port}. Health check failed: ${healthError.message}`);\n        }\n\n        // Make the actual git diff request\n        const response = await fetch(requestUrl, {\n            method: 'GET',\n            headers: {\n                'Accept': 'application/json',\n                'Content-Type': 'application/json'\n            },\n            mode: 'cors'\n        });\n\n        if (!response.ok) {\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n\n        const result = await response.json();\n        console.log('📦 Git diff response:', result);\n\n        // Hide loading\n        modal.querySelector('.git-diff-loading').style.display = 'none';\n\n        if (result.success) {\n            console.log('📊 Displaying successful git diff');\n            // Show successful diff\n            displayGitDiff(modal, result);\n        } else {\n            console.log('⚠️ Displaying git diff error:', result);\n            // Show error\n            displayGitDiffError(modal, result);\n        }\n\n    } catch (error) {\n        console.error('❌ Failed to fetch git diff:', error);\n        console.error('Error details:', {\n            name: error.name,\n            message: error.message,\n            stack: error.stack,\n            filePath,\n            timestamp,\n            workingDir\n        });\n\n        modal.querySelector('.git-diff-loading').style.display = 'none';\n\n        // Create detailed error message based on error type\n        let errorMessage = `Network error: ${error.message}`;\n        let suggestions = [];\n\n        if (error.message.includes('Failed to fetch')) {\n            errorMessage = 'Failed to connect to the monitoring server';\n            suggestions = [\n                'Check if the monitoring server is running on port 8765',\n                'Verify the port configuration in the dashboard',\n                'Check browser console for CORS or network errors',\n                'Try refreshing the page and reconnecting'\n            ];\n        } else if (error.message.includes('health check failed')) {\n            errorMessage = error.message;\n            suggestions = [\n                'The server may be starting up - try again in a few seconds',\n                'Check if another process is using port 8765',\n                'Restart the claude-mpm monitoring server'\n            ];\n        } else if (error.message.includes('HTTP')) {\n            errorMessage = `Server error: ${error.message}`;\n            suggestions = [\n                'The server encountered an internal error',\n                'Check the server logs for more details',\n                'Try with a different file or working directory'\n            ];\n        }\n\n        displayGitDiffError(modal, {\n            error: errorMessage,\n            file_path: filePath,\n            working_dir: workingDir,\n            suggestions: suggestions,\n            debug_info: {\n                error_type: error.name,\n                original_message: error.message,\n                port: window.dashboard?.socketClient?.port || document.getElementById('port-input')?.value || '8765',\n                timestamp: new Date().toISOString()\n            }\n        });\n    }\n}\n\nfunction highlightGitDiff(diffText) {\n    /**\n     * Apply basic syntax highlighting to git diff output\n     * WHY: Git diffs have a standard format that can be highlighted for better readability:\n     * - Lines starting with '+' are additions (green)\n     * - Lines starting with '-' are deletions (red)\n     * - Lines starting with '@@' are context headers (blue)\n     * - File headers and metadata get special formatting\n     */\n    return diffText\n        .split('\\n')\n        .map(line => {\n            // Escape HTML entities\n            const escaped = line\n                .replace(/&/g, '&amp;')\n                .replace(/</g, '&lt;')\n                .replace(/>/g, '&gt;');\n\n            // Apply diff highlighting\n            if (line.startsWith('+++') || line.startsWith('---')) {\n                return `<span class=\"diff-header\">${escaped}</span>`;\n            } else if (line.startsWith('@@')) {\n                return `<span class=\"diff-meta\">${escaped}</span>`;\n            } else if (line.startsWith('+')) {\n                return `<span class=\"diff-addition\">${escaped}</span>`;\n            } else if (line.startsWith('-')) {\n                return `<span class=\"diff-deletion\">${escaped}</span>`;\n            } else if (line.startsWith('commit ') || line.startsWith('Author:') || line.startsWith('Date:')) {\n                return `<span class=\"diff-header\">${escaped}</span>`;\n            } else {\n                return `<span class=\"diff-context\">${escaped}</span>`;\n            }\n        })\n        .join('\\n');\n}\n\nfunction displayGitDiff(modal, result) {\n    console.log('📝 displayGitDiff called with:', result);\n    const contentArea = modal.querySelector('.git-diff-content-area');\n    const commitHashElement = modal.querySelector('.commit-hash');\n    const methodElement = modal.querySelector('.diff-method');\n    const codeElement = modal.querySelector('.git-diff-code');\n\n    console.log('🔍 Elements found:', {\n        contentArea: !!contentArea,\n        commitHashElement: !!commitHashElement,\n        methodElement: !!methodElement,\n        codeElement: !!codeElement\n    });\n\n    // Update metadata\n    if (commitHashElement) commitHashElement.textContent = `Commit: ${result.commit_hash}`;\n    if (methodElement) methodElement.textContent = `Method: ${result.method}`;\n\n    // Update diff content with basic syntax highlighting\n    if (codeElement && result.diff) {\n        console.log('💡 Setting diff content, length:', result.diff.length);\n        codeElement.innerHTML = highlightGitDiff(result.diff);\n\n        // Force scrolling to work by setting explicit heights\n        const wrapper = modal.querySelector('.git-diff-scroll-wrapper');\n        if (wrapper) {\n            // Give it a moment for content to render\n            setTimeout(() => {\n                const modalContent = modal.querySelector('.modal-content');\n                const header = modal.querySelector('.git-diff-header');\n                const toolbar = modal.querySelector('.git-diff-toolbar');\n\n                const modalHeight = modalContent?.offsetHeight || 0;\n                const headerHeight = header?.offsetHeight || 0;\n                const toolbarHeight = toolbar?.offsetHeight || 0;\n\n                const availableHeight = modalHeight - headerHeight - toolbarHeight - 40; // 40px for padding\n\n                console.log('🎯 Setting explicit scroll height:', {\n                    modalHeight,\n                    headerHeight,\n                    toolbarHeight,\n                    availableHeight\n                });\n\n                wrapper.style.maxHeight = `${availableHeight}px`;\n                wrapper.style.overflowY = 'auto';\n            }, 50);\n        }\n    } else {\n        console.warn('⚠️ Missing codeElement or diff data');\n    }\n\n    // Show content area\n    if (contentArea) {\n        contentArea.style.display = 'block';\n        console.log('✅ Content area displayed');\n    }\n}\n\nfunction displayGitDiffError(modal, result) {\n    const errorArea = modal.querySelector('.git-diff-error');\n    const messageElement = modal.querySelector('.error-message');\n    const suggestionsElement = modal.querySelector('.error-suggestions');\n\n    // Create more user-friendly error messages\n    let errorMessage = result.error || 'Unknown error occurred';\n    let isUntracked = false;\n\n    if (errorMessage.includes('not tracked by git')) {\n        errorMessage = '📝 This file is not tracked by git yet';\n        isUntracked = true;\n    } else if (errorMessage.includes('No git history found')) {\n        errorMessage = '📋 No git history available for this file';\n    }\n\n    messageElement.innerHTML = `\n        <div class=\"error-main\">${errorMessage}</div>\n        ${result.file_path ? `<div class=\"error-file\">File: ${result.file_path}</div>` : ''}\n        ${result.working_dir ? `<div class=\"error-dir\">Working directory: ${result.working_dir}</div>` : ''}\n    `;\n\n    if (result.suggestions && result.suggestions.length > 0) {\n        const suggestionTitle = isUntracked ? 'How to track this file:' : 'Suggestions:';\n        suggestionsElement.innerHTML = `\n            <h4>${suggestionTitle}</h4>\n            <ul>\n                ${result.suggestions.map(s => `<li>${s}</li>`).join('')}\n            </ul>\n        `;\n    } else {\n        suggestionsElement.innerHTML = '';\n    }\n\n    console.log('📋 Displaying git diff error:', {\n        originalError: result.error,\n        processedMessage: errorMessage,\n        isUntracked,\n        suggestions: result.suggestions\n    });\n\n    errorArea.style.display = 'block';\n}\n\n// File Viewer Modal Functions\nwindow.showFileViewerModal = function(filePath) {\n    // Use the dashboard's current working directory\n    let workingDir = '';\n    if (window.dashboard && window.dashboard.currentWorkingDir) {\n        workingDir = window.dashboard.currentWorkingDir;\n    }\n\n    // Create modal if it doesn't exist\n    let modal = document.getElementById('file-viewer-modal');\n    if (!modal) {\n        modal = createFileViewerModal();\n        document.body.appendChild(modal);\n    }\n\n    // Update modal content\n    updateFileViewerModal(modal, filePath, workingDir);\n\n    // Show the modal as flex container\n    modal.style.display = 'flex';\n    document.body.style.overflow = 'hidden'; // Prevent background scrolling\n};\n\nwindow.hideFileViewerModal = function() {\n    const modal = document.getElementById('file-viewer-modal');\n    if (modal) {\n        modal.style.display = 'none';\n        document.body.style.overflow = ''; // Restore background scrolling\n    }\n};\n\nwindow.copyFileContent = function() {\n    const modal = document.getElementById('file-viewer-modal');\n    if (!modal) return;\n\n    const codeElement = modal.querySelector('.file-content-code');\n    if (!codeElement) return;\n\n    const text = codeElement.textContent;\n\n    if (navigator.clipboard && navigator.clipboard.writeText) {\n        navigator.clipboard.writeText(text).then(() => {\n            // Show brief feedback\n            const button = modal.querySelector('.file-content-copy');\n            const originalText = button.textContent;\n            button.textContent = '✅ Copied!';\n            setTimeout(() => {\n                button.textContent = originalText;\n            }, 2000);\n        }).catch(err => {\n            console.error('Failed to copy text:', err);\n        });\n    } else {\n        // Fallback for older browsers\n        const textarea = document.createElement('textarea');\n        textarea.value = text;\n        document.body.appendChild(textarea);\n        textarea.select();\n        document.execCommand('copy');\n        document.body.removeChild(textarea);\n\n        const button = modal.querySelector('.file-content-copy');\n        const originalText = button.textContent;\n        button.textContent = '✅ Copied!';\n        setTimeout(() => {\n            button.textContent = originalText;\n        }, 2000);\n    }\n};\n\n\n\n\nfunction displayFileContentError(modal, result) {\n    const errorArea = modal.querySelector('.file-viewer-error');\n    const messageElement = modal.querySelector('.error-message');\n    const suggestionsElement = modal.querySelector('.error-suggestions');\n\n    // Create user-friendly error messages\n    let errorMessage = result.error || 'Unknown error occurred';\n\n    if (errorMessage.includes('not found')) {\n        errorMessage = '📁 File not found or not accessible';\n    } else if (errorMessage.includes('permission')) {\n        errorMessage = '🔒 Permission denied accessing this file';\n    } else if (errorMessage.includes('too large')) {\n        errorMessage = '📏 File is too large to display';\n    } else if (!errorMessage.includes('📁') && !errorMessage.includes('🔒') && !errorMessage.includes('📏')) {\n        errorMessage = `⚠️ ${errorMessage}`;\n    }\n\n    messageElement.textContent = errorMessage;\n\n    // Add suggestions if available\n    if (result.suggestions && result.suggestions.length > 0) {\n        suggestionsElement.innerHTML = `\n            <h4>Suggestions:</h4>\n            <ul>\n                ${result.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}\n            </ul>\n        `;\n    } else {\n        suggestionsElement.innerHTML = `\n            <h4>Try:</h4>\n            <ul>\n                <li>Check if the file exists and is readable</li>\n                <li>Verify file permissions</li>\n                <li>Ensure the monitoring server has access to this file</li>\n            </ul>\n        `;\n    }\n\n    console.log('📋 Displaying file content error:', {\n        originalError: result.error,\n        processedMessage: errorMessage,\n        suggestions: result.suggestions\n    });\n\n    errorArea.style.display = 'block';\n}\n\n// Search Viewer Modal Functions\nwindow.showSearchViewerModal = function(searchParams, searchResults) {\n    // Create modal if it doesn't exist\n    let modal = document.getElementById('search-viewer-modal');\n    if (!modal) {\n        modal = createSearchViewerModal();\n        document.body.appendChild(modal);\n    }\n\n    // Update modal content\n    updateSearchViewerModal(modal, searchParams, searchResults);\n\n    // Show the modal as flex container\n    modal.style.display = 'flex';\n    document.body.style.overflow = 'hidden'; // Prevent background scrolling\n};\n\nwindow.hideSearchViewerModal = function() {\n    const modal = document.getElementById('search-viewer-modal');\n    if (modal) {\n        modal.style.display = 'none';\n        document.body.style.overflow = ''; // Restore background scrolling\n    }\n};\n\nfunction createSearchViewerModal() {\n    const modal = document.createElement('div');\n    modal.id = 'search-viewer-modal';\n    modal.className = 'modal search-viewer-modal';\n\n    modal.innerHTML = `\n        <div class=\"modal-content search-viewer-content\">\n            <div class=\"search-viewer-header\">\n                <h2 class=\"search-viewer-title\">\n                    <span class=\"search-viewer-icon\">🔍</span>\n                    <span class=\"search-viewer-title-text\">Search Results</span>\n                </h2>\n                <button class=\"search-viewer-close\" onclick=\"hideSearchViewerModal()\">\n                    <span>&times;</span>\n                </button>\n            </div>\n            <div class=\"search-viewer-body\">\n                <div class=\"search-params-section\">\n                    <h3>Search Parameters</h3>\n                    <pre class=\"search-params-display\"></pre>\n                </div>\n                <div class=\"search-results-section\">\n                    <h3>Search Results</h3>\n                    <div class=\"search-results-display\"></div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Close modal when clicking outside\n    modal.addEventListener('click', (e) => {\n        if (e.target === modal) {\n            hideSearchViewerModal();\n        }\n    });\n\n    // Close modal on Escape key\n    document.addEventListener('keydown', (e) => {\n        if (e.key === 'Escape' && modal.style.display === 'flex') {\n            hideSearchViewerModal();\n        }\n    });\n\n    return modal;\n}\n\nfunction updateSearchViewerModal(modal, searchParams, searchResults) {\n    const paramsDisplay = modal.querySelector('.search-params-display');\n    const resultsDisplay = modal.querySelector('.search-results-display');\n\n    // Display search parameters in formatted JSON\n    if (paramsDisplay && searchParams) {\n        paramsDisplay.textContent = JSON.stringify(searchParams, null, 2);\n    }\n\n    // Display search results\n    if (resultsDisplay && searchResults) {\n        let resultsHTML = '';\n        \n        if (typeof searchResults === 'string') {\n            // If results are a string, display as preformatted text\n            resultsHTML = `<pre class=\"search-results-text\">${escapeHtml(searchResults)}</pre>`;\n        } else if (Array.isArray(searchResults)) {\n            // If results are an array, display as a list\n            resultsHTML = '<ul class=\"search-results-list\">';\n            searchResults.forEach(result => {\n                if (typeof result === 'object') {\n                    resultsHTML += `<li><pre>${JSON.stringify(result, null, 2)}</pre></li>`;\n                } else {\n                    resultsHTML += `<li>${escapeHtml(String(result))}</li>`;\n                }\n            });\n            resultsHTML += '</ul>';\n        } else if (typeof searchResults === 'object') {\n            // If results are an object, display as formatted JSON\n            resultsHTML = `<pre class=\"search-results-json\">${JSON.stringify(searchResults, null, 2)}</pre>`;\n        } else {\n            // Fallback: display as text\n            resultsHTML = `<div class=\"search-results-text\">${escapeHtml(String(searchResults))}</div>`;\n        }\n        \n        resultsDisplay.innerHTML = resultsHTML;\n    }\n}\n\nfunction escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\n// Global window functions for backward compatibility\nwindow.showAgentInstanceDetails = function(instanceId) {\n    if (window.dashboard && typeof window.dashboard.showAgentInstanceDetails === 'function') {\n        window.dashboard.showAgentInstanceDetails(instanceId);\n    } else {\n        console.error('Dashboard not available or method not found');\n    }\n};\n\n// Initialize dashboard when page loads\ndocument.addEventListener('DOMContentLoaded', function() {\n    try {\n        // Create dashboard instance\n        window.dashboard = new Dashboard();\n        \n        // Call post-initialization setup that requires window.dashboard\n        // This must happen after window.dashboard is set\n        if (window.dashboard && typeof window.dashboard.postInit === 'function') {\n            window.dashboard.postInit();\n        }\n        \n        console.log('Dashboard loaded and initialized successfully');\n        \n        // Dispatch custom event to signal dashboard ready\n        document.dispatchEvent(new CustomEvent('dashboardReady', {\n            detail: { dashboard: window.dashboard }\n        }));\n    } catch (error) {\n        console.error('Failed to initialize dashboard:', error);\n        // Show user-friendly error message\n        document.body.innerHTML = `\n            <div style=\"padding: 20px; font-family: sans-serif;\">\n                <h1>Dashboard Initialization Error</h1>\n                <p>The dashboard failed to load properly. Please refresh the page or check the console for details.</p>\n                <pre style=\"background: #f5f5f5; padding: 10px; border-radius: 4px;\">${error.message}</pre>\n            </div>\n        `;\n    }\n});\n\n// ES6 Module export\nexport { Dashboard };\nexport default Dashboard;\n"],"names":["AgentHierarchy","constructor","agentInference","eventViewer","this","state","hierarchyTree","nodeMap","Map","expandedNodes","Set","selectedNode","expandAll","setupEventListeners","console","log","document","addEventListener","event","toggleTarget","target","closest","window","dashboard","agentHierarchy","nodeId","dataset","toggleNode","buildHierarchy","processAgentInference","pmDelegations","getPMDelegations","events","eventAgentMap","getEventAgentMap","mainPM","id","type","name","children","eventCount","status","startTime","endTime","expanded","impliedPMGroups","clear","set","processedAgents","delegationId","delegation","agentNode","agentName","delegationContext","extractDelegationContext","pmCall","agentEvents","length","endIndex","timestamp","startIndex","has","push","add","Date","orphanGroups","getOrphanGroups","impliedPMCounter","groupingKey","orphans","impliedPM","isImplied","tooltip","agentEventGroups","orphan","forEach","index","inference","get","isOrphan","_","some","e","eventIndex","firstEvent","lastEvent","uncategorizedOrphans","child","genericImpliedPM","agentGroups","pmOwnEvents","hasActive","tree","roots","ownEvents","size","totalImpliedAgents","Array","from","values","reduce","sum","pm","params","tool_parameters","data","task","request","description","maxLength","substring","toolInput","tool_input","render","filters","applyFilters","map","root","renderNode","join","node","level","isExpanded","hasChildren","isSelected","icon","getNodeIcon","expandIcon","statusClass","getStatusClass","impliedClass","tooltipAttr","escapeHtml","html","duration","calculateDuration","formatTime","delete","renderCurrentTab","selectNode","CustomEvent","detail","dispatchEvent","Object","keys","filteredTree","filteredRoot","filterNode","matches","searchText","searchLower","toLowerCase","includes","agentType","filteredChildren","filteredChild","toLocaleTimeString","hour","minute","second","hour12","start","end","getTime","toFixed","Math","floor","text","div","createElement","textContent","innerHTML","updateWithNewEvents","expandAllNodes","collapseAllNodes","BuildTracker","element","buildInfo","monitor","version","build","formatted_build","full_version","mpm","socketClient","init","loadDashboardVersion","createElements","response","fetch","ok","versionData","json","error","debug","className","mpmVersion","separator","monitorVersion","appendChild","title","setSocketClient","socket","on","eventData","build_info","updateBuildInfo","updateDisplay","mpmElement","querySelector","parentElement","monitorElement","last_updated","lastUpdated","toLocaleString","showDetailedInfo","info","modal","body","setTimeout","remove","mount","parent","getElement","destroy","parentNode","removeChild","off","Dashboard","moduleViewer","sessionManager","socketManager","uiStateManager","eventProcessor","exportManager","workingDirectoryManager","fileToolTracker","buildTracker","initializeSocketManager","initializeCoreComponents","initializeBuildTracker","initializeAgentInference","initializeAgentHierarchy","initializeUIStateManager","initializeWorkingDirectoryManager","initializeFileToolTracker","initializeEventProcessor","initializeExportManager","setupModuleInteractions","initializeFromURL","validateInitialization","missing","component","filter","c","warn","postInit","SocketManager","setupConnectionControls","getSocketClient","EventViewer","ModuleViewer","SessionManager","headerTitle","AgentInference","initialize","UIStateManager","setupTabFilters","WorkingDirectoryManager","FileToolTracker","EventProcessor","ExportManager","onEventUpdate","updateFileOperations","updateToolCalls","getCurrentTab","scrollListToBottom","onConnectionStatusChange","updateGitBranch","getCurrentWorkingDir","updateTabNavigationItems","showCardDetails","tabName","agentsSearchInput","getElementById","agentsTypeFilter","toolsSearchInput","toolsTypeFilter","filesSearchInput","filesTypeFilter","URLSearchParams","location","search","currentTab","ActivityTree","activityTreeInstance","initialized","renderWhenVisible","activityTree","renderAgents","renderTools","renderFiles","getSelectedCard","tab","updateCardSelectionUI","updateUnifiedSelectionUI","agentsList","value","hierarchyHTML","addHierarchyControls","uniqueInstances","getUniqueAgentInstances","updateAgentsFilterDropdowns","tabFilters","controls","action","toolsList","toolCalls","getToolCalls","toolCallsArray","entries","uniqueToolInstances","getUniqueToolInstances","toolHTML","generateToolHTML","updateToolsFilterDropdowns","filesList","fileOperations","getFileOperations","filesArray","uniqueFileInstances","getUniqueFileInstances","fileHTML","generateFileHTML","updateFilesFilterDropdowns","agentTypes","instance","sortedTypes","trim","populateFilterDropdown","toolNames","key","toolCall","tool_name","operations","flatMap","path","op","operation","selectId","allOption","select","currentValue","sortedValues","sort","a","b","localeCompare","option","showEventDetails","showAgentDetailsByIndex","showToolDetailsByIndex","showFileDetailsByIndex","getFilteredEventsForTab","isArray","filteredSingleEvent","applyAgentsFilters","showAgentEvent","showAgentInstanceDetails","instanceId","impliedInstance","find","inst","showImpliedAgentDetails","showAgentInstance","showImpliedAgent","note","filteredToolCalls","applyToolCallFilters","toolCallKey","showToolCallDetails","applyFilesFilters","filePath","showFileDetails","getToolCall","showToolCall","fileData","getFileOperationsForFile","showFileOperations","switchTab","selectCard","clearEvents","exportEvents","clearSelection","currentWorkingDir","dir","setWorkingDirectory","selectedCard","tabNavigation","createFileViewerModal","hideFileViewerModal","style","display","async","updateFileViewerModal","workingDir","filePathElement","fileSizeElement","Error","responsePromise","Promise","resolve","reject","responseHandler","file_path","success","emit","working_dir","result","contentArea","extensionElement","encodingElement","codeElement","extension","encoding","bytes","k","sizes","i","parseFloat","pow","formatFileSize","file_size","content","code","escaped","replace","addLineNumbers","highlightJavaScript","highlightPython","highlightJSON","highlightCSS","highlightHTML","highlightMarkdown","highlightCode","wrapper","modalContent","header","toolbar","modalHeight","offsetHeight","headerHeight","toolbarHeight","availableHeight","maxHeight","overflowY","displayFileContent","errorMessage","message","suggestions","errorArea","messageElement","suggestionsElement","s","originalError","processedMessage","displayFileError","split","line","String","padStart","displayGitDiffError","isUntracked","suggestionTitle","showFileViewerModal","overflow","copyFileContent","navigator","clipboard","writeText","then","button","originalText","catch","err","textarea","execCommand","showGitDiffModal","hideGitDiffModal","createGitDiffModal","timestampElement","port","portInput","file","append","requestUrl","urlParams","toString","healthResponse","method","headers","Accept","mode","statusText","healthError","commitHashElement","methodElement","commit_hash","diff","startsWith","displayGitDiff","stack","debug_info","error_type","original_message","toISOString","updateGitDiffModal","copyGitDiff","showSearchViewerModal","searchParams","searchResults","hideSearchViewerModal","createSearchViewerModal","paramsDisplay","resultsDisplay","JSON","stringify","resultsHTML","updateSearchViewerModal"],"mappings":"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"}