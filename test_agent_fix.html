<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Inference Test</title>
</head>
<body>
    <h1>Agent Inference Test</h1>
    <div id="test-results"></div>

    <script>
        // Mock EventViewer class for testing
        class MockEventViewer {
            constructor() {
                this.events = [
                    // Test SubagentStop event
                    {
                        "hook_event_name": "SubagentStop",
                        "agent_type": "research",
                        "agent_id": "research_agent_001",
                        "reason": "completed",
                        "session_id": "test_session_123",
                        "timestamp": "2025-08-05T10:30:00Z",
                        "data": {
                            "agent_type": "research",
                            "results": {"status": "success"}
                        }
                    },
                    // Test Task delegation event
                    {
                        "hook_event_name": "PreToolUse",
                        "tool_name": "Task",
                        "session_id": "test_session_123",
                        "timestamp": "2025-08-05T10:29:00Z",
                        "data": {
                            "tool_parameters": {
                                "subagent_type": "developer"
                            },
                            "delegation_details": {
                                "agent_type": "developer"
                            }
                        }
                    },
                    // Test Stop event (main agent)
                    {
                        "hook_event_name": "Stop",
                        "reason": "completed",
                        "session_id": "test_session_123",
                        "timestamp": "2025-08-05T10:31:00Z",
                        "data": {}
                    },
                    // Test Socket.IO hook event
                    {
                        "type": "hook.subagent_stop",
                        "timestamp": "2025-08-05T10:32:00Z",
                        "data": {
                            "agent_type": "researcher",
                            "session_id": "test_session_456"
                        }
                    }
                ];
            }
        }
    </script>

    <script src="/Users/masa/Projects/claude-mpm/src/claude_mpm/web/static/js/components/agent-inference.js"></script>

    <script>
        // Test the agent inference
        const mockEventViewer = new MockEventViewer();
        const agentInference = new AgentInference(mockEventViewer);
        
        console.log('Starting agent inference test...');
        
        // Process all events
        agentInference.processAgentInference();
        
        // Test individual events
        const results = [];
        mockEventViewer.events.forEach((event, index) => {
            const inference = agentInference.getInferredAgentForEvent(event);
            results.push({
                eventIndex: index,
                eventType: event.hook_event_name || event.type,
                agentName: inference?.agentName || 'FAILED',
                agentType: inference?.type || 'FAILED',
                confidence: inference?.confidence || 'FAILED',
                reason: inference?.reason || 'FAILED'
            });
        });
        
        // Display results
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '<h2>Test Results:</h2>' + 
            results.map(result => 
                `<div><strong>Event ${result.eventIndex} (${result.eventType}):</strong> ${result.agentName} (${result.agentType}, ${result.confidence}) - ${result.reason}</div>`
            ).join('');
        
        console.log('Test results:', results);
        
        // Check if we have any failures
        const failures = results.filter(r => r.agentName === 'FAILED' || r.agentName === 'Unknown');
        if (failures.length === 0) {
            console.log('✅ All tests passed! Agent inference is working correctly.');
            resultsDiv.innerHTML += '<div style="color: green; font-weight: bold; margin-top: 20px;">✅ All tests passed!</div>';
        } else {
            console.log('❌ Some tests failed:', failures);
            resultsDiv.innerHTML += '<div style="color: red; font-weight: bold; margin-top: 20px;">❌ Some tests failed</div>';
        }
    </script>
</body>
</html>