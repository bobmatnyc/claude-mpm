# Pre-Publish Cleanup Process

## Overview

The pre-publish cleanup process automatically removes temporary files, system artifacts, and deprecated documentation before each release. This ensures clean releases without unnecessary files.

## Automatic Cleanup

The cleanup process runs automatically as part of `make pre-publish` and includes:

### System Files
- **`.DS_Store`** files (macOS Finder metadata)
- **`__pycache__`** directories (Python bytecode cache)
- **`.pyc` / `.pyo`** files (compiled Python files)

All cleanup excludes `venv/` and `.venv/` directories.

### Test Artifacts (Root Directory)
- `dashboard_test.html` - Temporary dashboard test file
- `report_qa_test.html` - Temporary QA report test file
- `coverage.json` - Test coverage report (regenerated by tests)

### Deprecated Documentation
- `src/claude_mpm/agents/INSTRUCTIONS_OLD_DEPRECATED.md` - Explicitly deprecated agent instructions

## Manual Review Required

The following directories should be reviewed manually before major releases:

### Debug Scripts
- `tools/dev/debug_*.py` - Development debug scripts (30+ files)
- `scripts/development/debug_*.py` - Additional debug scripts (12+ files)

**Command:** `make clean-debug` (requires confirmation)

### Test Artifacts (Archived)
- `tests/test-temp-memory/` - Temporary test memory directory
- `src/claude_mpm/dashboard/static/archive/` - Archived HTML test files (24+ files)
- `tests/artifacts/reports/` - Old test reports

**Action:** Manual review and deletion if no longer needed

## Cleanup Commands

### Individual Cleanup Targets

```bash
# Clean system files (.DS_Store, __pycache__, *.pyc)
make clean-system-files

# Clean test artifacts in root
make clean-test-artifacts

# Remove deprecated documentation
make clean-deprecated

# Remove debug scripts (with confirmation)
make clean-debug

# Run all safe automated cleanup
make clean-pre-publish
```

### Integrated Cleanup

```bash
# Pre-publish workflow (includes cleanup automatically)
make pre-publish
```

The `pre-publish` target automatically runs `clean-pre-publish` as its first step, ensuring cleanup happens before quality checks.

## Safety Features

### Protection Mechanisms
- ✅ All `find` commands exclude `venv/` and `.venv/` directories
- ✅ Commands use `2>/dev/null || true` to prevent errors if files don't exist
- ✅ `clean-debug` requires manual Y/N confirmation before deleting
- ✅ Color-coded output for visibility (Yellow: actions, Green: success, Red: warnings)

### What Won't Be Deleted
- Core test suite in `tests/` directory
- Active development tools
- Current documentation
- Historical verification reports in `/docs/developer/verification-reports/`
- Any files in version control

## Publishing Workflow Integration

### Standard Release Process

```bash
# 1. Ensure changes committed
git status

# 2. Run pre-publish (includes cleanup automatically)
make pre-publish

# 3. Version bump
./scripts/manage_version.py bump patch

# 4. Build with quality checks
make safe-release-build

# 5. Publish to PyPI
make publish-pypi

# 6. Create GitHub release
gh release create vX.Y.Z --title "..." --notes "..."

# 7. Verify
pip install --upgrade claude-mpm
```

The cleanup step is now integrated at step 2 as part of `make pre-publish`.

## Cleanup Summary

### Files Cleaned Automatically (per release)
- **186+ files/directories** cleaned on average:
  - 115+ `__pycache__` directories
  - 10+ `.DS_Store` files
  - 2 root HTML test files
  - 1 root coverage.json
  - 1 deprecated documentation file
  - 50+ test artifact JSON files

### Space Saved
- Estimated **50-100 MB** per cleanup
- Prevents accumulation of temporary files
- Keeps git repository clean

## Troubleshooting

### "Permission denied" errors
```bash
# Check file permissions
ls -la dashboard_test.html

# If needed, remove manually
rm -f dashboard_test.html
```

### "No such file or directory"
This is normal if files don't exist. The cleanup targets use `|| true` to continue gracefully.

### Cleanup didn't remove everything
Some files may require manual review:
```bash
# List files that need manual review
find . -name "debug_*.py" | grep -E "(tools/dev|scripts/development)"
find tests/ -name "*_qa_report*.json"
```

## Best Practices

### Before Every Release
1. ✅ Run `make clean-pre-publish` explicitly to see what's cleaned
2. ✅ Review output for any unexpected deletions
3. ✅ Check git status to ensure only intended files remain
4. ✅ Run `make pre-publish` for full quality gate with cleanup

### Periodic Manual Cleanup (Quarterly)
1. Review and clean debug scripts: `make clean-debug`
2. Clean archived test files: `rm -rf src/claude_mpm/dashboard/static/archive/*_test.html`
3. Clean old test artifacts: `rm -rf tests/test-temp-memory/`
4. Update `.gitignore` if new patterns emerge

### After Major Refactoring
1. Run full cleanup
2. Review test artifacts directory
3. Update cleanup targets if new temporary file patterns appear
4. Document any new cleanup needs

## Configuration

### Makefile Location
`/Users/masa/Projects/claude-mpm/Makefile`

### Cleanup Target Definitions
Lines 584-628 in Makefile

### .gitignore Integration
Cleanup targets complement `.gitignore` by actively removing files that shouldn't be published, even if not tracked by git.

## See Also

- [Publishing Workflow](./publishing.md)
- [Publishing Quick Start](./publishing-quickstart.md)
- [Publishing Setup](./publishing-setup.md)
