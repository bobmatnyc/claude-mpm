# Agent Hierarchy Visualization

The Claude MPM Monitor Dashboard now features a hierarchical agent structure that displays PM (Project Manager) agents at the top level with their delegated subagents as children.

## Overview

The agent hierarchy provides a clear visual representation of:
- PM delegations to subagents via Task tool calls
- Parent-child relationships between PM and subagents
- Agent status (active, completed, pending)
- Event counts and timing for each agent
- Delegation context showing what task was assigned

## Features

### Hierarchical Tree View
- **PM at Root**: Main PM session displayed as the root node
- **Subagents as Children**: Agents delegated via Task tool appear as child nodes
- **Implied PM**: Orphan agents without explicit PM delegation grouped under "PM (Implied)"
- **Visual Indicators**: Icons, colors, and status badges for each agent type

### Interactive Controls
- **Expand/Collapse**: Click on nodes to expand or collapse their children
- **Expand All**: Button to expand entire hierarchy
- **Collapse All**: Button to collapse to root nodes only
- **Smooth Animations**: Transitions for expanding/collapsing

### Agent Information Display
- **Event Count**: Number of events generated by each agent
- **Status**: Active (green), Completed (gray), or Pending (yellow)
- **Task Context**: Description of the delegated task
- **Timing**: Start time and duration for completed agents

## Visual Structure

```
▼ PM (Main Session)
  ├─ ▶ research (Analyze codebase) - 45 events - completed
  ├─ ▼ engineer (Implement feature) - 123 events - active
  │   └─ Task: Implement user authentication
  └─ ▶ qa (Test implementation) - 0 events - pending

▼ PM (Implied)
  └─ ▶ security (Audit code) - 23 events - completed
```

## Implementation Details

### Components

1. **agent-hierarchy.js**: Core component managing the hierarchy tree
   - Builds tree structure from PM delegations
   - Handles expand/collapse functionality
   - Manages node selection and filtering

2. **agent-inference.js**: Enhanced with hierarchy building support
   - `buildDelegationHierarchy()`: Creates tree structure
   - `extractTaskContext()`: Extracts delegation descriptions
   - Tracks PM → subagent relationships

3. **dashboard.js**: Integration with main dashboard
   - Renders hierarchy in agents tab
   - Updates on new events
   - Manages filter controls

4. **dashboard.css**: Tree view styling
   - Indentation for hierarchy levels
   - Status color coding
   - Animations for interactions

### Event Processing

The hierarchy is built by:
1. Identifying PM Task tool calls (delegations)
2. Tracking SubagentStart/Stop events
3. Mapping events to their parent PM
4. Handling orphan agents without explicit delegation

### Status Determination

Agent status is determined by:
- **Active**: Has events but no SubagentStop event
- **Completed**: Has SubagentStop event
- **Pending**: Task delegated but no events yet

## Usage

1. **Open Dashboard**: Start the monitor with `claude-mpm monitor`
2. **Navigate to Agents Tab**: Click on the "Agents" tab
3. **View Hierarchy**: See the tree structure with PM at the top
4. **Interact**: Click nodes to expand/collapse, use control buttons
5. **Filter**: Use search and type filters to find specific agents

## Testing

Test files are provided:
- `/scripts/test_agent_hierarchy.py`: Generates test events
- `/tests/test_agent_hierarchy.py`: Unit tests for hierarchy logic

Run tests:
```bash
python scripts/test_agent_hierarchy.py  # Generate test data
python tests/test_agent_hierarchy.py     # Run unit tests
```

## Benefits

1. **Clear Delegation Flow**: Visualize how work flows from PM to subagents
2. **Status at a Glance**: Quickly see which agents are active or completed
3. **Task Context**: Understand what each agent was asked to do
4. **Performance Insights**: Event counts and timing help identify bottlenecks
5. **Orphan Detection**: Identify agents running without PM coordination