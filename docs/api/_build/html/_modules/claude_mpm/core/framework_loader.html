

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.core.framework_loader &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">claude_mpm.core.framework_loader</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.core.framework_loader</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Framework loader for Claude MPM.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.imports</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_import</span>

<span class="c1"># Import with fallback support - using absolute imports as primary since we&#39;re at module level</span>
<span class="n">get_logger</span> <span class="o">=</span> <span class="n">safe_import</span><span class="p">(</span><span class="s1">&#39;claude_mpm.core.logger&#39;</span><span class="p">,</span> <span class="s1">&#39;core.logger&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;get_logger&#39;</span><span class="p">])</span>
<span class="n">AgentRegistryAdapter</span> <span class="o">=</span> <span class="n">safe_import</span><span class="p">(</span><span class="s1">&#39;claude_mpm.core.agent_registry&#39;</span><span class="p">,</span> <span class="s1">&#39;core.agent_registry&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AgentRegistryAdapter&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="FrameworkLoader">
<a class="viewcode-back" href="../../../core/framework_loader.html#claude_mpm.core.framework_loader.FrameworkLoader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FrameworkLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and prepare framework instructions for injection.</span>
<span class="sd">    </span>
<span class="sd">    This component handles:</span>
<span class="sd">    1. Finding the framework (claude-multiagent-pm)</span>
<span class="sd">    2. Loading INSTRUCTIONS.md instructions</span>
<span class="sd">    3. Preparing agent definitions</span>
<span class="sd">    4. Formatting for injection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="FrameworkLoader.__init__">
<a class="viewcode-back" href="../../../core/framework_loader.html#claude_mpm.core.framework_loader.FrameworkLoader.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize framework loader.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            framework_path: Explicit path to framework (auto-detected if None)</span>
<span class="sd">            agents_dir: Custom agents directory (overrides framework agents)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;framework_loader&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span> <span class="o">=</span> <span class="n">framework_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_framework_path</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_dir</span> <span class="o">=</span> <span class="n">agents_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">framework_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">framework_last_modified</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_framework_content</span><span class="p">()</span>
        
        <span class="c1"># Initialize agent registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span> <span class="o">=</span> <span class="n">AgentRegistryAdapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span><span class="p">)</span></div>

        
    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_framework_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-detect claude-mpm framework.&quot;&quot;&quot;</span>
        <span class="c1"># First check if we&#39;re in claude-mpm project</span>
        <span class="n">current_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;claude-mpm&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_file</span><span class="p">):</span>
            <span class="c1"># We&#39;re running from claude-mpm, use its agents</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">current_file</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;claude-mpm&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using claude-mpm at: </span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">parent</span>
                    <span class="k">break</span>
        
        <span class="c1"># Otherwise check common locations for claude-mpm</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># Development location</span>
            <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;Projects&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude-mpm&quot;</span><span class="p">,</span>
            <span class="c1"># Current directory</span>
            <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;claude-mpm&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># Check for claude-mpm agents directory</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">candidate</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found claude-mpm at: </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">candidate</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Framework not found, will use minimal instructions&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_npm_global_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get npm global installation path.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;npm&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;-g&quot;</span><span class="p">],</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">npm_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">return</span> <span class="n">npm_root</span> <span class="o">/</span> <span class="s2">&quot;@bobmatnyc&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude-multiagent-pm&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_discover_framework_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover agent directories based on priority.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (agents_dir, templates_dir, main_dir)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agents_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">templates_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">main_dir</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_dir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">agents_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using custom agents directory: </span><span class="si">{</span><span class="n">agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span><span class="p">:</span>
            <span class="c1"># Prioritize templates directory over main agents directory</span>
            <span class="n">templates_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span>
            <span class="n">main_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            
            <span class="k">if</span> <span class="n">templates_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">templates_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">)):</span>
                <span class="n">agents_dir</span> <span class="o">=</span> <span class="n">templates_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using agents from templates directory: </span><span class="si">{</span><span class="n">agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">main_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">main_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">)):</span>
                <span class="n">agents_dir</span> <span class="o">=</span> <span class="n">main_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using agents from main directory: </span><span class="si">{</span><span class="n">agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">agents_dir</span><span class="p">,</span> <span class="n">templates_dir</span><span class="p">,</span> <span class="n">main_dir</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_try_load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to load a file with error handling.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            file_path: Path to the file to load</span>
<span class="sd">            file_type: Description of file type for logging</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            File content if successful, None otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2"> from: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract metadata if present</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
            <span class="n">version_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;!-- FRAMEWORK_VERSION: (\d+) --&gt;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version_match</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Keep as string to preserve leading zeros</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Framework version: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Store framework version if this is the main INSTRUCTIONS.md</span>
                <span class="k">if</span> <span class="s1">&#39;INSTRUCTIONS.md&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">framework_version</span> <span class="o">=</span> <span class="n">version</span>
                    
            <span class="c1"># Extract modification timestamp</span>
            <span class="n">timestamp_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;!-- LAST_MODIFIED: ([^&gt;]+) --&gt;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timestamp_match</span><span class="p">:</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last modified: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Store timestamp if this is the main INSTRUCTIONS.md</span>
                <span class="k">if</span> <span class="s1">&#39;INSTRUCTIONS.md&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">framework_last_modified</span> <span class="o">=</span> <span class="n">timestamp</span>
            
            <span class="k">return</span> <span class="n">content</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_instructions_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load INSTRUCTIONS.md or legacy CLAUDE.md from working directory.</span>
<span class="sd">        </span>
<span class="sd">        NOTE: We no longer load CLAUDE.md since Claude Code already picks it up automatically.</span>
<span class="sd">        This prevents duplication of instructions.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Dictionary to update with loaded instructions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Disabled - Claude Code already reads CLAUDE.md automatically</span>
        <span class="c1"># We don&#39;t need to duplicate it in the PM instructions</span>
        <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_workflow_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load WORKFLOW.md with project-specific override support.</span>
<span class="sd">        </span>
<span class="sd">        Precedence:</span>
<span class="sd">        1. Project-specific: .claude-mpm/agents/WORKFLOW.md</span>
<span class="sd">        2. System default: src/claude_mpm/agents/WORKFLOW.md</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Dictionary to update with workflow instructions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for project-specific workflow first</span>
        <span class="n">project_workflow_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.claude-mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;WORKFLOW.md&quot;</span>
        <span class="k">if</span> <span class="n">project_workflow_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">loaded_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_load_file</span><span class="p">(</span><span class="n">project_workflow_path</span><span class="p">,</span> <span class="s2">&quot;project-specific WORKFLOW.md&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loaded_content</span><span class="p">:</span>
                <span class="n">content</span><span class="p">[</span><span class="s2">&quot;workflow_instructions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded_content</span>
                <span class="n">content</span><span class="p">[</span><span class="s2">&quot;project_workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;project&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using project-specific WORKFLOW.md&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        
        <span class="c1"># Fall back to system workflow</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span><span class="p">:</span>
            <span class="n">system_workflow_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;WORKFLOW.md&quot;</span>
            <span class="k">if</span> <span class="n">system_workflow_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">loaded_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_load_file</span><span class="p">(</span><span class="n">system_workflow_path</span><span class="p">,</span> <span class="s2">&quot;system WORKFLOW.md&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">loaded_content</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">[</span><span class="s2">&quot;workflow_instructions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded_content</span>
                    <span class="n">content</span><span class="p">[</span><span class="s2">&quot;project_workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;system&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using system WORKFLOW.md&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_single_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a single agent file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_file: Path to the agent file</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (agent_name, agent_content) or (None, None) on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">agent_name</span> <span class="o">=</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">stem</span>
            <span class="c1"># Skip README files</span>
            <span class="k">if</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;README&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">content</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load agent </span><span class="si">{</span><span class="n">agent_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_base_agent_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">main_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load base_agent.md from main directory as fallback.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Dictionary to update with base agent</span>
<span class="sd">            main_dir: Main agents directory path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">main_dir</span> <span class="ow">and</span> <span class="n">main_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;base_agent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]:</span>
            <span class="n">base_agent_file</span> <span class="o">=</span> <span class="n">main_dir</span> <span class="o">/</span> <span class="s2">&quot;base_agent.md&quot;</span>
            <span class="k">if</span> <span class="n">base_agent_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">agent_name</span><span class="p">,</span> <span class="n">agent_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_single_agent</span><span class="p">(</span><span class="n">base_agent_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">and</span> <span class="n">agent_content</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_content</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_agents_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> 
                               <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">main_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load agent definitions from the appropriate directory.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Dictionary to update with loaded agents</span>
<span class="sd">            agents_dir: Primary agents directory to load from</span>
<span class="sd">            templates_dir: Templates directory path</span>
<span class="sd">            main_dir: Main agents directory path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agents_dir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span>
            
        <span class="n">content</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Load all agent files</span>
        <span class="k">for</span> <span class="n">agent_file</span> <span class="ow">in</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">):</span>
            <span class="n">agent_name</span><span class="p">,</span> <span class="n">agent_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_single_agent</span><span class="p">(</span><span class="n">agent_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">and</span> <span class="n">agent_content</span><span class="p">:</span>
                <span class="n">content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_content</span>
        
        <span class="c1"># If we used templates dir, also check main dir for base_agent.md</span>
        <span class="k">if</span> <span class="n">agents_dir</span> <span class="o">==</span> <span class="n">templates_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_base_agent_fallback</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">main_dir</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_framework_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load framework content.&quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;claude_md&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;loaded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;working_claude_md&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;framework_instructions&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;workflow_instructions&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;project_workflow&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        
        <span class="c1"># Load instructions file from working directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_instructions_file</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">content</span>
        
        <span class="c1"># Load framework&#39;s INSTRUCTIONS.md</span>
        <span class="n">framework_instructions_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;INSTRUCTIONS.md&quot;</span>
        <span class="k">if</span> <span class="n">framework_instructions_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">loaded_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_load_file</span><span class="p">(</span><span class="n">framework_instructions_path</span><span class="p">,</span> <span class="s2">&quot;framework INSTRUCTIONS.md&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loaded_content</span><span class="p">:</span>
                <span class="n">content</span><span class="p">[</span><span class="s2">&quot;framework_instructions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded_content</span>
                <span class="n">content</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Add framework version to content</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_version</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">[</span><span class="s2">&quot;instructions_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_version</span>
                    <span class="n">content</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_version</span>  <span class="c1"># Update main version key</span>
                <span class="c1"># Add modification timestamp to content</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_last_modified</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">[</span><span class="s2">&quot;instructions_last_modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_last_modified</span>
        
        <span class="c1"># Load BASE_PM.md for core framework requirements</span>
        <span class="n">base_pm_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_path</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude_mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;BASE_PM.md&quot;</span>
        <span class="k">if</span> <span class="n">base_pm_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">base_pm_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_load_file</span><span class="p">(</span><span class="n">base_pm_path</span><span class="p">,</span> <span class="s2">&quot;BASE_PM framework requirements&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_pm_content</span><span class="p">:</span>
                <span class="n">content</span><span class="p">[</span><span class="s2">&quot;base_pm_instructions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_pm_content</span>
        
        <span class="c1"># Load WORKFLOW.md - check for project-specific first, then system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_workflow_instructions</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        
        <span class="c1"># Discover agent directories</span>
        <span class="n">agents_dir</span><span class="p">,</span> <span class="n">templates_dir</span><span class="p">,</span> <span class="n">main_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discover_framework_paths</span><span class="p">()</span>
        
        <span class="c1"># Load agents from discovered directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_agents_directory</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">,</span> <span class="n">templates_dir</span><span class="p">,</span> <span class="n">main_dir</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">content</span>
    
<div class="viewcode-block" id="FrameworkLoader.get_framework_instructions">
<a class="viewcode-back" href="../../../core/framework_loader.html#claude_mpm.core.framework_loader.FrameworkLoader.get_framework_instructions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_framework_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get formatted framework instructions for injection.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Complete framework instructions ready for injection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]:</span>
            <span class="c1"># Build framework from components</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_full_framework</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use minimal fallback</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_minimal_framework</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_strip_metadata_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Strip metadata HTML comments from content.</span>
<span class="sd">        </span>
<span class="sd">        Removes comments like:</span>
<span class="sd">        &lt;!-- FRAMEWORK_VERSION: 0010 --&gt;</span>
<span class="sd">        &lt;!-- LAST_MODIFIED: 2025-08-10T00:00:00Z --&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="c1"># Remove HTML comments that contain metadata</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;!--\s*(FRAMEWORK_VERSION|LAST_MODIFIED|WORKFLOW_VERSION|PROJECT_WORKFLOW_VERSION|CUSTOM_PROJECT_WORKFLOW)[^&gt;]*--&gt;\n?&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="c1"># Also remove any leading blank lines that might result</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cleaned</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_full_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format full framework instructions.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        
        <span class="c1"># If we have the full framework INSTRUCTIONS.md, use it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;framework_instructions&quot;</span><span class="p">):</span>
            <span class="n">instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_metadata_comments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;framework_instructions&quot;</span><span class="p">])</span>
            
            <span class="c1"># Note: We don&#39;t add working directory CLAUDE.md here since Claude Code</span>
            <span class="c1"># already picks it up automatically. This prevents duplication.</span>
            
            <span class="c1"># Add WORKFLOW.md after instructions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_instructions&quot;</span><span class="p">):</span>
                <span class="n">workflow_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_metadata_comments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s1">&#39;workflow_instructions&#39;</span><span class="p">])</span>
                <span class="n">instructions</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">workflow_content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># Note: project-specific workflow is being used (logged elsewhere)</span>
            
            <span class="c1"># Add dynamic agent capabilities section</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_agent_capabilities_section</span><span class="p">()</span>
            
            <span class="c1"># Add current date for temporal awareness</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## Temporal Context</span><span class="se">\n</span><span class="s2">**Today&#39;s Date**: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;Apply date awareness to all time-sensitive tasks and decisions.</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add BASE_PM.md framework requirements AFTER INSTRUCTIONS.md</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_pm_instructions&quot;</span><span class="p">):</span>
                <span class="n">base_pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_metadata_comments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s1">&#39;base_pm_instructions&#39;</span><span class="p">])</span>
                <span class="n">instructions</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">base_pm</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Clean up any trailing whitespace</span>
            <span class="n">instructions</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">return</span> <span class="n">instructions</span>
        
        <span class="c1"># Otherwise fall back to generating framework</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Claude MPM Framework Instructions</span>

<span class="s2">You are operating within the Claude Multi-Agent Project Manager (MPM) framework.</span>

<span class="s2">## Core Role</span>
<span class="s2">You are a multi-agent orchestrator. Your primary responsibilities are:</span>
<span class="s2">- Delegate all implementation work to specialized agents via Task Tool</span>
<span class="s2">- Coordinate multi-agent workflows and cross-agent collaboration</span>
<span class="s2">- Extract and track TODO/BUG/FEATURE items for ticket creation</span>
<span class="s2">- Maintain project visibility and strategic oversight</span>
<span class="s2">- NEVER perform direct implementation work yourself</span>

<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="c1"># Note: We don&#39;t add working directory CLAUDE.md here since Claude Code</span>
        <span class="c1"># already picks it up automatically. This prevents duplication.</span>
        
        <span class="c1"># Add agent definitions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]:</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;## Available Agents</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;You have the following specialized agents available for delegation:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># List agents with brief descriptions and correct IDs</span>
            <span class="n">agent_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># Use the actual agent_name as the ID (it&#39;s the filename stem)</span>
                <span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_name</span>
                <span class="n">clean_name</span> <span class="o">=</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;engineer&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Engineer Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Code implementation and development&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;qa&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **QA Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Testing and quality assurance&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;documentation&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Documentation Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Documentation creation and maintenance&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;research&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Research Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Investigation and analysis&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;security&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Security Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Security analysis and protection&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;version&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Version Control Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Git operations and version management&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;ops&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Ops Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Deployment and operations&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **Data Engineer Agent** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Data management and AI API integration&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">agent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): Available for specialized tasks&quot;</span><span class="p">)</span>
            
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">agent_list</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add full agent details</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;### Agent Details</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">agent_content</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">instructions</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;#### </span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">instructions</span> <span class="o">+=</span> <span class="n">agent_content</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># Add orchestration principles</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">## Orchestration Principles</span>
<span class="s2">1. **Always Delegate**: Never perform direct work - use Task Tool for all implementation</span>
<span class="s2">2. **Comprehensive Context**: Provide rich, filtered context to each agent</span>
<span class="s2">3. **Track Everything**: Extract all TODO/BUG/FEATURE items systematically</span>
<span class="s2">4. **Cross-Agent Coordination**: Orchestrate workflows spanning multiple agents</span>
<span class="s2">5. **Results Integration**: Actively receive and integrate agent results</span>

<span class="s2">## Task Tool Format</span>
<span class="s2">```</span>
<span class="s2">**[Agent Name]**: [Clear task description with deliverables]</span>

<span class="s2">TEMPORAL CONTEXT: Today is [date]. Apply date awareness to [specific considerations].</span>

<span class="s2">**Task**: [Detailed task breakdown]</span>
<span class="s2">1. [Specific action item 1]</span>
<span class="s2">2. [Specific action item 2]</span>
<span class="s2">3. [Specific action item 3]</span>

<span class="s2">**Context**: [Comprehensive filtered context for this agent]</span>
<span class="s2">**Authority**: [Agent&#39;s decision-making scope]</span>
<span class="s2">**Expected Results**: [Specific deliverables needed]</span>
<span class="s2">**Integration**: [How results integrate with other work]</span>
<span class="s2">```</span>

<span class="s2">## Ticket Extraction Patterns</span>
<span class="s2">Extract tickets from these patterns:</span>
<span class="s2">- TODO: [description]  TODO ticket</span>
<span class="s2">- BUG: [description]  BUG ticket</span>
<span class="s2">- FEATURE: [description]  FEATURE ticket</span>
<span class="s2">- ISSUE: [description]  ISSUE ticket</span>
<span class="s2">- FIXME: [description]  BUG ticket</span>

<span class="s2">---</span>
<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">instructions</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_agent_capabilities_section</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate dynamic agent capabilities section from deployed agents.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
            
            <span class="c1"># Read directly from deployed agents in .claude/agents/</span>
            <span class="n">agents_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No .claude/agents directory found&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fallback_capabilities</span><span class="p">()</span>
            
            <span class="c1"># Build capabilities section</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## Available Agent Capabilities</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Collect deployed agents</span>
            <span class="n">deployed_agents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent_file</span> <span class="ow">in</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                    
                <span class="c1"># Parse agent metadata</span>
                <span class="n">agent_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_agent_metadata</span><span class="p">(</span><span class="n">agent_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">agent_data</span><span class="p">:</span>
                    <span class="n">deployed_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_data</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">deployed_agents</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fallback_capabilities</span><span class="p">()</span>
            
            <span class="c1"># Sort agents alphabetically by ID</span>
            <span class="n">deployed_agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            
            <span class="c1"># Display all agents with their rich descriptions</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">deployed_agents</span><span class="p">:</span>
                <span class="c1"># Clean up display name - handle common acronyms</span>
                <span class="n">display_name</span> <span class="o">=</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span>
                <span class="n">display_name</span> <span class="o">=</span> <span class="n">display_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Qa &#39;</span><span class="p">,</span> <span class="s1">&#39;QA &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Ui &#39;</span><span class="p">,</span> <span class="s1">&#39;UI &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Api &#39;</span><span class="p">,</span> <span class="s1">&#39;API &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">display_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;qa agent&#39;</span><span class="p">:</span>
                    <span class="n">display_name</span> <span class="o">=</span> <span class="s1">&#39;QA Agent&#39;</span>
                
                <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">### </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="c1"># Add any additional metadata if present</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authority&#39;</span><span class="p">):</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **Authority**: </span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;authority&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;primary_function&#39;</span><span class="p">):</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **Primary Function**: </span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;primary_function&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handoff_to&#39;</span><span class="p">):</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **Handoff To**: </span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;handoff_to&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;tools&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **Tools**: </span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;tools&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **Model**: </span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add simple Context-Aware Agent Selection</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Context-Aware Agent Selection</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;Select agents based on their descriptions above. Key principles:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;- **PM questions**  Answer directly (only exception)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;- Match task requirements to agent descriptions and authority</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;- Consider agent handoff recommendations</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;- Use the agent ID in parentheses when delegating via Task tool</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add summary</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**Total Available Agents**: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">deployed_agents</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">return</span> <span class="n">section</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate dynamic agent capabilities: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fallback_capabilities</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_agent_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse agent metadata from deployed agent file.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with agent metadata directly from YAML frontmatter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">agent_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                
            <span class="c1"># Default values</span>
            <span class="n">agent_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span>
                <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Specialized agent&#39;</span>
            <span class="p">}</span>
            
            <span class="c1"># Extract YAML frontmatter if present</span>
            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
                <span class="n">end_marker</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">end_marker</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">frontmatter</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">end_marker</span><span class="p">]</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">frontmatter</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
                        <span class="c1"># Use name as ID for Task tool</span>
                        <span class="n">agent_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">agent_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">agent_data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">agent_data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                        
                        <span class="c1"># Copy all metadata fields directly</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>  <span class="c1"># Skip already processed fields</span>
                                <span class="n">agent_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        
                        <span class="c1"># IMPORTANT: Do NOT add spaces to tools field - it breaks deployment!</span>
                        <span class="c1"># Tools must remain as comma-separated without spaces: &quot;Read,Write,Edit&quot;</span>
            
            <span class="k">return</span> <span class="n">agent_data</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse metadata from </span><span class="si">{</span><span class="n">agent_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_agent_selection_guide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployed_agents</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Context-Aware Agent Selection guide from deployed agents.</span>
<span class="sd">        </span>
<span class="sd">        Creates a mapping of task types to appropriate agents based on their</span>
<span class="sd">        descriptions and capabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Build selection mapping based on deployed agents</span>
        <span class="n">selection_map</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">deployed_agents</span><span class="p">:</span>
            <span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">desc_lower</span> <span class="o">=</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="c1"># Map task types to agents based on their descriptions</span>
            <span class="k">if</span> <span class="s1">&#39;implementation&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;engineer&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span> <span class="ow">and</span> <span class="s1">&#39;data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="p">):</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Implementation tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;codebase analysis&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;research&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Codebase analysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;testing&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;qa&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Testing/quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;documentation&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Documentation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;security&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;sast&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Security operations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;deployment&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;infrastructure&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;ops&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Deployment/infrastructure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;pipeline&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;etl&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">):</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Data pipeline/ETL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;git&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;version control&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Version control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;ticket&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;epic&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Ticket/issue management&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;browser&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;e2e&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Browser/E2E testing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;frontend&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;ui&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span> <span class="ow">or</span> <span class="s1">&#39;html&#39;</span> <span class="ow">in</span> <span class="n">desc_lower</span><span class="p">:</span>
                <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;Frontend/UI development&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`)&quot;</span>
        
        <span class="c1"># Always include PM questions</span>
        <span class="n">selection_map</span><span class="p">[</span><span class="s1">&#39;PM questions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Answer directly (only exception)&quot;</span>
        
        <span class="c1"># Format the selection guide</span>
        <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">agent_info</span> <span class="ow">in</span> <span class="n">selection_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">guide</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">task_type</span><span class="si">}</span><span class="s2">**  </span><span class="si">{</span><span class="n">agent_info</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">return</span> <span class="n">guide</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_fallback_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return fallback capabilities when dynamic discovery fails.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">## Available Agent Capabilities</span>

<span class="s2">You have the following specialized agents available for delegation:</span>

<span class="s2">- **Engineer** (`engineer`): Code implementation and development</span>
<span class="s2">- **Research** (`research-agent`): Investigation and analysis  </span>
<span class="s2">- **QA** (`qa-agent`): Testing and quality assurance</span>
<span class="s2">- **Documentation** (`documentation-agent`): Documentation creation and maintenance</span>
<span class="s2">- **Security** (`security-agent`): Security analysis and protection</span>
<span class="s2">- **Data Engineer** (`data-engineer`): Data management and pipelines</span>
<span class="s2">- **Ops** (`ops-agent`): Deployment and operations</span>
<span class="s2">- **Version Control** (`version-control`): Git operations and version management</span>

<span class="s2">**IMPORTANT**: Use the exact agent ID in parentheses when delegating tasks.</span>
<span class="s2">&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_minimal_framework</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format minimal framework instructions when full framework not available.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Claude PM Framework Instructions</span>

<span class="s2">You are operating within a Claude PM Framework deployment.</span>

<span class="s2">## Role</span>
<span class="s2">You are a multi-agent orchestrator. Your primary responsibilities:</span>
<span class="s2">- Delegate tasks to specialized agents via Task Tool</span>
<span class="s2">- Coordinate multi-agent workflows</span>
<span class="s2">- Extract TODO/BUG/FEATURE items for ticket creation</span>
<span class="s2">- NEVER perform direct implementation work</span>

<span class="s2">## Core Agents</span>
<span class="s2">- Documentation Agent - Documentation tasks</span>
<span class="s2">- Engineer Agent - Code implementation  </span>
<span class="s2">- QA Agent - Testing and validation</span>
<span class="s2">- Research Agent - Investigation and analysis</span>
<span class="s2">- Version Control Agent - Git operations</span>

<span class="s2">## Important Rules</span>
<span class="s2">1. Always delegate work via Task Tool</span>
<span class="s2">2. Provide comprehensive context to agents</span>
<span class="s2">3. Track all TODO/BUG/FEATURE items</span>
<span class="s2">4. Maintain project visibility</span>

<span class="s2">---</span>
<span class="s2">&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="FrameworkLoader.get_agent_list">
<a class="viewcode-back" href="../../../core/framework_loader.html#claude_mpm.core.framework_loader.FrameworkLoader.get_agent_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of available agents.&quot;&quot;&quot;</span>
        <span class="c1"># First try agent registry</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span><span class="p">:</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span><span class="o">.</span><span class="n">list_agents</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">agents</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">agents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># Fallback to loaded content</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

    
<div class="viewcode-block" id="FrameworkLoader.get_agent_definition">
<a class="viewcode-back" href="../../../core/framework_loader.html#claude_mpm.core.framework_loader.FrameworkLoader.get_agent_definition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get specific agent definition.&quot;&quot;&quot;</span>
        <span class="c1"># First try agent registry</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span><span class="o">.</span><span class="n">get_agent_definition</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">definition</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">definition</span>
        
        <span class="c1"># Fallback to loaded content</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_content</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="FrameworkLoader.get_agent_hierarchy">
<a class="viewcode-back" href="../../../core/framework_loader.html#claude_mpm.core.framework_loader.FrameworkLoader.get_agent_hierarchy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get agent hierarchy from registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_registry</span><span class="o">.</span><span class="n">get_agent_hierarchy</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="p">[]}</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>