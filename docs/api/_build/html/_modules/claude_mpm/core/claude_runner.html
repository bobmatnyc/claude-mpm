

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.core.claude_runner &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">claude_mpm.core.claude_runner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.core.claude_runner</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Claude runner with both exec and subprocess launch methods.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.config.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">paths</span>

<span class="c1"># Core imports that don&#39;t cause circular dependencies</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.logging_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">log_operation</span><span class="p">,</span> <span class="n">log_performance_context</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_project_logger</span><span class="p">,</span> <span class="n">ProjectLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.container</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_container</span><span class="p">,</span> <span class="n">ServiceLifetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AgentDeploymentInterface</span><span class="p">,</span>
    <span class="n">TicketManagerInterface</span><span class="p">,</span> 
    <span class="n">HookServiceInterface</span>
<span class="p">)</span>

<span class="c1"># Type checking imports to avoid circular dependencies</span>
<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.agents.deployment</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentDeploymentService</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.ticket_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">TicketManager</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.hook_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">HookService</span>


<div class="viewcode-block" id="ClaudeRunner">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ClaudeRunner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Claude runner that replaces the entire orchestrator system.</span>
<span class="sd">    </span>
<span class="sd">    This does exactly what we need:</span>
<span class="sd">    1. Deploy native agents to .claude/agents/</span>
<span class="sd">    2. Run Claude CLI with either exec or subprocess</span>
<span class="sd">    3. Extract tickets if needed</span>
<span class="sd">    4. Handle both interactive and non-interactive modes</span>
<span class="sd">    </span>
<span class="sd">    Supports two launch methods:</span>
<span class="sd">    - exec: Replace current process (default for backward compatibility)</span>
<span class="sd">    - subprocess: Launch as child process for more control</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ClaudeRunner.__init__">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">enable_tickets</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span><span class="p">,</span>
        <span class="n">claude_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">launch_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span>  <span class="c1"># &quot;exec&quot; or &quot;subprocess&quot;</span>
        <span class="n">enable_websocket</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">websocket_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8765</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Claude runner.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_tickets</span> <span class="o">=</span> <span class="n">enable_tickets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">claude_args</span> <span class="o">=</span> <span class="n">claude_args</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_method</span> <span class="o">=</span> <span class="n">launch_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_websocket</span> <span class="o">=</span> <span class="n">enable_websocket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websocket_port</span> <span class="o">=</span> <span class="n">websocket_port</span>
        
        <span class="c1"># Initialize project logger for session logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">log_level</span> <span class="o">!=</span> <span class="s2">&quot;OFF&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span> <span class="o">=</span> <span class="n">get_project_logger</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Initializing ClaudeRunner with </span><span class="si">{</span><span class="n">launch_method</span><span class="si">}</span><span class="s2"> launcher&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;runner&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project logger module not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize project logger: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize services using dependency injection</span>
        <span class="c1"># Determine the user&#39;s working directory from environment</span>
        <span class="n">user_working_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">user_working_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using user working directory from CLAUDE_MPM_USER_PWD&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;directory&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_working_dir</span><span class="p">)})</span>
        
        <span class="c1"># Get DI container and resolve services</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">get_container</span><span class="p">()</span>
        
        <span class="c1"># Register and resolve deployment service</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">container</span><span class="o">.</span><span class="n">is_registered</span><span class="p">(</span><span class="n">AgentDeploymentInterface</span><span class="p">):</span>
            <span class="c1"># Lazy import to avoid circular dependencies</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.agents.deployment</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentDeploymentService</span>
            <span class="n">container</span><span class="o">.</span><span class="n">register_factory</span><span class="p">(</span>
                <span class="n">AgentDeploymentInterface</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">AgentDeploymentService</span><span class="p">(</span><span class="n">working_directory</span><span class="o">=</span><span class="n">user_working_dir</span><span class="p">),</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">ServiceLifetime</span><span class="o">.</span><span class="n">SINGLETON</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deployment_service</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">AgentDeploymentInterface</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resolve AgentDeploymentService&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent deployment service initialization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        
        <span class="c1"># Initialize ticket manager if enabled using DI</span>
        <span class="k">if</span> <span class="n">enable_tickets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">container</span><span class="o">.</span><span class="n">is_registered</span><span class="p">(</span><span class="n">TicketManagerInterface</span><span class="p">):</span>
                <span class="c1"># Lazy import to avoid circular dependencies</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.ticket_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">TicketManager</span>
                <span class="n">container</span><span class="o">.</span><span class="n">register_singleton</span><span class="p">(</span><span class="n">TicketManagerInterface</span><span class="p">,</span> <span class="n">TicketManager</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ticket_manager</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TicketManagerInterface</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to initialize TicketManager&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ticket_manager</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enable_tickets</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ticket_manager</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Initialize configuration</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Configuration file not found, using defaults&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>  <span class="c1"># Will use defaults</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to load configuration&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration initialization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        
        <span class="c1"># Initialize response logging if enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">response_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_logging&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">response_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.claude_session_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_session_logger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response_logger</span> <span class="o">=</span> <span class="n">get_session_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                        <span class="s2">&quot;Response logging initialized&quot;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                        <span class="n">component</span><span class="o">=</span><span class="s2">&quot;logging&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to initialize response logger&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Initialize hook service using DI</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">container</span><span class="o">.</span><span class="n">is_registered</span><span class="p">(</span><span class="n">HookServiceInterface</span><span class="p">):</span>
            <span class="c1"># Lazy import to avoid circular dependencies</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.hook_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">HookService</span>
            <span class="n">container</span><span class="o">.</span><span class="n">register_factory</span><span class="p">(</span>
                <span class="n">HookServiceInterface</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">HookService</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">),</span>
                <span class="n">lifetime</span><span class="o">=</span><span class="n">ServiceLifetime</span><span class="o">.</span><span class="n">SINGLETON</span>
            <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook_service</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HookServiceInterface</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register_memory_hooks</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to initialize hook service&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook_service</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Load system instructions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_system_instructions</span><span class="p">()</span>
        
        <span class="c1"># Track if we need to create session logs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_log_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span> <span class="ow">and</span> <span class="n">log_level</span> <span class="o">!=</span> <span class="s2">&quot;OFF&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create a system.jsonl file in the session directory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">session_dir</span> <span class="o">/</span> <span class="s2">&quot;system.jsonl&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_session_event</span><span class="p">({</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;session_start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;runner&quot;</span><span class="p">:</span> <span class="s2">&quot;ClaudeRunner&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;enable_tickets&quot;</span><span class="p">:</span> <span class="n">enable_tickets</span><span class="p">,</span>
                    <span class="s2">&quot;log_level&quot;</span><span class="p">:</span> <span class="n">log_level</span><span class="p">,</span>
                    <span class="s2">&quot;launch_method&quot;</span><span class="p">:</span> <span class="n">launch_method</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permission denied creating session log file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OS error creating session log file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create session log file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize Socket.IO server reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span> <span class="o">=</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="ClaudeRunner.setup_agents">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner.setup_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deploy native agents to .claude/agents/.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="s2">&quot;Starting agent deployment&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                <span class="p">)</span>
            
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_service</span><span class="o">.</span><span class="n">deploy_agents</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;deployed&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">deployed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;deployed&#39;</span><span class="p">])</span>
                <span class="n">updated_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="p">[]))</span>
                
                <span class="k">if</span> <span class="n">deployed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Deployed </span><span class="si">{</span><span class="n">deployed_count</span><span class="si">}</span><span class="s2"> native agents&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updated_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Updated </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> agents&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Agent deployment successful: </span><span class="si">{</span><span class="n">deployed_count</span><span class="si">}</span><span class="s2"> deployed, </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> updated&quot;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                        <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                    <span class="p">)</span>
                    
                <span class="c1"># Set Claude environment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deployment_service</span><span class="o">.</span><span class="n">set_claude_environment</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All agents already up to date&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                        <span class="s2">&quot;All agents already up to date&quot;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                        <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
                
        
        <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Permission denied deploying agents to .claude/agents/: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💡 Try running with appropriate permissions or check directory ownership&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agent files not found: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💡 Ensure claude-mpm is properly installed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Missing required module for agent deployment: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💡 Some agent features may be limited&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error during agent deployment: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span><span class="p">)</span>
            <span class="c1"># Continue without agents rather than failing completely</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="ClaudeRunner.ensure_project_agents">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner.ensure_project_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_project_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure system agents are available in the project directory.</span>
<span class="sd">        </span>
<span class="sd">        Deploys system agents to project&#39;s .claude/agents/ directory</span>
<span class="sd">        if they don&#39;t exist or are outdated. This ensures agents are</span>
<span class="sd">        available for Claude Code to use. Project-specific JSON templates</span>
<span class="sd">        should be placed in .claude-mpm/agents/.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if agents are available, False on error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the correct user directory, not the framework directory</span>
            <span class="k">if</span> <span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            
            <span class="n">project_agents_dir</span> <span class="o">=</span> <span class="n">project_dir</span> <span class="o">/</span> <span class="s2">&quot;.claude-mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            
            <span class="c1"># Create directory if it doesn&#39;t exist</span>
            <span class="n">project_agents_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Ensuring agents are available in project: </span><span class="si">{</span><span class="n">project_agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                <span class="p">)</span>
            
            <span class="c1"># Deploy agents to project&#39;s .claude/agents directory (not .claude-mpm)</span>
            <span class="c1"># This ensures all system agents are deployed regardless of version</span>
            <span class="c1"># .claude-mpm/agents/ should only contain JSON source templates</span>
            <span class="c1"># .claude/agents/ should contain the built MD files for Claude Code</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_service</span><span class="o">.</span><span class="n">deploy_agents</span><span class="p">(</span>
                <span class="n">target_dir</span><span class="o">=</span><span class="n">project_dir</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span><span class="p">,</span>
                <span class="n">force_rebuild</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">deployment_mode</span><span class="o">=</span><span class="s2">&quot;project&quot;</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;deployed&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">deployed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;deployed&#39;</span><span class="p">])</span>
                <span class="n">updated_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="p">[]))</span>
                
                <span class="k">if</span> <span class="n">deployed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deployed </span><span class="si">{</span><span class="n">deployed_count</span><span class="si">}</span><span class="s2"> agents to project&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">updated_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> agents in project&quot;</span><span class="p">)</span>
                    
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="c1"># Agents already exist and are current</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project agents up to date: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;skipped&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> agents&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No agents deployed to project&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to ensure project agents: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to ensure project agents: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="ClaudeRunner.deploy_project_agents_to_claude">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner.deploy_project_agents_to_claude">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deploy_project_agents_to_claude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deploy project agents from .claude-mpm/agents/ to .claude/agents/.</span>
<span class="sd">        </span>
<span class="sd">        This method handles the deployment of project-specific agents (JSON format)</span>
<span class="sd">        from the project&#39;s agents directory to Claude&#39;s agent directory.</span>
<span class="sd">        Project agents take precedence over system agents.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Project agents allow teams to define custom, project-specific agents</span>
<span class="sd">        that override system agents. These are stored in JSON format in </span>
<span class="sd">        .claude-mpm/agents/ and need to be deployed to .claude/agents/</span>
<span class="sd">        as MD files for Claude to use them.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if deployment successful or no agents to deploy, False on error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the correct user directory, not the framework directory</span>
            <span class="k">if</span> <span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            
            <span class="n">project_agents_dir</span> <span class="o">=</span> <span class="n">project_dir</span> <span class="o">/</span> <span class="s2">&quot;.claude-mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            <span class="n">claude_agents_dir</span> <span class="o">=</span> <span class="n">project_dir</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            
            <span class="c1"># Check if project agents directory exists</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">project_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No project agents directory found&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Not an error - just no project agents</span>
            
            <span class="c1"># Get JSON agent files from agents directory</span>
            <span class="n">json_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">project_agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">json_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No JSON agents in project&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            
            <span class="c1"># Create .claude/agents directory if needed</span>
            <span class="n">claude_agents_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deploying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">json_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> project agents to .claude/agents/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Deploying project agents from </span><span class="si">{</span><span class="n">project_agents_dir</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">claude_agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                <span class="p">)</span>
            
            <span class="n">deployed_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">updated_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Deploy each JSON agent</span>
            <span class="c1"># CRITICAL: PM (Project Manager) must NEVER be deployed as it&#39;s the main Claude instance</span>
            <span class="n">EXCLUDED_AGENTS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;project_manager&#39;</span><span class="p">}</span>
            
            <span class="c1"># Initialize deployment service with proper base agent path</span>
            <span class="c1"># Use the existing deployment service&#39;s base agent path if available</span>
            <span class="n">base_agent_path</span> <span class="o">=</span> <span class="n">project_agents_dir</span> <span class="o">/</span> <span class="s2">&quot;base_agent.json&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">base_agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># Fall back to system base agent</span>
                <span class="n">base_agent_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_service</span><span class="o">.</span><span class="n">base_agent_path</span>
            
            <span class="c1"># Create a single deployment service instance for all agents</span>
            <span class="n">project_deployment</span> <span class="o">=</span> <span class="n">AgentDeploymentService</span><span class="p">(</span>
                <span class="n">templates_dir</span><span class="o">=</span><span class="n">project_agents_dir</span><span class="p">,</span>
                <span class="n">base_agent_path</span><span class="o">=</span><span class="n">base_agent_path</span><span class="p">,</span>
                <span class="n">working_directory</span><span class="o">=</span><span class="n">project_dir</span>  <span class="c1"># Pass the project directory</span>
            <span class="p">)</span>
            
            <span class="c1"># Load base agent data once</span>
            <span class="n">base_agent_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">base_agent_path</span> <span class="ow">and</span> <span class="n">base_agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                    <span class="n">base_agent_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load base agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">json_file</span> <span class="ow">in</span> <span class="n">json_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">json_file</span><span class="o">.</span><span class="n">stem</span>
                    
                    <span class="c1"># Skip PM agent - it&#39;s the main Claude instance, not a subagent</span>
                    <span class="k">if</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">EXCLUDED_AGENTS</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> (PM is the main Claude instance)&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    
                    <span class="n">target_file</span> <span class="o">=</span> <span class="n">claude_agents_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
                    
                    <span class="c1"># Check if agent needs update</span>
                    <span class="n">needs_update</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="c1"># Check if it&#39;s a project agent (has project marker)</span>
                        <span class="n">existing_content</span> <span class="o">=</span> <span class="n">target_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s2">&quot;author: claude-mpm-project&quot;</span> <span class="ow">in</span> <span class="n">existing_content</span> <span class="ow">or</span> <span class="s2">&quot;source: project&quot;</span> <span class="ow">in</span> <span class="n">existing_content</span><span class="p">:</span>
                            <span class="c1"># Compare modification times</span>
                            <span class="k">if</span> <span class="n">target_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;=</span> <span class="n">json_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">:</span>
                                <span class="n">needs_update</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> is up to date&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">needs_update</span><span class="p">:</span>
                        <span class="c1"># Build the agent markdown using the pre-initialized service and base agent data</span>
                        <span class="n">agent_content</span> <span class="o">=</span> <span class="n">project_deployment</span><span class="o">.</span><span class="n">_build_agent_markdown</span><span class="p">(</span>
                            <span class="n">agent_name</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">base_agent_data</span>
                        <span class="p">)</span>
                        
                        <span class="c1"># Mark as project agent</span>
                        <span class="n">agent_content</span> <span class="o">=</span> <span class="n">agent_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s2">&quot;author: claude-mpm&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;author: claude-mpm-project&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="c1"># Write the agent file</span>
                        <span class="n">is_update</span> <span class="o">=</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                        <span class="n">target_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">agent_content</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
                            <span class="n">updated_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated project agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">deployed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deployed project agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to deploy project agent </span><span class="si">{</span><span class="n">json_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            
            <span class="c1"># Report results</span>
            <span class="k">if</span> <span class="n">deployed_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">updated_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Deployed </span><span class="si">{</span><span class="n">deployed_count</span><span class="si">}</span><span class="s2"> project agents, updated </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Project agent deployment: </span><span class="si">{</span><span class="n">deployed_count</span><span class="si">}</span><span class="s2"> deployed, </span><span class="si">{</span><span class="n">updated_count</span><span class="si">}</span><span class="s2"> updated&quot;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                        <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span>
                    <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to deploy project agents: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️  </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s2">&quot;deployment&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="ClaudeRunner.run_interactive">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner.run_interactive">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run Claude in interactive mode.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This method now delegates to InteractiveSession class for better</span>
<span class="sd">        maintainability and reduced complexity. The session class handles all</span>
<span class="sd">        the details while this method provides the simple interface.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Using delegation pattern to reduce complexity from</span>
<span class="sd">        39 to &lt;10 and lines from 262 to &lt;80, while maintaining 100% backward</span>
<span class="sd">        compatibility. All functionality including response logging through</span>
<span class="sd">        the hook system is preserved.</span>
<span class="sd">        </span>
<span class="sd">        The hook system continues to capture Claude events (UserPromptSubmit,</span>
<span class="sd">        PreToolUse, PostToolUse, Task delegations) directly from Claude Code,</span>
<span class="sd">        providing comprehensive event capture without process control overhead.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            initial_context: Optional initial context to pass to Claude</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.interactive_session</span><span class="w"> </span><span class="kn">import</span> <span class="n">InteractiveSession</span>
        
        <span class="c1"># Create session handler</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">InteractiveSession</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Initialize session</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">initialize_interactive_session</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize interactive session: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Step 2: Set up environment</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">setup_interactive_environment</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to setup interactive environment&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Step 3: Handle interactive input/output</span>
            <span class="c1"># This is where the actual Claude process runs</span>
            <span class="n">session</span><span class="o">.</span><span class="n">handle_interactive_input</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Step 4: Clean up session</span>
            <span class="n">session</span><span class="o">.</span><span class="n">cleanup_interactive_session</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="ClaudeRunner.run_oneshot">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.ClaudeRunner.run_oneshot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_oneshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run Claude with a single prompt and return success status.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This method now delegates to OneshotSession class for better</span>
<span class="sd">        maintainability and reduced complexity. The session class handles</span>
<span class="sd">        all the details while this method provides the simple interface.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Using delegation pattern to reduce complexity from</span>
<span class="sd">        50 to &lt;10 and lines from 332 to &lt;80, while maintaining 100% backward</span>
<span class="sd">        compatibility. All functionality is preserved through the session class.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            prompt: The command or prompt to execute</span>
<span class="sd">            context: Optional context to prepend to the prompt</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if successful, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.oneshot_session</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneshotSession</span>
        
        <span class="c1"># Create session handler</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">OneshotSession</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Initialize session</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">initialize_session</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Special case: MPM commands return early</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/mpm:&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">success</span>
            
            <span class="c1"># Step 2: Deploy agents</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">deploy_agents</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Agent deployment had issues, continuing...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Step 3: Set up infrastructure</span>
            <span class="n">infrastructure</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">setup_infrastructure</span><span class="p">()</span>
            
            <span class="c1"># Step 4: Execute command</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">infrastructure</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">success</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Step 5: Clean up session</span>
            <span class="n">session</span><span class="o">.</span><span class="n">cleanup_session</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_tickets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract tickets from Claude&#39;s response.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticket_manager</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the ticket manager&#39;s extraction logic if available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticket_manager</span><span class="p">,</span> <span class="s1">&#39;extract_tickets_from_text&#39;</span><span class="p">):</span>
                <span class="n">tickets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticket_manager</span><span class="o">.</span><span class="n">extract_tickets_from_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tickets</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📋 Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span><span class="si">}</span><span class="s2"> tickets&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">tickets</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># Show first 3</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - [</span><span class="si">{</span><span class="n">ticket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">ticket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No title&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s2"> more&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticket extraction method not available&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ticket manager missing expected method: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid ticket data format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during ticket extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_system_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load and process system instructions from agents/INSTRUCTIONS.md.</span>
<span class="sd">        </span>
<span class="sd">        Implements project &gt; framework precedence:</span>
<span class="sd">        1. First check for project-specific instructions in .claude-mpm/agents/INSTRUCTIONS.md</span>
<span class="sd">        2. If not found, fall back to framework instructions in src/claude_mpm/agents/INSTRUCTIONS.md</span>
<span class="sd">        </span>
<span class="sd">        WHY: Allows projects to override the default PM instructions with project-specific</span>
<span class="sd">        guidance, while maintaining backward compatibility with the framework defaults.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Using CLAUDE_MPM_USER_PWD environment variable to locate the</span>
<span class="sd">        correct project directory, ensuring we check the right location even when</span>
<span class="sd">        claude-mpm is invoked from a different directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Determine the user&#39;s project directory</span>
            <span class="k">if</span> <span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            
            <span class="c1"># Check for project-specific INSTRUCTIONS.md first</span>
            <span class="n">project_instructions_path</span> <span class="o">=</span> <span class="n">project_dir</span> <span class="o">/</span> <span class="s2">&quot;.claude-mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;INSTRUCTIONS.md&quot;</span>
            
            <span class="n">instructions_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">instructions_source</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="n">project_instructions_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">instructions_path</span> <span class="o">=</span> <span class="n">project_instructions_path</span>
                <span class="n">instructions_source</span> <span class="o">=</span> <span class="s2">&quot;PROJECT&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found project-specific INSTRUCTIONS.md: </span><span class="si">{</span><span class="n">instructions_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fall back to framework instructions</span>
                <span class="n">module_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
                <span class="n">framework_instructions_path</span> <span class="o">=</span> <span class="n">module_path</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;INSTRUCTIONS.md&quot;</span>
                
                <span class="k">if</span> <span class="n">framework_instructions_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">instructions_path</span> <span class="o">=</span> <span class="n">framework_instructions_path</span>
                    <span class="n">instructions_source</span> <span class="o">=</span> <span class="s2">&quot;FRAMEWORK&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using framework INSTRUCTIONS.md: </span><span class="si">{</span><span class="n">instructions_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No INSTRUCTIONS.md found in project or framework&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># Read raw instructions</span>
            <span class="n">raw_instructions</span> <span class="o">=</span> <span class="n">instructions_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            
            <span class="c1"># Strip HTML metadata comments before processing</span>
            <span class="n">raw_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_metadata_comments</span><span class="p">(</span><span class="n">raw_instructions</span><span class="p">)</span>
            
            <span class="c1"># Process template variables if ContentAssembler is available</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.framework_claude_md_generator.content_assembler</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentAssembler</span>
                <span class="n">assembler</span> <span class="o">=</span> <span class="n">ContentAssembler</span><span class="p">()</span>
                <span class="n">processed_instructions</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">apply_template_variables</span><span class="p">(</span><span class="n">raw_instructions</span><span class="p">)</span>
                
                <span class="c1"># Append BASE_PM.md framework requirements with dynamic content</span>
                <span class="n">base_pm_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;BASE_PM.md&quot;</span>
                <span class="k">if</span> <span class="n">base_pm_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">base_pm_content</span> <span class="o">=</span> <span class="n">base_pm_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                    
                    <span class="c1"># Strip metadata comments from BASE_PM.md as well</span>
                    <span class="n">base_pm_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_metadata_comments</span><span class="p">(</span><span class="n">base_pm_content</span><span class="p">)</span>
                    
                    <span class="c1"># Process BASE_PM.md with dynamic content injection</span>
                    <span class="n">base_pm_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_base_pm_content</span><span class="p">(</span><span class="n">base_pm_content</span><span class="p">)</span>
                    
                    <span class="n">processed_instructions</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">base_pm_content</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended BASE_PM.md with dynamic capabilities from deployed agents&quot;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded and processed </span><span class="si">{</span><span class="n">instructions_source</span><span class="si">}</span><span class="s2"> PM instructions&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">processed_instructions</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ContentAssembler not available, using raw instructions&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">instructions_source</span><span class="si">}</span><span class="s2"> PM instructions (raw)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">raw_instructions</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process template variables: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, using raw instructions&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">instructions_source</span><span class="si">}</span><span class="s2"> PM instructions (raw, processing failed)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">raw_instructions</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load system instructions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_base_pm_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_pm_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process BASE_PM.md content with dynamic injections.</span>
<span class="sd">        </span>
<span class="sd">        This method replaces template variables in BASE_PM.md with:</span>
<span class="sd">        - {{agent-capabilities}}: List of deployed agents from .claude/agents/</span>
<span class="sd">        - {{current-date}}: Today&#39;s date for temporal context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        
        <span class="c1"># Replace {{current-date}} with actual date</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">base_pm_content</span> <span class="o">=</span> <span class="n">base_pm_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{{current-date}}&#39;</span><span class="p">,</span> <span class="n">current_date</span><span class="p">)</span>
        
        <span class="c1"># Replace {{agent-capabilities}} with deployed agents</span>
        <span class="k">if</span> <span class="s1">&#39;{{agent-capabilities}}&#39;</span> <span class="ow">in</span> <span class="n">base_pm_content</span><span class="p">:</span>
            <span class="n">capabilities_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_deployed_agent_capabilities</span><span class="p">()</span>
            <span class="n">base_pm_content</span> <span class="o">=</span> <span class="n">base_pm_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{{agent-capabilities}}&#39;</span><span class="p">,</span> <span class="n">capabilities_section</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">base_pm_content</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_strip_metadata_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Strip HTML metadata comments from content.</span>
<span class="sd">        </span>
<span class="sd">        Removes comments like:</span>
<span class="sd">        &lt;!-- FRAMEWORK_VERSION: 0010 --&gt;</span>
<span class="sd">        &lt;!-- LAST_MODIFIED: 2025-08-10T00:00:00Z --&gt;</span>
<span class="sd">        &lt;!-- WORKFLOW_VERSION: ... --&gt;</span>
<span class="sd">        &lt;!-- PROJECT_WORKFLOW_VERSION: ... --&gt;</span>
<span class="sd">        &lt;!-- CUSTOM_PROJECT_WORKFLOW --&gt;</span>
<span class="sd">        </span>
<span class="sd">        WHY: These metadata comments are useful for internal tracking but should not</span>
<span class="sd">        appear in the final instructions passed to Claude via --append-system-prompt.</span>
<span class="sd">        They clutter the instructions and provide no value to the Claude agent.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Using regex to remove all HTML comments that contain known</span>
<span class="sd">        metadata patterns. Also removes any resulting leading blank lines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        
        <span class="c1"># Remove HTML comments that contain metadata</span>
        <span class="n">patterns_to_strip</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;FRAMEWORK_VERSION&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LAST_MODIFIED&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;WORKFLOW_VERSION&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PROJECT_WORKFLOW_VERSION&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CUSTOM_PROJECT_WORKFLOW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AGENT_VERSION&#39;</span><span class="p">,</span>
            <span class="s1">&#39;METADATA_VERSION&#39;</span>
        <span class="p">]</span>
        
        <span class="c1"># Build regex pattern to match any of these metadata comments</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&lt;!--\s*(&#39;</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patterns_to_strip</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)[^&gt;]*--&gt;\n?&#39;</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        
        <span class="c1"># Also remove any leading blank lines that might result</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cleaned</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_deployed_agent_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate agent capabilities from deployed agents following Claude Code&#39;s hierarchy.</span>
<span class="sd">        </span>
<span class="sd">        Follows the agent precedence order:</span>
<span class="sd">        1. Project agents (.claude/agents/) - highest priority</span>
<span class="sd">        2. User agents (~/.config/claude/agents/) - middle priority  </span>
<span class="sd">        3. System agents (claude-desktop installation) - lowest priority</span>
<span class="sd">        </span>
<span class="sd">        Project agents override user/system agents with the same ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Track discovered agents by ID to handle overrides</span>
            <span class="n">discovered_agents</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># 1. First read system agents (lowest priority)</span>
            <span class="n">system_agents_dirs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;Library&quot;</span> <span class="o">/</span> <span class="s2">&quot;Application Support&quot;</span> <span class="o">/</span> <span class="s2">&quot;Claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span><span class="p">,</span>  <span class="c1"># macOS</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.config&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span><span class="p">,</span>  <span class="c1"># Linux</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;AppData&quot;</span> <span class="o">/</span> <span class="s2">&quot;Roaming&quot;</span> <span class="o">/</span> <span class="s2">&quot;Claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span><span class="p">,</span>  <span class="c1"># Windows</span>
            <span class="p">]</span>
            
            <span class="k">for</span> <span class="n">system_dir</span> <span class="ow">in</span> <span class="n">system_agents_dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">system_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_discover_agents_from_dir</span><span class="p">(</span><span class="n">system_dir</span><span class="p">,</span> <span class="n">discovered_agents</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="c1"># 2. Then read user agents (middle priority, overrides system)</span>
            <span class="n">user_agents_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.config&quot;</span> <span class="o">/</span> <span class="s2">&quot;claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            <span class="k">if</span> <span class="n">user_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_discover_agents_from_dir</span><span class="p">(</span><span class="n">user_agents_dir</span><span class="p">,</span> <span class="n">discovered_agents</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
            
            <span class="c1"># 3. Finally read project agents (highest priority, overrides all)</span>
            <span class="n">project_agents_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
            <span class="k">if</span> <span class="n">project_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_discover_agents_from_dir</span><span class="p">(</span><span class="n">project_agents_dir</span><span class="p">,</span> <span class="n">discovered_agents</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">discovered_agents</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No agents found in any tier&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fallback_capabilities</span><span class="p">()</span>
            
            <span class="c1"># Build capabilities section from discovered agents</span>
            <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Available Agent Capabilities</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;You have the following specialized agents available for delegation:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Group agents by category</span>
            <span class="n">agents_by_category</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">agent_info</span> <span class="ow">in</span> <span class="n">discovered_agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">agent_info</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agents_by_category</span><span class="p">:</span>
                    <span class="n">agents_by_category</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">agents_by_category</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_info</span><span class="p">)</span>
            
            <span class="c1"># Output agents by category</span>
            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">agents_by_category</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">### </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> Agents</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">agents_by_category</span><span class="p">[</span><span class="n">category</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                    <span class="n">tier_indicator</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">if</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;project&#39;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">** (`</span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">`</span><span class="si">{</span><span class="n">tier_indicator</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">agent</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add summary</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**Total Available Agents**: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discovered_agents</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Show tier distribution</span>
            <span class="n">tier_counts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">discovered_agents</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">tier</span> <span class="o">=</span> <span class="n">agent</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span>
                <span class="n">tier_counts</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span> <span class="o">=</span> <span class="n">tier_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tier_counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;**Agent Sources**: &quot;</span>
                <span class="n">tier_summary</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">tier_counts</span><span class="p">:</span>
                        <span class="n">tier_summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tier_counts</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tier_summary</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;Use the agent ID in parentheses when delegating tasks via the Task tool.</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated capabilities for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">discovered_agents</span><span class="p">)</span><span class="si">}</span><span class="s2"> agents &quot;</span> <span class="o">+</span>
                           <span class="sa">f</span><span class="s2">&quot;(project: </span><span class="si">{</span><span class="n">tier_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="o">+</span>
                           <span class="sa">f</span><span class="s2">&quot;user: </span><span class="si">{</span><span class="n">tier_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="o">+</span>
                           <span class="sa">f</span><span class="s2">&quot;system: </span><span class="si">{</span><span class="n">tier_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">section</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate deployed agent capabilities: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fallback_capabilities</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_discover_agents_from_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">discovered_agents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">tier</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover agents from a specific directory and add/override in discovered_agents.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agents_dir: Directory to search for agent .md files</span>
<span class="sd">            discovered_agents: Dictionary to update with discovered agents</span>
<span class="sd">            tier: The tier this directory represents (system/user/project)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span>
        
        <span class="n">agent_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">agent_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">agent_files</span><span class="p">):</span>
            <span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">stem</span>
            
            <span class="c1"># Skip pm.md if it exists (PM is not a deployable agent)</span>
            <span class="k">if</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pm&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Read agent content and extract metadata</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                
                <span class="c1"># Check for YAML frontmatter</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Specialized agent for delegation&quot;</span>
                
                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
                    <span class="c1"># Parse YAML frontmatter</span>
                    <span class="n">frontmatter_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^---\n(.*?)\n---&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">frontmatter_match</span><span class="p">:</span>
                        <span class="n">frontmatter</span> <span class="o">=</span> <span class="n">frontmatter_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># Extract name from frontmatter</span>
                        <span class="n">name_fm_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^name:\s*(.+)$&#39;</span><span class="p">,</span> <span class="n">frontmatter</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name_fm_match</span><span class="p">:</span>
                            <span class="n">name_value</span> <span class="o">=</span> <span class="n">name_fm_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="c1"># Format the name nicely</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">name_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                        
                        <span class="c1"># Extract description from frontmatter</span>
                        <span class="n">desc_fm_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^description:\s*(.+)$&#39;</span><span class="p">,</span> <span class="n">frontmatter</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">desc_fm_match</span><span class="p">:</span>
                            <span class="n">desc</span> <span class="o">=</span> <span class="n">desc_fm_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No frontmatter, extract from content</span>
                    <span class="n">name_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^#\s+(.+?)(?:\s+Agent)?$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name_match</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">name_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="c1"># Get first non-heading line after the title</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                            <span class="c1"># Found title, look for description after it</span>
                            <span class="k">for</span> <span class="n">desc_line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                                <span class="n">desc_line</span> <span class="o">=</span> <span class="n">desc_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">desc_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">desc_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                                    <span class="n">desc</span> <span class="o">=</span> <span class="n">desc_line</span>
                                    <span class="k">break</span>
                            <span class="k">break</span>
                
                <span class="c1"># Categorize based on agent name/type</span>
                <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_categorize_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                
                <span class="c1"># Add or override agent in discovered_agents</span>
                <span class="n">discovered_agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">150</span> <span class="k">else</span> <span class="n">desc</span><span class="p">,</span>
                    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                    <span class="s1">&#39;tier&#39;</span><span class="p">:</span> <span class="n">tier</span><span class="p">,</span>
                    <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent_file</span><span class="p">)</span>
                <span class="p">}</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered </span><span class="si">{</span><span class="n">tier</span><span class="si">}</span><span class="s2"> agent: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">agent_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse agent </span><span class="si">{</span><span class="n">agent_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_categorize_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Categorize an agent based on its ID and content.&quot;&quot;&quot;</span>
        <span class="n">agent_id_lower</span> <span class="o">=</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">content_lower</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;engineer&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;engineering&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Engineering&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;research&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;analysis&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span> <span class="ow">or</span> <span class="s1">&#39;analyzer&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Research&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;qa&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;quality&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span> <span class="ow">or</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Quality&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;security&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;security&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Security&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;doc&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;documentation&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Documentation&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Data&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;ops&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;deploy&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;operations&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Operations&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;version&#39;</span> <span class="ow">in</span> <span class="n">agent_id_lower</span> <span class="ow">or</span> <span class="s1">&#39;git&#39;</span> <span class="ow">in</span> <span class="n">content_lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Version Control&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;General&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_fallback_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return fallback agent capabilities when deployed agents can&#39;t be read.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">## Available Agent Capabilities</span>

<span class="s2">You have the following specialized agents available for delegation:</span>

<span class="s2">- **Engineer Agent**: Code implementation and development</span>
<span class="s2">- **Research Agent**: Investigation and analysis</span>
<span class="s2">- **QA Agent**: Testing and quality assurance</span>
<span class="s2">- **Documentation Agent**: Documentation creation and maintenance</span>
<span class="s2">- **Security Agent**: Security analysis and protection</span>
<span class="s2">- **Data Engineer Agent**: Data management and pipelines</span>
<span class="s2">- **Ops Agent**: Deployment and operations</span>
<span class="s2">- **Version Control Agent**: Git operations and version management</span>

<span class="s2">Use these agents to delegate specialized work via the Task tool.</span>
<span class="s2">&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_agent_capabilities_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate dynamic agent capabilities section from available agents.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agents</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Build capabilities section</span>
        <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## Available Agent Capabilities</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;You have the following specialized agents available for delegation:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># Group agents by category</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;general&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">categories</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
        
        <span class="c1"># List agents by category</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">### </span><span class="si">{</span><span class="n">category</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> Agents</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="n">category</span><span class="p">]):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;Specialized agent&#39;</span><span class="p">)</span>
                <span class="n">tools</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">** (`</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">`): </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - Tools: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (+</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="si">}</span><span class="s2"> more)&quot;</span>
                    <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># Add summary</span>
        <span class="n">section</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**Total Available Agents**: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">section</span> <span class="o">+=</span> <span class="s2">&quot;Use the agent ID in parentheses when delegating tasks via the Task tool.</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">return</span> <span class="n">section</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the complete system prompt including instructions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_instructions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to basic context</span>
            <span class="k">return</span> <span class="n">create_simple_context</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_contains_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if text contains signs of agent delegation.&quot;&quot;&quot;</span>
        <span class="c1"># Look for common delegation patterns</span>
        <span class="n">delegation_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Task(&quot;</span><span class="p">,</span>
            <span class="s2">&quot;subagent_type=&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delegating to&quot;</span><span class="p">,</span>
            <span class="s2">&quot;asking the&quot;</span><span class="p">,</span>
            <span class="s2">&quot;engineer agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;qa agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;documentation agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;research agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;security agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ops agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version_control agent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_engineer agent&quot;</span>
        <span class="p">]</span>
        
        <span class="n">text_lower</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">text_lower</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">delegation_patterns</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_agent_from_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to extract agent name from delegation response.&quot;&quot;&quot;</span>
        <span class="c1"># Look for common patterns</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        
        <span class="c1"># Pattern 1: subagent_type=&quot;agent_name&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;subagent_type=[&quot;</span><span class="se">\&#39;</span><span class="s1">]([^&quot;</span><span class="se">\&#39;</span><span class="s1">]*)[&quot;</span><span class="se">\&#39;</span><span class="s1">\)]&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Pattern 2: &quot;engineer agent&quot; etc</span>
        <span class="n">agent_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;engineer&quot;</span><span class="p">,</span> <span class="s2">&quot;qa&quot;</span><span class="p">,</span> <span class="s2">&quot;documentation&quot;</span><span class="p">,</span> <span class="s2">&quot;research&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;security&quot;</span><span class="p">,</span> <span class="s2">&quot;ops&quot;</span><span class="p">,</span> <span class="s2">&quot;version_control&quot;</span><span class="p">,</span> <span class="s2">&quot;data_engineer&quot;</span>
        <span class="p">]</span>
        <span class="n">text_lower</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agent_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2"> agent&quot;</span> <span class="ow">in</span> <span class="n">text_lower</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;agent: </span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">text_lower</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">agent</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_mpm_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle /mpm: commands directly without going to Claude.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract command and arguments</span>
            <span class="n">command_line</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Remove &quot;/mpm:&quot;</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">command_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No command specified. Available commands: test&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            
            <span class="n">command</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            
            <span class="c1"># Handle commands</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                        <span class="s2">&quot;Executed /mpm:test command&quot;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                        <span class="n">component</span><span class="o">=</span><span class="s2">&quot;command&quot;</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;agents&quot;</span><span class="p">:</span>
                <span class="c1"># Handle agents command - display deployed agent versions</span>
                <span class="c1"># WHY: This provides users with a quick way to check deployed agent versions</span>
                <span class="c1"># directly from within Claude Code, maintaining consistency with CLI behavior</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">_get_agent_versions_display</span>
                    <span class="n">agent_versions</span> <span class="o">=</span> <span class="n">_get_agent_versions_display</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">agent_versions</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">agent_versions</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No deployed agents found&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">To deploy agents, run: claude-mpm --mpm:agents deploy&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                            <span class="s2">&quot;Executed /mpm:agents command&quot;</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                            <span class="n">component</span><span class="o">=</span><span class="s2">&quot;command&quot;</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: CLI module not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting agent versions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available commands: test, agents&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
                
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Command interrupted&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to execute /mpm: command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;command&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_log_session_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log an event to the session log file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_log_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="o">**</span><span class="n">event_data</span>
                <span class="p">}</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IO error logging session event: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to log session event: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Robust version determination with multiple fallback mechanisms.</span>
<span class="sd">        </span>
<span class="sd">        WHY: The version display is critical for debugging and user experience.</span>
<span class="sd">        This implementation ensures we always show the correct version rather than </span>
<span class="sd">        defaulting to v0.0.0, even in edge cases where imports might fail.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We try multiple methods in order of preference:</span>
<span class="sd">        1. Package import (__version__) - fastest for normal installations</span>
<span class="sd">        2. importlib.metadata - standard for installed packages  </span>
<span class="sd">        3. VERSION file reading - fallback for development environments</span>
<span class="sd">        4. Only then default to v0.0.0 with detailed error logging</span>
<span class="sd">        </span>
<span class="sd">        Returns version string formatted as &quot;vX.Y.Z&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>
        <span class="n">method_used</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
        
        <span class="c1"># Method 1: Try package import (fastest, most common)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">__version__</span>
            <span class="n">method_used</span> <span class="o">=</span> <span class="s2">&quot;package_import&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version obtained via package import: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package import failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in package import: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Method 2: Try importlib.metadata (standard for installed packages)</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">importlib.metadata</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s1">&#39;claude-mpm&#39;</span><span class="p">)</span>
                <span class="n">method_used</span> <span class="o">=</span> <span class="s2">&quot;importlib_metadata&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version obtained via importlib.metadata: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Package not found in importlib.metadata (likely development install)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;importlib.metadata not available (Python &lt; 3.8)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in importlib.metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Method 3: Try reading VERSION file directly (development fallback)</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use centralized path management for VERSION file</span>
                <span class="k">if</span> <span class="n">paths</span><span class="o">.</span><span class="n">version_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">version_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">method_used</span> <span class="o">=</span> <span class="s2">&quot;version_file&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version obtained via VERSION file: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VERSION file not found at: </span><span class="si">{</span><span class="n">paths</span><span class="o">.</span><span class="n">version_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read VERSION file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Log final result</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;All version detection methods failed. This indicates a packaging or installation issue.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final version: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> (method: </span><span class="si">{</span><span class="n">method_used</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_register_memory_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register memory integration hooks with the hook service.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This activates the memory system by registering hooks that automatically</span>
<span class="sd">        inject agent memory before delegation and extract learnings after delegation.</span>
<span class="sd">        This is the critical connection point between the memory system and the CLI.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We register hooks here instead of in __init__ to ensure</span>
<span class="sd">        all services are initialized first. Hooks are only registered if the memory</span>
<span class="sd">        system is enabled in configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Only register if memory system is enabled</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.enabled&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Memory system disabled - skipping hook registration&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Import hook classes (lazy import to avoid circular dependencies)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.hooks.memory_integration_hook</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">MemoryPreDelegationHook</span><span class="p">,</span>
                    <span class="n">MemoryPostDelegationHook</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory integration hooks not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Register pre-delegation hook for memory injection</span>
            <span class="n">pre_hook</span> <span class="o">=</span> <span class="n">MemoryPreDelegationHook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_service</span><span class="o">.</span><span class="n">register_hook</span><span class="p">(</span><span class="n">pre_hook</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Registered memory pre-delegation hook (priority: </span><span class="si">{</span><span class="n">pre_hook</span><span class="o">.</span><span class="n">priority</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;❌ Failed to register memory pre-delegation hook&quot;</span><span class="p">)</span>
            
            <span class="c1"># Register post-delegation hook if auto-learning is enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.auto_learning&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>  <span class="c1"># Default to True now</span>
                <span class="n">post_hook</span> <span class="o">=</span> <span class="n">MemoryPostDelegationHook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_service</span><span class="o">.</span><span class="n">register_hook</span><span class="p">(</span><span class="n">post_hook</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Registered memory post-delegation hook (priority: </span><span class="si">{</span><span class="n">post_hook</span><span class="o">.</span><span class="n">priority</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;❌ Failed to register memory post-delegation hook&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ℹ️  Auto-learning disabled - skipping post-delegation hook&quot;</span><span class="p">)</span>
            
            <span class="c1"># Log summary of registered hooks</span>
            <span class="n">hooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_service</span><span class="o">.</span><span class="n">list_hooks</span><span class="p">()</span>
            <span class="n">pre_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hooks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pre_delegation&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">post_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hooks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post_delegation&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 Hook Service initialized: </span><span class="si">{</span><span class="n">pre_count</span><span class="si">}</span><span class="s2"> pre-delegation, </span><span class="si">{</span><span class="n">post_count</span><span class="si">}</span><span class="s2"> post-delegation hooks&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook service not initialized properly: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Failed to register memory hooks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Don&#39;t fail the entire initialization - memory system is optional</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_launch_subprocess_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Launch Claude as a subprocess with PTY for interactive mode.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This method launches Claude as a subprocess when explicitly requested</span>
<span class="sd">        (via --launch-method subprocess). Subprocess mode maintains the parent process,</span>
<span class="sd">        which can be useful for:</span>
<span class="sd">        1. Maintaining WebSocket connections and monitoring</span>
<span class="sd">        2. Providing proper cleanup and error handling</span>
<span class="sd">        3. Debugging and development scenarios</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We use PTY (pseudo-terminal) to maintain full interactive</span>
<span class="sd">        capabilities. Response logging is handled through the hook system, not I/O</span>
<span class="sd">        interception, for better performance and compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pty</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">select</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">termios</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tty</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
        
        <span class="c1"># Note: Response logging is handled through the hook system,</span>
        <span class="c1"># not through I/O interception (better performance)</span>
        
        <span class="c1"># Save original terminal settings</span>
        <span class="n">original_tty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
            <span class="n">original_tty</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        
        <span class="c1"># Create PTY</span>
        <span class="n">master_fd</span><span class="p">,</span> <span class="n">slave_fd</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start Claude process</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">slave_fd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">slave_fd</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">slave_fd</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span>
            <span class="p">)</span>
            
            <span class="c1"># Close slave in parent</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">slave_fd</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Claude subprocess started with PID </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;subprocess&quot;</span>
                <span class="p">)</span>
            
            <span class="c1"># Notify WebSocket clients</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="o">.</span><span class="n">claude_status_changed</span><span class="p">(</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;running&quot;</span><span class="p">,</span>
                    <span class="n">pid</span><span class="o">=</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Claude subprocess started&quot;</span>
                <span class="p">)</span>
            
            <span class="c1"># Set terminal to raw mode for proper interaction</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                <span class="n">tty</span><span class="o">.</span><span class="n">setraw</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
            
            <span class="c1"># Handle Ctrl+C gracefully</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">()</span>
            
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
            
            <span class="c1"># I/O loop</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Check if process is still running</span>
                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="c1"># Check for data from Claude or stdin</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">master_fd</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">master_fd</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">master_fd</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
                            <span class="c1"># Broadcast output to WebSocket clients</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Decode and send</span>
                                    <span class="n">output</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="o">.</span><span class="n">claude_output</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to broadcast output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>  <span class="c1"># EOF</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">break</span>
                
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">4096</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">master_fd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">break</span>
            
            <span class="c1"># Wait for process to complete</span>
            <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            
            <span class="c1"># Note: Response logging is handled through the hook system</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_logger</span><span class="o">.</span><span class="n">log_system</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Claude subprocess exited with code </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
                    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;subprocess&quot;</span>
                <span class="p">)</span>
            
            <span class="c1"># Notify WebSocket clients</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="o">.</span><span class="n">claude_status_changed</span><span class="p">(</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;stopped&quot;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Claude subprocess exited with code </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Restore terminal</span>
            <span class="k">if</span> <span class="n">original_tty</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSADRAIN</span><span class="p">,</span> <span class="n">original_tty</span><span class="p">)</span>
            
            <span class="c1"># Close PTY</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">master_fd</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            
            <span class="c1"># Ensure process is terminated</span>
            <span class="k">if</span> <span class="s1">&#39;process&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            
            <span class="c1"># End WebSocket session if in subprocess mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">websocket_server</span><span class="o">.</span><span class="n">session_ended</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_simple_context">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.create_simple_context">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_simple_context</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create basic context for Claude.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;You are Claude Code running in Claude MPM (Multi-Agent Project Manager).</span>

<span class="s2">You have access to native subagents via the Task tool with subagent_type parameter:</span>
<span class="s2">- engineer: For coding, implementation, and technical tasks</span>
<span class="s2">- qa: For testing, validation, and quality assurance  </span>
<span class="s2">- documentation: For docs, guides, and explanations</span>
<span class="s2">- research: For investigation and analysis</span>
<span class="s2">- security: For security-related tasks</span>
<span class="s2">- ops: For deployment and infrastructure</span>
<span class="s2">- version-control: For git and version management</span>
<span class="s2">- data-engineer: For data processing and APIs</span>

<span class="s2">Use these agents by calling: Task(description=&quot;task description&quot;, subagent_type=&quot;agent_name&quot;)</span>

<span class="s2">IMPORTANT: The Task tool accepts both naming formats:</span>
<span class="s2">- Capitalized format: &quot;Research&quot;, &quot;Engineer&quot;, &quot;QA&quot;, &quot;Version Control&quot;, &quot;Data Engineer&quot;</span>
<span class="s2">- Lowercase format: &quot;research&quot;, &quot;engineer&quot;, &quot;qa&quot;, &quot;version-control&quot;, &quot;data-engineer&quot;</span>

<span class="s2">Both formats work correctly. When you see capitalized names (matching TodoWrite prefixes), </span>
<span class="s2">automatically normalize them to lowercase-hyphenated format for the Task tool.</span>

<span class="s2">Work efficiently and delegate appropriately to subagents when needed.&quot;&quot;&quot;</span></div>



<span class="c1"># Backward compatibility alias</span>
<span class="n">SimpleClaudeRunner</span> <span class="o">=</span> <span class="n">ClaudeRunner</span>


<span class="c1"># Convenience functions for backward compatibility</span>
<div class="viewcode-block" id="run_claude_interactive">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.run_claude_interactive">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_claude_interactive</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run Claude interactively with optional context.&quot;&quot;&quot;</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">ClaudeRunner</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">create_simple_context</span><span class="p">()</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run_interactive</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></div>



<div class="viewcode-block" id="run_claude_oneshot">
<a class="viewcode-back" href="../../../claude_mpm.core.claude_runner.html#claude_mpm.run_claude_oneshot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_claude_oneshot</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run Claude with a single prompt.&quot;&quot;&quot;</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">ClaudeRunner</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">create_simple_context</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_oneshot</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>