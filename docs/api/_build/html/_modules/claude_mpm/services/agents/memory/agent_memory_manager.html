

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.services.agents.memory.agent_memory_manager &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../services.html">claude_mpm.services</a></li>
      <li class="breadcrumb-item active">claude_mpm.services.agents.memory.agent_memory_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.services.agents.memory.agent_memory_manager</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Agent Memory Manager Service</span>
<span class="sd">===========================</span>

<span class="sd">Manages agent memory files with size limits and validation.</span>

<span class="sd">This service provides:</span>
<span class="sd">- Memory file operations (load, save, validate)</span>
<span class="sd">- Size limit enforcement (8KB default)</span>
<span class="sd">- Auto-truncation when limits exceeded</span>
<span class="sd">- Default memory template creation</span>
<span class="sd">- Section management with item limits</span>
<span class="sd">- Timestamp updates</span>
<span class="sd">- Directory initialization with README</span>

<span class="sd">Memory files are stored in .claude-mpm/memories/ directory</span>
<span class="sd">following the naming convention: {agent_id}_agent.md</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.utils.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.project_analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProjectAnalyzer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemoryServiceInterface</span>
<span class="c1"># Socket.IO notifications are optional - we&#39;ll skip them if server is not available</span>


<div class="viewcode-block" id="AgentMemoryManager">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentMemoryManager</span><span class="p">(</span><span class="n">MemoryServiceInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages agent memory files with size limits and validation.</span>
<span class="sd">    </span>
<span class="sd">    WHY: Agents need to accumulate project-specific knowledge over time to become</span>
<span class="sd">    more effective. This service manages persistent memory files that agents can</span>
<span class="sd">    read before tasks and update with new learnings.</span>
<span class="sd">    </span>
<span class="sd">    DESIGN DECISION: Memory files are stored in .claude-mpm/memories/ (not project root)</span>
<span class="sd">    to keep them organized and separate from other project files. Files follow a</span>
<span class="sd">    standardized markdown format with enforced size limits to prevent unbounded growth.</span>
<span class="sd">    </span>
<span class="sd">    The 8KB limit (~2000 tokens) balances comprehensive knowledge storage with</span>
<span class="sd">    reasonable context size for agent prompts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Default limits - will be overridden by configuration</span>
    <span class="n">DEFAULT_MEMORY_LIMITS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s1">&#39;max_sections&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;max_items_per_section&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;max_line_length&#39;</span><span class="p">:</span> <span class="mi">120</span>
    <span class="p">}</span>
    
    <span class="n">REQUIRED_SECTIONS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Project Architecture&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Implementation Guidelines&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Common Mistakes to Avoid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Current Technical Context&#39;</span>
    <span class="p">]</span>
    
<div class="viewcode-block" id="AgentMemoryManager.__init__">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the memory manager.</span>
<span class="sd">        </span>
<span class="sd">        Sets up the memories directory and ensures it exists with proper README.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config: Optional Config object. If not provided, will create default Config.</span>
<span class="sd">            working_directory: Optional working directory. If not provided, uses current working directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize logger using the same pattern as LoggerMixin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">Config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_root</span> <span class="o">=</span> <span class="n">PathResolver</span><span class="o">.</span><span class="n">get_project_root</span><span class="p">()</span>
        <span class="c1"># Use current working directory by default, not project root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">working_directory</span> <span class="ow">or</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;.claude-mpm&quot;</span> <span class="o">/</span> <span class="s2">&quot;memories&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_memories_directory</span><span class="p">()</span>
        
        <span class="c1"># Initialize memory limits from configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_memory_limits</span><span class="p">()</span>
        
        <span class="c1"># Initialize project analyzer for context-aware memory creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_analyzer</span> <span class="o">=</span> <span class="n">ProjectAnalyzer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span></div>

    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create the logger instance (like LoggerMixin).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">:</span>
                <span class="n">logger_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                
                <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">module</span> <span class="o">!=</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                    <span class="n">logger_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger_name</span> <span class="o">=</span> <span class="n">class_name</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger_instance</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_instance</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_init_memory_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize memory limits from configuration.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Allows configuration-driven memory limits instead of hardcoded values.</span>
<span class="sd">        Supports agent-specific overrides for different memory requirements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if memory system is enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.enabled&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_learning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.auto_learning&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># Changed default to True</span>
        
        <span class="c1"># Load default limits from configuration</span>
        <span class="n">config_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.limits&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">:</span> <span class="n">config_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_size_kb&#39;</span><span class="p">,</span> 
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MEMORY_LIMITS</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;max_sections&#39;</span><span class="p">:</span> <span class="n">config_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_sections&#39;</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MEMORY_LIMITS</span><span class="p">[</span><span class="s1">&#39;max_sections&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;max_items_per_section&#39;</span><span class="p">:</span> <span class="n">config_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_items_per_section&#39;</span><span class="p">,</span> 
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MEMORY_LIMITS</span><span class="p">[</span><span class="s1">&#39;max_items_per_section&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;max_line_length&#39;</span><span class="p">:</span> <span class="n">config_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_line_length&#39;</span><span class="p">,</span> 
                                               <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_MEMORY_LIMITS</span><span class="p">[</span><span class="s1">&#39;max_line_length&#39;</span><span class="p">])</span>
        <span class="p">}</span>
        
        <span class="c1"># Load agent-specific overrides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_overrides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.agent_overrides&#39;</span><span class="p">,</span> <span class="p">{})</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get memory limits for specific agent, including overrides.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Different agents may need different memory capacities. Research agents</span>
<span class="sd">        might need larger memory for comprehensive findings, while simple agents</span>
<span class="sd">        can work with smaller limits.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing the effective limits for this agent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start with default limits</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Apply agent-specific overrides if they exist</span>
        <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_overrides</span><span class="p">:</span>
            <span class="n">overrides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_overrides</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;size_kb&#39;</span> <span class="ow">in</span> <span class="n">overrides</span><span class="p">:</span>
                <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overrides</span><span class="p">[</span><span class="s1">&#39;size_kb&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">limits</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_auto_learning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if auto-learning is enabled for specific agent.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if auto-learning is enabled for this agent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check agent-specific override first</span>
        <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_overrides</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_overrides</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_learning&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_learning</span><span class="p">)</span>
        
        <span class="c1"># Fall back to global setting</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_learning</span>
    
<div class="viewcode-block" id="AgentMemoryManager.load_agent_memory">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.load_agent_memory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_agent_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load agent memory file content.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Agents need to read their accumulated knowledge before starting tasks</span>
<span class="sd">        to apply learned patterns and avoid repeated mistakes.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier (e.g., &#39;research&#39;, &#39;engineer&#39;)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The memory file content, creating default if doesn&#39;t exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">memory_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">_agent.md&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">memory_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating default memory for agent: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">memory_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            
            <span class="c1"># Socket.IO notifications removed - memory manager works independently</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_repair</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading memory file for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Return default memory on error - never fail</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.update_agent_memory">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.update_agent_memory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_agent_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new learning item to specified section.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Agents discover new patterns and insights during task execution that</span>
<span class="sd">        should be preserved for future tasks. This method adds new learnings while</span>
<span class="sd">        enforcing size limits to prevent unbounded growth.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier</span>
<span class="sd">            section: The section name to add the item to</span>
<span class="sd">            new_item: The learning item to add</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if update succeeded, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_agent_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
            <span class="n">updated_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_item_to_section</span><span class="p">(</span><span class="n">current_memory</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">new_item</span><span class="p">)</span>
            
            <span class="c1"># Enforce limits</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exceeds_limits</span><span class="p">(</span><span class="n">updated_memory</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> exceeds limits, truncating&quot;</span><span class="p">)</span>
                <span class="n">updated_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_to_limits</span><span class="p">(</span><span class="n">updated_memory</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">)</span>
            
            <span class="c1"># Save with timestamp</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_memory_file</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">updated_memory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Never fail on memory errors</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.add_learning">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.add_learning">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_learning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">learning_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add structured learning to appropriate section.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Different types of learnings belong in different sections for better</span>
<span class="sd">        organization and retrieval. This method maps learning types to appropriate</span>
<span class="sd">        sections automatically.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier</span>
<span class="sd">            learning_type: Type of learning (pattern, architecture, guideline, etc.)</span>
<span class="sd">            content: The learning content</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if learning was added successfully</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">section_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;Coding Patterns Learned&#39;</span><span class="p">,</span>
            <span class="s1">&#39;architecture&#39;</span><span class="p">:</span> <span class="s1">&#39;Project Architecture&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;guideline&#39;</span><span class="p">:</span> <span class="s1">&#39;Implementation Guidelines&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mistake&#39;</span><span class="p">:</span> <span class="s1">&#39;Common Mistakes to Avoid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Effective Strategies&#39;</span><span class="p">,</span>
            <span class="s1">&#39;integration&#39;</span><span class="p">:</span> <span class="s1">&#39;Integration Points&#39;</span><span class="p">,</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="s1">&#39;Performance Considerations&#39;</span><span class="p">,</span>
            <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="s1">&#39;Domain-Specific Knowledge&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="s1">&#39;Current Technical Context&#39;</span>
        <span class="p">}</span>
        
        <span class="n">section</span> <span class="o">=</span> <span class="n">section_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">learning_type</span><span class="p">,</span> <span class="s1">&#39;Recent Learnings&#39;</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_agent_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        
        <span class="c1"># Socket.IO notifications removed - memory manager works independently</span>
        
        <span class="k">return</span> <span class="n">success</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create project-specific default memory file for agent.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Instead of generic templates, agents need project-specific knowledge</span>
<span class="sd">        from the start. This analyzes the current project and creates contextual</span>
<span class="sd">        memories with actual project characteristics.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: The project-specific memory template content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert agent_id to proper name, handling cases like &quot;test_agent&quot; -&gt; &quot;Test&quot;</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get limits for this agent</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_limits</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        
        <span class="c1"># Analyze the project for context-specific content</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project_characteristics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_analyzer</span><span class="o">.</span><span class="n">analyze_project</span><span class="p">()</span>
            <span class="n">project_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_analyzer</span><span class="o">.</span><span class="n">get_project_context_summary</span><span class="p">()</span>
            <span class="n">important_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_analyzer</span><span class="o">.</span><span class="n">get_important_files_for_context</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating project-specific memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> using analyzed project context&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error analyzing project for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">, falling back to basic template: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_basic_memory_template</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        
        <span class="c1"># Create project-specific sections</span>
        <span class="n">architecture_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_architecture_section</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">)</span>
        <span class="n">coding_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_coding_patterns_section</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">)</span>
        <span class="n">implementation_guidelines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_implementation_guidelines</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">)</span>
        <span class="n">tech_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_technical_context</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">)</span>
        <span class="n">integration_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_integration_points</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">)</span>
        
        <span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;# </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> Agent Memory - </span><span class="si">{</span><span class="n">project_characteristics</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span>

<span class="s2">&lt;!-- MEMORY LIMITS: </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">KB max | </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_sections&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> sections max | </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_items_per_section&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> items per section --&gt;</span>
<span class="s2">&lt;!-- Last Updated: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> | Auto-updated by: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> --&gt;</span>

<span class="s2">## Project Context</span>
<span class="si">{</span><span class="n">project_context</span><span class="si">}</span>

<span class="s2">## Project Architecture</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="n">architecture_items</span><span class="p">)</span><span class="si">}</span>

<span class="s2">## Coding Patterns Learned</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="n">coding_patterns</span><span class="p">)</span><span class="si">}</span>

<span class="s2">## Implementation Guidelines</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="n">implementation_guidelines</span><span class="p">)</span><span class="si">}</span>

<span class="s2">## Domain-Specific Knowledge</span>
<span class="s2">&lt;!-- Agent-specific knowledge for </span><span class="si">{</span><span class="n">project_characteristics</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2"> domain --&gt;</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_domain_knowledge_starters</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">,</span><span class="w"> </span><span class="n">agent_id</span><span class="p">)</span><span class="si">}</span>

<span class="s2">## Effective Strategies</span>
<span class="s2">&lt;!-- Successful approaches discovered through experience --&gt;</span>

<span class="s2">## Common Mistakes to Avoid</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_common_mistakes</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">))</span><span class="si">}</span>

<span class="s2">## Integration Points</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="n">integration_points</span><span class="p">)</span><span class="si">}</span>

<span class="s2">## Performance Considerations</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_performance_considerations</span><span class="p">(</span><span class="n">project_characteristics</span><span class="p">))</span><span class="si">}</span>

<span class="s2">## Current Technical Context</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_section_items</span><span class="p">(</span><span class="n">tech_context</span><span class="p">)</span><span class="si">}</span>

<span class="s2">## Recent Learnings</span>
<span class="s2">&lt;!-- Most recent discoveries and insights --&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="c1"># Save default file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memory_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">_agent.md&quot;</span>
            <span class="n">memory_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created project-specific memory file for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving default memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">template</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_basic_memory_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create basic memory template when project analysis fails.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Fallback template ensures agents always get some memory structure</span>
<span class="sd">        even if project analysis encounters errors.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: The agent identifier</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Basic memory template</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agent_name</span> <span class="o">=</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_root</span><span class="o">.</span><span class="n">name</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_limits</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;# </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> Agent Memory - </span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span>

<span class="s2">&lt;!-- MEMORY LIMITS: </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">KB max | </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_sections&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> sections max | </span><span class="si">{</span><span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_items_per_section&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> items per section --&gt;</span>
<span class="s2">&lt;!-- Last Updated: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> | Auto-updated by: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> --&gt;</span>

<span class="s2">## Project Context</span>
<span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">: Software project requiring analysis</span>

<span class="s2">## Project Architecture</span>
<span class="s2">- Analyze project structure to understand architecture patterns</span>

<span class="s2">## Coding Patterns Learned</span>
<span class="s2">- Observe codebase patterns and conventions during tasks</span>

<span class="s2">## Implementation Guidelines</span>
<span class="s2">- Extract implementation guidelines from project documentation</span>

<span class="s2">## Domain-Specific Knowledge</span>
<span class="s2">&lt;!-- Agent-specific knowledge accumulates here --&gt;</span>

<span class="s2">## Effective Strategies</span>
<span class="s2">&lt;!-- Successful approaches discovered through experience --&gt;</span>

<span class="s2">## Common Mistakes to Avoid</span>
<span class="s2">- Learn from errors encountered during project work</span>

<span class="s2">## Integration Points</span>
<span class="s2">&lt;!-- Key interfaces and integration patterns --&gt;</span>

<span class="s2">## Performance Considerations</span>
<span class="s2">&lt;!-- Performance insights and optimization patterns --&gt;</span>

<span class="s2">## Current Technical Context</span>
<span class="s2">- Project analysis pending - gather context during tasks</span>

<span class="s2">## Recent Learnings</span>
<span class="s2">&lt;!-- Most recent discoveries and insights --&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_architecture_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate architecture section items based on project analysis.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Architecture type</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">characteristics</span><span class="o">.</span><span class="n">architecture_type</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;mixed&#39;</span><span class="si">}</span><span class="s2"> implementation&quot;</span><span class="p">)</span>
        
        <span class="c1"># Key directories structure</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">key_directories</span><span class="p">:</span>
            <span class="n">key_dirs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">key_directories</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main directories: </span><span class="si">{</span><span class="n">key_dirs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Main modules</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">main_modules</span><span class="p">:</span>
            <span class="n">modules</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">main_modules</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Core modules: </span><span class="si">{</span><span class="n">modules</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Entry points</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">entry_points</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">entry_points</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entry points: </span><span class="si">{</span><span class="n">entries</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Frameworks affecting architecture</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">:</span>
            <span class="n">frameworks</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Web framework stack: </span><span class="si">{</span><span class="n">frameworks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>  <span class="c1"># Limit to prevent overwhelming</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_coding_patterns_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate coding patterns section based on project analysis.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Language-specific patterns</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Python project: use type hints, follow PEP 8 conventions&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;django&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">]:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Django patterns: models, views, templates separation&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;flask&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">]:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Flask patterns: blueprint organization, app factory pattern&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">==</span> <span class="s1">&#39;node_js&#39;</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Node.js project: use async/await, ES6+ features&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;express&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">]:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Express patterns: middleware usage, route organization&quot;</span><span class="p">)</span>
        
        <span class="c1"># Framework-specific patterns</span>
        <span class="k">for</span> <span class="n">framework</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">frameworks</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;react&#39;</span> <span class="ow">in</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;React patterns: component composition, hooks usage&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;vue&#39;</span> <span class="ow">in</span> <span class="n">framework</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Vue patterns: single file components, composition API&quot;</span><span class="p">)</span>
        
        <span class="c1"># Code conventions found</span>
        <span class="k">for</span> <span class="n">convention</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">code_conventions</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project uses: </span><span class="si">{</span><span class="n">convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_implementation_guidelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate implementation guidelines based on project analysis.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Package manager guidance</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">package_manager</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="n">characteristics</span><span class="o">.</span><span class="n">package_manager</span><span class="si">}</span><span class="s2"> for dependency management&quot;</span><span class="p">)</span>
        
        <span class="c1"># Testing guidelines</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">testing_framework</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Write tests using </span><span class="si">{</span><span class="n">characteristics</span><span class="o">.</span><span class="n">testing_framework</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Test patterns</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">test_patterns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Follow </span><span class="si">{</span><span class="n">pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Build tools</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">build_tools</span><span class="p">:</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">build_tools</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use build tools: </span><span class="si">{</span><span class="n">tools</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Configuration patterns</span>
        <span class="k">for</span> <span class="n">config_pattern</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">configuration_patterns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration: </span><span class="si">{</span><span class="n">config_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Important files to reference</span>
        <span class="n">important_configs</span> <span class="o">=</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">important_configs</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">important_configs</span><span class="p">:</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">important_configs</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key config files: </span><span class="si">{</span><span class="n">configs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_technical_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate current technical context based on project analysis.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Technology stack summary</span>
        <span class="n">tech_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span><span class="p">:</span>
            <span class="n">tech_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span><span class="p">)</span>
        <span class="n">tech_stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">frameworks</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">tech_stack</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tech stack: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tech_stack</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Databases in use</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">databases</span><span class="p">:</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">databases</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data storage: </span><span class="si">{</span><span class="n">dbs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># API patterns</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">api_patterns</span><span class="p">:</span>
            <span class="n">apis</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">api_patterns</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API patterns: </span><span class="si">{</span><span class="n">apis</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Key dependencies</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">key_dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">key_dependencies</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key dependencies: </span><span class="si">{</span><span class="n">deps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Documentation available</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">documentation_files</span><span class="p">:</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">documentation_files</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Documentation: </span><span class="si">{</span><span class="n">docs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_integration_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate integration points based on project analysis.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Database integrations</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">databases</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">db</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> database integration&quot;</span><span class="p">)</span>
        
        <span class="c1"># Web framework integrations</span>
        <span class="k">for</span> <span class="n">framework</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">framework</span><span class="si">}</span><span class="s2"> web framework integration&quot;</span><span class="p">)</span>
        
        <span class="c1"># API integrations</span>
        <span class="k">for</span> <span class="n">api_pattern</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">api_patterns</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_pattern</span><span class="si">}</span><span class="s2"> integration pattern&quot;</span><span class="p">)</span>
        
        <span class="c1"># Common integration patterns based on dependencies</span>
        <span class="n">integration_deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">key_dependencies</span> 
                          <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">dep</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="s1">&#39;rabbit&#39;</span><span class="p">,</span> <span class="s1">&#39;celery&#39;</span><span class="p">,</span> <span class="s1">&#39;kafka&#39;</span><span class="p">,</span> <span class="s1">&#39;docker&#39;</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">integration_deps</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dep</span><span class="si">}</span><span class="s2"> integration&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_common_mistakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate common mistakes based on project type and stack.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Language-specific mistakes</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Avoid circular imports - use late imports when needed&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Don&#39;t ignore virtual environment - always activate before work&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">==</span> <span class="s1">&#39;node_js&#39;</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Avoid callback hell - use async/await consistently&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Don&#39;t commit node_modules - ensure .gitignore is correct&quot;</span><span class="p">)</span>
        
        <span class="c1"># Framework-specific mistakes</span>
        <span class="k">if</span> <span class="s1">&#39;django&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Don&#39;t skip migrations - always create and apply them&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;flask&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Avoid app context issues - use proper application factory&quot;</span><span class="p">)</span>
        
        <span class="c1"># Database-specific mistakes</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">databases</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Don&#39;t ignore database transactions in multi-step operations&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Avoid N+1 queries - use proper joins or prefetching&quot;</span><span class="p">)</span>
        
        <span class="c1"># Testing mistakes</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">testing_framework</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Don&#39;t skip test isolation - ensure tests can run independently&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_performance_considerations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate performance considerations based on project stack.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Language-specific performance</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Use list comprehensions over loops where appropriate&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consider caching for expensive operations&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">primary_language</span> <span class="o">==</span> <span class="s1">&#39;node_js&#39;</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Leverage event loop - avoid blocking operations&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Use streams for large data processing&quot;</span><span class="p">)</span>
        
        <span class="c1"># Database performance</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">databases</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Index frequently queried columns&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Use connection pooling for database connections&quot;</span><span class="p">)</span>
        
        <span class="c1"># Web framework performance</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">web_frameworks</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Implement appropriate caching strategies&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Optimize static asset delivery&quot;</span><span class="p">)</span>
        
        <span class="c1"># Framework-specific performance</span>
        <span class="k">if</span> <span class="s1">&#39;react&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fw</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">frameworks</span><span class="p">]:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Use React.memo for expensive component renders&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">items</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_domain_knowledge_starters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristics</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate domain-specific knowledge starters based on project and agent type.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Project terminology</span>
        <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">project_terminology</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">characteristics</span><span class="o">.</span><span class="n">project_terminology</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Key project terms: </span><span class="si">{</span><span class="n">terms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Agent-specific starters</span>
        <span class="k">if</span> <span class="s1">&#39;research&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- Focus on code analysis, pattern discovery, and architectural insights&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">documentation_files</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- Prioritize documentation analysis for comprehensive understanding&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;engineer&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- Focus on implementation patterns, coding standards, and best practices&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">characteristics</span><span class="o">.</span><span class="n">testing_framework</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Ensure test coverage using </span><span class="si">{</span><span class="n">characteristics</span><span class="o">.</span><span class="n">testing_framework</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;pm&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;manager&#39;</span> <span class="ow">in</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- Focus on project coordination, task delegation, and progress tracking&quot;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- Monitor integration points and cross-component dependencies&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">if</span> <span class="n">items</span> <span class="k">else</span> <span class="s2">&quot;&lt;!-- Domain knowledge will accumulate here --&gt;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_section_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format list of items as markdown bullet points.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;!-- Items will be added as knowledge accumulates --&gt;&quot;</span>
        
        <span class="n">formatted_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="c1"># Ensure each item starts with a dash and is properly formatted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">formatted_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_items</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_item_to_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add item to specified section, respecting limits.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Each section has a maximum item limit to prevent information overload</span>
<span class="sd">        and maintain readability. When limits are reached, oldest items are removed</span>
<span class="sd">        to make room for new learnings (FIFO strategy).</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Current memory file content</span>
<span class="sd">            section: Section name to add item to</span>
<span class="sd">            new_item: Item to add</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Updated content with new item added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">section_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">section_end</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Find section boundaries</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;## </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">section_start</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">section_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">):</span>
                <span class="n">section_end</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">section_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Section doesn&#39;t exist, add it</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_new_section</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">new_item</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">section_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">section_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        
        <span class="c1"># Count existing items in section and find first item index</span>
        <span class="n">item_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_item_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">section_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">section_end</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">first_item_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">first_item_index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">item_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Check if we can add more items</span>
        <span class="k">if</span> <span class="n">item_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="p">[</span><span class="s1">&#39;max_items_per_section&#39;</span><span class="p">]:</span>
            <span class="c1"># Remove oldest item (first one) to make room</span>
            <span class="k">if</span> <span class="n">first_item_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">first_item_index</span><span class="p">)</span>
                <span class="n">section_end</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># Adjust section end after removal</span>
        
        <span class="c1"># Add new item (find insertion point after any comments)</span>
        <span class="n">insert_point</span> <span class="o">=</span> <span class="n">section_start</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">insert_point</span> <span class="o">&lt;</span> <span class="n">section_end</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="n">insert_point</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> 
            <span class="n">lines</span><span class="p">[</span><span class="n">insert_point</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">insert_point</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Ensure line length limit (account for &quot;- &quot; prefix)</span>
        <span class="n">max_item_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="p">[</span><span class="s1">&#39;max_line_length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>  <span class="c1"># Subtract 2 for &quot;- &quot; prefix</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_item_length</span><span class="p">:</span>
            <span class="n">new_item</span> <span class="o">=</span> <span class="n">new_item</span><span class="p">[:</span><span class="n">max_item_length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span>
        
        <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_point</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">new_item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Update timestamp</span>
        <span class="n">updated_content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_timestamp</span><span class="p">(</span><span class="n">updated_content</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_new_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new section with the given item.</span>
<span class="sd">        </span>
<span class="sd">        WHY: When agents discover learnings that don&#39;t fit existing sections,</span>
<span class="sd">        we need to create new sections dynamically while respecting the maximum</span>
<span class="sd">        section limit.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Current memory content</span>
<span class="sd">            section: New section name</span>
<span class="sd">            new_item: First item for the section</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Updated content with new section</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Count existing sections</span>
        <span class="n">section_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">section_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="p">[</span><span class="s1">&#39;max_sections&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum sections reached, cannot add &#39;</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="c1"># Try to add to Recent Learnings instead</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_item_to_section</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;Recent Learnings&#39;</span><span class="p">,</span> <span class="n">new_item</span><span class="p">)</span>
        
        <span class="c1"># Find insertion point (before Recent Learnings or at end)</span>
        <span class="n">insert_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## Recent Learnings&#39;</span><span class="p">):</span>
                <span class="n">insert_point</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        
        <span class="c1"># Insert new section</span>
        <span class="n">new_section</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;## </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;- </span><span class="si">{</span><span class="n">new_item</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_section</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_point</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_exceeds_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if content exceeds size limits.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Content to check</span>
<span class="sd">            agent_id: Optional agent ID for agent-specific limits</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if content exceeds limits</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get appropriate limits based on agent</span>
        <span class="k">if</span> <span class="n">agent_id</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_limits</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span>
            
        <span class="n">size_kb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span>
        <span class="k">return</span> <span class="n">size_kb</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_truncate_to_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Truncate content to fit within limits.</span>
<span class="sd">        </span>
<span class="sd">        WHY: When memory files exceed size limits, we need a strategy to reduce</span>
<span class="sd">        size while preserving the most important information. This implementation</span>
<span class="sd">        removes items from &quot;Recent Learnings&quot; first as they&#39;re typically less</span>
<span class="sd">        consolidated than other sections.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Content to truncate</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Truncated content within size limits</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get appropriate limits based on agent</span>
        <span class="k">if</span> <span class="n">agent_id</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_limits</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span>
            
        <span class="c1"># Strategy: Remove items from Recent Learnings first</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exceeds_limits</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">agent_id</span><span class="p">):</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># First try Recent Learnings</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## Recent Learnings&#39;</span><span class="p">):</span>
                    <span class="c1"># Find and remove first item in this section</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">):</span>
                            <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">):</span>
                            <span class="k">break</span>
                    <span class="k">break</span>
            
            <span class="c1"># If no Recent Learnings items, remove from other sections</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">removed</span><span class="p">:</span>
                <span class="c1"># Remove from sections in reverse order (bottom up)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">):</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            
            <span class="c1"># Safety: If nothing removed, truncate from end</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">removed</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the timestamp in the file header.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Content to update</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Content with updated timestamp</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;&lt;!-- Last Updated: .+ \| Auto-updated by: .+ --&gt;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;!-- Last Updated: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1"> | Auto-updated by: system --&gt;&#39;</span><span class="p">,</span>
            <span class="n">content</span>
        <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_and_repair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate memory file and repair if needed.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Memory files might be manually edited by developers or corrupted.</span>
<span class="sd">        This method ensures the file maintains required structure and sections.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Content to validate</span>
<span class="sd">            agent_id: Agent identifier</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Validated and repaired content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">existing_sections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="c1"># Find existing sections</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">):</span>
                <span class="n">section_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">existing_sections</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">section_name</span><span class="p">)</span>
        
        <span class="c1"># Check for required sections</span>
        <span class="n">missing_sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">required</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_SECTIONS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">required</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_sections</span><span class="p">:</span>
                <span class="n">missing_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">missing_sections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding missing sections to </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2"> memory: </span><span class="si">{</span><span class="n">missing_sections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Add missing sections before Recent Learnings</span>
            <span class="n">insert_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## Recent Learnings&#39;</span><span class="p">):</span>
                    <span class="n">insert_point</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>
            
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">missing_sections</span><span class="p">:</span>
                <span class="n">section_content</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;## </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;&lt;!-- Section added by repair --&gt;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;&#39;</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">section_content</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_point</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">insert_point</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">section_content</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_memory_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save memory content to file.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Memory updates need to be persisted atomically to prevent corruption</span>
<span class="sd">        and ensure learnings are preserved across agent invocations.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Agent identifier</span>
<span class="sd">            content: Content to save</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if save succeeded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memory_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">_agent.md&quot;</span>
            <span class="n">memory_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
<div class="viewcode-block" id="AgentMemoryManager.optimize_memory">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.optimize_memory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize agent memory by consolidating/cleaning memories.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Over time, memory files accumulate redundant or outdated information.</span>
<span class="sd">        This method delegates to the memory optimizer service to clean up and</span>
<span class="sd">        consolidate memories while preserving important information.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Optional specific agent ID. If None, optimizes all agents.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing optimization results and statistics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.memory.optimizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemoryOptimizer</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">MemoryOptimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">agent_id</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_agent_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimized memory for agent: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_all_memories</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optimized all agent memories&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error optimizing memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.build_memories_from_docs">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.build_memories_from_docs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_memories_from_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build agent memories from project documentation.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Project documentation contains valuable knowledge that should be</span>
<span class="sd">        extracted and assigned to appropriate agents for better context awareness.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            force_rebuild: If True, rebuilds even if docs haven&#39;t changed</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing build results and statistics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.memory.builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemoryBuilder</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">MemoryBuilder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">)</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_from_documentation</span><span class="p">(</span><span class="n">force_rebuild</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Built memories from documentation&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error building memories from docs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.route_memory_command">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.route_memory_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">route_memory_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Route memory command to appropriate agent via PM delegation.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Memory commands like &quot;remember this for next time&quot; need to be analyzed</span>
<span class="sd">        to determine which agent should store the information. This method provides</span>
<span class="sd">        routing logic for PM agent delegation.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: The content to be remembered</span>
<span class="sd">            context: Optional context for routing decisions</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing routing decision and reasoning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.memory.router</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemoryRouter</span>
            <span class="n">router</span> <span class="o">=</span> <span class="n">MemoryRouter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            
            <span class="n">routing_result</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">analyze_and_route</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Routed memory command: </span><span class="si">{</span><span class="n">routing_result</span><span class="p">[</span><span class="s1">&#39;target_agent&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">routing_result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error routing memory command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.get_memory_status">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.get_memory_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get comprehensive memory system status.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Provides detailed overview of memory system health, file sizes,</span>
<span class="sd">        optimization opportunities, and agent-specific statistics for monitoring</span>
<span class="sd">        and maintenance purposes.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing comprehensive memory system status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;system_enabled&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_enabled</span><span class="p">,</span>
                <span class="s2">&quot;auto_learning&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_learning</span><span class="p">,</span>
                <span class="s2">&quot;memory_directory&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="p">),</span>
                <span class="s2">&quot;total_agents&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;total_size_kb&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;optimization_opportunities&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;system_health&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">status</span><span class="p">[</span><span class="s2">&quot;system_health&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no_memory_dir&quot;</span>
                <span class="k">return</span> <span class="n">status</span>
            
            <span class="n">memory_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_agent.md&quot;</span><span class="p">))</span>
            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;total_agents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_files</span><span class="p">)</span>
            
            <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">memory_files</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
                <span class="n">size_kb</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="mi">1024</span>
                <span class="n">total_size</span> <span class="o">+=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span>
                
                <span class="n">agent_id</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_limits</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
                
                <span class="c1"># Analyze file content</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                    <span class="n">section_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">)])</span>
                    <span class="n">learning_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">)])</span>
                    
                    <span class="n">agent_status</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;size_kb&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">size_kb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s2">&quot;size_limit_kb&quot;</span><span class="p">:</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;size_utilization&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">size_kb</span> <span class="o">/</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                        <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="n">section_count</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">learning_count</span><span class="p">,</span>
                        <span class="s2">&quot;last_modified&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s2">&quot;auto_learning&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_auto_learning</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Check for optimization opportunities</span>
                    <span class="k">if</span> <span class="n">size_kb</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
                        <span class="n">status</span><span class="p">[</span><span class="s2">&quot;optimization_opportunities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: High memory usage (</span><span class="si">{</span><span class="n">size_kb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">KB)&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">section_count</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;max_sections&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
                        <span class="n">status</span><span class="p">[</span><span class="s2">&quot;optimization_opportunities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: Many sections (</span><span class="si">{</span><span class="n">section_count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    
                    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_status</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            
            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># Determine overall system health</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;optimization_opportunities&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">status</span><span class="p">[</span><span class="s2">&quot;system_health&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;needs_optimization&quot;</span>
            <span class="k">elif</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># More than 100KB total</span>
                <span class="n">status</span><span class="p">[</span><span class="s2">&quot;system_health&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;high_usage&quot;</span>
            
            <span class="k">return</span> <span class="n">status</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting memory status: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.cross_reference_memories">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.cross_reference_memories">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cross_reference_memories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find common patterns and cross-references across agent memories.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Different agents may have learned similar or related information.</span>
<span class="sd">        Cross-referencing helps identify knowledge gaps, redundancies, and</span>
<span class="sd">        opportunities for knowledge sharing between agents.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            query: Optional query to filter cross-references</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing cross-reference analysis results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cross_refs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;common_patterns&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;knowledge_gaps&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;redundancies&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;agent_correlations&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;query_matches&quot;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">query</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">cross_refs</span>
            
            <span class="n">memory_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_agent.md&quot;</span><span class="p">))</span>
            <span class="n">agent_memories</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># Load all agent memories</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">memory_files</span><span class="p">:</span>
                <span class="n">agent_id</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                    <span class="n">agent_memories</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            
            <span class="c1"># Find common patterns across agents</span>
            <span class="n">all_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">agent_lines</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">agent_memories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> 
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">)]</span>
                <span class="n">agent_lines</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span>
                <span class="n">all_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">line</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span>
            
            <span class="c1"># Look for similar content (basic similarity check)</span>
            <span class="n">line_counts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">all_lines</span><span class="p">:</span>
                <span class="c1"># Normalize line for comparison</span>
                <span class="n">normalized</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>  <span class="c1"># Only check substantial lines</span>
                    <span class="k">if</span> <span class="n">normalized</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_counts</span><span class="p">:</span>
                        <span class="n">line_counts</span><span class="p">[</span><span class="n">normalized</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">line_counts</span><span class="p">[</span><span class="n">normalized</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
            
            <span class="c1"># Find patterns appearing in multiple agents</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">agents</span> <span class="ow">in</span> <span class="n">line_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">agents</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Appears in multiple agents</span>
                    <span class="n">cross_refs</span><span class="p">[</span><span class="s2">&quot;common_patterns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">line</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">line</span><span class="p">,</span>
                        <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">agents</span><span class="p">)),</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span>
                    <span class="p">})</span>
            
            <span class="c1"># Query-specific matches</span>
            <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">agent_memories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">query_lower</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    
                    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                        <span class="n">cross_refs</span><span class="p">[</span><span class="s2">&quot;query_matches&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
                            <span class="s2">&quot;matches&quot;</span><span class="p">:</span> <span class="n">matches</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Limit to first 5 matches</span>
                        <span class="p">})</span>
            
            <span class="c1"># Calculate agent correlations (agents with similar knowledge domains)</span>
            <span class="k">for</span> <span class="n">agent_a</span> <span class="ow">in</span> <span class="n">agent_memories</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">agent_b</span> <span class="ow">in</span> <span class="n">agent_memories</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">agent_a</span> <span class="o">&lt;</span> <span class="n">agent_b</span><span class="p">:</span>  <span class="c1"># Avoid duplicates</span>
                        <span class="n">common_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span>
                            <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">agent_a</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">agent_b</span> <span class="ow">in</span> <span class="n">line</span>
                        <span class="p">])</span>
                        
                        <span class="k">if</span> <span class="n">common_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">correlation_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_a</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">agent_b</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">cross_refs</span><span class="p">[</span><span class="s2">&quot;agent_correlations&quot;</span><span class="p">][</span><span class="n">correlation_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_count</span>
            
            <span class="k">return</span> <span class="n">cross_refs</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cross-referencing memories: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>


<div class="viewcode-block" id="AgentMemoryManager.get_all_memories_raw">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.get_all_memories_raw">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_memories_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all agent memories in structured JSON format.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This provides programmatic access to all agent memories, allowing</span>
<span class="sd">        external tools, scripts, or APIs to retrieve and process the complete</span>
<span class="sd">        memory state of the system.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Returns structured data with metadata for each agent</span>
<span class="sd">        including file stats, sections, and parsed content. This enables both</span>
<span class="sd">        content access and system analysis.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing structured memory data for all agents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;total_agents&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;total_size_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>
            
            <span class="c1"># Ensure directory exists</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;total_agents&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;total_size_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No memory directory found&quot;</span>
                <span class="p">}</span>
            
            <span class="c1"># Find all agent memory files</span>
            <span class="n">memory_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_agent.md&quot;</span><span class="p">))</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_agents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_files</span><span class="p">)</span>
            
            <span class="c1"># Process each agent memory file</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">memory_files</span><span class="p">):</span>
                <span class="n">agent_id</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Get file stats</span>
                    <span class="n">stat</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
                    <span class="n">file_size</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_size_bytes&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">file_size</span>
                    
                    <span class="c1"># Load and parse memory content</span>
                    <span class="n">memory_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_agent_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">memory_content</span><span class="p">:</span>
                        <span class="n">sections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_memory_content_to_dict</span><span class="p">(</span><span class="n">memory_content</span><span class="p">)</span>
                        
                        <span class="c1"># Count total items across all sections</span>
                        <span class="n">total_items</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">sections</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        
                        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
                            <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="s2">&quot;file_size_bytes&quot;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
                            <span class="s2">&quot;file_size_kb&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="s2">&quot;last_modified&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                            <span class="s2">&quot;sections_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">),</span>
                            <span class="s2">&quot;total_items&quot;</span><span class="p">:</span> <span class="n">total_items</span><span class="p">,</span>
                            <span class="s2">&quot;auto_learning&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_auto_learning</span><span class="p">(</span><span class="n">agent_id</span><span class="p">),</span>
                            <span class="s2">&quot;size_limits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_limits</span><span class="p">(</span><span class="n">agent_id</span><span class="p">),</span>
                            <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="n">sections</span><span class="p">,</span>
                            <span class="s2">&quot;raw_content&quot;</span><span class="p">:</span> <span class="n">memory_content</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
                            <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                            <span class="s2">&quot;file_size_bytes&quot;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
                            <span class="s2">&quot;file_size_kb&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="s2">&quot;last_modified&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not load memory content&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">{},</span>
                            <span class="s2">&quot;raw_content&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                        <span class="p">}</span>
                        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing memory for agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
                        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">{},</span>
                        <span class="s2">&quot;raw_content&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                    <span class="p">}</span>
            
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;total_size_bytes&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting all memories raw: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_memory_content_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse memory content into structured dictionary format.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Provides consistent parsing of memory content into sections and items</span>
<span class="sd">        for both display and programmatic access. This ensures the same parsing</span>
<span class="sd">        logic is used across the system.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Raw memory file content</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict mapping section names to lists of items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">current_items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># Skip empty lines and header information</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Memory Usage&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## Memory Usage&#39;</span><span class="p">):</span>
                <span class="c1"># New section found</span>
                <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">current_items</span><span class="p">:</span>
                    <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_items</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                
                <span class="n">current_section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">current_items</span> <span class="o">=</span> <span class="p">[]</span>
                
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">current_section</span><span class="p">:</span>
                <span class="c1"># Item in current section</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Filter out very short items</span>
                    <span class="n">current_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="c1"># Add final section</span>
        <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">current_items</span><span class="p">:</span>
            <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_items</span>
        
        <span class="k">return</span> <span class="n">sections</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_memories_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure memories directory exists with README.</span>
<span class="sd">        </span>
<span class="sd">        WHY: The memories directory needs clear documentation so developers</span>
<span class="sd">        understand the purpose of these files and how to interact with them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensured memories directory exists: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">readme_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">/</span> <span class="s2">&quot;README.md&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">readme_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">readme_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Agent Memory System</span>

<span class="s2">## Purpose</span>
<span class="s2">Each agent maintains project-specific knowledge in these files. Agents read their memory file before tasks and update it when they learn something new.</span>

<span class="s2">## Manual Editing</span>
<span class="s2">Feel free to edit these files to:</span>
<span class="s2">- Add project-specific guidelines</span>
<span class="s2">- Remove outdated information  </span>
<span class="s2">- Reorganize for better clarity</span>
<span class="s2">- Add domain-specific knowledge</span>

<span class="s2">## Memory Limits</span>
<span class="s2">- Max file size: 8KB (~2000 tokens)</span>
<span class="s2">- Max sections: 10</span>
<span class="s2">- Max items per section: 15</span>
<span class="s2">- Files auto-truncate when limits exceeded</span>

<span class="s2">## File Format</span>
<span class="s2">Standard markdown with structured sections. Agents expect:</span>
<span class="s2">- Project Architecture</span>
<span class="s2">- Implementation Guidelines</span>
<span class="s2">- Common Mistakes to Avoid</span>
<span class="s2">- Current Technical Context</span>

<span class="s2">## How It Works</span>
<span class="s2">1. Agents read their memory file before starting tasks</span>
<span class="s2">2. Agents add learnings during or after task completion</span>
<span class="s2">3. Files automatically enforce size limits</span>
<span class="s2">4. Developers can manually edit for accuracy</span>

<span class="s2">## Memory File Lifecycle</span>
<span class="s2">- Created automatically when agent first runs</span>
<span class="s2">- Updated through hook system after delegations</span>
<span class="s2">- Manually editable by developers</span>
<span class="s2">- Version controlled with project</span>
<span class="s2">&quot;&quot;&quot;</span>
                <span class="n">readme_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">readme_content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created README.md in memories directory&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error ensuring memories directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Continue anyway - memory system should not block operations</span>
    
    <span class="c1"># ================================================================================</span>
    <span class="c1"># Interface Adapter Methods</span>
    <span class="c1"># ================================================================================</span>
    <span class="c1"># These methods adapt the existing implementation to comply with MemoryServiceInterface</span>
    
<div class="viewcode-block" id="AgentMemoryManager.load_memory">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.load_memory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load memory for a specific agent.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This adapter method provides interface compliance by wrapping</span>
<span class="sd">        the existing load_agent_memory method.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Identifier of the agent</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Memory content as string or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_agent_memory</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">content</span> <span class="k">if</span> <span class="n">content</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.save_memory">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.save_memory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save memory for a specific agent.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This adapter method provides interface compliance. The existing</span>
<span class="sd">        implementation uses update_agent_memory for modifications, so we</span>
<span class="sd">        implement a full save by writing directly to the file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Identifier of the agent</span>
<span class="sd">            content: Memory content to save</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if save successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memory_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">_agent.md&quot;</span>
            
            <span class="c1"># Validate size before saving</span>
            <span class="n">is_valid</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_memory_size</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory validation failed: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Write the content</span>
            <span class="n">memory_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved memory for agent </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save memory for </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.validate_memory_size">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.validate_memory_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_memory_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate memory content size and structure.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This adapter method provides interface compliance by implementing</span>
<span class="sd">        validation based on configured limits.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: Memory content to validate</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (is_valid, error_message)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check file size</span>
            <span class="n">size_kb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span>
            <span class="n">max_size_kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_file_size_kb&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">size_kb</span> <span class="o">&gt;</span> <span class="n">max_size_kb</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Memory size </span><span class="si">{</span><span class="n">size_kb</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">KB exceeds limit of </span><span class="si">{</span><span class="n">max_size_kb</span><span class="si">}</span><span class="s2">KB&quot;</span>
            
            <span class="c1"># Check section count</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^##\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="n">max_sections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_sections&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_sections</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Too many sections: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> (max </span><span class="si">{</span><span class="n">max_sections</span><span class="si">}</span><span class="s2">)&quot;</span>
            
            <span class="c1"># Check for required sections</span>
            <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_SECTIONS</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="n">found</span>
            
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Missing required sections: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

    
<div class="viewcode-block" id="AgentMemoryManager.get_memory_metrics">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.AgentMemoryManager.get_memory_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get memory usage metrics.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This adapter method provides interface compliance by gathering</span>
<span class="sd">        metrics about memory usage.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Optional specific agent ID, or None for all</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with memory metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_memories&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;total_size_kb&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;agent_metrics&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;limits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_limits</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">agent_id</span><span class="p">:</span>
                <span class="c1"># Get metrics for specific agent</span>
                <span class="n">memory_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">_agent.md&quot;</span>
                <span class="k">if</span> <span class="n">memory_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">memory_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">size_kb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span>
                    <span class="n">sections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^##\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                    
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;agent_metrics&quot;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;size_kb&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">size_kb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">),</span>
                        <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="kc">True</span>
                    <span class="p">}</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;total_memories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">size_kb</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get metrics for all agents</span>
                <span class="k">for</span> <span class="n">memory_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memories_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*_agent.md&quot;</span><span class="p">):</span>
                    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">memory_file</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_agent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">memory_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">size_kb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span>
                    <span class="n">sections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^##\s+(.+)$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                    
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;agent_metrics&quot;</span><span class="p">][</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;size_kb&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">size_kb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">),</span>
                        <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="kc">True</span>
                    <span class="p">}</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;total_memories&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">size_kb</span>
                
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;total_size_kb&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get memory metrics: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">metrics</span></div>
</div>



<span class="c1"># Convenience functions for external use</span>
<div class="viewcode-block" id="get_memory_manager">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.memory.agent_memory_manager.html#claude_mpm.services.agents.get_memory_manager">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_memory_manager</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentMemoryManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a singleton instance of the memory manager.</span>
<span class="sd">    </span>
<span class="sd">    WHY: The memory manager should be shared across the application to ensure</span>
<span class="sd">    consistent file access and avoid multiple instances managing the same files.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        config: Optional Config object. Only used on first instantiation.</span>
<span class="sd">        working_directory: Optional working directory. Only used on first instantiation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        AgentMemoryManager: The memory manager instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">get_memory_manager</span><span class="p">,</span> <span class="s1">&#39;_instance&#39;</span><span class="p">):</span>
        <span class="n">get_memory_manager</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">AgentMemoryManager</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_memory_manager</span><span class="o">.</span><span class="n">_instance</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>