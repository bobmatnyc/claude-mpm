

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.services.agents.registry.agent_registry &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../services.html">claude_mpm.services</a></li>
      <li class="breadcrumb-item active">claude_mpm.services.agents.registry.agent_registry</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.services.agents.registry.agent_registry</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Agent Registry Service - Consolidated Module</span>
<span class="sd">===========================================</span>

<span class="sd">Provides fully synchronous agent discovery and management system with caching,</span>
<span class="sd">validation, and hierarchical organization support.</span>

<span class="sd">Features:</span>
<span class="sd">- Two-tier hierarchy discovery (user â†’ system)</span>
<span class="sd">- Synchronous directory scanning</span>
<span class="sd">- Agent metadata collection and caching</span>
<span class="sd">- Agent type detection and classification  </span>
<span class="sd">- SharedPromptCache integration</span>
<span class="sd">- Agent validation and error handling</span>

<span class="sd">This is a consolidated version combining all functionality from the previous</span>
<span class="sd">multi-file implementation for better maintainability.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config_paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigPaths</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.memory.cache.simple_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleCacheService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.agents.frontmatter_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrontmatterValidator</span><span class="p">,</span> <span class="n">ValidationResult</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ============================================================================</span>
<span class="c1"># Constants and Types</span>
<span class="c1"># ============================================================================</span>

<span class="n">CORE_AGENT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;engineer&#39;</span><span class="p">,</span> <span class="s1">&#39;architect&#39;</span><span class="p">,</span> <span class="s1">&#39;qa&#39;</span><span class="p">,</span> <span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="s1">&#39;documentation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ops&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;research&#39;</span><span class="p">,</span> <span class="s1">&#39;version_control&#39;</span>
<span class="p">}</span>

<span class="n">SPECIALIZED_AGENT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;pm_orchestrator&#39;</span><span class="p">,</span> <span class="s1">&#39;frontend&#39;</span><span class="p">,</span> <span class="s1">&#39;backend&#39;</span><span class="p">,</span> <span class="s1">&#39;devops&#39;</span><span class="p">,</span> <span class="s1">&#39;ml&#39;</span><span class="p">,</span>
    <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;mobile&#39;</span><span class="p">,</span> <span class="s1">&#39;cloud&#39;</span><span class="p">,</span> <span class="s1">&#39;testing&#39;</span>
<span class="p">}</span>

<span class="n">ALL_AGENT_TYPES</span> <span class="o">=</span> <span class="n">CORE_AGENT_TYPES</span> <span class="o">|</span> <span class="n">SPECIALIZED_AGENT_TYPES</span>


<div class="viewcode-block" id="AgentTier">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentTier">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentTier</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent hierarchy tiers.&quot;&quot;&quot;</span>
    <span class="n">PROJECT</span> <span class="o">=</span> <span class="s2">&quot;project&quot;</span>  <span class="c1"># Highest precedence - project-specific agents</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">SYSTEM</span> <span class="o">=</span> <span class="s2">&quot;system&quot;</span></div>



<div class="viewcode-block" id="AgentType">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent classification types.&quot;&quot;&quot;</span>
    <span class="n">CORE</span> <span class="o">=</span> <span class="s2">&quot;core&quot;</span>
    <span class="n">SPECIALIZED</span> <span class="o">=</span> <span class="s2">&quot;specialized&quot;</span>
    <span class="n">CUSTOM</span> <span class="o">=</span> <span class="s2">&quot;custom&quot;</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span></div>



<span class="c1"># ============================================================================</span>
<span class="c1"># Data Models</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="AgentMetadata">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentMetadata">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentMetadata</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete metadata for discovered agent.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tier</span><span class="p">:</span> <span class="n">AgentTier</span>
    <span class="n">agent_type</span><span class="p">:</span> <span class="n">AgentType</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">capabilities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="n">last_modified</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
    <span class="n">file_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">is_valid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">validation_errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    
<div class="viewcode-block" id="AgentMetadata.to_dict">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentMetadata.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to dictionary for serialization.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;agent_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_type</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">data</span></div>

    
<div class="viewcode-block" id="AgentMetadata.from_dict">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentMetadata.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;AgentMetadata&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create from dictionary.&quot;&quot;&quot;</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgentTier</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;agent_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgentType</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;agent_type&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></div>
</div>



<span class="c1"># ============================================================================</span>
<span class="c1"># Main Registry Class</span>
<span class="c1"># ============================================================================</span>

<div class="viewcode-block" id="AgentRegistry">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Core Agent Registry - Fully synchronous agent discovery and management system.</span>
<span class="sd">    </span>
<span class="sd">    This consolidated version combines all functionality from the previous</span>
<span class="sd">    multi-file implementation into a single, maintainable module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AgentRegistry.__init__">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_service</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize AgentRegistry with optional cache service and model selector.&quot;&quot;&quot;</span>
        <span class="c1"># Use provided cache service or create a default one</span>
        <span class="k">if</span> <span class="n">cache_service</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a simple in-memory cache with 1 hour TTL by default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span> <span class="o">=</span> <span class="n">SimpleCacheService</span><span class="p">(</span><span class="n">default_ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span> <span class="o">=</span> <span class="n">cache_service</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model_selector</span> <span class="o">=</span> <span class="n">model_selector</span>
        
        <span class="c1"># Initialize frontmatter validator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frontmatter_validator</span> <span class="o">=</span> <span class="n">FrontmatterValidator</span><span class="p">()</span>
        
        <span class="c1"># Registry storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgentMetadata</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Cache configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span> <span class="o">=</span> <span class="s2">&quot;agent_registry&quot;</span>
        
        <span class="c1"># Track discovered files for cache invalidation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="c1"># Discovery configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;__pycache__&#39;</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">,</span> <span class="s1">&#39;node_modules&#39;</span><span class="p">,</span> <span class="s1">&#39;.pytest_cache&#39;</span><span class="p">}</span>
        
        <span class="c1"># Statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;last_discovery&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;total_discovered&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;cache_hits&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;cache_misses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;discovery_duration&#39;</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Setup discovery paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_discovery_paths</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AgentRegistry initialized with cache=</span><span class="si">{</span><span class="s1">&#39;enabled&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;disabled&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_discovery_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup standard discovery paths for agent files.&quot;&quot;&quot;</span>
        <span class="c1"># Project-level agents (highest priority)</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="n">ConfigPaths</span><span class="o">.</span><span class="n">get_project_agents_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">project_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
        
        <span class="c1"># User-level agents</span>
        <span class="n">user_path</span> <span class="o">=</span> <span class="n">ConfigPaths</span><span class="o">.</span><span class="n">get_user_agents_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_path</span><span class="p">)</span>
        
        <span class="c1"># System-level agents - multiple possible locations</span>
        <span class="n">system_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;agents&#39;</span> <span class="o">/</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span>
            <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/opt/claude-pm/agents&#39;</span><span class="p">),</span>
            <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/usr/local/claude-pm/agents&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">system_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovery paths configured: </span><span class="si">{</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># ========================================================================</span>
    <span class="c1"># Discovery Methods</span>
    <span class="c1"># ========================================================================</span>
    
<div class="viewcode-block" id="AgentRegistry.discover_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.discover_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">discover_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover all available agents across configured paths.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            force_refresh: Force re-discovery even if cache is valid</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of agent name to metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Try cache first</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_refresh</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_registry</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">cached</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="p">[</span><span class="s1">&#39;cache_hits&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached agent registry&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="p">[</span><span class="s1">&#39;cache_misses&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Clear existing registry and discovered files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Discover agents from all paths</span>
        <span class="k">for</span> <span class="n">discovery_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_tier</span><span class="p">(</span><span class="n">discovery_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_discover_path</span><span class="p">(</span><span class="n">discovery_path</span><span class="p">,</span> <span class="n">tier</span><span class="p">)</span>
        
        <span class="c1"># Handle tier precedence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_tier_precedence</span><span class="p">()</span>
        
        <span class="c1"># Cache the results with file tracking</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_registry</span><span class="p">()</span>
        
        <span class="c1"># Update statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="p">[</span><span class="s1">&#39;last_discovery&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="p">[</span><span class="s1">&#39;total_discovered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="p">[</span><span class="s1">&#39;discovery_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span><span class="si">}</span><span class="s2"> agents in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="p">[</span><span class="s1">&#39;discovery_duration&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_discover_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">tier</span><span class="p">:</span> <span class="n">AgentTier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover agents in a specific path.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span>
        
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
            <span class="c1"># Skip directories and ignored patterns</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check file extension</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_extensions</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Extract agent name</span>
            <span class="n">agent_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_agent_name</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_name</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Track discovered file for cache invalidation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># Create metadata</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_agent_metadata</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">tier</span><span class="p">)</span>
            
            <span class="c1"># Validate agent</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_agent</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
                <span class="c1"># Check tier precedence</span>
                <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_tier_precedence</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">tier</span><span class="p">,</span> <span class="n">existing</span><span class="o">.</span><span class="n">tier</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replaced </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> with higher precedence version from </span><span class="si">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_agent_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract agent name from file path.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span>
        
        <span class="c1"># Remove common suffixes</span>
        <span class="n">suffixes_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;-agent&#39;</span><span class="p">,</span> <span class="s1">&#39;.agent&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffixes_to_remove</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
                <span class="k">break</span>
        
        <span class="c1"># Skip empty or invalid names</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="n">name</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_agent_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tier</span><span class="p">:</span> <span class="n">AgentTier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentMetadata</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create agent metadata from file.&quot;&quot;&quot;</span>
        <span class="c1"># Get file stats</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
        
        <span class="c1"># Calculate checksum</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">checksum</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to calculate checksum for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Determine agent type</span>
        <span class="n">agent_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
        
        <span class="c1"># Extract description and metadata from file</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            
            <span class="c1"># Try to parse as JSON/YAML/MD for structured data</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.md&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yml&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.json&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">)</span>
                        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.md&#39;</span><span class="p">:</span>
                        <span class="c1"># Parse markdown with YAML frontmatter</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                        
                        <span class="c1"># Check for YAML frontmatter</span>
                        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^---\s*$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">frontmatter_text</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">frontmatter_text</span><span class="p">)</span>
                                
                                <span class="c1"># Validate and correct frontmatter</span>
                                <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frontmatter_validator</span><span class="o">.</span><span class="n">validate_and_correct</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied corrections to </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">correction</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">correction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    
                                    <span class="c1"># Use corrected frontmatter if available</span>
                                    <span class="k">if</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">corrected_frontmatter</span><span class="p">:</span>
                                        <span class="n">data</span> <span class="o">=</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">corrected_frontmatter</span>
                                
                                <span class="k">if</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation errors in </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                
                                <span class="n">description</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                <span class="n">version</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">)</span>
                                <span class="n">capabilities</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># Tools in .md format</span>
                                <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># No frontmatter, use defaults</span>
                                <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2"> agent&quot;</span>
                                <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.0.0&#39;</span>
                                <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># No frontmatter, use defaults</span>
                            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2"> agent&quot;</span>
                            <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.0.0&#39;</span>
                            <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># YAML files</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">)</span>
                        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            
            <span class="c1"># Extract from markdown files</span>
            <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.md&#39;</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">20</span><span class="p">]):</span>  <span class="c1"># Check first 20 lines</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Version:&#39;</span><span class="p">):</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Description:&#39;</span><span class="p">):</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">AgentMetadata</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">agent_name</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span>
            <span class="n">tier</span><span class="o">=</span><span class="n">tier</span><span class="p">,</span>
            <span class="n">agent_type</span><span class="o">=</span><span class="n">agent_type</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">capabilities</span><span class="o">=</span><span class="n">capabilities</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">st_ctime</span><span class="p">,</span>
            <span class="n">last_modified</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span>
            <span class="n">file_size</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
            <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
        <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_classify_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Classify agent based on name.&quot;&quot;&quot;</span>
        <span class="n">name_lower</span> <span class="o">=</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="c1"># Remove common suffixes for classification</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;-agent&#39;</span><span class="p">,</span> <span class="s1">&#39;.agent&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name_lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="n">name_lower</span> <span class="o">=</span> <span class="n">name_lower</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">name_lower</span> <span class="ow">in</span> <span class="n">CORE_AGENT_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">CORE</span>
        <span class="k">elif</span> <span class="n">name_lower</span> <span class="ow">in</span> <span class="n">SPECIALIZED_AGENT_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">SPECIALIZED</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">core</span> <span class="ow">in</span> <span class="n">name_lower</span> <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="n">CORE_AGENT_TYPES</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">CORE</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">spec</span> <span class="ow">in</span> <span class="n">name_lower</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">SPECIALIZED_AGENT_TYPES</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">SPECIALIZED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AgentType</span><span class="o">.</span><span class="n">CUSTOM</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_tier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentTier</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine tier based on path location.&quot;&quot;&quot;</span>
        <span class="n">path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="c1"># Check if it&#39;s a project-level path (in current working directory)</span>
        <span class="c1"># Project agents are in &lt;project_root&gt;/.claude-mpm/agents</span>
        <span class="n">project_agents_dir</span> <span class="o">=</span> <span class="n">ConfigPaths</span><span class="o">.</span><span class="n">get_project_agents_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">project_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="n">project_agents_dir</span> <span class="ow">or</span> <span class="n">project_agents_dir</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">parents</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">PROJECT</span>
        
        <span class="c1"># Check if it&#39;s a user-level path (in home directory)</span>
        <span class="n">user_agents_dir</span> <span class="o">=</span> <span class="n">ConfigPaths</span><span class="o">.</span><span class="n">get_user_agents_dir</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="n">user_agents_dir</span> <span class="ow">or</span> <span class="n">user_agents_dir</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">parents</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">USER</span>
        
        <span class="c1"># Everything else is system-level</span>
        <span class="k">return</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">SYSTEM</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_has_tier_precedence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tier1</span><span class="p">:</span> <span class="n">AgentTier</span><span class="p">,</span> <span class="n">tier2</span><span class="p">:</span> <span class="n">AgentTier</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if tier1 has precedence over tier2.&quot;&quot;&quot;</span>
        <span class="n">precedence</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">AgentTier</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Highest precedence</span>
            <span class="n">AgentTier</span><span class="o">.</span><span class="n">USER</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">AgentTier</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">precedence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">precedence</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_tier_precedence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply tier precedence rules to discovered agents.&quot;&quot;&quot;</span>
        <span class="c1"># Group agents by name</span>
        <span class="n">agents_by_name</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agents_by_name</span><span class="p">:</span>
                <span class="n">agents_by_name</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">agents_by_name</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
        
        <span class="c1"># Apply precedence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">agents</span> <span class="ow">in</span> <span class="n">agents_by_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Sort by tier precedence</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">{</span><span class="n">AgentTier</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">USER</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">tier</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied tier precedence for </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">: using </span><span class="si">{</span><span class="n">agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> version&quot;</span><span class="p">)</span>
    
    <span class="c1"># ========================================================================</span>
    <span class="c1"># Validation Methods</span>
    <span class="c1"># ========================================================================</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">AgentMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate agent metadata and file.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Agent file does not exist&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check name validity</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid agent name&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check for required fields based on file type</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing &#39;name&#39; field in JSON&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;role&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing &#39;role&#39; field in JSON&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Update metadata</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">validation_errors</span> <span class="o">=</span> <span class="n">errors</span>
        
        <span class="k">return</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_valid</span>
    
    <span class="c1"># ========================================================================</span>
    <span class="c1"># Cache Methods</span>
    <span class="c1"># ========================================================================</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cached_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgentMetadata</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get registry from cache if available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span><span class="si">}</span><span class="s2">_registry&quot;</span>
            <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
                <span class="c1"># Deserialize metadata</span>
                <span class="n">registry</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">cached_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgentMetadata</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                
                <span class="c1"># Also restore discovered files set</span>
                <span class="n">files_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span><span class="si">}</span><span class="s2">_discovered_files&quot;</span>
                <span class="n">discovered_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">files_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">discovered_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">discovered_files</span><span class="p">}</span>
                
                <span class="k">return</span> <span class="n">registry</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get cached registry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache the current registry with file tracking.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span><span class="si">}</span><span class="s2">_registry&quot;</span>
            
            <span class="c1"># Serialize metadata</span>
            <span class="n">cache_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> 
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            
            <span class="c1"># If the cache service supports file tracking, use it</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;tracked_files&#39;</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                    <span class="c1"># Cache with file tracking for automatic invalidation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                        <span class="n">cache_key</span><span class="p">,</span> 
                        <span class="n">cache_data</span><span class="p">,</span> 
                        <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">,</span>
                        <span class="n">tracked_files</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fall back to regular caching</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">cache_data</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fall back to regular caching</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">cache_data</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">)</span>
            
            <span class="c1"># Also cache the discovered files list</span>
            <span class="n">files_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span><span class="si">}</span><span class="s2">_discovered_files&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">files_key</span><span class="p">,</span> 
                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="p">],</span>
                <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>
            <span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cached agent registry with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> tracked files&quot;</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to cache registry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="AgentRegistry.invalidate_cache">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.invalidate_cache">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invalidate the registry cache.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Invalidate both registry and files cache</span>
                <span class="n">registry_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span><span class="si">}</span><span class="s2">_registry&quot;</span>
                <span class="n">files_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_prefix</span><span class="si">}</span><span class="s2">_discovered_files&quot;</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">registry_key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">files_key</span><span class="p">)</span>
                
                <span class="c1"># Also clear in-memory registry to force re-discovery</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discovered_files</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Invalidated registry cache&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to invalidate cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    <span class="c1"># ========================================================================</span>
    <span class="c1"># Query Methods</span>
    <span class="c1"># ========================================================================</span>
    
<div class="viewcode-block" id="AgentRegistry.get_agent">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.get_agent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metadata for a specific agent.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure registry is populated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.list_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.list_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentTier</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                   <span class="n">agent_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List agents with optional filtering.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure registry is populated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="n">agents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="c1"># Apply filters</span>
        <span class="k">if</span> <span class="n">tier</span><span class="p">:</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">agents</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">tier</span> <span class="o">==</span> <span class="n">tier</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">agent_type</span><span class="p">:</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">agents</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">agent_type</span> <span class="o">==</span> <span class="n">agent_type</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">agents</span></div>

    
<div class="viewcode-block" id="AgentRegistry.get_agent_names">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.get_agent_names">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of all agent names.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

    
<div class="viewcode-block" id="AgentRegistry.get_core_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.get_core_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_core_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all core framework agents.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_agents</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">CORE</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.get_specialized_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.get_specialized_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_specialized_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all specialized agents.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_agents</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">SPECIALIZED</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.get_custom_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.get_custom_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_custom_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all custom user-defined agents.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_agents</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">CUSTOM</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.search_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.search_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search agents by name or description.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">query_lower</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> 
                <span class="n">query_lower</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="c1"># ========================================================================</span>
    <span class="c1"># Statistics and Monitoring</span>
    <span class="c1"># ========================================================================</span>
    
<div class="viewcode-block" id="AgentRegistry.get_statistics">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.get_statistics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get comprehensive registry statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_agents&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">),</span>
            <span class="s1">&#39;discovery_stats&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_stats</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;agents_by_tier&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;agents_by_type&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;validation_stats&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;invalid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">},</span>
            <span class="s1">&#39;cache_metrics&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Add cache metrics if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="p">,</span> <span class="s1">&#39;get_cache_metrics&#39;</span><span class="p">):</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cache_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_service</span><span class="o">.</span><span class="n">get_cache_metrics</span><span class="p">()</span>
        
        <span class="c1"># Count by tier</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;agents_by_tier&#39;</span><span class="p">][</span><span class="n">tier</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;agents_by_tier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># Count by type</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">agent_type</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">agent_type</span><span class="o">.</span><span class="n">value</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;agents_by_type&#39;</span><span class="p">][</span><span class="n">agent_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;agents_by_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># Validation stats</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;validation_stats&#39;</span><span class="p">][</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;validation_stats&#39;</span><span class="p">][</span><span class="s1">&#39;invalid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;validation_stats&#39;</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">stats</span></div>

    
<div class="viewcode-block" id="AgentRegistry.validate_all_agents">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.validate_all_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_all_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate all discovered agents and return errors.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Re-validate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_agent</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metadata</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">validation_errors</span>
        
        <span class="k">return</span> <span class="n">errors</span></div>

    
    <span class="c1"># ========================================================================</span>
    <span class="c1"># Utility Methods</span>
    <span class="c1"># ========================================================================</span>
    
<div class="viewcode-block" id="AgentRegistry.add_discovery_path">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.add_discovery_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_discovery_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new path for agent discovery.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added discovery path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Invalidate cache since paths changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>
            <span class="c1"># Force re-discovery with new path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">(</span><span class="n">force_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.remove_discovery_path">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.remove_discovery_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_discovery_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a path from agent discovery.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed discovery path: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Invalidate cache since paths changed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>
            <span class="c1"># Force re-discovery without the removed path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">(</span><span class="n">force_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.export_registry">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.export_registry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export registry to JSON file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discover_agents</span><span class="p">()</span>
        
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        
        <span class="c1"># Serialize registry</span>
        <span class="n">export_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;exported_at&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="s1">&#39;total_agents&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">),</span>
                <span class="s1">&#39;discovery_paths&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_paths</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;agents&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">export_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported registry to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="AgentRegistry.import_registry">
<a class="viewcode-back" href="../../../../../claude_mpm.services.agents.registry.agent_registry.html#claude_mpm.services.agents.AgentRegistry.import_registry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import registry from JSON file.&quot;&quot;&quot;</span>
        <span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Clear current registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Import agents</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">agent_data</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgentMetadata</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">agent_data</span><span class="p">)</span>
        
        <span class="c1"># Cache imported registry</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_registry</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imported </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span><span class="si">}</span><span class="s2"> agents from </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>