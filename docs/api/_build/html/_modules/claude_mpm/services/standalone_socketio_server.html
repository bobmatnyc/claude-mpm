

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.services.standalone_socketio_server &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../services.html">claude_mpm.services</a></li>
      <li class="breadcrumb-item active">claude_mpm.services.standalone_socketio_server</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.services.standalone_socketio_server</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Standalone Socket.IO server with independent versioning and deployment agnostic design.</span>

<span class="sd">This server is designed to run independently of claude-mpm and maintain its own versioning.</span>
<span class="sd">It provides a persistent Socket.IO service that can handle multiple claude-mpm client connections.</span>

<span class="sd">KEY DESIGN PRINCIPLES:</span>
<span class="sd">1. Single server per machine - Only one instance should run</span>
<span class="sd">2. Persistent across sessions - Server keeps running when code is pushed  </span>
<span class="sd">3. Separate versioning - Server has its own version schema independent of claude-mpm</span>
<span class="sd">4. Version compatibility mapping - Track which server versions work with which claude-mpm versions</span>
<span class="sd">5. Deployment agnostic - Works with local script, PyPI, npm installations</span>

<span class="sd">WHY standalone architecture:</span>
<span class="sd">- Allows server evolution independent of claude-mpm releases</span>
<span class="sd">- Enables persistent monitoring across multiple claude-mpm sessions</span>
<span class="sd">- Provides better resource management (one server vs multiple)</span>
<span class="sd">- Simplifies debugging and maintenance</span>
<span class="sd">- Supports different installation methods (PyPI, local, Docker, etc.)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.metadata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fcntl</span>  <span class="c1"># Unix file locking</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>

<span class="c1"># Import health monitoring and recovery systems</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.health_monitor</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">AdvancedHealthMonitor</span><span class="p">,</span> <span class="n">ProcessResourceChecker</span><span class="p">,</span> 
        <span class="n">NetworkConnectivityChecker</span><span class="p">,</span> <span class="n">ServiceHealthChecker</span><span class="p">,</span>
        <span class="n">HealthStatus</span><span class="p">,</span> <span class="n">HealthCheckResult</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.recovery_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecoveryManager</span><span class="p">,</span> <span class="n">RecoveryEvent</span>
    <span class="n">HEALTH_MONITORING_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">HEALTH_MONITORING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Create stub classes to prevent errors</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">AdvancedHealthMonitor</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">add_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_current_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">export_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">RecoveryManager</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">handle_health_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_recovery_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">{}</span>

<span class="c1"># Import enhanced error classes</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">DaemonConflictError</span><span class="p">,</span> <span class="n">PortConflictError</span><span class="p">,</span> <span class="n">StaleProcessError</span><span class="p">,</span>
        <span class="n">RecoveryFailedError</span><span class="p">,</span> <span class="n">HealthCheckError</span><span class="p">,</span> <span class="n">format_troubleshooting_guide</span>
    <span class="p">)</span>
    <span class="n">ENHANCED_ERRORS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">ENHANCED_ERRORS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Create stub classes to prevent errors</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">DaemonConflictError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">PortConflictError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">StaleProcessError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">RecoveryFailedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">HealthCheckError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_troubleshooting_guide</span><span class="p">(</span><span class="n">error</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
    <span class="n">PSUTIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PSUTIL_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">psutil</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Windows file locking support</span>
<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">msvcrt</span>
        <span class="n">WINDOWS_LOCKING</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">WINDOWS_LOCKING</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">WINDOWS_LOCKING</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">msvcrt</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">socketio</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp</span><span class="w"> </span><span class="kn">import</span> <span class="n">web</span>
    <span class="n">SOCKETIO_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1"># Get Socket.IO version</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">SOCKETIO_VERSION</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s1">&#39;python-socketio&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">SOCKETIO_VERSION</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SOCKETIO_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">socketio</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">web</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">SOCKETIO_VERSION</span> <span class="o">=</span> <span class="s1">&#39;not-installed&#39;</span>

<span class="c1"># Standalone server version - independent of claude-mpm</span>
<span class="n">STANDALONE_SERVER_VERSION</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>

<span class="c1"># Compatibility matrix - which server versions work with which claude-mpm versions</span>
<span class="n">COMPATIBILITY_MATRIX</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;1.0.0&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;claude_mpm_versions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&gt;=0.7.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;min_python&quot;</span><span class="p">:</span> <span class="s2">&quot;3.8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;socketio_min&quot;</span><span class="p">:</span> <span class="s2">&quot;5.11.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;persistent_server&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version_compatibility&quot;</span><span class="p">,</span>
            <span class="s2">&quot;process_isolation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;health_monitoring&quot;</span><span class="p">,</span>
            <span class="s2">&quot;advanced_health_monitoring&quot;</span><span class="p">,</span>
            <span class="s2">&quot;automatic_recovery&quot;</span><span class="p">,</span>
            <span class="s2">&quot;circuit_breaker&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resource_monitoring&quot;</span><span class="p">,</span>
            <span class="s2">&quot;event_namespacing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comprehensive_diagnostics&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metrics_export&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>


<div class="viewcode-block" id="StandaloneSocketIOServer">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StandaloneSocketIOServer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standalone Socket.IO server with independent lifecycle and versioning.</span>
<span class="sd">    </span>
<span class="sd">    This server runs independently of claude-mpm processes and provides:</span>
<span class="sd">    - Version compatibility checking</span>
<span class="sd">    - Process isolation and management</span>
<span class="sd">    - Persistent operation across claude-mpm sessions</span>
<span class="sd">    - Health monitoring and diagnostics</span>
<span class="sd">    - Event namespacing and routing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="StandaloneSocketIOServer.__init__">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8765</span><span class="p">,</span> 
                 <span class="n">server_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">=</span> <span class="n">STANDALONE_SERVER_VERSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span> <span class="o">=</span> <span class="n">server_id</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;socketio-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        
        <span class="c1"># Setup logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logging</span><span class="p">()</span>
        
        <span class="c1"># Server state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_history</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>  <span class="c1"># Larger history for standalone server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_versions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Track client claude-mpm versions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;events_processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;clients_served&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;last_activity&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        
        <span class="c1"># Asyncio components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Process management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pidfile_path</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_lock</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># File lock object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">PSUTIL_AVAILABLE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_start_time</span> <span class="o">=</span> <span class="n">current_process</span><span class="o">.</span><span class="n">create_time</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get process start time: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SOCKETIO_AVAILABLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Socket.IO dependencies not available. Install with: pip install python-socketio aiohttp&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Log initialization with comprehensive info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standalone Socket.IO server v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="si">}</span><span class="s2"> initialized&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="si">}</span><span class="s2">, PID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using python-socketio v</span><span class="si">{</span><span class="n">SOCKETIO_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enhanced validation: psutil </span><span class="si">{</span><span class="s1">&#39;available&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">PSUTIL_AVAILABLE</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not available&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File locking: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;supported&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;Windows&#39;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">WINDOWS_LOCKING</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not supported&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Health monitoring: </span><span class="si">{</span><span class="s1">&#39;available&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">HEALTH_MONITORING_AVAILABLE</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not available&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize health monitoring system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">HEALTH_MONITORING_AVAILABLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_health_monitoring</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_start_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process start time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process_start_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup dedicated logging for standalone server.&quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;socketio_standalone_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;%(asctime)s - StandaloneSocketIO[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="si">}</span><span class="s1">] - %(levelname)s - %(message)s&#39;</span>
            <span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">logger</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_health_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize health monitoring and recovery systems.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Health monitoring configuration</span>
            <span class="n">health_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;check_interval&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>  <span class="c1"># Check every 30 seconds</span>
                <span class="s1">&#39;history_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>   <span class="c1"># Keep 100 health check results</span>
                <span class="s1">&#39;aggregation_window&#39;</span><span class="p">:</span> <span class="mi">300</span>  <span class="c1"># 5 minute aggregation window</span>
            <span class="p">}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="n">AdvancedHealthMonitor</span><span class="p">(</span><span class="n">health_config</span><span class="p">)</span>
            
            <span class="c1"># Add health checkers</span>
            
            <span class="c1"># Process resource monitoring</span>
            <span class="k">if</span> <span class="n">PSUTIL_AVAILABLE</span><span class="p">:</span>
                <span class="n">process_checker</span> <span class="o">=</span> <span class="n">ProcessResourceChecker</span><span class="p">(</span>
                    <span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                    <span class="n">cpu_threshold</span><span class="o">=</span><span class="mf">80.0</span><span class="p">,</span>      <span class="c1"># 80% CPU threshold</span>
                    <span class="n">memory_threshold_mb</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>  <span class="c1"># 500MB memory threshold</span>
                    <span class="n">fd_threshold</span><span class="o">=</span><span class="mi">1000</span>        <span class="c1"># 1000 file descriptor threshold</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">add_checker</span><span class="p">(</span><span class="n">process_checker</span><span class="p">)</span>
            
            <span class="c1"># Network connectivity monitoring</span>
            <span class="n">network_checker</span> <span class="o">=</span> <span class="n">NetworkConnectivityChecker</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">add_checker</span><span class="p">(</span><span class="n">network_checker</span><span class="p">)</span>
            
            <span class="c1"># Service health monitoring (will be initialized after server stats are available)</span>
            <span class="c1"># This is added later in start_async after health_stats is fully initialized</span>
            
            <span class="c1"># Recovery manager configuration</span>
            <span class="n">recovery_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;check_interval&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="s1">&#39;max_recovery_attempts&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;recovery_timeout&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                <span class="s1">&#39;circuit_breaker&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;failure_threshold&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="s1">&#39;timeout_seconds&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                    <span class="s1">&#39;success_threshold&#39;</span><span class="p">:</span> <span class="mi">3</span>
                <span class="p">},</span>
                <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;warning_threshold&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;critical_threshold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;failure_window_seconds&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                    <span class="s1">&#39;min_recovery_interval&#39;</span><span class="p">:</span> <span class="mi">60</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">recovery_manager</span> <span class="o">=</span> <span class="n">RecoveryManager</span><span class="p">(</span><span class="n">recovery_config</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            
            <span class="c1"># Link health monitor and recovery manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">add_health_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_health_result</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Health monitoring and recovery systems initialized&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize health monitoring: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recovery_manager</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_health_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">health_result</span><span class="p">:</span> <span class="n">HealthCheckResult</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle health check results and trigger recovery if needed.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recovery_manager</span><span class="p">:</span>
                <span class="n">recovery_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recovery_manager</span><span class="o">.</span><span class="n">handle_health_result</span><span class="p">(</span><span class="n">health_result</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">recovery_event</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovery triggered: </span><span class="si">{</span><span class="n">recovery_event</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling health result: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Enhanced error reporting for health check failures</span>
            <span class="k">if</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">health_result</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">health_result</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">]:</span>
                    <span class="n">health_error</span> <span class="o">=</span> <span class="n">HealthCheckError</span><span class="p">(</span>
                        <span class="n">check_name</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">health_result</span><span class="p">,</span> <span class="s1">&#39;check_name&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
                        <span class="n">check_status</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">health_result</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">),</span>
                        <span class="n">check_details</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">health_result</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Health Check Failure Details:</span><span class="se">\n</span><span class="si">{</span><span class="n">health_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pidfile_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get path for PID file to track running server.&quot;&quot;&quot;</span>
        <span class="c1"># Use system temp directory or user home</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>  <span class="c1"># Windows</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TEMP&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Unix-like</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;claude_mpm_socketio_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">.pid&quot;</span>
    
<div class="viewcode-block" id="StandaloneSocketIOServer.check_compatibility">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.check_compatibility">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if client version is compatible with this server version.</span>
<span class="sd">        </span>
<span class="sd">        Returns compatibility info including warnings and supported features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_compat</span> <span class="o">=</span> <span class="n">COMPATIBILITY_MATRIX</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;compatible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
            <span class="s2">&quot;client_version&quot;</span><span class="p">:</span> <span class="n">client_version</span><span class="p">,</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;supported_features&quot;</span><span class="p">:</span> <span class="n">server_compat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;requirements&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;min_python&quot;</span><span class="p">:</span> <span class="n">server_compat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_python&quot;</span><span class="p">,</span> <span class="s2">&quot;3.8&quot;</span><span class="p">),</span>
                <span class="s2">&quot;socketio_min&quot;</span><span class="p">:</span> <span class="n">server_compat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;socketio_min&quot;</span><span class="p">,</span> <span class="s2">&quot;5.11.0&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1"># Simple version compatibility check</span>
        <span class="c1"># In production, you&#39;d use proper semantic versioning</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_version</span> <span class="o">&gt;=</span> <span class="s2">&quot;0.7.0&quot;</span><span class="p">:</span>  <span class="c1"># Minimum supported</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;compatible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client version </span><span class="si">{</span><span class="n">client_version</span><span class="si">}</span><span class="s2"> may not be fully supported&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;compatible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse client version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;compatible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_process_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">expected_cmdline_patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that a process is actually our Socket.IO server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pid: Process ID to validate</span>
<span class="sd">            expected_cmdline_patterns: Command line patterns that should match our server</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict with validation results and process info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validation_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;is_valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;is_zombie&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;is_our_server&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;process_info&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PSUTIL_AVAILABLE</span><span class="p">:</span>
            <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;psutil not available for enhanced validation&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback to basic process existence check</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;process_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;basic_os_check&quot;</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">validation_result</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            
            <span class="c1"># Basic process info</span>
            <span class="n">process_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="p">(),</span>
                <span class="s2">&quot;create_time&quot;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">create_time</span><span class="p">(),</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                <span class="s2">&quot;cwd&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;cmdline&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;memory_info&quot;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
            
            <span class="c1"># Check if process is zombie</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">psutil</span><span class="o">.</span><span class="n">STATUS_ZOMBIE</span><span class="p">:</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;is_zombie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is a zombie&quot;</span><span class="p">)</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;process_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_info</span>
                <span class="k">return</span> <span class="n">validation_result</span>
            
            <span class="c1"># Get additional process details</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">process_info</span><span class="p">[</span><span class="s2">&quot;cwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
                <span class="n">process_info</span><span class="p">[</span><span class="s2">&quot;cmdline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">cmdline</span><span class="p">()</span>
                <span class="n">process_info</span><span class="p">[</span><span class="s2">&quot;memory_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">,</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access denied getting process details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;process_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_info</span>
            <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Validate this is likely our server process</span>
            <span class="n">cmdline</span> <span class="o">=</span> <span class="n">process_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmdline&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">cmdline_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="c1"># Default patterns for our Socket.IO server</span>
            <span class="k">if</span> <span class="n">expected_cmdline_patterns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expected_cmdline_patterns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;socketio&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;standalone_socketio_server&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;claude-mpm&quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
                <span class="p">]</span>
            
            <span class="c1"># Check if any patterns match the command line</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">cmdline_str</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">expected_cmdline_patterns</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;is_our_server&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> matches server patterns: </span><span class="si">{</span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">zip</span><span class="p">(</span><span class="n">expected_cmdline_patterns</span><span class="p">,</span><span class="w"> </span><span class="n">matches</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> command line &#39;</span><span class="si">{</span><span class="n">cmdline_str</span><span class="si">}</span><span class="s2">&#39; does not match expected patterns: </span><span class="si">{</span><span class="n">expected_cmdline_patterns</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> does not appear to be our server: </span><span class="si">{</span><span class="n">cmdline</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> no longer exists&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access denied to process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">validation_result</span><span class="p">[</span><span class="s2">&quot;validation_errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error validating process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">validation_result</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_acquire_pidfile_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pidfile_fd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Acquire exclusive lock on PID file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pidfile_fd: Open file descriptor for PID file</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if lock acquired successfully, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span> <span class="ow">and</span> <span class="n">WINDOWS_LOCKING</span><span class="p">:</span>
                <span class="c1"># Windows file locking</span>
                <span class="n">msvcrt</span><span class="o">.</span><span class="n">locking</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">LK_NBLCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Unix file locking</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not acquire PID file lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_release_pidfile_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pidfile_fd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Release lock on PID file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pidfile_fd: Open file descriptor for PID file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span> <span class="ow">and</span> <span class="n">WINDOWS_LOCKING</span><span class="p">:</span>
                <span class="n">msvcrt</span><span class="o">.</span><span class="n">locking</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">LK_UNLCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error releasing PID file lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_pidfile_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pidfile_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">process_start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that PID file was created around the same time as the process.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pidfile_path: Path to PID file</span>
<span class="sd">            process_start_time: Process start time from psutil</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if timestamps are reasonably close, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pidfile_mtime</span> <span class="o">=</span> <span class="n">pidfile_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="n">time_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pidfile_mtime</span> <span class="o">-</span> <span class="n">process_start_time</span><span class="p">)</span>
            
            <span class="c1"># Allow up to 5 seconds difference (process start vs file creation)</span>
            <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&lt;=</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;PID file timestamp (</span><span class="si">{</span><span class="n">pidfile_mtime</span><span class="si">}</span><span class="s2">) and process start time (</span><span class="si">{</span><span class="n">process_start_time</span><span class="si">}</span><span class="s2">) &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;differ by </span><span class="si">{</span><span class="n">time_diff</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not validate PID file timestamp: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
<div class="viewcode-block" id="StandaloneSocketIOServer.is_already_running">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.is_already_running">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_already_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_on_conflict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced check if another server instance is already running on this port.</span>
<span class="sd">        </span>
<span class="sd">        This method performs comprehensive validation including:</span>
<span class="sd">        - PID file existence and validity</span>
<span class="sd">        - Process identity verification (command line, start time)</span>
<span class="sd">        - Zombie process detection</span>
<span class="sd">        - Port availability check</span>
<span class="sd">        - Automatic cleanup of stale PID files</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if a valid server is already running, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking if server is already running on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Check PID file existence</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No PID file found&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PID file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Step 2: Read PID from file with support for both JSON and legacy formats</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pid_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_content</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty PID file&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;empty_file&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
                    
                    <span class="c1"># Try JSON format first (new format)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pidfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pid_content</span><span class="p">)</span>
                        <span class="n">old_pid</span> <span class="o">=</span> <span class="n">pidfile_data</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span>
                        <span class="n">server_id</span> <span class="o">=</span> <span class="n">pidfile_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server_id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PID </span><span class="si">{</span><span class="n">old_pid</span><span class="si">}</span><span class="s2"> for server </span><span class="si">{</span><span class="n">server_id</span><span class="si">}</span><span class="s2"> in JSON format&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="c1"># Fallback to legacy format (plain PID number)</span>
                        <span class="k">if</span> <span class="n">pid_content</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">old_pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid_content</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PID </span><span class="si">{</span><span class="n">old_pid</span><span class="si">}</span><span class="s2"> in legacy format&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid PID content in file: &#39;</span><span class="si">{</span><span class="n">pid_content</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; (truncated)&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;invalid_content&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not read PID file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;read_error&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
            
            <span class="c1"># Step 3: Enhanced process validation</span>
            <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_process_identity</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">old_pid</span><span class="si">}</span><span class="s2"> is not valid: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;validation_errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raise_on_conflict</span> <span class="ow">and</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StaleProcessError</span><span class="p">(</span>
                        <span class="n">pid</span><span class="o">=</span><span class="n">old_pid</span><span class="p">,</span>
                        <span class="n">pidfile_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span>
                        <span class="n">process_status</span><span class="o">=</span><span class="s2">&quot;not_found&quot;</span><span class="p">,</span>
                        <span class="n">validation_errors</span><span class="o">=</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;validation_errors&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;invalid_process&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s2">&quot;is_zombie&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">old_pid</span><span class="si">}</span><span class="s2"> is a zombie, cleaning up&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raise_on_conflict</span> <span class="ow">and</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StaleProcessError</span><span class="p">(</span>
                        <span class="n">pid</span><span class="o">=</span><span class="n">old_pid</span><span class="p">,</span>
                        <span class="n">pidfile_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span>
                        <span class="n">process_status</span><span class="o">=</span><span class="s2">&quot;zombie&quot;</span><span class="p">,</span>
                        <span class="n">validation_errors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Process is a zombie (terminated but not reaped)&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;zombie_process&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
            
            <span class="c1"># Step 4: Verify this is actually our server process</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s2">&quot;is_our_server&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">old_pid</span><span class="si">}</span><span class="s2"> exists but does not appear to be our Socket.IO server. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Command line: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;process_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmdline&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Don&#39;t automatically clean up - might be another legitimate process</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span>
            
            <span class="c1"># Step 5: Validate process start time against PID file timestamp</span>
            <span class="k">if</span> <span class="n">PSUTIL_AVAILABLE</span> <span class="ow">and</span> <span class="s1">&#39;create_time&#39;</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;process_info&#39;</span><span class="p">]:</span>
                <span class="n">process_start_time</span> <span class="o">=</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;process_info&#39;</span><span class="p">][</span><span class="s1">&#39;create_time&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_pidfile_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="n">process_start_time</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PID file timestamp does not match process start time&quot;</span><span class="p">)</span>
                    <span class="c1"># Continue anyway - timestamp validation is not critical</span>
            
            <span class="c1"># Step 6: All validations passed</span>
            <span class="n">process_info</span> <span class="o">=</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;process_info&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found valid running server: PID </span><span class="si">{</span><span class="n">old_pid</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;status: </span><span class="si">{</span><span class="n">process_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;name: </span><span class="si">{</span><span class="n">process_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">raise_on_conflict</span> <span class="ow">and</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                <span class="c1"># Try to extract server ID from PID file if available</span>
                <span class="n">server_id</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                            <span class="n">pidfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                            <span class="n">server_id</span> <span class="o">=</span> <span class="n">pidfile_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server_id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="k">raise</span> <span class="n">DaemonConflictError</span><span class="p">(</span>
                    <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                    <span class="n">existing_pid</span><span class="o">=</span><span class="n">old_pid</span><span class="p">,</span>
                    <span class="n">existing_server_id</span><span class="o">=</span><span class="n">server_id</span><span class="p">,</span>
                    <span class="n">process_info</span><span class="o">=</span><span class="n">process_info</span><span class="p">,</span>
                    <span class="n">pidfile_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span>
                <span class="p">)</span>
            
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="p">(</span><span class="n">DaemonConflictError</span><span class="p">,</span> <span class="n">StaleProcessError</span><span class="p">,</span> <span class="n">PortConflictError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Re-raise our enhanced errors instead of catching them</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during enhanced server check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback to basic port check on unexpected errors</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_port_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raise_on_conflict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback method to check if port is in use.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            raise_on_conflict: If True, raises PortConflictError instead of returning True</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if port is in use, False otherwise</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            PortConflictError: If raise_on_conflict=True and port is in use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2"> is in use by some process&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">raise_on_conflict</span> <span class="ow">and</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                        <span class="c1"># Try to identify the conflicting process if psutil is available</span>
                        <span class="n">conflicting_process</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">PSUTIL_AVAILABLE</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
                                <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">([</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;cmdline&#39;</span><span class="p">]):</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">connections</span><span class="p">():</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">laddr</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="ow">or</span> <span class="n">conn</span><span class="o">.</span><span class="n">laddr</span><span class="o">.</span><span class="n">ip</span> <span class="o">==</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">conn</span><span class="o">.</span><span class="n">laddr</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>
                                                <span class="n">conflicting_process</span> <span class="o">=</span> <span class="p">{</span>
                                                    <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">],</span>
                                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                                    <span class="s1">&#39;cmdline&#39;</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cmdline&#39;</span><span class="p">]</span>
                                                <span class="p">}</span>
                                                <span class="k">break</span>
                                    <span class="k">except</span> <span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">,</span> <span class="n">psutil</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">):</span>
                                        <span class="k">continue</span>
                                    <span class="k">if</span> <span class="n">conflicting_process</span><span class="p">:</span>
                                        <span class="k">break</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>  <span class="c1"># Ignore errors in process discovery</span>
                        
                        <span class="k">raise</span> <span class="n">PortConflictError</span><span class="p">(</span>
                            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                            <span class="n">conflicting_process</span><span class="o">=</span><span class="n">conflicting_process</span>
                        <span class="p">)</span>
                    
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">PortConflictError</span><span class="p">):</span>  <span class="c1"># Don&#39;t mask our own exceptions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking port availability: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_stale_pidfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up stale PID file with logging.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            reason: Reason for cleanup (for logging)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned up stale PID file (reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to clean up stale PID file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="StandaloneSocketIOServer.create_pidfile">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.create_pidfile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_pidfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create PID file with exclusive locking to track this server instance.</span>
<span class="sd">        </span>
<span class="sd">        This method creates a PID file with exclusive locking to prevent race conditions</span>
<span class="sd">        and ensures only one server instance can hold the lock at a time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Open file for writing with exclusive creation</span>
            <span class="n">pidfile_fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            
            <span class="c1"># Try to acquire exclusive lock</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquire_pidfile_lock</span><span class="p">(</span><span class="n">pidfile_fd</span><span class="p">):</span>
                <span class="n">pidfile_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DaemonConflictError</span><span class="p">(</span>
                        <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                        <span class="n">existing_pid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Unknown PID since we can&#39;t get lock</span>
                        <span class="n">existing_server_id</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                        <span class="n">pidfile_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not acquire exclusive lock on PID file&quot;</span><span class="p">)</span>
            
            <span class="c1"># Write PID and additional metadata</span>
            <span class="n">pidfile_content</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
                <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;process_start_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_start_time</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_start_time</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(),</span>
                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="p">}</span>
            
            <span class="c1"># Write JSON format for better validation</span>
            <span class="n">pidfile_fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pidfile_content</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">pidfile_fd</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
            <span class="c1"># Keep file descriptor open to maintain lock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_lock</span> <span class="o">=</span> <span class="n">pidfile_fd</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created PID file with exclusive lock: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PID file content: </span><span class="si">{</span><span class="n">pidfile_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create PID file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;pidfile_fd&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pidfile_fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">raise</span></div>

    
<div class="viewcode-block" id="StandaloneSocketIOServer.remove_pidfile">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.remove_pidfile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_pidfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove PID file and release lock on shutdown.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Release file lock first</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_lock</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_release_pidfile_lock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_lock</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_lock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_lock</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Released PID file lock&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error releasing PID file lock: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Remove PID file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed PID file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove PID file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="StandaloneSocketIOServer.setup_signal_handlers">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.setup_signal_handlers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_signal_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup signal handlers for graceful shutdown.&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received signal </span><span class="si">{</span><span class="n">signum</span><span class="si">}</span><span class="s2">, initiating shutdown...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s1">&#39;SIGHUP&#39;</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="StandaloneSocketIOServer.start_async">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.start_async">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the server asynchronously.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SOCKETIO_AVAILABLE</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Socket.IO dependencies not available. Install with: pip install python-socketio aiohttp&quot;</span>
            <span class="k">if</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Installation steps:</span><span class="se">\n</span><span class="s2">  1. pip install python-socketio aiohttp</span><span class="se">\n</span><span class="s2">  2. Restart the server</span><span class="se">\n</span><span class="s2">  3. Verify installation: python -c &#39;import socketio; print(socketio.__version__)&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting standalone Socket.IO server v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create Socket.IO server with production settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">AsyncServer</span><span class="p">(</span>
            <span class="n">cors_allowed_origins</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>  <span class="c1"># Configure appropriately for production</span>
            <span class="n">async_mode</span><span class="o">=</span><span class="s1">&#39;aiohttp&#39;</span><span class="p">,</span>
            <span class="n">ping_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">ping_interval</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
            <span class="n">max_http_buffer_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Use our own logger</span>
            <span class="n">engineio_logger</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="c1"># Create aiohttp application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        
        <span class="c1"># Setup routes and event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_routes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_event_handlers</span><span class="p">()</span>
        
        <span class="c1"># Start the server</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">AppRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">TCPSite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Create PID file after successful server start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_pidfile</span><span class="p">()</span>
            
            <span class="c1"># Start health monitoring</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="p">:</span>
                <span class="c1"># Add service health checker now that stats are available</span>
                <span class="n">service_checker</span> <span class="o">=</span> <span class="n">ServiceHealthChecker</span><span class="p">(</span>
                    <span class="n">service_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">,</span>
                    <span class="n">max_clients</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">max_error_rate</span><span class="o">=</span><span class="mf">0.1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">add_checker</span><span class="p">(</span><span class="n">service_checker</span><span class="p">)</span>
                
                <span class="c1"># Start monitoring</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">start_monitoring</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Health monitoring started&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Clean up partial initialization</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;runner&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            
            <span class="c1"># Enhanced error handling for common startup failures</span>
            <span class="k">if</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Address already in use&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;Permission denied&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="c1"># This is likely a port conflict</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Check if port is in use and raise appropriate error</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_check_port_only</span><span class="p">(</span><span class="n">raise_on_conflict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">PortConflictError</span><span class="p">:</span>
                        <span class="c1"># Re-raise the more specific error</span>
                        <span class="k">raise</span>
            
            <span class="k">raise</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 Standalone Socket.IO server STARTED on http://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔧 Server ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;💾 PID file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="StandaloneSocketIOServer.start">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the server in the main thread (for standalone execution).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_already_running</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Server is already running. Use stop() first or choose a different port.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_signal_handlers</span><span class="p">()</span>
        
        <span class="c1"># Run in main thread for standalone operation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_forever</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received KeyboardInterrupt, shutting down...&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="kc">True</span></div>

    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the server until stopped.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_async</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Keep server running with periodic health checks</span>
            <span class="n">last_health_check</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># Periodic health check and stats update</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_health_check</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>  <span class="c1"># Every 30 seconds</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_health_stats</span><span class="p">()</span>
                    <span class="n">last_health_check</span> <span class="o">=</span> <span class="n">now</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in server loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    
<div class="viewcode-block" id="StandaloneSocketIOServer.stop">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.StandaloneSocketIOServer.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the server gracefully.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping standalone Socket.IO server...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="c1"># Schedule shutdown in the event loop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_async</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Direct shutdown</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_async</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_pidfile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped&quot;</span><span class="p">)</span></div>

    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_shutdown_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async shutdown process.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Stop health monitoring</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">stop_monitoring</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Health monitoring stopped&quot;</span><span class="p">)</span>
            
            <span class="c1"># Close all client connections</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            
            <span class="c1"># Stop the web server</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during shutdown: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup HTTP routes for health checks and admin endpoints.&quot;&quot;&quot;</span>
        
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">version_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Version discovery endpoint.&quot;&quot;&quot;</span>
            <span class="n">compatibility_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
                <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                <span class="s2">&quot;socketio_version&quot;</span><span class="p">:</span> <span class="n">SOCKETIO_VERSION</span><span class="p">,</span>
                <span class="s2">&quot;compatibility_matrix&quot;</span><span class="p">:</span> <span class="n">COMPATIBILITY_MATRIX</span><span class="p">,</span>
                <span class="s2">&quot;supported_client_versions&quot;</span><span class="p">:</span> <span class="n">COMPATIBILITY_MATRIX</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;claude_mpm_versions&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">COMPATIBILITY_MATRIX</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">json_response</span><span class="p">(</span><span class="n">compatibility_info</span><span class="p">)</span>
        
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Health check endpoint with detailed diagnostics.&quot;&quot;&quot;</span>
            <span class="n">uptime</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            
            <span class="n">health_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="k">else</span> <span class="s2">&quot;stopped&quot;</span><span class="p">,</span>
                <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
                <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                <span class="s2">&quot;uptime_seconds&quot;</span><span class="p">:</span> <span class="n">uptime</span><span class="p">,</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;clients_connected&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span>
                <span class="s2">&quot;client_versions&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_versions</span><span class="p">),</span>
                <span class="s2">&quot;health_stats&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">),</span>
                <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;socketio_version&quot;</span><span class="p">:</span> <span class="n">SOCKETIO_VERSION</span><span class="p">,</span>
                    <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">json_response</span><span class="p">(</span><span class="n">health_info</span><span class="p">)</span>
        
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">compatibility_check</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check compatibility with a specific client version.&quot;&quot;&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">client_version</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;client_version&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
            
            <span class="n">compatibility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">client_version</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">json_response</span><span class="p">(</span><span class="n">compatibility</span><span class="p">)</span>
        
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stats_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Server statistics endpoint.&quot;&quot;&quot;</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;server_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                    <span class="s2">&quot;uptime&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="s2">&quot;connections&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;current_clients&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span>
                    <span class="s2">&quot;total_served&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;clients_served&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;client_versions&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_versions</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;total_processed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;events_processed&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;history_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_history</span><span class="p">),</span>
                    <span class="s2">&quot;last_activity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;last_activity&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">json_response</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        
        <span class="c1"># Register routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/version&#39;</span><span class="p">,</span> <span class="n">version_endpoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/health&#39;</span><span class="p">,</span> <span class="n">health_endpoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/status&#39;</span><span class="p">,</span> <span class="n">health_endpoint</span><span class="p">)</span>  <span class="c1"># Alias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_post</span><span class="p">(</span><span class="s1">&#39;/compatibility&#39;</span><span class="p">,</span> <span class="n">compatibility_check</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/stats&#39;</span><span class="p">,</span> <span class="n">stats_endpoint</span><span class="p">)</span>
        
        <span class="c1"># Serve Socket.IO client library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="s1">&#39;/socket.io/&#39;</span><span class="p">,</span> 
                                 <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> 
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;socketio_static&#39;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_event_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup Socket.IO event handlers.&quot;&quot;&quot;</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">auth</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle client connection with version compatibility checking.&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="n">client_addr</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            
            <span class="c1"># Extract client version from auth if provided</span>
            <span class="n">client_version</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
            <span class="k">if</span> <span class="n">auth</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">auth</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">client_version</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;claude_mpm_version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">client_versions</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;clients_served&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;last_activity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔗 Client </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> connected from </span><span class="si">{</span><span class="n">client_addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📋 Client version: </span><span class="si">{</span><span class="n">client_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Total clients: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check version compatibility</span>
            <span class="n">compatibility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">client_version</span><span class="p">)</span>
            
            <span class="c1"># Send connection acknowledgment with compatibility info</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;connection_ack&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
                <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                <span class="s2">&quot;compatibility&quot;</span><span class="p">:</span> <span class="n">compatibility</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="p">},</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
            
            <span class="c1"># Send current server status</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_server_status</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compatibility</span><span class="p">[</span><span class="s2">&quot;compatible&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Client </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> version </span><span class="si">{</span><span class="n">client_version</span><span class="si">}</span><span class="s2"> has compatibility issues&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;compatibility_warning&#39;</span><span class="p">,</span> <span class="n">compatibility</span><span class="p">,</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle client disconnection.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_versions</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_versions</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔌 Client </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> disconnected&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Remaining clients: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ping</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle ping requests.&quot;&quot;&quot;</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
                <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span>
            <span class="p">},</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_version</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle version info requests.&quot;&quot;&quot;</span>
            <span class="n">version_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
                <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                <span class="s2">&quot;socketio_version&quot;</span><span class="p">:</span> <span class="n">SOCKETIO_VERSION</span><span class="p">,</span>
                <span class="s2">&quot;compatibility_matrix&quot;</span><span class="p">:</span> <span class="n">COMPATIBILITY_MATRIX</span>
            <span class="p">}</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;version_info&#39;</span><span class="p">,</span> <span class="n">version_info</span><span class="p">,</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">claude_event</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle events from claude-mpm clients and broadcast to other clients.&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Add server metadata</span>
                <span class="n">enhanced_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">data</span><span class="p">,</span>
                    <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
                    <span class="s2">&quot;received_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
                <span class="p">}</span>
                
                <span class="c1"># Store in event history</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enhanced_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;events_processed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;last_activity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
                
                <span class="c1"># Broadcast to all other clients</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;claude_event&#39;</span><span class="p">,</span> <span class="n">enhanced_data</span><span class="p">,</span> <span class="n">skip_sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📤 Broadcasted claude_event from </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> clients&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling claude_event: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="c1"># Check if error rate is becoming concerning</span>
                <span class="k">if</span> <span class="n">ENHANCED_ERRORS_AVAILABLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">error_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;events_processed&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error_rate</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># More than 10% error rate</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ High error rate detected: </span><span class="si">{</span><span class="n">error_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> errors out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s1">&#39;events_processed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> events)&quot;</span><span class="p">)</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle event history requests.&quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_history</span><span class="p">))</span>
            
            <span class="n">history</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_history</span><span class="p">)[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span> <span class="k">if</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span>
            
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;event_history&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;events&quot;</span><span class="p">:</span> <span class="n">history</span><span class="p">,</span>
                <span class="s2">&quot;total_available&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_history</span><span class="p">),</span>
                <span class="s2">&quot;returned&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
            <span class="p">},</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_server_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send current server status to a client.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span><span class="p">,</span>
            <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span>
            <span class="s2">&quot;uptime&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
            <span class="s2">&quot;clients_connected&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span>
            <span class="s2">&quot;events_processed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s2">&quot;events_processed&quot;</span><span class="p">],</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;server_status&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">room</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_health_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update health statistics.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏥 Health check - Clients: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Events: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s1">&#39;events_processed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Errors: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">health_stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../services/communication.html#claude_mpm.services.standalone_socketio_server.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point for standalone server execution.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Standalone Claude MPM Socket.IO Server&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--host&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Host to bind to&quot;</span><span class="p">)</span>  
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8765</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Port to bind to&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--server-id&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom server ID&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--check-running&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> 
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Check if server is already running and exit&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--stop&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop running server&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show version info&quot;</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standalone Socket.IO Server v</span><span class="si">{</span><span class="n">STANDALONE_SERVER_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Socket.IO v</span><span class="si">{</span><span class="n">SOCKETIO_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compatibility: </span><span class="si">{</span><span class="n">COMPATIBILITY_MATRIX</span><span class="p">[</span><span class="n">STANDALONE_SERVER_VERSION</span><span class="p">][</span><span class="s1">&#39;claude_mpm_versions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">server</span> <span class="o">=</span> <span class="n">StandaloneSocketIOServer</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
        <span class="n">server_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">server_id</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">check_running</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">server</span><span class="o">.</span><span class="n">is_already_running</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server is running on </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No server running on </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">server</span><span class="o">.</span><span class="n">is_already_running</span><span class="p">():</span>
            <span class="c1"># Send termination signal to running server with enhanced validation</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Read and validate PID file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">pidfile_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                
                <span class="c1"># Try to parse as JSON first (new format), fallback to plain PID</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pidfile_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">pidfile_data</span><span class="p">[</span><span class="s2">&quot;pid&quot;</span><span class="p">]</span>
                    <span class="n">server_id</span> <span class="o">=</span> <span class="n">pidfile_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;server_id&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found server </span><span class="si">{</span><span class="n">server_id</span><span class="si">}</span><span class="s2"> with PID </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="c1"># Fallback to old format</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">server_id</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
                
                <span class="c1"># Validate the process before attempting to stop it</span>
                <span class="n">validation</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">_validate_process_identity</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is not valid or no longer exists&quot;</span><span class="p">)</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;stop_command_invalid_process&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cleaned up stale PID file&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s2">&quot;is_zombie&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> is a zombie, cleaning up PID file&quot;</span><span class="p">)</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">_cleanup_stale_pidfile</span><span class="p">(</span><span class="s2">&quot;stop_command_zombie&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s2">&quot;is_our_server&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> may not be our Socket.IO server&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command line: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;process_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmdline&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Stop it anyway? [y/N]: &quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborted&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># Send termination signal</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent stop signal to server (PID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                
                <span class="c1"># Wait a moment for graceful shutdown</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="c1"># Check if process is still running</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server is still running, sending SIGKILL...&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server stopped successfully&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No server running to stop&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Start the server</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>