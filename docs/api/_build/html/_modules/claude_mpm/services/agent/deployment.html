

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.services.agent.deployment &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../services.html">claude_mpm.services</a></li>
      <li class="breadcrumb-item active">claude_mpm.services.agent.deployment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.services.agent.deployment</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Agent deployment service for Claude Code native subagents.</span>

<span class="sd">This service handles the complete lifecycle of agent deployment:</span>
<span class="sd">1. Building agent YAML files from JSON templates</span>
<span class="sd">2. Managing versioning and updates</span>
<span class="sd">3. Deploying to Claude Code&#39;s .claude/agents directory</span>
<span class="sd">4. Environment configuration for agent discovery</span>
<span class="sd">5. Deployment verification and cleanup</span>

<span class="sd">OPERATIONAL CONSIDERATIONS:</span>
<span class="sd">- Deployment is idempotent - safe to run multiple times</span>
<span class="sd">- Version checking prevents unnecessary rebuilds (saves I/O)</span>
<span class="sd">- Supports force rebuild for troubleshooting</span>
<span class="sd">- Maintains backward compatibility with legacy versions</span>
<span class="sd">- Handles migration from old serial versioning to semantic versioning</span>

<span class="sd">MONITORING:</span>
<span class="sd">- Check logs for deployment status and errors</span>
<span class="sd">- Monitor disk space in .claude/agents directory</span>
<span class="sd">- Track version migration progress</span>
<span class="sd">- Verify agent discovery after deployment</span>

<span class="sd">ROLLBACK PROCEDURES:</span>
<span class="sd">- Keep backups of .claude/agents before major updates</span>
<span class="sd">- Use clean_deployment() to remove system agents</span>
<span class="sd">- User-created agents are preserved during cleanup</span>
<span class="sd">- Version tracking allows targeted rollbacks</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.logging_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">log_operation</span><span class="p">,</span> <span class="n">log_performance_context</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentDeploymentError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnvironmentVars</span><span class="p">,</span> <span class="n">Paths</span><span class="p">,</span> <span class="n">AgentMetadata</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.config.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">paths</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TimeoutConfig</span><span class="p">,</span>
    <span class="n">SystemLimits</span><span class="p">,</span>
    <span class="n">ResourceLimits</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.interfaces</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentDeploymentInterface</span>


<div class="viewcode-block" id="AgentDeploymentService">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentDeploymentService</span><span class="p">(</span><span class="n">AgentDeploymentInterface</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service for deploying Claude Code native agents.</span>
<span class="sd">    </span>
<span class="sd">    METRICS COLLECTION OPPORTUNITIES:</span>
<span class="sd">    This service could collect valuable deployment metrics including:</span>
<span class="sd">    - Agent deployment frequency and success rates</span>
<span class="sd">    - Template validation performance  </span>
<span class="sd">    - Version migration patterns</span>
<span class="sd">    - Deployment duration by agent type</span>
<span class="sd">    - Cache hit rates for agent templates</span>
<span class="sd">    - Resource usage during deployment (memory, CPU)</span>
<span class="sd">    - Agent file sizes and complexity metrics</span>
<span class="sd">    - Deployment failure reasons and patterns</span>
<span class="sd">    </span>
<span class="sd">    DEPLOYMENT PIPELINE:</span>
<span class="sd">    1. Initialize with template and base agent paths</span>
<span class="sd">    2. Load base agent configuration (shared settings)</span>
<span class="sd">    3. Iterate through agent templates</span>
<span class="sd">    4. Check version and update requirements</span>
<span class="sd">    5. Build YAML files with proper formatting</span>
<span class="sd">    6. Deploy to target directory</span>
<span class="sd">    7. Set environment variables for discovery</span>
<span class="sd">    8. Verify deployment success</span>
<span class="sd">    </span>
<span class="sd">    ENVIRONMENT REQUIREMENTS:</span>
<span class="sd">    - Write access to .claude/agents directory</span>
<span class="sd">    - Python 3.8+ for pathlib and typing features</span>
<span class="sd">    - JSON parsing for template files</span>
<span class="sd">    - YAML generation capabilities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AgentDeploymentService.__init__">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">base_agent_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize agent deployment service.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            templates_dir: Directory containing agent JSON files</span>
<span class="sd">            base_agent_path: Path to base_agent.md file</span>
<span class="sd">            working_directory: User&#39;s working directory (for project agents)</span>
<span class="sd">            </span>
<span class="sd">        METRICS OPPORTUNITY: Track initialization performance:</span>
<span class="sd">        - Template directory scan time</span>
<span class="sd">        - Base agent loading time</span>
<span class="sd">        - Initial validation overhead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        
        <span class="c1"># METRICS: Initialize deployment metrics tracking</span>
        <span class="c1"># This data structure would be used for collecting deployment telemetry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_deployments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;successful_deployments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;failed_deployments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;migrations_performed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;average_deployment_time_ms&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;deployment_times&#39;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Keep last 100 for rolling average</span>
            <span class="s1">&#39;agent_type_counts&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Track deployments by agent type</span>
            <span class="s1">&#39;version_migration_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;template_validation_times&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Track validation performance</span>
            <span class="s1">&#39;deployment_errors&#39;</span><span class="p">:</span> <span class="p">{}</span>  <span class="c1"># Track error types and frequencies</span>
        <span class="p">}</span>
        
        <span class="c1"># Determine the actual working directory</span>
        <span class="c1"># Priority: working_directory param &gt; CLAUDE_MPM_USER_PWD env var &gt; current directory</span>
        <span class="k">if</span> <span class="n">working_directory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLAUDE_MPM_USER_PWD&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working directory for deployment: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Find templates directory using centralized path management</span>
        <span class="k">if</span> <span class="n">templates_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">templates_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use centralized paths instead of fragile parent calculations</span>
            <span class="c1"># For system agents, still use templates subdirectory</span>
            <span class="c1"># For project/user agents, this should be overridden with actual agents dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">agents_dir</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span>
        
        <span class="c1"># Find base agent file</span>
        <span class="k">if</span> <span class="n">base_agent_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_agent_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use centralized paths for consistency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">agents_dir</span> <span class="o">/</span> <span class="s2">&quot;base_agent.json&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Templates directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="AgentDeploymentService.deploy_agents">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.deploy_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deploy_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">deployment_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_async</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and deploy agents by combining base_agent.md with templates.</span>
<span class="sd">        Also deploys system instructions for PM framework.</span>
<span class="sd">        </span>
<span class="sd">        DEPLOYMENT MODES:</span>
<span class="sd">        - &quot;update&quot;: Normal update mode - skip agents with matching versions (default)</span>
<span class="sd">        - &quot;project&quot;: Project deployment mode - always deploy all agents regardless of version</span>
<span class="sd">        </span>
<span class="sd">        CONFIGURATION:</span>
<span class="sd">        The config parameter or default configuration is used to determine:</span>
<span class="sd">        - Which agents to exclude from deployment</span>
<span class="sd">        - Case sensitivity for agent name matching</span>
<span class="sd">        - Whether to exclude agent dependencies</span>
<span class="sd">        </span>
<span class="sd">        METRICS COLLECTED:</span>
<span class="sd">        - Deployment start/end timestamps</span>
<span class="sd">        - Individual agent deployment durations</span>
<span class="sd">        - Success/failure rates by agent type</span>
<span class="sd">        - Version migration statistics</span>
<span class="sd">        - Template validation performance</span>
<span class="sd">        - Error type frequencies</span>
<span class="sd">        </span>
<span class="sd">        OPERATIONAL FLOW:</span>
<span class="sd">        0. Validates and repairs broken frontmatter in existing agents (Step 0)</span>
<span class="sd">        1. Validates target directory (creates if needed)</span>
<span class="sd">        2. Loads base agent configuration</span>
<span class="sd">        3. Discovers all agent templates</span>
<span class="sd">        4. For each agent:</span>
<span class="sd">           - Checks if update needed (version comparison)</span>
<span class="sd">           - Builds YAML configuration</span>
<span class="sd">           - Writes to target directory</span>
<span class="sd">           - Tracks deployment status</span>
<span class="sd">        </span>
<span class="sd">        PERFORMANCE CONSIDERATIONS:</span>
<span class="sd">        - Skips unchanged agents (version-based caching)</span>
<span class="sd">        - Batch processes all agents in single pass</span>
<span class="sd">        - Minimal file I/O with in-memory building</span>
<span class="sd">        - Parallel-safe (no shared state mutations)</span>
<span class="sd">        </span>
<span class="sd">        ERROR HANDLING:</span>
<span class="sd">        - Continues deployment on individual agent failures</span>
<span class="sd">        - Collects all errors for reporting</span>
<span class="sd">        - Logs detailed error context</span>
<span class="sd">        - Returns comprehensive results dict</span>
<span class="sd">        </span>
<span class="sd">        MONITORING POINTS:</span>
<span class="sd">        - Track total deployment time</span>
<span class="sd">        - Monitor skipped vs updated vs new agents</span>
<span class="sd">        - Check error rates and patterns</span>
<span class="sd">        - Verify migration completion</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_dir: Target directory for agents (default: .claude/agents/)</span>
<span class="sd">            force_rebuild: Force rebuild even if agents exist (useful for troubleshooting)</span>
<span class="sd">            deployment_mode: &quot;update&quot; for version-aware updates, &quot;project&quot; for always deploy</span>
<span class="sd">            config: Optional configuration object (loads default if not provided)</span>
<span class="sd">            use_async: Use async operations for 50-70% faster deployment (default: True)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with deployment results:</span>
<span class="sd">            - target_dir: Deployment location</span>
<span class="sd">            - deployed: List of newly deployed agents</span>
<span class="sd">            - updated: List of updated agents</span>
<span class="sd">            - migrated: List of agents migrated to new version format</span>
<span class="sd">            - skipped: List of unchanged agents</span>
<span class="sd">            - errors: List of deployment errors</span>
<span class="sd">            - total: Total number of agents processed</span>
<span class="sd">            - repaired: List of agents with repaired frontmatter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># METRICS: Record deployment start time for performance tracking</span>
        <span class="n">deployment_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Try async deployment for better performance if requested</span>
        <span class="k">if</span> <span class="n">use_async</span><span class="p">:</span>
            <span class="n">async_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_async_deployment</span><span class="p">(</span>
                <span class="n">target_dir</span><span class="o">=</span><span class="n">target_dir</span><span class="p">,</span>
                <span class="n">force_rebuild</span><span class="o">=</span><span class="n">force_rebuild</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="n">deployment_start_time</span><span class="o">=</span><span class="n">deployment_start_time</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">async_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">async_results</span>
        
        <span class="c1"># Continue with synchronous deployment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using synchronous deployment&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load and process configuration</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">excluded_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_deployment_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        
        <span class="c1"># Determine target agents directory</span>
        <span class="n">agents_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_agents_directory</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
        
        <span class="c1"># Initialize results dictionary</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_deployment_results</span><span class="p">(</span><span class="n">agents_dir</span><span class="p">,</span> <span class="n">deployment_start_time</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create agents directory if needed</span>
            <span class="n">agents_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># STEP 0: Validate and repair broken frontmatter in existing agents</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repair_existing_agents</span><span class="p">(</span><span class="n">agents_dir</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
            
            <span class="c1"># Log deployment source tier</span>
            <span class="n">source_tier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_source_tier</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building and deploying </span><span class="si">{</span><span class="n">source_tier</span><span class="si">}</span><span class="s2"> agents to: </span><span class="si">{</span><span class="n">agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Note: System instructions are now loaded directly by SimpleClaudeRunner</span>
            
            <span class="c1"># Check if templates directory exists</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agents directory not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            
            <span class="c1"># Convert any existing YAML files to MD format</span>
            <span class="n">conversion_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_yaml_to_md</span><span class="p">(</span><span class="n">agents_dir</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;converted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;converted&quot;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># Load base agent content</span>
            <span class="n">base_agent_data</span><span class="p">,</span> <span class="n">base_agent_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_base_agent</span><span class="p">()</span>
            
            <span class="c1"># Get and filter template files</span>
            <span class="n">template_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filtered_templates</span><span class="p">(</span><span class="n">excluded_agents</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_files</span><span class="p">)</span>
            
            <span class="c1"># Deploy each agent template</span>
            <span class="k">for</span> <span class="n">template_file</span> <span class="ow">in</span> <span class="n">template_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deploy_single_agent</span><span class="p">(</span>
                    <span class="n">template_file</span><span class="o">=</span><span class="n">template_file</span><span class="p">,</span>
                    <span class="n">agents_dir</span><span class="o">=</span><span class="n">agents_dir</span><span class="p">,</span>
                    <span class="n">base_agent_data</span><span class="o">=</span><span class="n">base_agent_data</span><span class="p">,</span>
                    <span class="n">base_agent_version</span><span class="o">=</span><span class="n">base_agent_version</span><span class="p">,</span>
                    <span class="n">force_rebuild</span><span class="o">=</span><span class="n">force_rebuild</span><span class="p">,</span>
                    <span class="n">deployment_mode</span><span class="o">=</span><span class="n">deployment_mode</span><span class="p">,</span>
                    <span class="n">results</span><span class="o">=</span><span class="n">results</span>
                <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Deployed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;deployed&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> agents, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;updated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;migrated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;migrated&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;converted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;converted&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> YAML files, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;repaired </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;repaired&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> frontmatter, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;skipped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;skipped&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;errors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="n">AgentDeploymentError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Custom error with context already formatted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Wrap unexpected errors</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agent deployment failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            
            <span class="c1"># METRICS: Track deployment failure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;failed_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_errors&#39;</span><span class="p">][</span><span class="n">error_type</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># METRICS: Calculate final deployment metrics</span>
        <span class="n">deployment_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">deployment_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">deployment_end_time</span> <span class="o">-</span> <span class="n">deployment_start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms</span>
        
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deployment_end_time</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;duration_ms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deployment_duration</span>
        
        <span class="c1"># METRICS: Update rolling averages and statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_deployment_metrics</span><span class="p">(</span><span class="n">deployment_duration</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_deployment_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_ms</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update internal deployment metrics.</span>
<span class="sd">        </span>
<span class="sd">        METRICS TRACKING:</span>
<span class="sd">        - Rolling average of deployment times (last 100)</span>
<span class="sd">        - Success/failure rates</span>
<span class="sd">        - Agent type distribution</span>
<span class="sd">        - Version migration patterns</span>
<span class="sd">        - Error frequency analysis</span>
<span class="sd">        </span>
<span class="sd">        This method demonstrates ETL-like processing:</span>
<span class="sd">        1. Extract: Gather raw metrics from deployment results</span>
<span class="sd">        2. Transform: Calculate averages, rates, and distributions</span>
<span class="sd">        3. Load: Store in internal metrics structure for reporting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update total deployment count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;total_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Track success/failure</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;successful_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;failed_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Update rolling average deployment time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c1"># Keep only last 100 for memory efficiency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        
        <span class="c1"># Calculate new average</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;average_deployment_time_ms&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">])</span> <span class="o">/</span> \
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">])</span>
    
<div class="viewcode-block" id="AgentDeploymentService.get_deployment_metrics">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.get_deployment_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_deployment_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current deployment metrics.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing:</span>
<span class="sd">            - Total deployments and success rates</span>
<span class="sd">            - Average deployment time</span>
<span class="sd">            - Agent type distribution</span>
<span class="sd">            - Migration statistics</span>
<span class="sd">            - Error analysis</span>
<span class="sd">            </span>
<span class="sd">        This demonstrates a metrics API endpoint that could be:</span>
<span class="sd">        - Exposed via REST API for monitoring tools</span>
<span class="sd">        - Pushed to time-series databases (Prometheus, InfluxDB)</span>
<span class="sd">        - Used for dashboards and alerting</span>
<span class="sd">        - Integrated with AI observability platforms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success_rate</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;total_deployments&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">success_rate</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;successful_deployments&#39;</span><span class="p">]</span> <span class="o">/</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;total_deployments&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_deployments&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;total_deployments&#39;</span><span class="p">],</span>
            <span class="s1">&#39;successful_deployments&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;successful_deployments&#39;</span><span class="p">],</span>
            <span class="s1">&#39;failed_deployments&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;failed_deployments&#39;</span><span class="p">],</span>
            <span class="s1">&#39;success_rate_percent&#39;</span><span class="p">:</span> <span class="n">success_rate</span><span class="p">,</span>
            <span class="s1">&#39;average_deployment_time_ms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;average_deployment_time_ms&#39;</span><span class="p">],</span>
            <span class="s1">&#39;migrations_performed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;migrations_performed&#39;</span><span class="p">],</span>
            <span class="s1">&#39;agent_type_distribution&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;agent_type_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;version_migrations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;version_migration_count&#39;</span><span class="p">],</span>
            <span class="s1">&#39;error_distribution&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;recent_deployment_times&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;deployment_times&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>  <span class="c1"># Last 10</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="AgentDeploymentService.reset_metrics">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.reset_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset deployment metrics.</span>
<span class="sd">        </span>
<span class="sd">        Useful for:</span>
<span class="sd">        - Starting fresh metrics collection periods</span>
<span class="sd">        - Testing and development</span>
<span class="sd">        - Scheduled metric rotation (e.g., daily reset)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_deployments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;successful_deployments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;failed_deployments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;migrations_performed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;average_deployment_time_ms&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;deployment_times&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;agent_type_counts&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;version_migration_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;template_validation_times&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;deployment_errors&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deployment metrics reset&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version_marker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract version number from content.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            content: File content</span>
<span class="sd">            version_marker: Version marker to look for (e.g., &quot;AGENT_VERSION:&quot; or &quot;BASE_AGENT_VERSION:&quot;)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Version number or 0 if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;&lt;!-- </span><span class="si">{</span><span class="n">version_marker</span><span class="si">}</span><span class="s2"> (\d+) --&gt;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_agent_markdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">base_agent_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a complete agent markdown file with YAML frontmatter.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_name: Name of the agent</span>
<span class="sd">            template_path: Path to the agent template JSON file</span>
<span class="sd">            base_agent_data: Base agent data from JSON</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Complete agent markdown content with YAML frontmatter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        
        <span class="c1"># Read template JSON</span>
        <span class="n">template_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">template_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        
        <span class="c1"># Extract basic info</span>
        <span class="c1"># Handle both &#39;agent_version&#39; (new format) and &#39;version&#39; (old format)</span>
        <span class="n">agent_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span><span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">base_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span><span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># Format version string as semantic version</span>
        <span class="c1"># Combine base and agent versions for a unified semantic version</span>
        <span class="c1"># Use agent version as primary, with base version in metadata</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">agent_version</span><span class="p">)</span>
        
        <span class="c1"># Build YAML frontmatter</span>
        <span class="c1"># Check new format first (metadata.description), then old format</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="s1">&#39;Agent for specialized tasks&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Get tags from new format (metadata.tags) or old format</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">[</span><span class="n">agent_name</span><span class="p">,</span> <span class="s1">&#39;mpm-framework&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># Get tools from capabilities.tools in new format</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">[</span><span class="s2">&quot;Read&quot;</span><span class="p">,</span> <span class="s2">&quot;Write&quot;</span><span class="p">,</span> <span class="s2">&quot;Edit&quot;</span><span class="p">,</span> <span class="s2">&quot;Grep&quot;</span><span class="p">,</span> <span class="s2">&quot;Glob&quot;</span><span class="p">,</span> <span class="s2">&quot;LS&quot;</span><span class="p">]</span>  <span class="c1"># Default fallback</span>
        <span class="p">)</span>
        
        <span class="c1"># Get model from capabilities.model in new format</span>
        <span class="n">model</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="s2">&quot;sonnet&quot;</span>  <span class="c1"># Default fallback</span>
        <span class="p">)</span>
        
        <span class="c1"># Simplify model name for Claude Code</span>
        <span class="n">model_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;claude-4-sonnet-20250514&#39;</span><span class="p">:</span> <span class="s1">&#39;sonnet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;claude-sonnet-4-20250514&#39;</span><span class="p">:</span> <span class="s1">&#39;sonnet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;claude-opus-4-20250514&#39;</span><span class="p">:</span> <span class="s1">&#39;opus&#39;</span><span class="p">,</span>
            <span class="s1">&#39;claude-3-opus-20240229&#39;</span><span class="p">:</span> <span class="s1">&#39;opus&#39;</span><span class="p">,</span>
            <span class="s1">&#39;claude-3-haiku-20240307&#39;</span><span class="p">:</span> <span class="s1">&#39;haiku&#39;</span><span class="p">,</span>
            <span class="s1">&#39;claude-3.5-sonnet&#39;</span><span class="p">:</span> <span class="s1">&#39;sonnet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;claude-3-sonnet&#39;</span><span class="p">:</span> <span class="s1">&#39;sonnet&#39;</span>
        <span class="p">}</span>
        <span class="c1"># Better fallback: extract the model type (opus/sonnet/haiku) from the string</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_map</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;opus&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;opus&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;sonnet&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;sonnet&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;haiku&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;haiku&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Last resort: try to extract from hyphenated format</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">model_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">model</span> <span class="k">else</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_map</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
        
        <span class="c1"># Get response format from template or use base agent default</span>
        <span class="n">response_format</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;structured&#39;</span><span class="p">)</span>
        
        <span class="c1"># Convert lists to space-separated strings for Claude Code compatibility</span>
        <span class="n">tags_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">tags</span>
        
        <span class="c1"># Convert tools list to comma-separated string for Claude Code compatibility</span>
        <span class="c1"># IMPORTANT: No spaces after commas - Claude Code requires exact format</span>
        <span class="n">tools_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">tools</span>
        
        <span class="c1"># Extract proper agent_id and name from template</span>
        <span class="n">agent_id</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_id&#39;</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">)</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">)</span>
        
        <span class="c1"># Convert agent_id to Claude Code compatible name (replace underscores with hyphens)</span>
        <span class="c1"># Claude Code requires name to match pattern: ^[a-z0-9]+(-[a-z0-9]+)*$</span>
        <span class="n">claude_code_name</span> <span class="o">=</span> <span class="n">agent_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="c1"># Build frontmatter with only the fields Claude Code uses</span>
        <span class="n">frontmatter_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;---&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;name: </span><span class="si">{</span><span class="n">claude_code_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;description: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;version: </span><span class="si">{</span><span class="n">version_string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;base_version: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">base_version</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;author: claude-mpm&quot;</span><span class="p">,</span>  <span class="c1"># Identify as system agent for deployment</span>
            <span class="sa">f</span><span class="s2">&quot;tools: </span><span class="si">{</span><span class="n">tools_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">]</span>
        
        <span class="c1"># Add optional fields if present</span>
        <span class="c1"># Check for color in metadata section (new format) or root (old format)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">frontmatter_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;color: </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">frontmatter_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">frontmatter_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">frontmatter_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="n">frontmatter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frontmatter_lines</span><span class="p">)</span>
        
        <span class="c1"># Get the main content (instructions)</span>
        <span class="c1"># Check multiple possible locations for instructions</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="sa">f</span><span class="s2">&quot;You are the </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> agent. Perform tasks related to </span><span class="si">{</span><span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;your specialization&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">frontmatter</span> <span class="o">+</span> <span class="n">content</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_agent_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">base_agent_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a complete agent YAML file by combining base agent and template.</span>
<span class="sd">        Only includes essential fields for Claude Code best practices.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_name: Name of the agent</span>
<span class="sd">            template_path: Path to the agent template JSON file</span>
<span class="sd">            base_agent_data: Base agent data from JSON</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Complete agent YAML content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        
        <span class="c1"># Read template JSON</span>
        <span class="n">template_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">template_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        
        <span class="c1"># Extract capabilities</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># Extract version information</span>
        <span class="n">agent_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span><span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">agent_version</span><span class="p">)</span>
        
        <span class="c1"># Get tools list</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">tools_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="k">if</span> <span class="n">tools</span> <span class="k">else</span> <span class="s1">&#39;Read, Write, Edit, Grep, Glob, LS&#39;</span>
        
        <span class="c1"># Get description</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> agent for specialized tasks&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Get priority based on agent type</span>
        <span class="n">priority_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;security&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
            <span class="s1">&#39;qa&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;engineer&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
            <span class="s1">&#39;documentation&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
            <span class="s1">&#39;research&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ops&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data_engineer&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
            <span class="s1">&#39;version_control&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
        <span class="p">}</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="n">priority_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;claude-3-5-sonnet-20241022&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get temperature</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Build clean YAML frontmatter with only essential fields</span>
        <span class="n">yaml_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;---</span>
<span class="s2">name: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span>
<span class="s2">description: &quot;</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">version: &quot;</span><span class="si">{</span><span class="n">version_string</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">tools: </span><span class="si">{</span><span class="n">tools_str</span><span class="si">}</span>
<span class="s2">priority: </span><span class="si">{</span><span class="n">priority</span><span class="si">}</span>
<span class="s2">model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span>
<span class="s2">temperature: </span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        
        <span class="c1"># Add allowed_tools if present</span>
        <span class="k">if</span> <span class="s1">&#39;allowed_tools&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
            <span class="n">yaml_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">allowed_tools: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;allowed_tools&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="c1"># Add disallowed_tools if present  </span>
        <span class="k">if</span> <span class="s1">&#39;disallowed_tools&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
            <span class="n">yaml_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">disallowed_tools: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;disallowed_tools&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="n">yaml_content</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># Get instructions from template</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Add base instructions if not already included</span>
        <span class="n">base_instructions</span> <span class="o">=</span> <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_instructions</span> <span class="ow">and</span> <span class="n">base_instructions</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="n">yaml_content</span> <span class="o">+=</span> <span class="n">base_instructions</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            
        <span class="n">yaml_content</span> <span class="o">+=</span> <span class="n">instructions</span>
        
        <span class="k">return</span> <span class="n">yaml_content</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_narrative_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">template_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge narrative fields from base and template, combining arrays.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            base_data: Base agent data</span>
<span class="sd">            template_data: Agent template data</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Merged narrative fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_narrative</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">template_narrative</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="n">merged</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># For narrative fields, combine base + template</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;when_to_use&#39;</span><span class="p">,</span> <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">]:</span>
            <span class="n">base_items</span> <span class="o">=</span> <span class="n">base_narrative</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">template_items</span> <span class="o">=</span> <span class="n">template_narrative</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">merged</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_items</span> <span class="o">+</span> <span class="n">template_items</span>
        
        <span class="c1"># For instructions, combine with separator</span>
        <span class="n">base_instructions</span> <span class="o">=</span> <span class="n">base_narrative</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">template_instructions</span> <span class="o">=</span> <span class="n">template_narrative</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">base_instructions</span> <span class="ow">and</span> <span class="n">template_instructions</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;instructions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_instructions</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">template_instructions</span>
        <span class="k">elif</span> <span class="n">template_instructions</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;instructions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_instructions</span>
        <span class="k">elif</span> <span class="n">base_instructions</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;instructions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_instructions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;instructions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            
        <span class="k">return</span> <span class="n">merged</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_configuration_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">template_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge configuration fields, with template overriding base.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            base_data: Base agent data</span>
<span class="sd">            template_data: Agent template data</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Merged configuration fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">template_config</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># Start with base configuration</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">base_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Override with template-specific configuration</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">template_config</span><span class="p">)</span>
        
        <span class="c1"># Also merge in capabilities from new format if not already in config</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capabilities&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">capabilities</span><span class="p">:</span>
            <span class="c1"># Map capabilities fields to configuration fields</span>
            <span class="k">if</span> <span class="s1">&#39;tools&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;tools&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;tools&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;tools&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;max_tokens&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;max_tokens&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;max_tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;max_tokens&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;temperature&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;temperature&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;memory_limit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;memory_limit&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;memory_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;memory_limit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;cpu_limit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;cpu_limit&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;cpu_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;cpu_limit&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;network_access&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;network_access&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;network_access&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;network_access&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">capabilities</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capabilities</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        
        <span class="c1"># Also check metadata for description and tags in new format</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged</span> <span class="ow">and</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">merged</span>
    
<div class="viewcode-block" id="AgentDeploymentService.set_claude_environment">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.set_claude_environment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_claude_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set Claude environment variables for agent discovery.</span>
<span class="sd">        </span>
<span class="sd">        OPERATIONAL PURPOSE:</span>
<span class="sd">        Claude Code discovers agents through environment variables that</span>
<span class="sd">        point to configuration directories. This method ensures proper</span>
<span class="sd">        environment setup for agent runtime discovery.</span>
<span class="sd">        </span>
<span class="sd">        ENVIRONMENT VARIABLES SET:</span>
<span class="sd">        1. CLAUDE_CONFIG_DIR: Root configuration directory path</span>
<span class="sd">        2. CLAUDE_MAX_PARALLEL_SUBAGENTS: Concurrency limit (default: 5)</span>
<span class="sd">        3. CLAUDE_TIMEOUT: Agent execution timeout (default: 600s)</span>
<span class="sd">        </span>
<span class="sd">        DEPLOYMENT CONSIDERATIONS:</span>
<span class="sd">        - Call after agent deployment for immediate availability</span>
<span class="sd">        - Environment changes affect current process and children</span>
<span class="sd">        - Does not persist across system restarts</span>
<span class="sd">        - Add to shell profile for permanent configuration</span>
<span class="sd">        </span>
<span class="sd">        TROUBLESHOOTING:</span>
<span class="sd">        - Verify with: echo $CLAUDE_CONFIG_DIR</span>
<span class="sd">        - Check agent discovery: ls $CLAUDE_CONFIG_DIR/agents/</span>
<span class="sd">        - Monitor timeout issues in production</span>
<span class="sd">        - Adjust parallel limits based on system resources</span>
<span class="sd">        </span>
<span class="sd">        PERFORMANCE TUNING:</span>
<span class="sd">        - Increase parallel agents for CPU-bound tasks</span>
<span class="sd">        - Reduce for memory-constrained environments</span>
<span class="sd">        - Balance timeout with longest expected operations</span>
<span class="sd">        - Monitor resource usage during parallel execution</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config_dir: Claude configuration directory (default: .claude/)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of environment variables set for verification</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_dir</span><span class="p">:</span>
            <span class="c1"># Use the working directory determined during initialization</span>
            <span class="n">config_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="n">Paths</span><span class="o">.</span><span class="n">CLAUDE_CONFIG_DIR</span><span class="o">.</span><span class="n">value</span>
        
        <span class="n">env_vars</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Set Claude configuration directory</span>
        <span class="n">env_vars</span><span class="p">[</span><span class="n">EnvironmentVars</span><span class="o">.</span><span class="n">CLAUDE_CONFIG_DIR</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
        
        <span class="c1"># Set parallel agent limits</span>
        <span class="n">env_vars</span><span class="p">[</span><span class="n">EnvironmentVars</span><span class="o">.</span><span class="n">CLAUDE_MAX_PARALLEL_SUBAGENTS</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvironmentVars</span><span class="o">.</span><span class="n">DEFAULT_MAX_AGENTS</span><span class="o">.</span><span class="n">value</span>
        
        <span class="c1"># Set timeout for agent execution</span>
        <span class="n">env_vars</span><span class="p">[</span><span class="n">EnvironmentVars</span><span class="o">.</span><span class="n">CLAUDE_TIMEOUT</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvironmentVars</span><span class="o">.</span><span class="n">DEFAULT_TIMEOUT</span><span class="o">.</span><span class="n">value</span>
        
        <span class="c1"># Apply environment variables</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set environment: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">env_vars</span></div>

    
<div class="viewcode-block" id="AgentDeploymentService.verify_deployment">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.verify_deployment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify agent deployment and Claude configuration.</span>
<span class="sd">        </span>
<span class="sd">        OPERATIONAL PURPOSE:</span>
<span class="sd">        Post-deployment verification ensures agents are correctly deployed</span>
<span class="sd">        and discoverable by Claude Code. Critical for deployment validation</span>
<span class="sd">        and troubleshooting runtime issues.</span>
<span class="sd">        </span>
<span class="sd">        VERIFICATION CHECKS:</span>
<span class="sd">        1. Configuration directory exists and is accessible</span>
<span class="sd">        2. Agents directory contains expected YAML files</span>
<span class="sd">        3. Agent files have valid YAML frontmatter</span>
<span class="sd">        4. Version format is current (identifies migration needs)</span>
<span class="sd">        5. Environment variables are properly set</span>
<span class="sd">        </span>
<span class="sd">        MONITORING INTEGRATION:</span>
<span class="sd">        - Call after deployment for health checks</span>
<span class="sd">        - Include in deployment pipelines</span>
<span class="sd">        - Log results for audit trails</span>
<span class="sd">        - Alert on missing agents or errors</span>
<span class="sd">        </span>
<span class="sd">        TROUBLESHOOTING GUIDE:</span>
<span class="sd">        - Missing config_dir: Check deployment target path</span>
<span class="sd">        - No agents found: Verify deployment completed</span>
<span class="sd">        - Migration needed: Run with force_rebuild</span>
<span class="sd">        - Environment warnings: Call set_claude_environment()</span>
<span class="sd">        </span>
<span class="sd">        RESULT INTERPRETATION:</span>
<span class="sd">        - agents_found: Successfully deployed agents</span>
<span class="sd">        - agents_needing_migration: Require version update</span>
<span class="sd">        - warnings: Non-critical issues to address</span>
<span class="sd">        - environment: Current runtime configuration</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config_dir: Claude configuration directory (default: .claude/)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Verification results dictionary:</span>
<span class="sd">            - config_dir: Checked directory path</span>
<span class="sd">            - agents_found: List of discovered agents with metadata</span>
<span class="sd">            - agents_needing_migration: Agents with old version format</span>
<span class="sd">            - environment: Current environment variables</span>
<span class="sd">            - warnings: List of potential issues</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_dir</span><span class="p">:</span>
            <span class="c1"># Use the working directory determined during initialization</span>
            <span class="n">config_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;config_dir&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_dir</span><span class="p">),</span>
            <span class="s2">&quot;agents_found&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;agents_needing_migration&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="c1"># Check configuration directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration directory not found: </span><span class="si">{</span><span class="n">config_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="c1"># Check agents directory</span>
        <span class="n">agents_dir</span> <span class="o">=</span> <span class="n">config_dir</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agents directory not found: </span><span class="si">{</span><span class="n">agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="c1"># List deployed agents</span>
        <span class="n">agent_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">))</span>
        
        <span class="c1"># Get exclusion configuration for logging purposes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
            <span class="n">excluded_agents</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.excluded_agents&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">excluded_agents</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Note: The following agents are configured for exclusion: </span><span class="si">{</span><span class="n">excluded_agents</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Ignore config loading errors in verification</span>
        
        <span class="k">for</span> <span class="n">agent_file</span> <span class="ow">in</span> <span class="n">agent_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Read first few lines to get agent name from YAML</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">agent_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
                    
                <span class="n">agent_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">agent_file</span><span class="p">)</span>
                <span class="p">}</span>
                
                <span class="c1"># Extract name, version, and base_version from YAML frontmatter</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">base_version_str</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;name:&quot;</span><span class="p">):</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;version:&quot;</span><span class="p">):</span>
                        <span class="n">version_str</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_str</span>
                    <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;base_version:&quot;</span><span class="p">):</span>
                        <span class="n">base_version_str</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;base_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_version_str</span>
                
                <span class="c1"># Check if agent needs migration</span>
                <span class="k">if</span> <span class="n">version_str</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_old_version_format</span><span class="p">(</span><span class="n">version_str</span><span class="p">):</span>
                    <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;needs_migration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;agents_needing_migration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;agents_found&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_info</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="n">agent_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check environment variables</span>
        <span class="n">env_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CLAUDE_CONFIG_DIR&quot;</span><span class="p">,</span> <span class="s2">&quot;CLAUDE_MAX_PARALLEL_SUBAGENTS&quot;</span><span class="p">,</span> <span class="s2">&quot;CLAUDE_TIMEOUT&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment variable not set: </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div>

    
<div class="viewcode-block" id="AgentDeploymentService.deploy_agent">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.deploy_agent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deploy_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy a single agent to the specified directory.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_name: Name of the agent to deploy</span>
<span class="sd">            target_dir: Target directory for deployment (Path object)</span>
<span class="sd">            force_rebuild: Whether to force rebuild even if version is current</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if deployment was successful, False otherwise</span>
<span class="sd">            </span>
<span class="sd">        WHY: Single agent deployment because:</span>
<span class="sd">        - Users may want to deploy specific agents only</span>
<span class="sd">        - Reduces deployment time for targeted updates</span>
<span class="sd">        - Enables selective agent management in projects</span>
<span class="sd">        </span>
<span class="sd">        FIXED: Method now correctly handles all internal calls to:</span>
<span class="sd">        - _check_agent_needs_update (with 3 arguments)</span>
<span class="sd">        - _build_agent_markdown (with 3 arguments including base_agent_data)</span>
<span class="sd">        - Properly loads base_agent_data before building agent content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the template file</span>
            <span class="n">template_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">template_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent template not found: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Ensure target directory exists</span>
            <span class="n">agents_dir</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="s1">&#39;.claude&#39;</span> <span class="o">/</span> <span class="s1">&#39;agents&#39;</span>
            <span class="n">agents_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Build and deploy the agent</span>
            <span class="n">target_file</span> <span class="o">=</span> <span class="n">agents_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
            
            <span class="c1"># Check if update is needed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_rebuild</span> <span class="ow">and</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># Load base agent data for version checking</span>
                <span class="n">base_agent_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">base_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                        <span class="n">base_agent_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                        <span class="n">base_agent_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span><span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load base agent for version check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">needs_update</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_agent_needs_update</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">template_file</span><span class="p">,</span> <span class="n">base_agent_version</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">needs_update</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> is up to date&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Load base agent data for building</span>
            <span class="n">base_agent_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                    <span class="n">base_agent_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load base agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Build the agent markdown</span>
            <span class="n">agent_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_agent_markdown</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">template_file</span><span class="p">,</span> <span class="n">base_agent_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_content</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to build agent content for </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            
            <span class="c1"># Write to target file</span>
            <span class="n">target_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">agent_content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully deployed agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="n">AgentDeploymentError</span><span class="p">:</span>
            <span class="c1"># Re-raise our custom exceptions</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Wrap generic exceptions with context</span>
            <span class="k">raise</span> <span class="n">AgentDeploymentError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to deploy agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;agent_name&quot;</span><span class="p">:</span> <span class="n">agent_name</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>

    
<div class="viewcode-block" id="AgentDeploymentService.list_available_agents">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.list_available_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_available_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List available agent templates.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of agent information dictionaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agents directory not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">agents</span>
        
        <span class="n">template_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>
        
        <span class="c1"># Load configuration for exclusions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
            <span class="n">excluded_agents</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.excluded_agents&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.case_sensitive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Normalize excluded agents for comparison</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span><span class="p">:</span>
                <span class="n">excluded_agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">excluded_agents</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If config loading fails, use empty exclusion list</span>
            <span class="n">excluded_agents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">case_sensitive</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Build combined exclusion set</span>
        <span class="n">hardcoded_exclusions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;MEMORIES&quot;</span><span class="p">,</span> <span class="s2">&quot;TODOWRITE&quot;</span><span class="p">,</span> <span class="s2">&quot;INSTRUCTIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;README&quot;</span><span class="p">,</span> <span class="s2">&quot;pm&quot;</span><span class="p">,</span> <span class="s2">&quot;PM&quot;</span><span class="p">,</span> <span class="s2">&quot;project_manager&quot;</span><span class="p">}</span>
        
        <span class="c1"># Filter out excluded agents</span>
        <span class="n">filtered_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">template_files</span><span class="p">:</span>
            <span class="n">agent_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span>
            
            <span class="c1"># Check hardcoded exclusions</span>
            <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">hardcoded_exclusions</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check file patterns</span>
            <span class="k">if</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.backup&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check user-configured exclusions</span>
            <span class="n">compare_name</span> <span class="o">=</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="n">agent_name</span>
            <span class="k">if</span> <span class="n">compare_name</span> <span class="ow">in</span> <span class="n">excluded_agents</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">filtered_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="n">template_files</span> <span class="o">=</span> <span class="n">filtered_files</span>
        
        <span class="k">for</span> <span class="n">template_file</span> <span class="ow">in</span> <span class="n">template_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">agent_name</span> <span class="o">=</span> <span class="n">template_file</span><span class="o">.</span><span class="n">stem</span>
                <span class="n">agent_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">agent_name</span><span class="p">,</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">template_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">template_file</span><span class="p">),</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">template_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> agent for specialized tasks&quot;</span>
                <span class="p">}</span>
                
                <span class="c1"># Try to extract metadata from template JSON</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                    <span class="n">template_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">template_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                    
                    <span class="c1"># Handle different schema formats</span>
                    <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">template_data</span><span class="p">:</span>
                        <span class="c1"># New schema format</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;specializations&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;specializations&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;configuration_fields&#39;</span> <span class="ow">in</span> <span class="n">template_data</span><span class="p">:</span>
                        <span class="c1"># Old schema format</span>
                        <span class="n">config_fields</span> <span class="o">=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;configuration_fields&#39;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;primary_role&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
                    
                    <span class="c1"># Handle both &#39;agent_version&#39; (new format) and &#39;version&#39; (old format)</span>
                    <span class="n">version_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span><span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">version_tuple</span><span class="p">)</span>
                
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Use defaults if can&#39;t parse</span>
                
                <span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_info</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read template </span><span class="si">{</span><span class="n">template_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">agents</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_agent_needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployed_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">template_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">current_base_version</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a deployed agent needs to be updated.</span>
<span class="sd">        </span>
<span class="sd">        OPERATIONAL LOGIC:</span>
<span class="sd">        1. Verifies agent is system-managed (claude-mpm authored)</span>
<span class="sd">        2. Extracts version from deployed YAML frontmatter</span>
<span class="sd">        3. Detects old version formats requiring migration</span>
<span class="sd">        4. Compares semantic versions for update decision</span>
<span class="sd">        5. Returns detailed reason for update/skip decision</span>
<span class="sd">        </span>
<span class="sd">        VERSION MIGRATION STRATEGY:</span>
<span class="sd">        - Old serial format (0002-0005) -&gt; Semantic (2.5.0)</span>
<span class="sd">        - Missing versions -&gt; Force update to latest</span>
<span class="sd">        - Non-semantic formats -&gt; Trigger migration</span>
<span class="sd">        - Preserves user modifications (non-system agents)</span>
<span class="sd">        </span>
<span class="sd">        PERFORMANCE OPTIMIZATION:</span>
<span class="sd">        - Early exit for non-system agents</span>
<span class="sd">        - Regex compilation cached by Python</span>
<span class="sd">        - Minimal file reads (frontmatter only)</span>
<span class="sd">        - Version comparison without full parse</span>
<span class="sd">        </span>
<span class="sd">        ERROR RECOVERY:</span>
<span class="sd">        - Assumes update needed on parse failures</span>
<span class="sd">        - Logs warnings for investigation</span>
<span class="sd">        - Never blocks deployment pipeline</span>
<span class="sd">        - Safe fallback to force update</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            deployed_file: Path to the deployed agent file</span>
<span class="sd">            template_file: Path to the template file</span>
<span class="sd">            current_base_version: Current base agent version (unused in new strategy)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (needs_update: bool, reason: str)</span>
<span class="sd">            - needs_update: True if agent should be redeployed</span>
<span class="sd">            - reason: Human-readable explanation for decision</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read deployed agent content</span>
            <span class="n">deployed_content</span> <span class="o">=</span> <span class="n">deployed_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            
            <span class="c1"># Check if it&#39;s a system agent (authored by claude-mpm)</span>
            <span class="k">if</span> <span class="s2">&quot;claude-mpm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deployed_content</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;not a system agent&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract version info from YAML frontmatter</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
            
            <span class="c1"># Check if using old serial format first</span>
            <span class="n">is_old_format</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">old_version_str</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Try legacy combined format (e.g., &quot;0002-0005&quot;)</span>
            <span class="n">legacy_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^version:\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]?(\d+)-(\d+)[&quot;</span><span class="se">\&#39;</span><span class="s1">]?&#39;</span><span class="p">,</span> <span class="n">deployed_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">legacy_match</span><span class="p">:</span>
                <span class="n">is_old_format</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">old_version_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">legacy_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">legacy_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># Convert legacy format to semantic version</span>
                <span class="c1"># Treat the agent version (second number) as minor version</span>
                <span class="n">deployed_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">legacy_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected old serial version format: </span><span class="si">{</span><span class="n">old_version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to extract semantic version format (e.g., &quot;2.1.0&quot;)</span>
                <span class="n">version_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^version:\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]?v?(\d+)\.(\d+)\.(\d+)[&quot;</span><span class="se">\&#39;</span><span class="s1">]?&#39;</span><span class="p">,</span> <span class="n">deployed_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">version_match</span><span class="p">:</span>
                    <span class="n">deployed_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback: try separate fields (very old format)</span>
                    <span class="n">agent_version_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^agent_version:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">deployed_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">agent_version_match</span><span class="p">:</span>
                        <span class="n">is_old_format</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">old_version_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;agent_version: </span><span class="si">{</span><span class="n">agent_version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">deployed_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">agent_version_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected old separate version format: </span><span class="si">{</span><span class="n">old_version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Check for missing version field</span>
                        <span class="k">if</span> <span class="s2">&quot;version:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deployed_content</span><span class="p">:</span>
                            <span class="n">is_old_format</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">old_version_str</span> <span class="o">=</span> <span class="s2">&quot;missing&quot;</span>
                            <span class="n">deployed_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detected missing version field&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">deployed_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># For base version, we don&#39;t need to extract from deployed file anymore</span>
            <span class="c1"># as it&#39;s tracked in metadata</span>
            
            <span class="c1"># Read template to get current agent version</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
            <span class="n">template_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">template_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
            
            <span class="c1"># Extract agent version from template (handle both numeric and semantic versioning)</span>
            <span class="n">current_agent_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span><span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">template_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            
            <span class="c1"># Compare semantic versions properly</span>
            <span class="c1"># Semantic version comparison: compare major, then minor, then patch</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">compare_versions</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">v2</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Compare two version tuples. Returns -1 if v1 &lt; v2, 0 if equal, 1 if v1 &gt; v2.&quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
                        <span class="k">return</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="mi">0</span>
            
            <span class="c1"># If old format detected, always trigger update for migration</span>
            <span class="k">if</span> <span class="n">is_old_format</span><span class="p">:</span>
                <span class="n">new_version_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">current_agent_version</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;migration needed from old format (</span><span class="si">{</span><span class="n">old_version_str</span><span class="si">}</span><span class="s2">) to semantic version (</span><span class="si">{</span><span class="n">new_version_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check if agent template version is newer</span>
            <span class="k">if</span> <span class="n">compare_versions</span><span class="p">(</span><span class="n">current_agent_version</span><span class="p">,</span> <span class="n">deployed_agent_version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">deployed_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">deployed_agent_version</span><span class="p">)</span>
                <span class="n">current_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">current_agent_version</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;agent template updated (</span><span class="si">{</span><span class="n">deployed_str</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">current_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            
            <span class="c1"># Note: We no longer check base agent version separately since we&#39;re using</span>
            <span class="c1"># a unified semantic version for the agent</span>
            
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;up to date&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking agent update status: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># On error, assume update is needed</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;version check failed&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="AgentDeploymentService.clean_deployment">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.clean_deployment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up deployed agents.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config_dir: Claude configuration directory (default: .claude/)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Cleanup results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_dir</span><span class="p">:</span>
            <span class="c1"># Use the working directory determined during initialization</span>
            <span class="n">config_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;removed&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="n">agents_dir</span> <span class="o">=</span> <span class="n">config_dir</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agents directory not found: </span><span class="si">{</span><span class="n">agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="c1"># Remove system agents only (identified by claude-mpm author)</span>
        <span class="n">agent_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">agent_file</span> <span class="ow">in</span> <span class="n">agent_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if it&#39;s a system agent</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">agent_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;author: claude-mpm&quot;</span> <span class="ow">in</span> <span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;author: &#39;claude-mpm&#39;&quot;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                        <span class="n">agent_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;removed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">agent_file</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed agent: </span><span class="si">{</span><span class="n">agent_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to remove </span><span class="si">{</span><span class="n">agent_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="c1"># Not raising AgentDeploymentError here to continue cleanup</span>
        
        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_agent_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract metadata from simplified agent template content.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            template_content: Agent template markdown content</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of extracted metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">template_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Extract sections based on the new simplified format</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">section_content</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## When to Use&#39;</span><span class="p">):</span>
                <span class="c1"># Save previous section before starting new one</span>
                <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">section_content</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s1">&#39;when_to_use&#39;</span>
                <span class="n">section_content</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## Specialized Knowledge&#39;</span><span class="p">):</span>
                <span class="c1"># Save previous section before starting new one</span>
                <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">section_content</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s1">&#39;specialized_knowledge&#39;</span>
                <span class="n">section_content</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## Unique Capabilities&#39;</span><span class="p">):</span>
                <span class="c1"># Save previous section before starting new one</span>
                <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">section_content</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s1">&#39;unique_capabilities&#39;</span>
                <span class="n">section_content</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;# &#39;</span><span class="p">):</span>
                <span class="c1"># End of section - save current section</span>
                <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">section_content</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">section_content</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">):</span>
                <span class="c1"># Extract list item, removing the &quot;- &quot; prefix</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">section_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
        <span class="c1"># Handle last section if file ends without another header</span>
        <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">section_content</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Ensure all required fields have defaults</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;when_to_use&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;unique_capabilities&#39;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="k">return</span> <span class="n">metadata</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get appropriate tools for an agent based on its type.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_name: Name of the agent</span>
<span class="sd">            metadata: Agent metadata</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of tool names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base tools all agents should have</span>
        <span class="n">base_tools</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Read&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Write&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;Edit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MultiEdit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Grep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Glob&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TodoWrite&quot;</span>
        <span class="p">]</span>
        
        <span class="c1"># Agent-specific tools</span>
        <span class="n">agent_tools</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;engineer&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">,</span> <span class="s2">&quot;WebSearch&quot;</span><span class="p">,</span> <span class="s2">&quot;WebFetch&quot;</span><span class="p">],</span>
            <span class="s1">&#39;qa&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">,</span> <span class="s2">&quot;WebSearch&quot;</span><span class="p">],</span>
            <span class="s1">&#39;documentation&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;WebSearch&quot;</span><span class="p">,</span> <span class="s2">&quot;WebFetch&quot;</span><span class="p">],</span>
            <span class="s1">&#39;research&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;WebSearch&quot;</span><span class="p">,</span> <span class="s2">&quot;WebFetch&quot;</span><span class="p">,</span> <span class="s2">&quot;Bash&quot;</span><span class="p">],</span>
            <span class="s1">&#39;security&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">,</span> <span class="s2">&quot;WebSearch&quot;</span><span class="p">,</span> <span class="s2">&quot;Grep&quot;</span><span class="p">],</span>
            <span class="s1">&#39;ops&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">,</span> <span class="s2">&quot;WebSearch&quot;</span><span class="p">],</span>
            <span class="s1">&#39;data_engineer&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">,</span> <span class="s2">&quot;WebSearch&quot;</span><span class="p">],</span>
            <span class="s1">&#39;version_control&#39;</span><span class="p">:</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="c1"># Return specific tools or default set</span>
        <span class="k">return</span> <span class="n">agent_tools</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">base_tools</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Bash&quot;</span><span class="p">,</span> <span class="s2">&quot;WebSearch&quot;</span><span class="p">])</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_version_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_tuple</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format version tuple for display.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            version_tuple: Tuple of (major, minor, patch)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Formatted version string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version_tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">version_tuple</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">version_tuple</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">minor</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">patch</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for legacy format</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_tuple</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_old_version_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a version string is in the old serial format.</span>
<span class="sd">        </span>
<span class="sd">        Old formats include:</span>
<span class="sd">        - Serial format: &quot;0002-0005&quot; (contains hyphen, all digits)</span>
<span class="sd">        - Missing version field</span>
<span class="sd">        - Non-semantic version formats</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            version_str: Version string to check</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if old format, False if semantic version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        
        <span class="c1"># Check for serial format (e.g., &quot;0002-0005&quot;)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d+-\d+$&#39;</span><span class="p">,</span> <span class="n">version_str</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="c1"># Check for semantic version format (e.g., &quot;2.1.0&quot;)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^v?\d+\.\d+\.\d+$&#39;</span><span class="p">,</span> <span class="n">version_str</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="c1"># Any other format is considered old</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse version from various formats to semantic version tuple.</span>
<span class="sd">        </span>
<span class="sd">        Handles:</span>
<span class="sd">        - Integer values: 5 -&gt; (0, 5, 0)</span>
<span class="sd">        - String integers: &quot;5&quot; -&gt; (0, 5, 0)</span>
<span class="sd">        - Semantic versions: &quot;2.1.0&quot; -&gt; (2, 1, 0)</span>
<span class="sd">        - Invalid formats: returns (0, 0, 0)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            version_value: Version in various formats</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (major, minor, patch) for comparison</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version_value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># Legacy integer version - treat as minor version</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">version_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Try to parse as simple integer</span>
            <span class="k">if</span> <span class="n">version_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_value</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Try to parse semantic version (e.g., &quot;2.1.0&quot; or &quot;v2.1.0&quot;)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
            <span class="n">sem_ver_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^v?(\d+)\.(\d+)\.(\d+)&#39;</span><span class="p">,</span> <span class="n">version_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sem_ver_match</span><span class="p">:</span>
                <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sem_ver_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">minor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sem_ver_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sem_ver_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span>
            
            <span class="c1"># Try to extract first number from string as minor version</span>
            <span class="n">num_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">,</span> <span class="n">version_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_match</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Default to 0.0.0 for invalid formats</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_yaml_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format a list for YAML with proper indentation.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            items: List of items</span>
<span class="sd">            indent: Number of spaces to indent</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Formatted YAML list string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;No items specified&quot;</span><span class="p">]</span>
        
        <span class="n">indent_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>
        <span class="n">formatted_items</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="c1"># Escape quotes in the item</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">formatted_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent_str</span><span class="si">}</span><span class="s1">- &quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_items</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_specific_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get agent-specific configuration based on agent type.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_name: Name of the agent</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of agent-specific configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Base configuration all agents share</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">TimeoutConfig</span><span class="o">.</span><span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
            <span class="s1">&#39;max_tokens&#39;</span><span class="p">:</span> <span class="n">SystemLimits</span><span class="o">.</span><span class="n">MAX_TOKEN_LIMIT</span><span class="p">,</span>
            <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="n">ResourceLimits</span><span class="o">.</span><span class="n">STANDARD_MEMORY_RANGE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># Use lower bound of standard memory</span>
            <span class="s1">&#39;cpu_limit&#39;</span><span class="p">:</span> <span class="n">ResourceLimits</span><span class="o">.</span><span class="n">STANDARD_CPU_RANGE</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Use upper bound of standard CPU</span>
            <span class="s1">&#39;network_access&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># Agent-specific configurations</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;engineer&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Code implementation, development, and inline documentation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;engineer&quot;, &quot;development&quot;, &quot;coding&quot;, &quot;implementation&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;MultiEdit&quot;, &quot;Bash&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;WebSearch&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Code implementation needed&#39;</span><span class="p">,</span> <span class="s1">&#39;Bug fixes required&#39;</span><span class="p">,</span> <span class="s1">&#39;Refactoring tasks&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Programming best practices&#39;</span><span class="p">,</span> <span class="s1">&#39;Design patterns&#39;</span><span class="p">,</span> <span class="s1">&#39;Code optimization&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Write production code&#39;</span><span class="p">,</span> <span class="s1">&#39;Debug complex issues&#39;</span><span class="p">,</span> <span class="s1">&#39;Refactor codebases&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Code implementation and development&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;coding&quot;, &quot;debugging&quot;, &quot;refactoring&quot;, &quot;optimization&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL code implementation decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;qa&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Quality assurance, testing, and validation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;qa&quot;, &quot;testing&quot;, &quot;quality&quot;, &quot;validation&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;Bash&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Testing needed&#39;</span><span class="p">,</span> <span class="s1">&#39;Quality validation&#39;</span><span class="p">,</span> <span class="s1">&#39;Test coverage analysis&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Testing methodologies&#39;</span><span class="p">,</span> <span class="s1">&#39;Quality metrics&#39;</span><span class="p">,</span> <span class="s1">&#39;Test automation&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Execute test suites&#39;</span><span class="p">,</span> <span class="s1">&#39;Identify edge cases&#39;</span><span class="p">,</span> <span class="s1">&#39;Validate quality&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Testing and quality assurance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;testing&quot;, &quot;validation&quot;, &quot;quality-assurance&quot;, &quot;coverage&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL testing and quality decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;documentation&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Documentation creation, maintenance, and changelog generation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;documentation&quot;, &quot;writing&quot;, &quot;changelog&quot;, &quot;docs&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;MultiEdit&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;WebSearch&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Documentation updates needed&#39;</span><span class="p">,</span> <span class="s1">&#39;Changelog generation&#39;</span><span class="p">,</span> <span class="s1">&#39;README updates&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Technical writing&#39;</span><span class="p">,</span> <span class="s1">&#39;Documentation standards&#39;</span><span class="p">,</span> <span class="s1">&#39;Semantic versioning&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Create clear documentation&#39;</span><span class="p">,</span> <span class="s1">&#39;Generate changelogs&#39;</span><span class="p">,</span> <span class="s1">&#39;Maintain docs&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Documentation and technical writing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;technical-writing&quot;, &quot;changelog&quot;, &quot;api-docs&quot;, &quot;guides&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL documentation decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;research&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Technical research, analysis, and investigation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;research&quot;, &quot;analysis&quot;, &quot;investigation&quot;, &quot;evaluation&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;WebSearch&quot;, &quot;WebFetch&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Technical research needed&#39;</span><span class="p">,</span> <span class="s1">&#39;Solution evaluation&#39;</span><span class="p">,</span> <span class="s1">&#39;Best practices investigation&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Research methodologies&#39;</span><span class="p">,</span> <span class="s1">&#39;Technical analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;Evaluation frameworks&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Deep investigation&#39;</span><span class="p">,</span> <span class="s1">&#39;Comparative analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;Evidence-based recommendations&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Research and technical analysis&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;investigation&quot;, &quot;analysis&quot;, &quot;evaluation&quot;, &quot;recommendations&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL research decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;security&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Security analysis, vulnerability assessment, and protection&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;security&quot;, &quot;vulnerability&quot;, &quot;protection&quot;, &quot;audit&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;Bash&quot;, &quot;WebSearch&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Security review needed&#39;</span><span class="p">,</span> <span class="s1">&#39;Vulnerability assessment&#39;</span><span class="p">,</span> <span class="s1">&#39;Security audit&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Security best practices&#39;</span><span class="p">,</span> <span class="s1">&#39;OWASP guidelines&#39;</span><span class="p">,</span> <span class="s1">&#39;Vulnerability patterns&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Identify vulnerabilities&#39;</span><span class="p">,</span> <span class="s1">&#39;Security auditing&#39;</span><span class="p">,</span> <span class="s1">&#39;Threat modeling&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Security analysis and protection&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;vulnerability-assessment&quot;, &quot;security-audit&quot;, &quot;threat-modeling&quot;, &quot;protection&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL security decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;ops&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Deployment, operations, and infrastructure management&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;ops&quot;, &quot;deployment&quot;, &quot;infrastructure&quot;, &quot;devops&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;Bash&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Deployment configuration&#39;</span><span class="p">,</span> <span class="s1">&#39;Infrastructure setup&#39;</span><span class="p">,</span> <span class="s1">&#39;CI/CD pipeline work&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Deployment best practices&#39;</span><span class="p">,</span> <span class="s1">&#39;Infrastructure as code&#39;</span><span class="p">,</span> <span class="s1">&#39;CI/CD&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Configure deployments&#39;</span><span class="p">,</span> <span class="s1">&#39;Manage infrastructure&#39;</span><span class="p">,</span> <span class="s1">&#39;Automate operations&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Operations and deployment management&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;deployment&quot;, &quot;infrastructure&quot;, &quot;automation&quot;, &quot;monitoring&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL operations decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;data_engineer&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Data pipeline management and AI API integrations&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;data&quot;, &quot;pipeline&quot;, &quot;etl&quot;, &quot;ai-integration&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;Bash&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;WebSearch&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Data pipeline setup&#39;</span><span class="p">,</span> <span class="s1">&#39;Database design&#39;</span><span class="p">,</span> <span class="s1">&#39;AI API integration&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Data architectures&#39;</span><span class="p">,</span> <span class="s1">&#39;ETL processes&#39;</span><span class="p">,</span> <span class="s1">&#39;AI/ML APIs&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Design data schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;Build pipelines&#39;</span><span class="p">,</span> <span class="s1">&#39;Integrate AI services&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Data engineering and AI integration&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;data-pipelines&quot;, &quot;etl&quot;, &quot;database&quot;, &quot;ai-integration&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL data engineering decisions&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s1">&#39;version_control&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Git operations, version management, and release coordination&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;git&quot;, &quot;version-control&quot;, &quot;release&quot;, &quot;branching&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Bash&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;network_access&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Git operations are local</span>
                <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Git operations needed&#39;</span><span class="p">,</span> <span class="s1">&#39;Version bumping&#39;</span><span class="p">,</span> <span class="s1">&#39;Release management&#39;</span><span class="p">],</span>
                <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Git workflows&#39;</span><span class="p">,</span> <span class="s1">&#39;Semantic versioning&#39;</span><span class="p">,</span> <span class="s1">&#39;Release processes&#39;</span><span class="p">],</span>
                <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Complex git operations&#39;</span><span class="p">,</span> <span class="s1">&#39;Version management&#39;</span><span class="p">,</span> <span class="s1">&#39;Release coordination&#39;</span><span class="p">],</span>
                <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="s1">&#39;Version control and release management&#39;</span><span class="p">,</span>
                <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;git&quot;, &quot;versioning&quot;, &quot;branching&quot;, &quot;releases&quot;]&#39;</span><span class="p">,</span>
                <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="s1">&#39;ALL version control decisions&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1"># Return the specific config or a default</span>
        <span class="k">return</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> agent for specialized tasks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;[&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s1">&quot;, &quot;specialized&quot;, &quot;mpm&quot;]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tools&#39;</span><span class="p">:</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;, &quot;TodoWrite&quot;]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s1">&#39;when_to_use&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;When </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s1"> expertise is needed&#39;</span><span class="p">],</span>
            <span class="s1">&#39;specialized_knowledge&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> domain knowledge&#39;</span><span class="p">],</span>
            <span class="s1">&#39;unique_capabilities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> specialized operations&#39;</span><span class="p">],</span>
            <span class="s1">&#39;primary_role&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> operations&#39;</span><span class="p">,</span>
            <span class="s1">&#39;specializations&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;[&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s1">&quot;]&#39;</span><span class="p">,</span>
            <span class="s1">&#39;authority&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;ALL </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s1"> decisions&#39;</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_deploy_system_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy system instructions for PM framework.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_dir: Target directory for deployment</span>
<span class="sd">            force_rebuild: Force rebuild even if exists</span>
<span class="sd">            results: Results dictionary to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the INSTRUCTIONS.md file</span>
            <span class="n">module_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">instructions_path</span> <span class="o">=</span> <span class="n">module_path</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;INSTRUCTIONS.md&quot;</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instructions_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System instructions not found: </span><span class="si">{</span><span class="n">instructions_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Target file for system instructions - use CLAUDE.md in user&#39;s home .claude directory</span>
            <span class="n">target_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;~/.claude/CLAUDE.md&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
            
            <span class="c1"># Ensure .claude directory exists</span>
            <span class="n">target_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Check if update needed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_rebuild</span> <span class="ow">and</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># Compare modification times</span>
                <span class="k">if</span> <span class="n">target_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;=</span> <span class="n">instructions_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CLAUDE.md&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System instructions up to date&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            
            <span class="c1"># Read and deploy system instructions</span>
            <span class="n">instructions_content</span> <span class="o">=</span> <span class="n">instructions_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            <span class="n">target_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">instructions_content</span><span class="p">)</span>
            
            <span class="n">is_update</span> <span class="o">=</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CLAUDE.md&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">instructions_path</span><span class="p">),</span>
                    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
                <span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated system instructions&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;deployed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CLAUDE.md&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">instructions_path</span><span class="p">),</span> 
                    <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
                <span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deployed system instructions&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to deploy system instructions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="c1"># Not raising AgentDeploymentError as this is non-critical</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_yaml_to_md</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert existing YAML agent files to MD format with YAML frontmatter.</span>
<span class="sd">        </span>
<span class="sd">        This method handles backward compatibility by finding existing .yaml</span>
<span class="sd">        agent files and converting them to .md format expected by Claude Code.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_dir: Directory containing agent files</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with conversion results:</span>
<span class="sd">            - converted: List of converted files</span>
<span class="sd">            - errors: List of conversion errors</span>
<span class="sd">            - skipped: List of files that didn&#39;t need conversion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;converted&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find existing YAML agent files</span>
            <span class="n">yaml_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.yaml&quot;</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No YAML files found to convert&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">yaml_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> YAML files to convert to MD format&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">yaml_file</span> <span class="ow">in</span> <span class="n">yaml_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">stem</span>
                    <span class="n">md_file</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
                    
                    <span class="c1"># Skip if MD file already exists (unless it&#39;s older than YAML)</span>
                    <span class="k">if</span> <span class="n">md_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="c1"># Check modification times for safety</span>
                        <span class="n">yaml_mtime</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
                        <span class="n">md_mtime</span> <span class="o">=</span> <span class="n">md_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
                        
                        <span class="k">if</span> <span class="n">md_mtime</span> <span class="o">&gt;=</span> <span class="n">yaml_mtime</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;yaml_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">),</span>
                                <span class="s2">&quot;md_file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">md_file</span><span class="p">),</span>
                                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;MD file already exists and is newer&quot;</span>
                            <span class="p">})</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># MD file is older, proceed with conversion</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MD file </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is older than YAML, converting...&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Read YAML content</span>
                    <span class="n">yaml_content</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                    
                    <span class="c1"># Convert YAML to MD with YAML frontmatter</span>
                    <span class="n">md_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_yaml_content_to_md</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">)</span>
                    
                    <span class="c1"># Write MD file</span>
                    <span class="n">md_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">md_content</span><span class="p">)</span>
                    
                    <span class="c1"># Create backup of YAML file before removing (for safety)</span>
                    <span class="n">backup_file</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">.yaml.backup&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">yaml_file</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">backup_file</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created backup: </span><span class="si">{</span><span class="n">backup_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">backup_error</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create backup for </span><span class="si">{</span><span class="n">yaml_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">backup_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Still remove the original YAML file even if backup fails</span>
                        <span class="n">yaml_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;converted&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">),</span>
                        <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">md_file</span><span class="p">),</span>
                        <span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="n">agent_name</span>
                    <span class="p">})</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">yaml_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to convert </span><span class="si">{</span><span class="n">yaml_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;YAML to MD conversion failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_yaml_content_to_md</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert YAML agent content to MD format with YAML frontmatter.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            yaml_content: Original YAML content</span>
<span class="sd">            agent_name: Name of the agent</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Markdown content with YAML frontmatter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
        
        <span class="c1"># Extract YAML frontmatter and content</span>
        <span class="n">yaml_parts</span> <span class="o">=</span> <span class="n">yaml_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yaml_parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># No proper YAML frontmatter, treat entire content as instructions</span>
            <span class="n">frontmatter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;---</span>
<span class="s2">name: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span>
<span class="s2">description: &quot;Agent for specialized tasks&quot;</span>
<span class="s2">version: &quot;1.0.0&quot;</span>
<span class="s2">author: &quot;claude-mpm@anthropic.com&quot;</span>
<span class="s2">created: &quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">Z&quot;</span>
<span class="s2">updated: &quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">Z&quot;</span>
<span class="s2">tags: [&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;, &quot;mpm-framework&quot;]</span>
<span class="s2">tools: [&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;]</span>
<span class="s2">metadata:</span>
<span class="s2">  deployment_type: &quot;system&quot;</span>
<span class="s2">  converted_from: &quot;yaml&quot;</span>
<span class="s2">---</span>

<span class="s2">&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">frontmatter</span> <span class="o">+</span> <span class="n">yaml_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Parse existing frontmatter</span>
        <span class="n">yaml_frontmatter</span> <span class="o">=</span> <span class="n">yaml_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="n">yaml_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Extract key fields from YAML frontmatter</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">agent_name</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_yaml_field</span><span class="p">(</span><span class="n">yaml_frontmatter</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> agent for specialized tasks&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_yaml_field</span><span class="p">(</span><span class="n">yaml_frontmatter</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;1.0.0&quot;</span>
        <span class="n">tools_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_yaml_field</span><span class="p">(</span><span class="n">yaml_frontmatter</span><span class="p">,</span> <span class="s1">&#39;tools&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;Read, Write, Edit, Grep, Glob, LS&quot;</span>
        
        <span class="c1"># Convert tools string to list format</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools_line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tools_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tools_line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">):</span>
                <span class="c1"># Already in list format</span>
                <span class="n">tools_list</span> <span class="o">=</span> <span class="n">tools_line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Convert comma-separated to list</span>
                <span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="n">tools_list</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tools_list</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tools_line</span><span class="p">)</span> <span class="k">if</span> <span class="n">tools_line</span> <span class="k">else</span> <span class="s1">&#39;[&quot;Read&quot;, &quot;Write&quot;, &quot;Edit&quot;, &quot;Grep&quot;, &quot;Glob&quot;, &quot;LS&quot;]&#39;</span>
        
        <span class="c1"># Build new YAML frontmatter</span>
        <span class="n">new_frontmatter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;---</span>
<span class="s2">name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span>
<span class="s2">description: &quot;</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">version: &quot;</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">author: &quot;claude-mpm@anthropic.com&quot;</span>
<span class="s2">created: &quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">Z&quot;</span>
<span class="s2">updated: &quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">Z&quot;</span>
<span class="s2">tags: [&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;, &quot;mpm-framework&quot;]</span>
<span class="s2">tools: </span><span class="si">{</span><span class="n">tools_list</span><span class="si">}</span>
<span class="s2">metadata:</span>
<span class="s2">  deployment_type: &quot;system&quot;</span>
<span class="s2">  converted_from: &quot;yaml&quot;</span>
<span class="s2">---</span>

<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="n">new_frontmatter</span> <span class="o">+</span> <span class="n">instructions</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_yaml_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a field value from YAML content.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            yaml_content: YAML content string</span>
<span class="sd">            field_name: Field name to extract</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Field value or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Match field with quoted or unquoted values</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;^</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">:\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]?(.*?)[&quot;</span><span class="se">\&#39;</span><span class="s1">]?\s*$&#39;</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># Try with alternative spacing patterns</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;^</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">\s*:\s*(.+)$&#39;</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">yaml_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Remove quotes if present</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">value</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error extracting YAML field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_try_async_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> 
                              <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">],</span> <span class="n">deployment_start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to use async deployment for better performance.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Async deployment is 50-70% faster than synchronous deployment</span>
<span class="sd">        by using concurrent operations for file I/O and processing.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_dir: Target directory for deployment</span>
<span class="sd">            force_rebuild: Whether to force rebuild</span>
<span class="sd">            config: Configuration object</span>
<span class="sd">            deployment_start_time: Start time for metrics</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Deployment results if successful, None if async not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.async_agent_deployment</span><span class="w"> </span><span class="kn">import</span> <span class="n">deploy_agents_async_wrapper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using async deployment for improved performance&quot;</span><span class="p">)</span>
            
            <span class="c1"># Run async deployment</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">deploy_agents_async_wrapper</span><span class="p">(</span>
                <span class="n">templates_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="p">,</span>
                <span class="n">base_agent_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="p">,</span>
                <span class="n">working_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                <span class="n">target_dir</span><span class="o">=</span><span class="n">target_dir</span><span class="p">,</span>
                <span class="n">force_rebuild</span><span class="o">=</span><span class="n">force_rebuild</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">config</span>
            <span class="p">)</span>
            
            <span class="c1"># Add metrics about async vs sync</span>
            <span class="k">if</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;deployment_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;async&#39;</span>
                <span class="n">duration_ms</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async deployment completed in </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
                
                <span class="c1"># Update internal metrics</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;total_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;successful_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;failed_deployments&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">return</span> <span class="n">results</span>
            
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Async deployment not available, falling back to sync&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async deployment failed, falling back to sync: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_deployment_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and process deployment configuration.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized configuration loading reduces duplication</span>
<span class="sd">        and ensures consistent handling of exclusion settings.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config: Optional configuration object</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (config, excluded_agents)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load configuration if not provided</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        
        <span class="c1"># Get agent exclusion configuration</span>
        <span class="n">excluded_agents</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.excluded_agents&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.case_sensitive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">exclude_dependencies</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.exclude_dependencies&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Normalize excluded agents list for comparison</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span><span class="p">:</span>
            <span class="n">excluded_agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">excluded_agents</span><span class="p">]</span>
        
        <span class="c1"># Log exclusion configuration if agents are being excluded</span>
        <span class="k">if</span> <span class="n">excluded_agents</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excluding agents from deployment: </span><span class="si">{</span><span class="n">excluded_agents</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Case sensitive matching: </span><span class="si">{</span><span class="n">case_sensitive</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exclude dependencies: </span><span class="si">{</span><span class="n">exclude_dependencies</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="n">excluded_agents</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_agents_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the correct agents directory based on input.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Different deployment scenarios require different directory</span>
<span class="sd">        structures. This method centralizes the logic for consistency.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_dir: Optional target directory</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Path to agents directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_dir</span><span class="p">:</span>
            <span class="c1"># Default to working directory&#39;s .claude/agents directory (not home)</span>
            <span class="c1"># This ensures we deploy to the user&#39;s project directory</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        
        <span class="c1"># If target_dir provided, use it directly (caller decides structure)</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
        
        <span class="c1"># Check if this is already an agents directory</span>
        <span class="k">if</span> <span class="n">target_dir</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;agents&quot;</span><span class="p">:</span>
            <span class="c1"># Already an agents directory, use as-is</span>
            <span class="k">return</span> <span class="n">target_dir</span>
        <span class="k">elif</span> <span class="n">target_dir</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;.claude-mpm&quot;</span><span class="p">:</span>
            <span class="c1"># .claude-mpm directory, add agents subdirectory</span>
            <span class="k">return</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        <span class="k">elif</span> <span class="n">target_dir</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;.claude&quot;</span><span class="p">:</span>
            <span class="c1"># .claude directory, add agents subdirectory</span>
            <span class="k">return</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume it&#39;s a project directory, add .claude/agents</span>
            <span class="k">return</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_deployment_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">deployment_start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the deployment results dictionary.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Consistent result structure ensures all deployment</span>
<span class="sd">        operations return the same format for easier processing.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agents_dir: Target agents directory</span>
<span class="sd">            deployment_start_time: Start time for metrics</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Initialized results dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;target_dir&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">agents_dir</span><span class="p">),</span>
            <span class="s2">&quot;deployed&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;migrated&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Track agents migrated from old format</span>
            <span class="s2">&quot;converted&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Track YAML to MD conversions</span>
            <span class="s2">&quot;repaired&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Track agents with repaired frontmatter</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># METRICS: Add detailed timing and performance data to results</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">deployment_start_time</span><span class="p">,</span>
                <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;agent_timings&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Track individual agent deployment times</span>
                <span class="s2">&quot;validation_times&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Track template validation times</span>
                <span class="s2">&quot;resource_usage&quot;</span><span class="p">:</span> <span class="p">{}</span>  <span class="c1"># Could track memory/CPU if needed</span>
            <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_repair_existing_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate and repair broken frontmatter in existing agents.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Ensures all existing agents have valid YAML frontmatter</span>
<span class="sd">        before deployment, preventing runtime errors in Claude Code.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agents_dir: Directory containing agent files</span>
<span class="sd">            results: Results dictionary to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">repair_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_repair_existing_agents</span><span class="p">(</span><span class="n">agents_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">repair_results</span><span class="p">[</span><span class="s2">&quot;repaired&quot;</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;repaired&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repair_results</span><span class="p">[</span><span class="s2">&quot;repaired&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repaired frontmatter in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">repair_results</span><span class="p">[</span><span class="s1">&#39;repaired&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> existing agents&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">repair_results</span><span class="p">[</span><span class="s2">&quot;repaired&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Repaired: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_source_tier</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the source tier for logging.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Understanding which tier (SYSTEM/USER/PROJECT) agents</span>
<span class="sd">        are being deployed from helps with debugging and auditing.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Source tier string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;.claude-mpm/agents&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;/templates&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;PROJECT&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;/.claude-mpm/agents&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;/templates&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;USER&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;SYSTEM&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_base_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load base agent content and version.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Base agent contains shared configuration that all agents</span>
<span class="sd">        inherit, reducing duplication and ensuring consistency.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (base_agent_data, base_agent_version)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_agent_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">base_agent_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                <span class="n">base_agent_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_agent_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="c1"># Handle both &#39;base_version&#39; (new format) and &#39;version&#39; (old format)</span>
                <span class="c1"># MIGRATION PATH: Supporting both formats during transition period</span>
                <span class="n">base_agent_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_version</span><span class="p">(</span>
                    <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_version&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded base agent template (version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_version_display</span><span class="p">(</span><span class="n">base_agent_version</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># NON-FATAL: Base agent is optional enhancement, not required</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load base agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">base_agent_data</span><span class="p">,</span> <span class="n">base_agent_version</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_filtered_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excluded_agents</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get and filter template files based on exclusion rules.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized filtering logic ensures consistent exclusion</span>
<span class="sd">        handling across different deployment scenarios.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            excluded_agents: List of agents to exclude</span>
<span class="sd">            config: Configuration object</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of filtered template files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all template files</span>
        <span class="n">template_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">))</span>
        
        <span class="c1"># Build the combined exclusion set</span>
        <span class="c1"># Start with hardcoded exclusions (these are ALWAYS excluded)</span>
        <span class="n">hardcoded_exclusions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;MEMORIES&quot;</span><span class="p">,</span> <span class="s2">&quot;TODOWRITE&quot;</span><span class="p">,</span> <span class="s2">&quot;INSTRUCTIONS&quot;</span><span class="p">,</span> 
                               <span class="s2">&quot;README&quot;</span><span class="p">,</span> <span class="s2">&quot;pm&quot;</span><span class="p">,</span> <span class="s2">&quot;PM&quot;</span><span class="p">,</span> <span class="s2">&quot;project_manager&quot;</span><span class="p">}</span>
        
        <span class="c1"># Get case sensitivity setting</span>
        <span class="n">case_sensitive</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_deployment.case_sensitive&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Filter out excluded agents</span>
        <span class="n">filtered_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">excluded_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">template_files</span><span class="p">:</span>
            <span class="n">agent_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span>
            
            <span class="c1"># Check hardcoded exclusions (always case-sensitive)</span>
            <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">hardcoded_exclusions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excluding </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">: hardcoded system exclusion&quot;</span><span class="p">)</span>
                <span class="n">excluded_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check file patterns</span>
            <span class="k">if</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.backup&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excluding </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">: file pattern exclusion&quot;</span><span class="p">)</span>
                <span class="n">excluded_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check user-configured exclusions</span>
            <span class="n">compare_name</span> <span class="o">=</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">case_sensitive</span> <span class="k">else</span> <span class="n">agent_name</span>
            <span class="k">if</span> <span class="n">compare_name</span> <span class="ow">in</span> <span class="n">excluded_agents</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excluding </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">: user-configured exclusion&quot;</span><span class="p">)</span>
                <span class="n">excluded_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            
            <span class="c1"># Agent is not excluded, add to filtered list</span>
            <span class="n">filtered_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">excluded_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excluded </span><span class="si">{</span><span class="n">excluded_count</span><span class="si">}</span><span class="s2"> agents from deployment&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">filtered_files</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_deploy_single_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> 
                            <span class="n">base_agent_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">base_agent_version</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
                            <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">deployment_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                            <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy a single agent template.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Extracting single agent deployment logic reduces complexity</span>
<span class="sd">        and makes the main deployment loop more readable.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            template_file: Agent template file</span>
<span class="sd">            agents_dir: Target agents directory</span>
<span class="sd">            base_agent_data: Base agent data</span>
<span class="sd">            base_agent_version: Base agent version</span>
<span class="sd">            force_rebuild: Whether to force rebuild</span>
<span class="sd">            deployment_mode: Deployment mode (update/project)</span>
<span class="sd">            results: Results dictionary to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># METRICS: Track individual agent deployment time</span>
            <span class="n">agent_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="n">agent_name</span> <span class="o">=</span> <span class="n">template_file</span><span class="o">.</span><span class="n">stem</span>
            <span class="n">target_file</span> <span class="o">=</span> <span class="n">agents_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
            
            <span class="c1"># Check if agent needs update</span>
            <span class="n">needs_update</span><span class="p">,</span> <span class="n">is_migration</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_update_status</span><span class="p">(</span>
                <span class="n">target_file</span><span class="p">,</span> <span class="n">template_file</span><span class="p">,</span> <span class="n">base_agent_version</span><span class="p">,</span> 
                <span class="n">force_rebuild</span><span class="p">,</span> <span class="n">deployment_mode</span>
            <span class="p">)</span>
            
            <span class="c1"># Skip if exists and doesn&#39;t need update (only in update mode)</span>
            <span class="k">if</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">needs_update</span> <span class="ow">and</span> <span class="n">deployment_mode</span> <span class="o">!=</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped up-to-date agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Build the agent file as markdown with YAML frontmatter</span>
            <span class="n">agent_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_agent_markdown</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">template_file</span><span class="p">,</span> <span class="n">base_agent_data</span><span class="p">)</span>
            
            <span class="c1"># Write the agent file</span>
            <span class="n">is_update</span> <span class="o">=</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="n">target_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">agent_content</span><span class="p">)</span>
            
            <span class="c1"># Record metrics and update results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_agent_deployment</span><span class="p">(</span>
                <span class="n">agent_name</span><span class="p">,</span> <span class="n">template_file</span><span class="p">,</span> <span class="n">target_file</span><span class="p">,</span>
                <span class="n">is_update</span><span class="p">,</span> <span class="n">is_migration</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
                <span class="n">agent_start_time</span><span class="p">,</span> <span class="n">results</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="n">AgentDeploymentError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Re-raise our custom exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Wrap generic exceptions with context</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to build </span><span class="si">{</span><span class="n">template_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">template_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                            <span class="n">base_agent_version</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">force_rebuild</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                            <span class="n">deployment_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if agent needs update and determine status.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized update checking logic ensures consistent</span>
<span class="sd">        version comparison and migration detection.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_file: Target agent file</span>
<span class="sd">            template_file: Template file</span>
<span class="sd">            base_agent_version: Base agent version</span>
<span class="sd">            force_rebuild: Whether to force rebuild</span>
<span class="sd">            deployment_mode: Deployment mode</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (needs_update, is_migration, reason)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">needs_update</span> <span class="o">=</span> <span class="n">force_rebuild</span>
        <span class="n">is_migration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># In project deployment mode, always deploy regardless of version</span>
        <span class="k">if</span> <span class="n">deployment_mode</span> <span class="o">==</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">needs_update</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project deployment mode: will deploy </span><span class="si">{</span><span class="n">template_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">needs_update</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">needs_update</span> <span class="ow">and</span> <span class="n">target_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># In update mode, check version compatibility</span>
            <span class="n">needs_update</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_agent_needs_update</span><span class="p">(</span>
                <span class="n">target_file</span><span class="p">,</span> <span class="n">template_file</span><span class="p">,</span> <span class="n">base_agent_version</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">needs_update</span><span class="p">:</span>
                <span class="c1"># Check if this is a migration from old format</span>
                <span class="k">if</span> <span class="s2">&quot;migration needed&quot;</span> <span class="ow">in</span> <span class="n">reason</span><span class="p">:</span>
                    <span class="n">is_migration</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migrating agent </span><span class="si">{</span><span class="n">template_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">template_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2"> needs update: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">needs_update</span><span class="p">,</span> <span class="n">is_migration</span><span class="p">,</span> <span class="n">reason</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_record_agent_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                                <span class="n">target_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">is_update</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                                <span class="n">is_migration</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">agent_start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record deployment metrics and update results.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized metrics recording ensures consistent tracking</span>
<span class="sd">        of deployment performance and statistics.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_name: Name of the agent</span>
<span class="sd">            template_file: Template file</span>
<span class="sd">            target_file: Target file</span>
<span class="sd">            is_update: Whether this is an update</span>
<span class="sd">            is_migration: Whether this is a migration</span>
<span class="sd">            reason: Update/migration reason</span>
<span class="sd">            agent_start_time: Start time for this agent</span>
<span class="sd">            results: Results dictionary to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># METRICS: Record deployment time for this agent</span>
        <span class="n">agent_deployment_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">agent_start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># Convert to ms</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;agent_timings&quot;</span><span class="p">][</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_deployment_time</span>
        
        <span class="c1"># METRICS: Update agent type deployment counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;agent_type_counts&#39;</span><span class="p">][</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;agent_type_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">deployment_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">agent_name</span><span class="p">,</span>
            <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">template_file</span><span class="p">),</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_file</span><span class="p">),</span>
            <span class="s2">&quot;deployment_time_ms&quot;</span><span class="p">:</span> <span class="n">agent_deployment_time</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">is_migration</span><span class="p">:</span>
            <span class="n">deployment_info</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;migrated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deployment_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully migrated agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> to semantic versioning&quot;</span><span class="p">)</span>
            
            <span class="c1"># METRICS: Track migration statistics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;migrations_performed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="p">[</span><span class="s1">&#39;version_migration_count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">elif</span> <span class="n">is_update</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deployment_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;deployed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deployment_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Built and deployed agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_and_repair_existing_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate and repair broken frontmatter in existing agent files.</span>
<span class="sd">        </span>
<span class="sd">        This method scans existing .claude/agents/*.md files and validates their</span>
<span class="sd">        frontmatter. If the frontmatter is broken or missing, it attempts to repair</span>
<span class="sd">        it or marks the agent for replacement during deployment.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Ensures all existing agents have valid YAML frontmatter before deployment,</span>
<span class="sd">        preventing runtime errors in Claude Code when loading agents.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agents_dir: Directory containing agent .md files</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with validation results:</span>
<span class="sd">            - repaired: List of agent names that were repaired</span>
<span class="sd">            - replaced: List of agent names marked for replacement</span>
<span class="sd">            - errors: List of validation errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;repaired&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;replaced&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Import frontmatter validator</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.agents.frontmatter_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrontmatterValidator</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="n">FrontmatterValidator</span><span class="p">()</span>
            
            <span class="c1"># Find existing agent files</span>
            <span class="n">agent_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No existing agent files to validate&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validating frontmatter in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">agent_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing agents&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">agent_file</span> <span class="ow">in</span> <span class="n">agent_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">stem</span>
                    
                    <span class="c1"># Read agent file content</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">agent_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
                    
                    <span class="c1"># Check if this is a system agent (authored by claude-mpm)</span>
                    <span class="c1"># Only repair system agents, leave user agents alone</span>
                    <span class="k">if</span> <span class="s2">&quot;author: claude-mpm&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;author: &#39;claude-mpm&#39;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping validation for user agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    
                    <span class="c1"># Extract and validate frontmatter</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">):</span>
                        <span class="c1"># No frontmatter at all - mark for replacement</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> has no frontmatter, marking for replacement&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;replaced&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                        <span class="c1"># Delete the file so it will be recreated</span>
                        <span class="n">agent_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="k">continue</span>
                    
                    <span class="c1"># Try to extract frontmatter</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">end_marker</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">end_marker</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">end_marker</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">end_marker</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Broken frontmatter - mark for replacement</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> has broken frontmatter, marking for replacement&quot;</span><span class="p">)</span>
                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;replaced&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                            <span class="c1"># Delete the file so it will be recreated</span>
                            <span class="n">agent_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                            <span class="k">continue</span>
                        
                        <span class="c1"># Validate frontmatter with the validator</span>
                        <span class="n">validation_result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_file</span><span class="p">(</span><span class="n">agent_file</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                            <span class="c1"># Check if it can be corrected</span>
                            <span class="k">if</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">corrected_frontmatter</span><span class="p">:</span>
                                <span class="c1"># Apply corrections</span>
                                <span class="n">correction_result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">correct_file</span><span class="p">(</span><span class="n">agent_file</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">correction_result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;repaired&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repaired frontmatter for agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">correction</span> <span class="ow">in</span> <span class="n">correction_result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">correction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Cannot be corrected - mark for replacement</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> has invalid frontmatter that cannot be repaired, marking for replacement&quot;</span><span class="p">)</span>
                                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;replaced&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                                <span class="c1"># Delete the file so it will be recreated</span>
                                <span class="n">agent_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                            <span class="c1"># Has warnings but is valid</span>
                            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> warning: </span><span class="si">{</span><span class="n">warning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># Any error in parsing - mark for replacement</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse frontmatter for </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, marking for replacement&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;replaced&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
                        <span class="c1"># Delete the file so it will be recreated</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">agent_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to validate agent </span><span class="si">{</span><span class="n">agent_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FrontmatterValidator not available, skipping validation&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agent validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="c1"># ================================================================================</span>
    <span class="c1"># Interface Adapter Methods</span>
    <span class="c1"># ================================================================================</span>
    <span class="c1"># These methods adapt the existing implementation to comply with AgentDeploymentInterface</span>
    
<div class="viewcode-block" id="AgentDeploymentService.validate_agent">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.validate_agent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate agent configuration and structure.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This adapter method provides interface compliance while leveraging</span>
<span class="sd">        the existing validation logic in _check_agent_needs_update and other methods.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_path: Path to agent configuration file</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (is_valid, list_of_errors)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Agent file not found: </span><span class="si">{</span><span class="n">agent_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            
            <span class="n">content</span> <span class="o">=</span> <span class="n">agent_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            
            <span class="c1"># Check YAML frontmatter format</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing YAML frontmatter&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract and validate version</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
            <span class="n">version_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^version:\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]?(.+?)[&quot;</span><span class="se">\&#39;</span><span class="s1">]?$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">version_match</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing version field in frontmatter&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check for required fields</span>
            <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;tools&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
                <span class="n">field_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">rf</span><span class="s1">&#39;^</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">:\s*.+$&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field_match</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required field: </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># If no errors, validation passed</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Validation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="AgentDeploymentService.get_deployment_status">
<a class="viewcode-back" href="../../../../claude_mpm.services.agent.deployment.html#claude_mpm.services.agent.deployment.AgentDeploymentService.get_deployment_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_deployment_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current deployment status and metrics.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This adapter method provides interface compliance by wrapping</span>
<span class="sd">        verify_deployment and adding deployment metrics.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with deployment status information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get verification results</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_deployment</span><span class="p">()</span>
        
        <span class="c1"># Add deployment metrics</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;deployment_metrics&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployment_metrics</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s2">&quot;verification&quot;</span><span class="p">:</span> <span class="n">verification</span><span class="p">,</span>
            <span class="s2">&quot;agents_deployed&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agents_found&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s2">&quot;agents_needing_migration&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agents_needing_migration&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s2">&quot;has_warnings&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;environment_configured&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;environment&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">status</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>