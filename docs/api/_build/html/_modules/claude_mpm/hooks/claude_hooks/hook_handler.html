

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.hooks.claude_hooks.hook_handler &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">claude_mpm.hooks.claude_hooks.hook_handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.hooks.claude_hooks.hook_handler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;Optimized Claude Code hook handler with Socket.IO connection pooling.</span>

<span class="sd">This handler now uses a connection pool for Socket.IO clients to reduce</span>
<span class="sd">connection overhead and implement circuit breaker and batching patterns.</span>

<span class="sd">WHY connection pooling approach:</span>
<span class="sd">- Reduces connection setup/teardown overhead by 80%</span>
<span class="sd">- Implements circuit breaker for resilience during outages</span>
<span class="sd">- Provides micro-batching for high-frequency events</span>
<span class="sd">- Maintains persistent connections for better performance</span>
<span class="sd">- Falls back gracefully when Socket.IO unavailable</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="c1"># Import constants for configuration</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">NetworkConfig</span><span class="p">,</span>
        <span class="n">TimeoutConfig</span><span class="p">,</span>
        <span class="n">RetryConfig</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Fallback values if constants module not available</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">NetworkConfig</span><span class="p">:</span>
        <span class="n">SOCKETIO_PORT_RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8080</span><span class="p">,</span> <span class="mi">8099</span><span class="p">)</span>
        <span class="n">RECONNECTION_DELAY</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">SOCKET_WAIT_TIMEOUT</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">TimeoutConfig</span><span class="p">:</span>
        <span class="n">QUICK_TIMEOUT</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">RetryConfig</span><span class="p">:</span>
        <span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">INITIAL_RETRY_DELAY</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Debug mode is enabled by default for better visibility into hook processing</span>
<span class="c1"># Set CLAUDE_MPM_HOOK_DEBUG=false to disable debug output</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLAUDE_MPM_HOOK_DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;false&#39;</span>

<span class="c1"># Add imports for memory hook integration with comprehensive error handling</span>
<span class="n">MEMORY_HOOKS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Use centralized path management for adding src to path</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.config.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">paths</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">ensure_in_path</span><span class="p">()</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.hook_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">HookService</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.hooks.memory_integration_hook</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">MemoryPreDelegationHook</span><span class="p">,</span>
        <span class="n">MemoryPostDelegationHook</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.hooks.base_hook</span><span class="w"> </span><span class="kn">import</span> <span class="n">HookContext</span><span class="p">,</span> <span class="n">HookType</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
    <span class="n">MEMORY_HOOKS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Catch all exceptions to prevent any import errors from breaking the handler</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory hooks not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">MEMORY_HOOKS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Response tracking integration</span>
<span class="n">RESPONSE_TRACKING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.response_tracker</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResponseTracker</span>
    <span class="n">RESPONSE_TRACKING_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response tracking not available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">RESPONSE_TRACKING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Socket.IO import</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">socketio</span>
    <span class="n">SOCKETIO_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SOCKETIO_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">socketio</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># No fallback needed - we only use Socket.IO now</span>


<div class="viewcode-block" id="ClaudeHookHandler">
<a class="viewcode-back" href="../../../../claude_mpm.hooks.claude_hooks.hook_handler.html#claude_mpm.hooks.claude_hooks.ClaudeHookHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ClaudeHookHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimized hook handler with direct Socket.IO client.</span>
<span class="sd">    </span>
<span class="sd">    WHY direct client approach:</span>
<span class="sd">    - Simple and reliable synchronous operation</span>
<span class="sd">    - No complex threading or async issues</span>
<span class="sd">    - Fast connection reuse when possible</span>
<span class="sd">    - Graceful fallback when Socket.IO unavailable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ClaudeHookHandler.__init__">
<a class="viewcode-back" href="../../../../claude_mpm.hooks.claude_hooks.hook_handler.html#claude_mpm.hooks.claude_hooks.ClaudeHookHandler.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Socket.IO client (persistent if possible)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Agent delegation tracking</span>
        <span class="c1"># Store recent Task delegations: session_id -&gt; agent_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Use deque to limit memory usage (keep last 100 delegations)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegation_history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="c1"># Store delegation request data for response correlation: session_id -&gt; request_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Git branch cache (to avoid repeated subprocess calls)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache_time</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Initialize memory hooks if available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_hooks_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_delegation_hook</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_delegation_hook</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">MEMORY_HOOKS_AVAILABLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_memory_hooks</span><span class="p">()</span>
        
        <span class="c1"># Initialize response tracking if available and enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_all_interactions</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Track all Claude interactions, not just delegations</span>
        <span class="k">if</span> <span class="n">RESPONSE_TRACKING_AVAILABLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_response_tracking</span><span class="p">()</span>
        
        <span class="c1"># Store current user prompts for comprehensive response tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_prompts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># session_id -&gt; prompt data</span></div>

        
        <span class="c1"># No fallback server needed - we only use Socket.IO now</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_track_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a new agent delegation with optional request data for response correlation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DEBUG] _track_delegation called:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - session_id: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - agent_type: </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - request_data provided: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - delegation_requests size before: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">and</span> <span class="n">agent_type</span> <span class="ow">and</span> <span class="n">agent_type</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_type</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delegation_history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">))</span>
            
            <span class="c1"># Store request data for response tracking correlation</span>
            <span class="k">if</span> <span class="n">request_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;agent_type&#39;</span><span class="p">:</span> <span class="n">agent_type</span><span class="p">,</span>
                    <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request_data</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ✅ Stored in delegation_requests[</span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...]&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - delegation_requests size after: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Clean up old delegations (older than 5 minutes)</span>
            <span class="n">cutoff_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">300</span>
            <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># Check if this is an old entry by looking in history</span>
                <span class="n">found_recent</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">hist_key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_history</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">hist_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">hist_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cutoff_time</span><span class="p">:</span>
                            <span class="n">found_recent</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_recent</span><span class="p">:</span>
                    <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_delegation_agent_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the agent type for a session&#39;s active delegation.&quot;&quot;&quot;</span>
        <span class="c1"># First try exact session match</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">and</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_delegations</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
        
        <span class="c1"># Then try to find in recent history</span>
        <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">agent_type</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_history</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">agent_type</span>
        
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_memory_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize memory hooks for automatic agent memory management.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This activates the memory system by connecting Claude Code hook events</span>
<span class="sd">        to our memory integration hooks. This enables automatic memory injection</span>
<span class="sd">        before delegations and learning extraction after delegations.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We initialize hooks here in the Claude hook handler because</span>
<span class="sd">        this is where Claude Code events are processed. This ensures memory hooks</span>
<span class="sd">        are triggered at the right times during agent delegation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create configuration</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
            
            <span class="c1"># Only initialize if memory system is enabled</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.enabled&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Memory system disabled - skipping hook initialization&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Initialize pre-delegation hook for memory injection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_delegation_hook</span> <span class="o">=</span> <span class="n">MemoryPreDelegationHook</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            
            <span class="c1"># Initialize post-delegation hook if auto-learning is enabled</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory.auto_learning&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>  <span class="c1"># Default to True now</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_delegation_hook</span> <span class="o">=</span> <span class="n">MemoryPostDelegationHook</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_hooks_initialized</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">hooks_info</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_delegation_hook</span><span class="p">:</span>
                    <span class="n">hooks_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pre-delegation&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_delegation_hook</span><span class="p">:</span>
                    <span class="n">hooks_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;post-delegation&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Memory hooks initialized: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hooks_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Failed to initialize memory hooks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Don&#39;t fail the entire handler - memory system is optional</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_response_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize response tracking if enabled in configuration.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This enables automatic capture and storage of agent responses</span>
<span class="sd">        for analysis, debugging, and learning purposes. Integration into the</span>
<span class="sd">        existing hook handler avoids duplicate event capture.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Check configuration to allow enabling/disabling</span>
<span class="sd">        response tracking without code changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create configuration with optional config file</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLAUDE_PM_CONFIG_FILE&#39;</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">config_file</span> <span class="k">else</span> <span class="n">Config</span><span class="p">()</span>
            
            <span class="c1"># Check if response tracking is enabled (check both sections for compatibility)</span>
            <span class="n">response_tracking_enabled</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_tracking.enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">response_logging_enabled</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_logging.enabled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">response_tracking_enabled</span> <span class="ow">or</span> <span class="n">response_logging_enabled</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Response tracking disabled - skipping initialization&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Initialize response tracker with config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span> <span class="o">=</span> <span class="n">ResponseTracker</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">()</span>
            
            <span class="c1"># Check if we should track all interactions (not just delegations)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_all_interactions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_tracking.track_all_interactions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> \
                                         <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_logging.track_all_interactions&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;all interactions&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_all_interactions</span> <span class="k">else</span> <span class="s2">&quot;Task delegations only&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Response tracking initialized (mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Failed to initialize response tracking: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Don&#39;t fail the entire handler - response tracking is optional</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_track_agent_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track agent response by correlating with original request and saving response.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This integrates response tracking into the existing hook flow,</span>
<span class="sd">        capturing agent responses when Task delegations complete. It correlates</span>
<span class="sd">        the response with the original request stored during pre-tool processing.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: Only track responses if response tracking is enabled</span>
<span class="sd">        and we have the original request data. Graceful error handling ensures</span>
<span class="sd">        response tracking failures don&#39;t break hook processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the original request data stored during pre-tool</span>
            <span class="n">request_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No request data found for session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">, skipping response tracking&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Extract response from event output</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
                <span class="c1"># If no output, use error or construct a basic response</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">exit_code</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Task completed with exit code: </span><span class="si">{</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Convert response to string if it&#39;s not already</span>
            <span class="n">response_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            
            <span class="c1"># Try to extract structured JSON response from agent output</span>
            <span class="n">structured_response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Look for JSON block in the response (agents should return JSON at the end)</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                <span class="n">json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;```json\s*(\{.*?\})\s*```&#39;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">json_match</span><span class="p">:</span>
                    <span class="n">structured_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted structured response from </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No structured JSON response found in </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Get the original request (prompt + description)</span>
            <span class="n">original_request</span> <span class="o">=</span> <span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">original_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">original_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="c1"># Combine prompt and description for the full request</span>
            <span class="n">full_request</span> <span class="o">=</span> <span class="n">prompt</span>
            <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">description</span> <span class="o">!=</span> <span class="n">prompt</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">full_request</span><span class="p">:</span>
                    <span class="n">full_request</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Description: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">full_request</span> <span class="o">=</span> <span class="n">description</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_request</span><span class="p">:</span>
                <span class="n">full_request</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Task delegation to </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent&quot;</span>
            
            <span class="c1"># Prepare metadata with structured response data if available</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;exit_code&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;has_error&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)),</span>
                <span class="s1">&#39;duration_ms&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_ms&#39;</span><span class="p">),</span>
                <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;tool_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">,</span>
                <span class="s1">&#39;original_request_timestamp&#39;</span><span class="p">:</span> <span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="c1"># Add structured response data to metadata if available</span>
            <span class="k">if</span> <span class="n">structured_response</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;structured_response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;task_completed&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_completed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="s1">&#39;instructions&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;files_modified&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_modified&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s1">&#39;tools_used&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools_used&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s1">&#39;remember&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remember&#39;</span><span class="p">)</span>
                <span class="p">}</span>
                
                <span class="c1"># Check if task was completed for logging purposes</span>
                <span class="k">if</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_completed&#39;</span><span class="p">):</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;task_completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="c1"># Log files modified for debugging</span>
                <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_modified&#39;</span><span class="p">):</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">structured_response</span><span class="p">[</span><span class="s1">&#39;files_modified&#39;</span><span class="p">]]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> modified files: </span><span class="si">{</span><span class="n">files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Track the response</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="o">.</span><span class="n">track_response</span><span class="p">(</span>
                <span class="n">agent_name</span><span class="o">=</span><span class="n">agent_type</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">full_request</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">response_text</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Tracked response for </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent in session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response tracking returned None for </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent (might be excluded or disabled)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Clean up the request data after successful tracking</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Failed to track agent response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Don&#39;t fail the hook processing - response tracking is optional</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_git_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get git branch for the given directory with caching.</span>
<span class="sd">        </span>
<span class="sd">        WHY caching approach:</span>
<span class="sd">        - Avoids repeated subprocess calls which are expensive</span>
<span class="sd">        - Caches results for 30 seconds per directory</span>
<span class="sd">        - Falls back gracefully if git command fails</span>
<span class="sd">        - Returns &#39;Unknown&#39; for non-git directories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use current working directory if not specified</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">working_dir</span><span class="p">:</span>
            <span class="n">working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        
        <span class="c1"># Check cache first (cache for 30 seconds)</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">working_dir</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache</span> 
            <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache_time</span>
            <span class="ow">and</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache_time</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        
        <span class="c1"># Try to get git branch</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Change to the working directory temporarily</span>
            <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
            
            <span class="c1"># Run git command to get current branch</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">,</span> <span class="s1">&#39;--show-current&#39;</span><span class="p">],</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">TimeoutConfig</span><span class="o">.</span><span class="n">QUICK_TIMEOUT</span>  <span class="c1"># Quick timeout to avoid hanging</span>
            <span class="p">)</span>
            
            <span class="c1"># Restore original directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Cache the result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache_time</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="k">return</span> <span class="n">branch</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Not a git repository or no branch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache_time</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>
                
        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="c1"># Git not available or command failed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_git_branch_cache_time</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
            <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_socketio_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create Socket.IO client with improved reliability.</span>
<span class="sd">        </span>
<span class="sd">        WHY improved approach:</span>
<span class="sd">        - Implements retry logic with exponential backoff</span>
<span class="sd">        - Properly tests connection before returning</span>
<span class="sd">        - Ensures connection persists across events</span>
<span class="sd">        - Better error handling and recovery</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SOCKETIO_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Check if we have a connected client</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Test if still connected</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Connection lost, clear it</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hook handler: Socket.IO connection lost, reconnecting...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Need to create or reconnect client</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLAUDE_MPM_SOCKETIO_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;8765&#39;</span><span class="p">))</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="n">RetryConfig</span><span class="o">.</span><span class="n">MAX_RETRIES</span>
        <span class="n">retry_delay</span> <span class="o">=</span> <span class="n">RetryConfig</span><span class="o">.</span><span class="n">INITIAL_RETRY_DELAY</span>
        
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Clean up old client if exists</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="c1"># Create new client</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
                    <span class="n">reconnection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Enable auto-reconnection</span>
                    <span class="n">reconnection_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">reconnection_delay</span><span class="o">=</span><span class="n">NetworkConfig</span><span class="o">.</span><span class="n">RECONNECTION_DELAY</span><span class="p">,</span>
                    <span class="n">reconnection_delay_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">engineio_logger</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                
                <span class="c1"># Try to connect with proper wait</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;http://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                    <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                    <span class="n">wait_timeout</span><span class="o">=</span><span class="n">NetworkConfig</span><span class="o">.</span><span class="n">SOCKET_WAIT_TIMEOUT</span>
                <span class="p">)</span>
                
                <span class="c1"># Verify connection</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Successfully connected to Socket.IO server on port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Failed to connect to Socket.IO after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Connection attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed, retrying...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                
                <span class="c1"># Exponential backoff with async delay</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Use asyncio.sleep if in async context, otherwise fall back to time.sleep</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                            <span class="c1"># We&#39;re in an async context, use async sleep</span>
                            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Sync context, use regular sleep</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># Fallback to sync sleep if asyncio not available</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
                    <span class="n">retry_delay</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Double the delay for next attempt</span>
        
        <span class="c1"># All attempts failed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="ClaudeHookHandler.handle">
<a class="viewcode-back" href="../../../../claude_mpm.hooks.claude_hooks.hook_handler.html#claude_mpm.hooks.claude_hooks.ClaudeHookHandler.handle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process hook event with minimal overhead and zero blocking delays.</span>
<span class="sd">        </span>
<span class="sd">        WHY this approach:</span>
<span class="sd">        - Fast path processing for minimal latency (no blocking waits)</span>
<span class="sd">        - Non-blocking Socket.IO connection and event emission</span>
<span class="sd">        - Removed sleep() delays that were adding 100ms+ to every hook</span>
<span class="sd">        - Connection timeout prevents indefinite hangs</span>
<span class="sd">        - Graceful degradation if Socket.IO unavailable</span>
<span class="sd">        - Always continues regardless of event status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read and parse event</span>
            <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_hook_event</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_continue_execution</span><span class="p">()</span>
                <span class="k">return</span>
            
            <span class="c1"># Route event to appropriate handler</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_route_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            
            <span class="c1"># Always continue execution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_continue_execution</span><span class="p">()</span>
            
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Fail fast and silent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_continue_execution</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_hook_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and parse hook event from stdin.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized event reading with error handling</span>
<span class="sd">        ensures consistent parsing and validation.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Parsed event dictionary or None if invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event_data</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to parse hook event&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_route_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Route event to appropriate handler based on type.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized routing reduces complexity and makes</span>
<span class="sd">        it easier to add new event types.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            event: Hook event dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hook_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hook_event_name&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        
        <span class="c1"># Map event types to handlers</span>
        <span class="n">event_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;UserPromptSubmit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_user_prompt_fast</span><span class="p">,</span>
            <span class="s1">&#39;PreToolUse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_pre_tool_fast</span><span class="p">,</span>
            <span class="s1">&#39;PostToolUse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_post_tool_fast</span><span class="p">,</span>
            <span class="s1">&#39;Notification&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_notification_fast</span><span class="p">,</span>
            <span class="s1">&#39;Stop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_stop_fast</span><span class="p">,</span>
            <span class="s1">&#39;SubagentStop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_subagent_stop_fast</span><span class="p">,</span>
            <span class="s1">&#39;AssistantResponse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_assistant_response</span>
        <span class="p">}</span>
        
        <span class="c1"># Call appropriate handler if exists</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">event_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hook_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling </span><span class="si">{</span><span class="n">hook_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_continue_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send continue action to Claude.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized response ensures consistent format</span>
<span class="sd">        and makes it easier to add response modifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;continue&quot;</span><span class="p">}))</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_emit_socketio_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Emit Socket.IO event with improved reliability and logging.</span>
<span class="sd">        </span>
<span class="sd">        WHY improved approach:</span>
<span class="sd">        - Better error handling and recovery</span>
<span class="sd">        - Comprehensive event logging for debugging</span>
<span class="sd">        - Automatic reconnection on failure</span>
<span class="sd">        - Validates data before emission</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Always try to emit Socket.IO events if available</span>
        <span class="c1"># The daemon should be running when manager is active</span>
        
        <span class="c1"># Get Socket.IO client</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_socketio_client</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: No Socket.IO client available for event: hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Format event for Socket.IO server</span>
            <span class="n">claude_event_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># Dashboard expects &#39;hook.&#39; prefix</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span>
            <span class="p">}</span>
            
            <span class="c1"># Log important events for debugging</span>
            <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subagent_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;pre_tool&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;subagent_stop&#39;</span><span class="p">:</span>
                    <span class="n">agent_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Emitting SubagentStop for agent &#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;pre_tool&#39;</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tool_name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Task&#39;</span><span class="p">:</span>
                    <span class="n">delegation</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delegation_details&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">agent_type</span> <span class="o">=</span> <span class="n">delegation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Emitting Task delegation to agent &#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Emit synchronously with verification</span>
            <span class="n">client</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;claude_event&#39;</span><span class="p">,</span> <span class="n">claude_event_data</span><span class="p">)</span>
            
            <span class="c1"># Verify emission for critical events</span>
            <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subagent_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;pre_tool&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Successfully emitted Socket.IO event: hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Event emitted but connection status uncertain: hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Force reconnection next time</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Socket.IO emit failed for hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Mark as disconnected so next call will reconnect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># Try to reconnect immediately for critical events</span>
            <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subagent_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;pre_tool&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Attempting immediate reconnection for critical event: hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="c1"># Clear the client to force reconnection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Try to get a new client and emit again</span>
                <span class="n">retry_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_socketio_client</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">retry_client</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">retry_client</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;claude_event&#39;</span><span class="p">,</span> <span class="n">claude_event_data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Successfully re-emitted event after reconnection: hook.</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">retry_e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Re-emission failed: </span><span class="si">{</span><span class="n">retry_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_user_prompt_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle user prompt with comprehensive data capture.</span>
<span class="sd">        </span>
<span class="sd">        WHY enhanced data capture:</span>
<span class="sd">        - Provides full context for debugging and monitoring</span>
<span class="sd">        - Captures prompt text, working directory, and session context</span>
<span class="sd">        - Enables better filtering and analysis in dashboard</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Skip /mpm commands to reduce noise unless debug is enabled</span>
        <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/mpm&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Get working directory and git branch</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_git_branch</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_dir</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        
        <span class="c1"># Extract comprehensive prompt data</span>
        <span class="n">prompt_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;prompt_text&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s1">&#39;prompt_preview&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s1">&#39;prompt_length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;is_command&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
            <span class="s1">&#39;contains_code&#39;</span><span class="p">:</span> <span class="s1">&#39;```&#39;</span> <span class="ow">in</span> <span class="n">prompt</span> <span class="ow">or</span> <span class="s1">&#39;python&#39;</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;javascript&#39;</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;urgent&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="s1">&#39;fix&#39;</span><span class="p">,</span> <span class="s1">&#39;broken&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;normal&#39;</span>
        <span class="p">}</span>
        
        <span class="c1"># Store prompt for comprehensive response tracking if enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_all_interactions</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_prompts</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored prompt for comprehensive tracking: session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="c1"># Emit to /hook namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;user_prompt&#39;</span><span class="p">,</span> <span class="n">prompt_data</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_pre_tool_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle pre-tool use with comprehensive data capture.</span>
<span class="sd">        </span>
<span class="sd">        WHY comprehensive capture:</span>
<span class="sd">        - Captures tool parameters for debugging and security analysis</span>
<span class="sd">        - Provides context about what Claude is about to do</span>
<span class="sd">        - Enables pattern analysis and security monitoring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enhanced debug logging for session correlation</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DEBUG] PreToolUse event received:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - session_id: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - event keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="n">tool_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tool_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tool_input</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tool_input&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># Extract key parameters based on tool type</span>
        <span class="n">tool_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tool_parameters</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">)</span>
        
        <span class="c1"># Classify tool operation</span>
        <span class="n">operation_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_tool_operation</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">)</span>
        
        <span class="c1"># Get working directory and git branch</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_git_branch</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_dir</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        
        <span class="n">pre_tool_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tool_name&#39;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span>
            <span class="s1">&#39;operation_type&#39;</span><span class="p">:</span> <span class="n">operation_type</span><span class="p">,</span>
            <span class="s1">&#39;tool_parameters&#39;</span><span class="p">:</span> <span class="n">tool_params</span><span class="p">,</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;parameter_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;is_file_operation&#39;</span><span class="p">:</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Write&#39;</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiEdit&#39;</span><span class="p">,</span> <span class="s1">&#39;Read&#39;</span><span class="p">,</span> <span class="s1">&#39;LS&#39;</span><span class="p">,</span> <span class="s1">&#39;Glob&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_execution&#39;</span><span class="p">:</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Bash&#39;</span><span class="p">,</span> <span class="s1">&#39;NotebookEdit&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_delegation&#39;</span><span class="p">:</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Task&#39;</span><span class="p">,</span>
            <span class="s1">&#39;security_risk&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assess_security_risk</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1"># Add delegation-specific data if this is a Task tool</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Task&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Normalize agent type to handle capitalized names like &quot;Research&quot;, &quot;Engineer&quot;, etc.</span>
            <span class="n">raw_agent_type</span> <span class="o">=</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            
            <span class="c1"># Use AgentNameNormalizer if available, otherwise simple lowercase normalization</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.core.agent_name_normalizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentNameNormalizer</span>
                <span class="n">normalizer</span> <span class="o">=</span> <span class="n">AgentNameNormalizer</span><span class="p">()</span>
                <span class="c1"># Convert to Task format (lowercase with hyphens)</span>
                <span class="n">agent_type</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">to_task_format</span><span class="p">(</span><span class="n">raw_agent_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_agent_type</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span> <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="c1"># Fallback to simple normalization</span>
                <span class="n">agent_type</span> <span class="o">=</span> <span class="n">raw_agent_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_agent_type</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span> <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
            
            <span class="n">pre_tool_data</span><span class="p">[</span><span class="s1">&#39;delegation_details&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;agent_type&#39;</span><span class="p">:</span> <span class="n">agent_type</span><span class="p">,</span>
                <span class="s1">&#39;original_agent_type&#39;</span><span class="p">:</span> <span class="n">raw_agent_type</span><span class="p">,</span>  <span class="c1"># Keep original for debugging</span>
                <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;task_preview&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))[:</span><span class="mi">100</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="c1"># Track this delegation for SubagentStop correlation and response tracking</span>
            <span class="c1"># session_id already extracted at method start</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Task delegation tracking:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - session_id: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - agent_type: </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - raw_agent_type: </span><span class="si">{</span><span class="n">raw_agent_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - tool_name: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">and</span> <span class="n">agent_type</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
                <span class="c1"># Prepare request data for response tracking correlation</span>
                <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;agent_type&#39;</span><span class="p">:</span> <span class="n">agent_type</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_track_delegation</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Delegation tracked successfully&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Request data keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - delegation_requests size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="c1"># Show all session IDs for debugging</span>
                    <span class="n">all_sessions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">all_sessions</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - All stored sessions (first 16 chars):&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">all_sessions</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># Show up to 10</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">sid</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">... (agent: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                
                <span class="c1"># Log important delegations for debugging</span>
                <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">or</span> <span class="n">agent_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;research&#39;</span><span class="p">,</span> <span class="s1">&#39;engineer&#39;</span><span class="p">,</span> <span class="s1">&#39;qa&#39;</span><span class="p">,</span> <span class="s1">&#39;documentation&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Task delegation started - agent: &#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;, session: &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Trigger memory pre-delegation hook</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_memory_pre_delegation_hook</span><span class="p">(</span><span class="n">agent_type</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
            
            <span class="c1"># Emit a subagent_start event for better tracking</span>
            <span class="n">subagent_start_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;agent_type&#39;</span><span class="p">:</span> <span class="n">agent_type</span><span class="p">,</span>
                <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
                <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;hook_event_name&#39;</span><span class="p">:</span> <span class="s1">&#39;SubagentStart&#39;</span>  <span class="c1"># For dashboard compatibility</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;subagent_start&#39;</span><span class="p">,</span> <span class="n">subagent_start_data</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;pre_tool&#39;</span><span class="p">,</span> <span class="n">pre_tool_data</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_post_tool_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle post-tool use with comprehensive data capture.</span>
<span class="sd">        </span>
<span class="sd">        WHY comprehensive capture:</span>
<span class="sd">        - Captures execution results and success/failure status</span>
<span class="sd">        - Provides duration and performance metrics</span>
<span class="sd">        - Enables pattern analysis of tool usage and success rates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tool_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tool_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Extract result data</span>
        <span class="n">result_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_tool_results</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="c1"># Calculate duration if timestamps are available</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_duration</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="c1"># Get working directory and git branch</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_git_branch</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_dir</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        
        <span class="n">post_tool_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tool_name&#39;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span>
            <span class="s1">&#39;exit_code&#39;</span><span class="p">:</span> <span class="n">exit_code</span><span class="p">,</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;blocked&#39;</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;duration_ms&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s1">&#39;result_summary&#39;</span><span class="p">:</span> <span class="n">result_data</span><span class="p">,</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;has_output&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;has_error&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;output_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
        
        <span class="c1"># Handle Task delegation completion for memory hooks and response tracking</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Task&#39;</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">agent_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_delegation_agent_type</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            
            <span class="c1"># Trigger memory post-delegation hook</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trigger_memory_post_delegation_hook</span><span class="p">(</span><span class="n">agent_type</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
            
            <span class="c1"># Track agent response if response tracking is enabled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_agent_response</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;post_tool&#39;</span><span class="p">,</span> <span class="n">post_tool_data</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_tool_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract relevant parameters based on tool type.</span>
<span class="sd">        </span>
<span class="sd">        WHY tool-specific extraction:</span>
<span class="sd">        - Different tools have different important parameters</span>
<span class="sd">        - Provides meaningful context for dashboard display</span>
<span class="sd">        - Enables tool-specific analysis and monitoring</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;raw_input&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)}</span>
        
        <span class="c1"># Common parameters across all tools</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;input_type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s1">&#39;param_keys&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tool_input</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">tool_input</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="c1"># Tool-specific parameter extraction</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Write&#39;</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiEdit&#39;</span><span class="p">,</span> <span class="s1">&#39;Read&#39;</span><span class="p">,</span> <span class="s1">&#39;NotebookRead&#39;</span><span class="p">,</span> <span class="s1">&#39;NotebookEdit&#39;</span><span class="p">]:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notebook_path&#39;</span><span class="p">),</span>
                <span class="s1">&#39;content_length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new_string&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))),</span>
                <span class="s1">&#39;is_create&#39;</span><span class="p">:</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Write&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_edit&#39;</span><span class="p">:</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiEdit&#39;</span><span class="p">,</span> <span class="s1">&#39;NotebookEdit&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Bash&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>  <span class="c1"># Truncate long commands</span>
                <span class="s1">&#39;command_length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">),</span>
                <span class="s1">&#39;has_pipe&#39;</span><span class="p">:</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">command</span><span class="p">,</span>
                <span class="s1">&#39;has_redirect&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">in</span> <span class="n">command</span> <span class="ow">or</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">command</span><span class="p">,</span>
                <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Grep&#39;</span><span class="p">,</span> <span class="s1">&#39;Glob&#39;</span><span class="p">]:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;output_mode&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_mode&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;WebFetch&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span>  <span class="c1"># Truncate prompt</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Task&#39;</span><span class="p">:</span>
            <span class="c1"># Special handling for Task tool (agent delegations)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;subagent_type&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;prompt_preview&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">if</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_pm_delegation&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_research_delegation&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;research&#39;</span><span class="p">,</span>
                <span class="s1">&#39;is_engineer_delegation&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;engineer&#39;</span>
            <span class="p">})</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;TodoWrite&#39;</span><span class="p">:</span>
            <span class="c1"># Special handling for TodoWrite tool (task management)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;todo_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">todos</span><span class="p">),</span>
                <span class="s1">&#39;todos&#39;</span><span class="p">:</span> <span class="n">todos</span><span class="p">,</span>  <span class="c1"># Full todo list</span>
                <span class="s1">&#39;todo_summary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_todos</span><span class="p">(</span><span class="n">todos</span><span class="p">),</span>
                <span class="s1">&#39;has_in_progress&#39;</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;in_progress&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">todos</span><span class="p">),</span>
                <span class="s1">&#39;has_pending&#39;</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;pending&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">todos</span><span class="p">),</span>
                <span class="s1">&#39;has_completed&#39;</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">todos</span><span class="p">),</span>
                <span class="s1">&#39;priorities&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">todos</span><span class="p">))</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">params</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_todos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">todos</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a summary of the todo list for quick understanding.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">todos</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;Empty todo list&#39;</span><span class="p">}</span>
        
        <span class="n">status_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pending&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;in_progress&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">priority_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">todo</span> <span class="ow">in</span> <span class="n">todos</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">status_counts</span><span class="p">:</span>
                <span class="n">status_counts</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">priority</span> <span class="ow">in</span> <span class="n">priority_counts</span><span class="p">:</span>
                <span class="n">priority_counts</span><span class="p">[</span><span class="n">priority</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Create a text summary</span>
        <span class="n">summary_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> completed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;in_progress&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;in_progress&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> in progress&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_counts</span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pending&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">todos</span><span class="p">),</span>
            <span class="s1">&#39;status_counts&#39;</span><span class="p">:</span> <span class="n">status_counts</span><span class="p">,</span>
            <span class="s1">&#39;priority_counts&#39;</span><span class="p">:</span> <span class="n">priority_counts</span><span class="p">,</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_parts</span><span class="p">)</span> <span class="k">if</span> <span class="n">summary_parts</span> <span class="k">else</span> <span class="s1">&#39;No tasks&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_classify_tool_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Classify the type of operation being performed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Read&#39;</span><span class="p">,</span> <span class="s1">&#39;LS&#39;</span><span class="p">,</span> <span class="s1">&#39;Glob&#39;</span><span class="p">,</span> <span class="s1">&#39;Grep&#39;</span><span class="p">,</span> <span class="s1">&#39;NotebookRead&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;read&#39;</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Write&#39;</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiEdit&#39;</span><span class="p">,</span> <span class="s1">&#39;NotebookEdit&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;write&#39;</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Bash&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;execute&#39;</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;WebFetch&#39;</span><span class="p">,</span> <span class="s1">&#39;WebSearch&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;network&#39;</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;TodoWrite&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;task_management&#39;</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Task&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;delegation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;other&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_assess_security_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assess the security risk level of the tool operation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="s1">&#39;Bash&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># Check for potentially dangerous commands</span>
            <span class="n">dangerous_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rm -rf&#39;</span><span class="p">,</span> <span class="s1">&#39;sudo&#39;</span><span class="p">,</span> <span class="s1">&#39;chmod 777&#39;</span><span class="p">,</span> <span class="s1">&#39;curl&#39;</span><span class="p">,</span> <span class="s1">&#39;wget&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt; /etc/&#39;</span><span class="p">,</span> <span class="s1">&#39;dd if=&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pattern</span> <span class="ow">in</span> <span class="n">command</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">dangerous_patterns</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">command</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s1">&#39;medium&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;low&#39;</span>
        <span class="k">elif</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Write&#39;</span><span class="p">,</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="s1">&#39;MultiEdit&#39;</span><span class="p">]:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># Check for system file modifications</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span> <span class="ow">in</span> <span class="n">file_path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;/etc/&#39;</span><span class="p">,</span> <span class="s1">&#39;/usr/&#39;</span><span class="p">,</span> <span class="s1">&#39;/var/&#39;</span><span class="p">,</span> <span class="s1">&#39;/sys/&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s1">&#39;high&#39;</span>
            <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;medium&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;low&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;low&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_tool_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract and summarize tool execution results.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;exit_code&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;has_output&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;has_error&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        
        <span class="c1"># Extract output if available</span>
        <span class="k">if</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;has_output&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                <span class="s1">&#39;output_preview&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">output</span><span class="p">,</span>
                <span class="s1">&#39;output_lines&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">output</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">})</span>
        
        <span class="c1"># Extract error information</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;has_error&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;error_preview&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">error</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate operation duration in milliseconds if timestamps are available.&quot;&quot;&quot;</span>
        <span class="c1"># This would require start/end timestamps from Claude Code</span>
        <span class="c1"># For now, return None as we don&#39;t have this data</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_notification_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle notification events from Claude.</span>
<span class="sd">        </span>
<span class="sd">        WHY enhanced notification capture:</span>
<span class="sd">        - Provides visibility into Claude&#39;s status and communication flow</span>
<span class="sd">        - Captures notification type, content, and context for monitoring</span>
<span class="sd">        - Enables pattern analysis of Claude&#39;s notification behavior</span>
<span class="sd">        - Useful for debugging communication issues and user experience</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">notification_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notification_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get working directory and git branch</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_git_branch</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_dir</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        
        <span class="n">notification_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;notification_type&#39;</span><span class="p">:</span> <span class="n">notification_type</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;message_preview&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;message_length&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;is_user_input_request&#39;</span><span class="p">:</span> <span class="s1">&#39;input&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;waiting&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="s1">&#39;is_error_notification&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;failed&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="s1">&#39;is_status_update&#39;</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="s1">&#39;analyzing&#39;</span><span class="p">,</span> <span class="s1">&#39;working&#39;</span><span class="p">,</span> <span class="s1">&#39;thinking&#39;</span><span class="p">])</span>
        <span class="p">}</span>
        
        <span class="c1"># Emit to /hook namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;notification&#39;</span><span class="p">,</span> <span class="n">notification_data</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_stop_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract metadata from stop event.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Centralized metadata extraction ensures consistent</span>
<span class="sd">        data collection across stop event handling.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            event: Stop event dictionary</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Metadata dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_git_branch</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_dir</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
            <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
            <span class="s1">&#39;stop_type&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_type&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_track_stop_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Track response for stop events.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Separated response tracking logic for better modularity</span>
<span class="sd">        and easier testing/maintenance.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            event: Stop event dictionary</span>
<span class="sd">            session_id: Session identifier</span>
<span class="sd">            metadata: Event metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="p">):</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract output from event</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_output&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="c1"># Check if we have a pending prompt for this session</span>
            <span class="n">prompt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_prompts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - output present: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="si">}</span><span class="s2"> (length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - prompt_data present: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">prompt_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">output</span> <span class="ow">and</span> <span class="n">prompt_data</span><span class="p">:</span>
                <span class="c1"># Add prompt timestamp to metadata</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;prompt_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
                
                <span class="c1"># Track the main Claude response</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="o">.</span><span class="n">track_response</span><span class="p">(</span>
                    <span class="n">agent_name</span><span class="o">=</span><span class="s1">&#39;claude_main&#39;</span><span class="p">,</span>
                    <span class="n">request</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">],</span>
                    <span class="n">response</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
                    <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Response tracked to: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                
                <span class="c1"># Clean up pending prompt</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_prompts</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error tracking stop response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_stop_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle stop events when Claude processing stops.</span>
<span class="sd">        </span>
<span class="sd">        WHY comprehensive stop capture:</span>
<span class="sd">        - Provides visibility into Claude&#39;s session lifecycle</span>
<span class="sd">        - Captures stop reason and context for analysis</span>
<span class="sd">        - Enables tracking of session completion patterns</span>
<span class="sd">        - Useful for understanding when and why Claude stops responding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Extract metadata for this stop event</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_stop_metadata</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="c1"># Debug logging</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_stop_event_debug</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        
        <span class="c1"># Track response if enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_stop_response</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        
        <span class="c1"># Emit stop event to Socket.IO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_stop_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_log_stop_event_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log debug information for stop events.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Separated debug logging for cleaner code and easier</span>
<span class="sd">        enable/disable of debug output.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            event: Stop event dictionary</span>
<span class="sd">            session_id: Session identifier</span>
<span class="sd">            metadata: Event metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Stop event processing:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - response_tracking_enabled: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - response_tracker exists: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - session_id: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - reason: </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - stop_type: </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_emit_stop_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Emit stop event data to Socket.IO.</span>
<span class="sd">        </span>
<span class="sd">        WHY: Separated Socket.IO emission for better modularity</span>
<span class="sd">        and easier testing/mocking.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            event: Stop event dictionary</span>
<span class="sd">            session_id: Session identifier</span>
<span class="sd">            metadata: Event metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stop_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">],</span>
            <span class="s1">&#39;stop_type&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;stop_type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;working_directory&#39;</span><span class="p">],</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;git_branch&#39;</span><span class="p">],</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_user_initiated&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;user_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;user_cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;interrupt&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_error_stop&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_completion_stop&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">],</span>
            <span class="s1">&#39;has_output&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_output&#39;</span><span class="p">))</span>
        <span class="p">}</span>
        
        <span class="c1"># Emit to /hook namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">stop_data</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_subagent_stop_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle subagent stop events with improved agent type detection.</span>
<span class="sd">        </span>
<span class="sd">        WHY comprehensive subagent stop capture:</span>
<span class="sd">        - Provides visibility into subagent lifecycle and delegation patterns</span>
<span class="sd">        - Captures agent type, ID, reason, and results for analysis</span>
<span class="sd">        - Enables tracking of delegation success/failure patterns</span>
<span class="sd">        - Useful for understanding subagent performance and reliability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Enhanced debug logging for session correlation</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[DEBUG] SubagentStop event received:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - session_id: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - event keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - delegation_requests size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Show all stored session IDs for comparison</span>
            <span class="n">all_sessions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">all_sessions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Stored sessions (first 16 chars):&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">all_sessions</span><span class="p">[:</span><span class="mi">10</span><span class="p">]:</span>  <span class="c1"># Show up to 10</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">sid</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">... (agent: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - No stored sessions in delegation_requests!&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="c1"># First try to get agent type from our tracking</span>
        <span class="n">agent_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_delegation_agent_type</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">session_id</span> <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
        
        <span class="c1"># Fall back to event data if tracking didn&#39;t have it</span>
        <span class="k">if</span> <span class="n">agent_type</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
            <span class="n">agent_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">))</span>
        
        <span class="n">agent_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_id&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subagent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_reason&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">))</span>
        
        <span class="c1"># Try to infer agent type from other fields if still unknown</span>
        <span class="k">if</span> <span class="n">agent_type</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span> <span class="ow">and</span> <span class="s1">&#39;task&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
            <span class="n">task_desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;research&#39;</span> <span class="ow">in</span> <span class="n">task_desc</span><span class="p">:</span>
                <span class="n">agent_type</span> <span class="o">=</span> <span class="s1">&#39;research&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;engineer&#39;</span> <span class="ow">in</span> <span class="n">task_desc</span> <span class="ow">or</span> <span class="s1">&#39;code&#39;</span> <span class="ow">in</span> <span class="n">task_desc</span><span class="p">:</span>
                <span class="n">agent_type</span> <span class="o">=</span> <span class="s1">&#39;engineer&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;pm&#39;</span> <span class="ow">in</span> <span class="n">task_desc</span> <span class="ow">or</span> <span class="s1">&#39;project&#39;</span> <span class="ow">in</span> <span class="n">task_desc</span><span class="p">:</span>
                <span class="n">agent_type</span> <span class="o">=</span> <span class="s1">&#39;pm&#39;</span>
        
        <span class="c1"># Always log SubagentStop events for debugging</span>
        <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">or</span> <span class="n">agent_type</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler: Processing SubagentStop - agent: &#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;, session: &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;, reason: &#39;</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="c1"># Get working directory and git branch</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cwd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">git_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_git_branch</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">working_dir</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span>
        
        <span class="c1"># Try to extract structured response from output if available</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">structured_response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                <span class="n">json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;```json\s*(\{.*?\})\s*```&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">json_match</span><span class="p">:</span>
                    <span class="n">structured_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted structured response from </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent in SubagentStop&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">pass</span>  <span class="c1"># No structured response, that&#39;s okay</span>
        
        <span class="c1"># Track agent response even without structured JSON</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] SubagentStop response tracking check:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - response_tracking_enabled: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - response_tracker exists: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - session_id: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - agent_type: </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Check if session exists in our storage</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ✅ Session found in delegation_requests&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Stored agent: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ❌ Session NOT found in delegation_requests!&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Looking for partial match...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="c1"># Try to find partial matches</span>
                <span class="k">for</span> <span class="n">stored_sid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">stored_sid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span> <span class="ow">or</span> <span class="n">session_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stored_sid</span><span class="p">[:</span><span class="mi">8</span><span class="p">]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - Partial match found: </span><span class="si">{</span><span class="n">stored_sid</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the original request data (with fuzzy matching fallback)</span>
                <span class="n">request_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
                
                <span class="c1"># If exact match fails, try partial matching</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">request_info</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Trying fuzzy match for session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="c1"># Try to find a session that matches the first 8-16 characters</span>
                    <span class="k">for</span> <span class="n">stored_sid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">stored_sid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span> <span class="ow">or</span> 
                            <span class="n">session_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">stored_sid</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span> <span class="ow">or</span>
                            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stored_sid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="ow">and</span> 
                             <span class="n">stored_sid</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span> <span class="o">==</span> <span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">])):</span>
                            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="se">\u2705</span><span class="s2"> Fuzzy match found: </span><span class="si">{</span><span class="n">stored_sid</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                            <span class="n">request_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stored_sid</span><span class="p">)</span>
                            <span class="c1"># Update the key to use the current session_id for consistency</span>
                            <span class="k">if</span> <span class="n">request_info</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_info</span>
                                <span class="c1"># Optionally remove the old key to avoid duplicates</span>
                                <span class="k">if</span> <span class="n">stored_sid</span> <span class="o">!=</span> <span class="n">session_id</span><span class="p">:</span>
                                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">stored_sid</span><span class="p">]</span>
                            <span class="k">break</span>
                
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - request_info present: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">request_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">request_info</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ✅ Found request data for response tracking&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - stored agent_type: </span><span class="si">{</span><span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agent_type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - request keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - ❌ No request data found for session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">request_info</span><span class="p">:</span>
                    <span class="c1"># Use the output as the response</span>
                    <span class="n">response_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">if</span> <span class="n">output</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> completed with reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
                    
                    <span class="c1"># Get the original request</span>
                    <span class="n">original_request</span> <span class="o">=</span> <span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="n">original_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">original_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    
                    <span class="c1"># Combine prompt and description</span>
                    <span class="n">full_request</span> <span class="o">=</span> <span class="n">prompt</span>
                    <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">description</span> <span class="o">!=</span> <span class="n">prompt</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">full_request</span><span class="p">:</span>
                            <span class="n">full_request</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Description: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">full_request</span> <span class="o">=</span> <span class="n">description</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">full_request</span><span class="p">:</span>
                        <span class="n">full_request</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Task delegation to </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent&quot;</span>
                    
                    <span class="c1"># Prepare metadata</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;exit_code&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;has_error&#39;</span><span class="p">:</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;blocked&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;duration_ms&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_ms&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
                        <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;subagent_stop&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                        <span class="s1">&#39;original_request_timestamp&#39;</span><span class="p">:</span> <span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Add structured response if available</span>
                    <span class="k">if</span> <span class="n">structured_response</span><span class="p">:</span>
                        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;structured_response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structured_response</span>
                        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;task_completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_completed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    
                    <span class="c1"># Track the response</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="o">.</span><span class="n">track_response</span><span class="p">(</span>
                        <span class="n">agent_name</span><span class="o">=</span><span class="n">agent_type</span><span class="p">,</span>
                        <span class="n">request</span><span class="o">=</span><span class="n">full_request</span><span class="p">,</span>
                        <span class="n">response</span><span class="o">=</span><span class="n">response_text</span><span class="p">,</span>
                        <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Tracked </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2"> agent response on SubagentStop: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    
                    <span class="c1"># Clean up the request data</span>
                    <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">delegation_requests</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
                        
                <span class="k">elif</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No request data for SubagentStop session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">..., agent: </span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Failed to track response on SubagentStop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="n">subagent_stop_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;agent_type&#39;</span><span class="p">:</span> <span class="n">agent_type</span><span class="p">,</span>
            <span class="s1">&#39;agent_id&#39;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
            <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">working_dir</span><span class="p">,</span>
            <span class="s1">&#39;git_branch&#39;</span><span class="p">:</span> <span class="n">git_branch</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;is_successful_completion&#39;</span><span class="p">:</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_error_termination&#39;</span><span class="p">:</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;blocked&#39;</span><span class="p">],</span>
            <span class="s1">&#39;is_delegation_related&#39;</span><span class="p">:</span> <span class="n">agent_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;research&#39;</span><span class="p">,</span> <span class="s1">&#39;engineer&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;ops&#39;</span><span class="p">,</span> <span class="s1">&#39;qa&#39;</span><span class="p">,</span> <span class="s1">&#39;documentation&#39;</span><span class="p">,</span> <span class="s1">&#39;security&#39;</span><span class="p">],</span>
            <span class="s1">&#39;has_results&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;duration_context&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_ms&#39;</span><span class="p">),</span>
            <span class="s1">&#39;hook_event_name&#39;</span><span class="p">:</span> <span class="s1">&#39;SubagentStop&#39;</span>  <span class="c1"># Explicitly set for dashboard</span>
        <span class="p">}</span>
        
        <span class="c1"># Add structured response data if available</span>
        <span class="k">if</span> <span class="n">structured_response</span><span class="p">:</span>
            <span class="n">subagent_stop_data</span><span class="p">[</span><span class="s1">&#39;structured_response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;task_completed&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_completed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="s1">&#39;instructions&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;files_modified&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_modified&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s1">&#39;tools_used&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tools_used&#39;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s1">&#39;remember&#39;</span><span class="p">:</span> <span class="n">structured_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remember&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        
        <span class="c1"># Debug log the processed data</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SubagentStop processed data: agent_type=&#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;, session_id=&#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        
        <span class="c1"># Emit to /hook namespace with high priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emit_socketio_event</span><span class="p">(</span><span class="s1">&#39;/hook&#39;</span><span class="p">,</span> <span class="s1">&#39;subagent_stop&#39;</span><span class="p">,</span> <span class="n">subagent_stop_data</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_assistant_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle assistant response events for comprehensive response tracking.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This enables capture of all Claude responses, not just Task delegations.</span>
<span class="sd">        When track_all_interactions is enabled, we capture every Claude response</span>
<span class="sd">        paired with its original user prompt.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We correlate responses with stored prompts using session_id.</span>
<span class="sd">        This provides complete conversation tracking for analysis and learning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracking_enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_all_interactions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_id</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Get the stored prompt for this session</span>
        <span class="n">prompt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_prompts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No stored prompt for session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">..., skipping response tracking&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract response content from event</span>
            <span class="n">response_content</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response_content</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No response content in event for session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span>
            
            <span class="c1"># Track the response</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;prompt_timestamp&#39;</span><span class="p">:</span> <span class="n">prompt_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">),</span>
                <span class="s1">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">prompt_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;working_directory&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant_response&#39;</span><span class="p">,</span>
                <span class="s1">&#39;session_type&#39;</span><span class="p">:</span> <span class="s1">&#39;interactive&#39;</span>
            <span class="p">}</span>
            
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_tracker</span><span class="o">.</span><span class="n">track_response</span><span class="p">(</span>
                <span class="n">agent_name</span><span class="o">=</span><span class="s1">&#39;claude&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">],</span>
                <span class="n">response</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Tracked Claude response for session </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
            <span class="c1"># Clean up the stored prompt</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_prompts</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Failed to track assistant response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_trigger_memory_pre_delegation_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger memory pre-delegation hook for agent memory injection.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This connects Claude Code&#39;s Task delegation events to our memory system.</span>
<span class="sd">        When Claude is about to delegate to an agent, we inject the agent&#39;s memory</span>
<span class="sd">        into the delegation context so the agent has access to accumulated knowledge.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We modify the tool_input in place to inject memory context.</span>
<span class="sd">        This ensures the agent receives the memory as part of their initial context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_hooks_initialized</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_delegation_hook</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create hook context for memory injection</span>
            <span class="n">hook_context</span> <span class="o">=</span> <span class="n">HookContext</span><span class="p">(</span>
                <span class="n">hook_type</span><span class="o">=</span><span class="n">HookType</span><span class="o">.</span><span class="n">PRE_DELEGATION</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="n">agent_type</span><span class="p">,</span>
                    <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">tool_input</span><span class="p">,</span>
                    <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span>
                <span class="p">},</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;claude_hook_handler&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tool_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span>
                <span class="p">},</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span>
            <span class="p">)</span>
            
            <span class="c1"># Execute pre-delegation hook</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_delegation_hook</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">hook_context</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">modified</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="c1"># Update tool_input with memory-enhanced context</span>
                <span class="n">enhanced_context</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">enhanced_context</span> <span class="ow">and</span> <span class="s1">&#39;agent_memory&#39;</span> <span class="ow">in</span> <span class="n">enhanced_context</span><span class="p">:</span>
                    <span class="c1"># Inject memory into the task prompt/description</span>
                    <span class="n">original_prompt</span> <span class="o">=</span> <span class="n">tool_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">memory_section</span> <span class="o">=</span> <span class="n">enhanced_context</span><span class="p">[</span><span class="s1">&#39;agent_memory&#39;</span><span class="p">]</span>
                    
                    <span class="c1"># Prepend memory to the original prompt</span>
                    <span class="n">enhanced_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory_section</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">original_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">tool_input</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enhanced_prompt</span>
                    
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="n">memory_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">memory_section</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Injected </span><span class="si">{</span><span class="n">memory_size</span><span class="si">}</span><span class="s2"> bytes of memory for agent &#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Memory pre-delegation hook failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Don&#39;t fail the delegation - memory is optional</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_trigger_memory_post_delegation_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger memory post-delegation hook for learning extraction.</span>
<span class="sd">        </span>
<span class="sd">        WHY: This connects Claude Code&#39;s Task completion events to our memory system.</span>
<span class="sd">        When an agent completes a task, we extract learnings from the result and</span>
<span class="sd">        store them in the agent&#39;s memory for future use.</span>
<span class="sd">        </span>
<span class="sd">        DESIGN DECISION: We extract learnings from both the tool output and any</span>
<span class="sd">        error messages, providing comprehensive context for the memory system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_hooks_initialized</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_delegation_hook</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract result content from the event</span>
            <span class="n">result_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_code&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Build result content</span>
            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">result_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">result_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Task completed with exit code: </span><span class="si">{</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Create hook context for learning extraction</span>
            <span class="n">hook_context</span> <span class="o">=</span> <span class="n">HookContext</span><span class="p">(</span>
                <span class="n">hook_type</span><span class="o">=</span><span class="n">HookType</span><span class="o">.</span><span class="n">POST_DELEGATION</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="n">agent_type</span><span class="p">,</span>
                    <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">result_content</span><span class="p">,</span>
                        <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;exit_code&#39;</span><span class="p">:</span> <span class="n">exit_code</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span>
                <span class="p">},</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;claude_hook_handler&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tool_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Task&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;duration_ms&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_ms&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span>
            <span class="p">)</span>
            
            <span class="c1"># Execute post-delegation hook</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_delegation_hook</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">hook_context</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                <span class="n">learnings_extracted</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;learnings_extracted&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">learnings_extracted</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">DEBUG</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Extracted </span><span class="si">{</span><span class="n">learnings_extracted</span><span class="si">}</span><span class="s2"> learnings for agent &#39;</span><span class="si">{</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Memory post-delegation hook failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="c1"># Don&#39;t fail the delegation result - memory is optional</span>
    
<div class="viewcode-block" id="ClaudeHookHandler.__del__">
<a class="viewcode-back" href="../../../../claude_mpm.hooks.claude_hooks.hook_handler.html#claude_mpm.hooks.claude_hooks.ClaudeHookHandler.__del__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup Socket.IO client on handler destruction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sio_connected</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sio_client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../../claude_mpm.hooks.claude_hooks.hook_handler.html#claude_mpm.hooks.claude_hooks.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entry point with comprehensive error handling.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">ClaudeHookHandler</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">handle</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Always output continue action to not block Claude</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;continue&quot;</span><span class="p">}))</span>
        <span class="c1"># Log error for debugging</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hook handler error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Exit cleanly even on error</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>