

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.agents.agent_loader &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">claude_mpm.agents.agent_loader</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.agents.agent_loader</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Unified Agent Loader System</span>
<span class="sd">==========================</span>

<span class="sd">This module provides a unified system for loading and managing AI agent configurations</span>
<span class="sd">from JSON template files. It serves as the central registry for all agent types in the</span>
<span class="sd">Claude MPM system, handling discovery, validation, caching, and dynamic model selection.</span>

<span class="sd">Architecture Overview:</span>
<span class="sd">----------------------</span>
<span class="sd">The agent loader follows a plugin-like architecture where agents are discovered from</span>
<span class="sd">JSON template files in a designated directory. Each agent is validated against a</span>
<span class="sd">standardized schema before being registered for use.</span>

<span class="sd">Key Features:</span>
<span class="sd">-------------</span>
<span class="sd">- Automatic agent discovery from JSON files in configured agent directories</span>
<span class="sd">- Schema validation ensures all agents conform to the expected structure</span>
<span class="sd">- Intelligent caching using SharedPromptCache for performance optimization</span>
<span class="sd">- Dynamic model selection based on task complexity analysis</span>
<span class="sd">- Backward compatibility with legacy get_*_agent_prompt() functions</span>
<span class="sd">- Prepends base instructions to maintain consistency across all agents</span>

<span class="sd">Design Decisions:</span>
<span class="sd">-----------------</span>
<span class="sd">1. JSON-based Configuration: We chose JSON over YAML or Python files for:</span>
<span class="sd">   - Schema validation support</span>
<span class="sd">   - Language-agnostic configuration</span>
<span class="sd">   - Easy parsing and generation by tools</span>

<span class="sd">2. Lazy Loading with Caching: Agents are loaded on-demand and cached to:</span>
<span class="sd">   - Reduce startup time</span>
<span class="sd">   - Minimize memory usage for unused agents</span>
<span class="sd">   - Allow hot-reloading during development</span>

<span class="sd">3. Dynamic Model Selection: The system can analyze task complexity to:</span>
<span class="sd">   - Optimize cost by using appropriate model tiers</span>
<span class="sd">   - Improve performance for simple tasks</span>
<span class="sd">   - Ensure complex tasks get sufficient model capabilities</span>

<span class="sd">Usage Examples:</span>
<span class="sd">--------------</span>
<span class="sd">    from claude_mpm.agents.agent_loader import get_documentation_agent_prompt</span>
<span class="sd">    </span>
<span class="sd">    # Get agent prompt using backward-compatible function</span>
<span class="sd">    prompt = get_documentation_agent_prompt()</span>
<span class="sd">    </span>
<span class="sd">    # Get agent with model selection info</span>
<span class="sd">    prompt, model, config = get_agent_prompt(&quot;research_agent&quot;, </span>
<span class="sd">                                            return_model_info=True,</span>
<span class="sd">                                            task_description=&quot;Analyze codebase&quot;)</span>
<span class="sd">    </span>
<span class="sd">    # List all available agents</span>
<span class="sd">    agents = list_available_agents()</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.memory.cache.shared_prompt_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">SharedPromptCache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.base_agent_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepend_base_instructions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..validation.agent_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentValidator</span><span class="p">,</span> <span class="n">ValidationResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathResolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.agent_name_normalizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentNameNormalizer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..core.config_paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigPaths</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.frontmatter_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrontmatterValidator</span>

<span class="c1"># Temporary placeholders for missing module</span>
<span class="c1"># WHY: These classes would normally come from a task_complexity module, but</span>
<span class="c1"># we&#39;ve included them here temporarily to avoid breaking dependencies.</span>
<span class="c1"># This allows the agent loader to function independently while the full</span>
<span class="c1"># complexity analysis system is being developed.</span>
<div class="viewcode-block" id="ComplexityLevel">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.ComplexityLevel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ComplexityLevel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the complexity level of a task for model selection.&quot;&quot;&quot;</span>
    <span class="n">LOW</span> <span class="o">=</span> <span class="s2">&quot;LOW&quot;</span>      <span class="c1"># Simple tasks suitable for fast, economical models</span>
    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="s2">&quot;MEDIUM&quot;</span>  <span class="c1"># Standard tasks requiring balanced capabilities</span>
    <span class="n">HIGH</span> <span class="o">=</span> <span class="s2">&quot;HIGH&quot;</span>    <span class="c1"># Complex tasks needing advanced reasoning</span></div>


<div class="viewcode-block" id="ModelType">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.ModelType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Claude model tiers used for dynamic selection based on task complexity.&quot;&quot;&quot;</span>
    <span class="n">HAIKU</span> <span class="o">=</span> <span class="s2">&quot;haiku&quot;</span>    <span class="c1"># Fast, economical model for simple tasks</span>
    <span class="n">SONNET</span> <span class="o">=</span> <span class="s2">&quot;sonnet&quot;</span>  <span class="c1"># Balanced model for general-purpose tasks</span>
    <span class="n">OPUS</span> <span class="o">=</span> <span class="s2">&quot;opus&quot;</span>      <span class="c1"># Most capable model for complex reasoning</span></div>


<span class="c1"># Module-level logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AgentTier">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentTier">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentTier</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent precedence tiers.&quot;&quot;&quot;</span>
    <span class="n">PROJECT</span> <span class="o">=</span> <span class="s2">&quot;project&quot;</span>  <span class="c1"># Highest precedence - project-specific agents</span>
    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>       <span class="c1"># User-level agents from ~/.claude-mpm</span>
    <span class="n">SYSTEM</span> <span class="o">=</span> <span class="s2">&quot;system&quot;</span>   <span class="c1"># Lowest precedence - framework built-in agents</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_templates_dirs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AgentTier</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get directories containing agent JSON files across all tiers.</span>
<span class="sd">    </span>
<span class="sd">    Returns a dictionary mapping tiers to their agent directories:</span>
<span class="sd">    - PROJECT: .claude-mpm/agents in the current working directory</span>
<span class="sd">    - USER: ~/.claude-mpm/agents </span>
<span class="sd">    - SYSTEM: Built-in agents relative to this module</span>
<span class="sd">    </span>
<span class="sd">    WHY: We support multiple tiers to allow project-specific customization</span>
<span class="sd">    while maintaining backward compatibility with system agents.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict mapping AgentTier to Path (or None if not available)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># PROJECT tier - ALWAYS check current working directory dynamically</span>
    <span class="c1"># This ensures we pick up project agents even if CWD changes</span>
    <span class="n">project_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="n">ConfigPaths</span><span class="o">.</span><span class="n">CONFIG_DIR</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
    <span class="k">if</span> <span class="n">project_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dirs</span><span class="p">[</span><span class="n">AgentTier</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_dir</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PROJECT agents at: </span><span class="si">{</span><span class="n">project_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># USER tier - check user home directory</span>
    <span class="n">user_config_dir</span> <span class="o">=</span> <span class="n">ConfigPaths</span><span class="o">.</span><span class="n">get_user_config_dir</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user_config_dir</span><span class="p">:</span>
        <span class="n">user_agents_dir</span> <span class="o">=</span> <span class="n">user_config_dir</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        <span class="k">if</span> <span class="n">user_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">dirs</span><span class="p">[</span><span class="n">AgentTier</span><span class="o">.</span><span class="n">USER</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_agents_dir</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found USER agents at: </span><span class="si">{</span><span class="n">user_agents_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># SYSTEM tier - built-in agents</span>
    <span class="n">system_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span>
    <span class="k">if</span> <span class="n">system_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">dirs</span><span class="p">[</span><span class="n">AgentTier</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">]</span> <span class="o">=</span> <span class="n">system_dir</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found SYSTEM agents at: </span><span class="si">{</span><span class="n">system_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dirs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_templates_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the primary directory containing agent JSON files.</span>
<span class="sd">    </span>
<span class="sd">    DEPRECATED: Use _get_agent_templates_dirs() for tier-aware loading.</span>
<span class="sd">    This function is kept for backward compatibility.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Path: Absolute path to the system agents directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span>


<span class="c1"># Agent directory - where all agent JSON files are stored</span>
<span class="n">AGENT_TEMPLATES_DIR</span> <span class="o">=</span> <span class="n">_get_agent_templates_dir</span><span class="p">()</span>

<span class="c1"># Cache prefix for agent prompts - versioned to allow cache invalidation on schema changes</span>
<span class="c1"># WHY: The &quot;v2:&quot; suffix allows us to invalidate all cached prompts when we make</span>
<span class="c1"># breaking changes to the agent schema format</span>
<span class="n">AGENT_CACHE_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;agent_prompt:v2:&quot;</span>

<span class="c1"># Model configuration thresholds for dynamic selection</span>
<span class="c1"># WHY: These thresholds define complexity score ranges (0-100) that map to</span>
<span class="c1"># appropriate Claude models. The ranges are based on empirical testing of</span>
<span class="c1"># task performance across different model tiers.</span>
<span class="n">MODEL_THRESHOLDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ModelType</span><span class="o">.</span><span class="n">HAIKU</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_complexity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_complexity&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
    <span class="n">ModelType</span><span class="o">.</span><span class="n">SONNET</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_complexity&quot;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="s2">&quot;max_complexity&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">},</span>
    <span class="n">ModelType</span><span class="o">.</span><span class="n">OPUS</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;min_complexity&quot;</span><span class="p">:</span> <span class="mi">71</span><span class="p">,</span> <span class="s2">&quot;max_complexity&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Model name mappings for Claude API</span>
<span class="c1"># WHY: These map our internal model types to the actual API model identifiers.</span>
<span class="c1"># The specific versions are chosen for their stability and feature completeness.</span>
<span class="n">MODEL_NAME_MAPPINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ModelType</span><span class="o">.</span><span class="n">HAIKU</span><span class="p">:</span> <span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">,</span>      <span class="c1"># Fast, cost-effective</span>
    <span class="n">ModelType</span><span class="o">.</span><span class="n">SONNET</span><span class="p">:</span> <span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span>    <span class="c1"># Balanced performance</span>
    <span class="n">ModelType</span><span class="o">.</span><span class="n">OPUS</span><span class="p">:</span> <span class="s2">&quot;claude-opus-4-20250514&quot;</span>         <span class="c1"># Maximum capability</span>
<span class="p">}</span>


<div class="viewcode-block" id="AgentLoader">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Central registry for loading and managing agent configurations.</span>
<span class="sd">    </span>
<span class="sd">    This class implements the core agent discovery and management system. It:</span>
<span class="sd">    1. Discovers agent JSON files from the agents directory</span>
<span class="sd">    2. Validates each agent against the standardized schema</span>
<span class="sd">    3. Maintains an in-memory registry of valid agents</span>
<span class="sd">    4. Provides caching for performance optimization</span>
<span class="sd">    5. Supports dynamic agent reloading</span>
<span class="sd">    </span>
<span class="sd">    METRICS COLLECTION OPPORTUNITIES:</span>
<span class="sd">    - Agent load times and cache hit rates</span>
<span class="sd">    - Validation performance by agent type</span>
<span class="sd">    - Agent usage frequency and patterns</span>
<span class="sd">    - Model selection distribution</span>
<span class="sd">    - Task complexity analysis results</span>
<span class="sd">    - Memory usage for agent definitions</span>
<span class="sd">    - Error rates during loading/validation</span>
<span class="sd">    - Agent prompt size distributions</span>
<span class="sd">    </span>
<span class="sd">    The loader follows a singleton-like pattern through the module-level</span>
<span class="sd">    _loader instance to ensure consistent state across the application.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        validator: AgentValidator instance for schema validation</span>
<span class="sd">        cache: SharedPromptCache instance for performance optimization</span>
<span class="sd">        _agent_registry: Internal dictionary mapping agent IDs to their configurations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AgentLoader.__init__">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the agent loader and discover available agents.</span>
<span class="sd">        </span>
<span class="sd">        The initialization process:</span>
<span class="sd">        1. Creates validator for schema checking</span>
<span class="sd">        2. Gets shared cache instance for performance</span>
<span class="sd">        3. Initializes empty agent registry</span>
<span class="sd">        4. Discovers template directories across all tiers</span>
<span class="sd">        5. Triggers agent discovery and loading</span>
<span class="sd">        </span>
<span class="sd">        METRICS OPPORTUNITIES:</span>
<span class="sd">        - Track initialization time</span>
<span class="sd">        - Monitor agent discovery performance</span>
<span class="sd">        - Count total agents loaded vs validation failures</span>
<span class="sd">        - Measure memory footprint of loaded agents</span>
<span class="sd">        </span>
<span class="sd">        WHY: We load agents eagerly during initialization to:</span>
<span class="sd">        - Detect configuration errors early</span>
<span class="sd">        - Build the registry once for efficient access</span>
<span class="sd">        - Validate all agents before the system starts using them</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">AgentValidator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">SharedPromptCache</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Template directories will be discovered dynamically during loading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_template_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Track which tier each agent came from for debugging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgentTier</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Initialize frontmatter validator for .md agent files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frontmatter_validator</span> <span class="o">=</span> <span class="n">FrontmatterValidator</span><span class="p">()</span>
        
        <span class="c1"># METRICS: Initialize performance tracking</span>
        <span class="c1"># This structure collects valuable telemetry for AI agent performance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;agents_loaded&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;agents_by_tier&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">AgentTier</span><span class="p">},</span>
            <span class="s1">&#39;validation_failures&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;cache_hits&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;cache_misses&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;load_times&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># agent_id -&gt; load time ms</span>
            <span class="s1">&#39;usage_counts&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># agent_id -&gt; usage count</span>
            <span class="s1">&#39;model_selections&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># model -&gt; count</span>
            <span class="s1">&#39;complexity_scores&#39;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Distribution of task complexity</span>
            <span class="s1">&#39;prompt_sizes&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># agent_id -&gt; prompt size in chars</span>
            <span class="s1">&#39;error_types&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># error_type -&gt; count</span>
            <span class="s1">&#39;initialization_time_ms&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        
        <span class="c1"># METRICS: Track initialization performance</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_agents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;initialization_time_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent loader initialized in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;initialization_time_ms&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_async</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover and load all valid agents from all tier directories.</span>
<span class="sd">        </span>
<span class="sd">        This method implements the agent discovery mechanism with tier precedence:</span>
<span class="sd">        1. Scans each tier directory (PROJECT → USER → SYSTEM)</span>
<span class="sd">        2. Loads and validates each agent file</span>
<span class="sd">        3. Registers agents with precedence (PROJECT overrides USER overrides SYSTEM)</span>
<span class="sd">        </span>
<span class="sd">        WHY: We use tier-based discovery to allow:</span>
<span class="sd">        - Project-specific agent customization</span>
<span class="sd">        - User-level agent modifications</span>
<span class="sd">        - Fallback to system defaults</span>
<span class="sd">        </span>
<span class="sd">        Performance:</span>
<span class="sd">        - Async loading (default) provides 60-80% faster startup</span>
<span class="sd">        - Falls back to sync loading if async unavailable</span>
<span class="sd">        </span>
<span class="sd">        Error Handling:</span>
<span class="sd">        - Invalid JSON files are logged but don&#39;t stop the loading process</span>
<span class="sd">        - Schema validation failures are logged with details</span>
<span class="sd">        - The system continues to function with whatever valid agents it finds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try async loading for better performance</span>
        <span class="k">if</span> <span class="n">use_async</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.async_agent_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_agents_async</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using async agent loading for improved performance&quot;</span><span class="p">)</span>
                
                <span class="c1"># Load agents asynchronously</span>
                <span class="n">agents</span> <span class="o">=</span> <span class="n">load_agents_async</span><span class="p">()</span>
                
                <span class="c1"># Update registry</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span> <span class="o">=</span> <span class="n">agents</span>
                
                <span class="c1"># Update metrics</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;agents_loaded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span>
                
                <span class="c1"># Extract tier information</span>
                <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">agent_data</span> <span class="ow">in</span> <span class="n">agents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">tier_str</span> <span class="o">=</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_tier&#39;</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">AgentTier</span><span class="p">(</span><span class="n">tier_str</span><span class="p">)</span>
                    
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span><span class="si">}</span><span class="s2"> agents successfully&quot;</span><span class="p">)</span>
                <span class="k">return</span>
                
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Async loading not available, falling back to sync&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async loading failed, falling back to sync: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Fall back to synchronous loading</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using synchronous agent loading&quot;</span><span class="p">)</span>
        
        <span class="c1"># Dynamically discover agent directories at load time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_template_dirs</span> <span class="o">=</span> <span class="n">_get_agent_templates_dirs</span><span class="p">()</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading agents from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_template_dirs</span><span class="p">)</span><span class="si">}</span><span class="s2"> tier(s)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Perform startup validation check for .md agent files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_markdown_agents</span><span class="p">()</span>
        
        <span class="c1"># Process tiers in REVERSE precedence order (SYSTEM first, PROJECT last)</span>
        <span class="c1"># This ensures PROJECT agents override USER/SYSTEM agents</span>
        <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="p">[</span><span class="n">AgentTier</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">tier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_dirs</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">templates_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_dirs</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> agents from </span><span class="si">{</span><span class="n">templates_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">json_file</span> <span class="ow">in</span> <span class="n">templates_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
                <span class="c1"># Skip the schema definition file itself</span>
                <span class="k">if</span> <span class="n">json_file</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;agent_schema.json&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">agent_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    
                    <span class="c1"># For files without _agent suffix, use the filename as agent_id</span>
                    <span class="k">if</span> <span class="s2">&quot;agent_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_data</span><span class="p">:</span>
                        <span class="n">agent_data</span><span class="p">[</span><span class="s2">&quot;agent_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_file</span><span class="o">.</span><span class="n">stem</span>
                    
                    <span class="c1"># Validate against schema to ensure consistency</span>
                    <span class="c1"># Skip validation for now if instructions are plain text (not in expected format)</span>
                    <span class="k">if</span> <span class="s2">&quot;instructions&quot;</span> <span class="ow">in</span> <span class="n">agent_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agent_data</span><span class="p">[</span><span class="s2">&quot;instructions&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_data</span><span class="p">[</span><span class="s2">&quot;instructions&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
                        <span class="c1"># For very long instructions, skip validation but log warning</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping validation for </span><span class="si">{</span><span class="n">json_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> due to long instructions&quot;</span><span class="p">)</span>
                        <span class="n">validation_result</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="p">(</span><span class="n">is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warnings</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Validation skipped due to long instructions&quot;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validate_agent</span><span class="p">(</span><span class="n">agent_data</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                        <span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_id&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">agent_id</span><span class="p">:</span>
                            <span class="c1"># Check if this agent was already loaded from a higher-precedence tier</span>
                            <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">:</span>
                                <span class="n">existing_tier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
                                <span class="c1"># Only override if current tier has higher precedence</span>
                                <span class="k">if</span> <span class="n">tier</span> <span class="o">==</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">PROJECT</span> <span class="ow">or</span> \
                                   <span class="p">(</span><span class="n">tier</span> <span class="o">==</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">USER</span> <span class="ow">and</span> <span class="n">existing_tier</span> <span class="o">==</span> <span class="n">AgentTier</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">):</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overriding </span><span class="si">{</span><span class="n">existing_tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> agent &#39;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&#39; with </span><span class="si">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> version&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> agent &#39;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&#39; - already loaded from </span><span class="si">{</span><span class="n">existing_tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                            
                            <span class="c1"># Register the agent</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_data</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tier</span>
                            
                            <span class="c1"># METRICS: Track successful agent load</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;agents_loaded&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;agents_by_tier&#39;</span><span class="p">][</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> agent: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Log validation errors but continue loading other agents</span>
                        <span class="c1"># METRICS: Track validation failure</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;validation_failures&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid agent in </span><span class="si">{</span><span class="n">json_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">validation_result</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Log loading errors but don&#39;t crash - system should be resilient</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load </span><span class="si">{</span><span class="n">json_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_markdown_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate frontmatter in all .md agent files at startup.</span>
<span class="sd">        </span>
<span class="sd">        This method performs validation and reports issues found in agent files.</span>
<span class="sd">        It checks all tiers and provides a summary of validation results.</span>
<span class="sd">        Auto-correction is applied in memory but not written to files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validation_summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_checked&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;corrected&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;by_tier&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Check the .claude/agents directory for .md files</span>
        <span class="n">claude_agents_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.claude&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span>
        <span class="k">if</span> <span class="n">claude_agents_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating agent files in .claude/agents directory...&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">md_file</span> <span class="ow">in</span> <span class="n">claude_agents_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">):</span>
                <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;total_checked&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="c1"># Validate the file</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frontmatter_validator</span><span class="o">.</span><span class="n">validate_file</span><span class="p">(</span><span class="n">md_file</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                    <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                    <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;corrected&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-corrected frontmatter in </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">correction</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">correction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                    <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation errors in </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Warning in </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">warning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check template directories for .md files</span>
        <span class="k">for</span> <span class="n">tier</span><span class="p">,</span> <span class="n">templates_dir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_dirs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">templates_dir</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">tier_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;checked&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;corrected&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
            <span class="k">for</span> <span class="n">md_file</span> <span class="ow">in</span> <span class="n">templates_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">):</span>
                <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;total_checked&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tier_stats</span><span class="p">[</span><span class="s1">&#39;checked&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="c1"># Validate the file</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frontmatter_validator</span><span class="o">.</span><span class="n">validate_file</span><span class="p">(</span><span class="n">md_file</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_valid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                    <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">tier_stats</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                    <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;corrected&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">tier_stats</span><span class="p">[</span><span class="s1">&#39;corrected&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-corrected </span><span class="si">{</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> agent </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                    <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">tier_stats</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">tier_stats</span><span class="p">[</span><span class="s1">&#39;checked&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;by_tier&#39;</span><span class="p">][</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">tier_stats</span>
        
        <span class="c1"># Log validation summary</span>
        <span class="k">if</span> <span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;total_checked&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Agent validation summary: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;total_checked&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> files checked, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> valid, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;corrected&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> auto-corrected, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">validation_summary</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with errors&quot;</span>
            <span class="p">)</span>
            
            <span class="c1"># Store in metrics for reporting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;validation_summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_summary</span>
    
<div class="viewcode-block" id="AgentLoader.get_agent">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader.get_agent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve agent configuration by ID.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Unique identifier for the agent (e.g., &quot;research_agent&quot;)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict containing the full agent configuration, or None if not found</span>
<span class="sd">            </span>
<span class="sd">        WHY: Direct dictionary lookup for O(1) performance, essential for</span>
<span class="sd">        frequently accessed agents during runtime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agent_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">agent_data</span> <span class="ow">and</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">:</span>
            <span class="c1"># Add tier information to the agent data for debugging</span>
            <span class="n">agent_data</span> <span class="o">=</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">agent_data</span><span class="p">[</span><span class="s1">&#39;_tier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">agent_data</span></div>

    
<div class="viewcode-block" id="AgentLoader.list_agents">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader.list_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a summary list of all available agents.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of agent summaries containing key metadata fields</span>
<span class="sd">            </span>
<span class="sd">        WHY: We return a summary instead of full configurations to:</span>
<span class="sd">        - Reduce memory usage when listing many agents</span>
<span class="sd">        - Provide only the information needed for agent selection</span>
<span class="sd">        - Keep the API response size manageable</span>
<span class="sd">        </span>
<span class="sd">        The returned list is sorted by ID for consistent ordering across calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">agent_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Extract key fields from nested structure for easy consumption</span>
            <span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">),</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;resource_tier&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource_tier&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span></div>

    
<div class="viewcode-block" id="AgentLoader.get_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader.get_agent_prompt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve agent instructions/prompt by ID with caching support.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Unique identifier for the agent</span>
<span class="sd">            force_reload: If True, bypass cache and reload from registry</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The agent&#39;s instruction prompt, or None if not found</span>
<span class="sd">            </span>
<span class="sd">        Caching Strategy:</span>
<span class="sd">        - Prompts are cached for 1 hour (3600 seconds) by default</span>
<span class="sd">        - Cache keys are versioned (v2:) to allow bulk invalidation</span>
<span class="sd">        - Force reload bypasses cache for development/debugging</span>
<span class="sd">        </span>
<span class="sd">        METRICS TRACKED:</span>
<span class="sd">        - Cache hit/miss rates for optimization</span>
<span class="sd">        - Agent usage frequency for popular agents</span>
<span class="sd">        - Prompt loading times for performance</span>
<span class="sd">        - Prompt sizes for memory analysis</span>
<span class="sd">        </span>
<span class="sd">        WHY: Caching is critical here because:</span>
<span class="sd">        - Agent prompts can be large (several KB)</span>
<span class="sd">        - They&#39;re accessed frequently during agent execution</span>
<span class="sd">        - They rarely change in production</span>
<span class="sd">        - The 1-hour TTL balances freshness with performance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGENT_CACHE_PREFIX</span><span class="si">}{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># METRICS: Track usage count for this agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;usage_counts&#39;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;usage_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># METRICS: Track load time</span>
        <span class="n">load_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="c1"># Check cache first unless force reload is requested</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="n">cached_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># METRICS: Track cache hit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_hits&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent prompt for &#39;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&#39; loaded from cache&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cached_content</span><span class="p">)</span>
        
        <span class="c1"># METRICS: Track cache miss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_misses&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Get agent data from registry</span>
        <span class="n">agent_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_data</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent not found: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Extract instructions from the agent configuration</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instructions&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instructions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No instructions found for agent: </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># METRICS: Track prompt size for memory analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>
        
        <span class="c1"># METRICS: Record load time</span>
        <span class="n">load_time_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">load_start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;load_times&#39;</span><span class="p">][</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_time_ms</span>
        
        <span class="c1"># Cache the content with 1 hour TTL for performance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent prompt for &#39;</span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&#39; cached successfully&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">instructions</span></div>

    
<div class="viewcode-block" id="AgentLoader.get_metrics">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader.get_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get collected performance metrics.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing:</span>
<span class="sd">            - Cache performance (hit rate, miss rate)</span>
<span class="sd">            - Agent usage statistics</span>
<span class="sd">            - Load time analysis</span>
<span class="sd">            - Memory usage patterns</span>
<span class="sd">            - Error tracking</span>
<span class="sd">            - Tier distribution</span>
<span class="sd">            </span>
<span class="sd">        This data could be:</span>
<span class="sd">        - Exposed via monitoring endpoints</span>
<span class="sd">        - Logged periodically for analysis</span>
<span class="sd">        - Used for capacity planning</span>
<span class="sd">        - Fed to AI operations platforms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_hits&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_misses&#39;</span><span class="p">]</span>
        <span class="n">cache_hit_rate</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">cache_total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cache_hit_rate</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_hits&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">cache_total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Calculate average load times</span>
        <span class="n">avg_load_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;load_times&#39;</span><span class="p">]:</span>
            <span class="n">avg_load_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;load_times&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;load_times&#39;</span><span class="p">])</span>
        
        <span class="c1"># Find most used agents</span>
        <span class="n">top_agents</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;usage_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;initialization_time_ms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;initialization_time_ms&#39;</span><span class="p">],</span>
            <span class="s1">&#39;agents_loaded&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;agents_loaded&#39;</span><span class="p">],</span>
            <span class="s1">&#39;agents_by_tier&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;agents_by_tier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;validation_failures&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;validation_failures&#39;</span><span class="p">],</span>
            <span class="s1">&#39;cache_hit_rate_percent&#39;</span><span class="p">:</span> <span class="n">cache_hit_rate</span><span class="p">,</span>
            <span class="s1">&#39;cache_hits&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_hits&#39;</span><span class="p">],</span>
            <span class="s1">&#39;cache_misses&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;cache_misses&#39;</span><span class="p">],</span>
            <span class="s1">&#39;average_load_time_ms&#39;</span><span class="p">:</span> <span class="n">avg_load_time</span><span class="p">,</span>
            <span class="s1">&#39;top_agents_by_usage&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">top_agents</span><span class="p">),</span>
            <span class="s1">&#39;model_selection_distribution&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;model_selections&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;prompt_size_stats&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;total_agents&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;average_size&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;max_size&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;min_size&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;prompt_sizes&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="s1">&#39;error_types&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;error_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="AgentLoader.get_agent_metadata">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.AgentLoader.get_agent_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agent_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get comprehensive agent metadata including capabilities and configuration.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            agent_id: Unique identifier for the agent</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing all agent metadata except instructions,</span>
<span class="sd">            or None if agent not found</span>
<span class="sd">            </span>
<span class="sd">        WHY: This method provides access to agent configuration without</span>
<span class="sd">        including the potentially large instruction text. This is useful for:</span>
<span class="sd">        - UI displays showing agent capabilities</span>
<span class="sd">        - Programmatic agent selection based on features</span>
<span class="sd">        - Debugging and introspection</span>
<span class="sd">        </span>
<span class="sd">        The returned structure mirrors the JSON schema sections for consistency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agent_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">agent_id</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">),</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{}),</span>      <span class="c1"># Name, description, category</span>
            <span class="s2">&quot;capabilities&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1"># Model, tools, features</span>
            <span class="s2">&quot;knowledge&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;knowledge&quot;</span><span class="p">,</span> <span class="p">{}),</span>      <span class="c1"># Domain expertise</span>
            <span class="s2">&quot;interactions&quot;</span><span class="p">:</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interactions&quot;</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># User interaction patterns</span>
        <span class="p">}</span></div>
</div>



<span class="c1"># Global loader instance - singleton pattern for consistent state</span>
<span class="c1"># WHY: We use a module-level singleton because:</span>
<span class="c1"># - Agent configurations should be consistent across the application</span>
<span class="c1"># - Loading and validation only needs to happen once</span>
<span class="c1"># - Multiple loaders would lead to cache inconsistencies</span>
<span class="n">_loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_loader</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AgentLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get or create the global agent loader instance (singleton pattern).</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        AgentLoader: The single global instance</span>
<span class="sd">        </span>
<span class="sd">    WHY: The singleton pattern ensures:</span>
<span class="sd">    - Agents are loaded and validated only once</span>
<span class="sd">    - All parts of the application see the same agent registry</span>
<span class="sd">    - Cache state remains consistent</span>
<span class="sd">    - Memory usage is minimized</span>
<span class="sd">    </span>
<span class="sd">    Thread Safety: Python&#39;s GIL makes this simple implementation thread-safe</span>
<span class="sd">    for the single assignment operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_loader</span>
    <span class="k">if</span> <span class="n">_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_loader</span> <span class="o">=</span> <span class="n">AgentLoader</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_loader</span>


<div class="viewcode-block" id="load_agent_prompt_from_md">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.load_agent_prompt_from_md">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_agent_prompt_from_md</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load agent prompt from JSON template (legacy function name).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_name: Agent name (matches agent ID in new schema)</span>
<span class="sd">        force_reload: Force reload from file, bypassing cache</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Agent instructions from JSON template, or None if not found</span>
<span class="sd">        </span>
<span class="sd">    NOTE: Despite the &quot;md&quot; in the function name, this loads from JSON files.</span>
<span class="sd">    The name is kept for backward compatibility with existing code that</span>
<span class="sd">    expects this interface. New code should use get_agent_prompt() directly.</span>
<span class="sd">    </span>
<span class="sd">    WHY: This wrapper exists to maintain backward compatibility during the</span>
<span class="sd">    migration from markdown-based agents to JSON-based agents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent_prompt</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_analyze_task_complexity</span><span class="p">(</span><span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze task complexity to determine optimal model selection.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        task_description: Description of the task to analyze</span>
<span class="sd">        context_size: Size of context in characters (affects complexity)</span>
<span class="sd">        **kwargs: Additional parameters for complexity analysis such as:</span>
<span class="sd">            - code_analysis: Whether code analysis is required</span>
<span class="sd">            - multi_step: Whether the task involves multiple steps</span>
<span class="sd">            - domain_expertise: Required domain knowledge level</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">            - complexity_score: Numeric score 0-100</span>
<span class="sd">            - complexity_level: LOW, MEDIUM, or HIGH</span>
<span class="sd">            - recommended_model: Suggested Claude model tier</span>
<span class="sd">            - optimal_prompt_size: Recommended prompt size range</span>
<span class="sd">            - error: Error message if analysis fails</span>
<span class="sd">            </span>
<span class="sd">    WHY: This is a placeholder implementation that returns sensible defaults.</span>
<span class="sd">    The actual TaskComplexityAnalyzer module would use NLP techniques to:</span>
<span class="sd">    - Analyze task description for complexity indicators</span>
<span class="sd">    - Consider context size and memory requirements</span>
<span class="sd">    - Factor in domain-specific requirements</span>
<span class="sd">    - Optimize for cost vs capability trade-offs</span>
<span class="sd">    </span>
<span class="sd">    Current Implementation: Returns medium complexity as a safe default that</span>
<span class="sd">    works well for most tasks while the full analyzer is being developed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Temporary implementation until TaskComplexityAnalyzer is available</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TaskComplexityAnalyzer not available, using default values&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;complexity_score&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s2">&quot;complexity_level&quot;</span><span class="p">:</span> <span class="n">ComplexityLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
        <span class="s2">&quot;recommended_model&quot;</span><span class="p">:</span> <span class="n">ModelType</span><span class="o">.</span><span class="n">SONNET</span><span class="p">,</span>
        <span class="s2">&quot;optimal_prompt_size&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;TaskComplexityAnalyzer module not available&quot;</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_model_config</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">complexity_analysis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine optimal model configuration based on agent type and task complexity.</span>
<span class="sd">    </span>
<span class="sd">    METRICS TRACKED:</span>
<span class="sd">    - Model selection distribution</span>
<span class="sd">    - Complexity score distribution</span>
<span class="sd">    - Dynamic vs static selection rates</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_name: Name of the agent requesting model selection (already normalized to agent_id format)</span>
<span class="sd">        complexity_analysis: Results from task complexity analysis (if available)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (selected_model, model_config) where:</span>
<span class="sd">            - selected_model: Claude API model identifier</span>
<span class="sd">            - model_config: Dictionary with selection metadata</span>
<span class="sd">            </span>
<span class="sd">    Model Selection Strategy:</span>
<span class="sd">    1. Each agent has a default model defined in its capabilities</span>
<span class="sd">    2. Dynamic selection can override based on task complexity</span>
<span class="sd">    3. Environment variables can control selection behavior</span>
<span class="sd">    </span>
<span class="sd">    Environment Variables:</span>
<span class="sd">    - ENABLE_DYNAMIC_MODEL_SELECTION: Global toggle (default: true)</span>
<span class="sd">    - CLAUDE_PM_{AGENT}_MODEL_SELECTION: Per-agent override</span>
<span class="sd">    </span>
<span class="sd">    WHY: This flexible approach allows:</span>
<span class="sd">    - Cost optimization by using cheaper models for simple tasks</span>
<span class="sd">    - Performance optimization by using powerful models only when needed</span>
<span class="sd">    - Easy override for testing or production constraints</span>
<span class="sd">    - Gradual rollout of dynamic selection features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    <span class="n">agent_data</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_data</span><span class="p">:</span>
        <span class="c1"># Fallback for unknown agents - use Sonnet as safe default</span>
        <span class="k">return</span> <span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">}</span>
    
    <span class="c1"># Get model from agent capabilities (agent&#39;s preferred model)</span>
    <span class="n">default_model</span> <span class="o">=</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check if dynamic model selection is enabled globally</span>
    <span class="n">enable_dynamic_selection</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ENABLE_DYNAMIC_MODEL_SELECTION&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
    
    <span class="c1"># Check for per-agent override in environment</span>
    <span class="c1"># This allows fine-grained control over specific agents</span>
    <span class="n">agent_override_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CLAUDE_PM_</span><span class="si">{</span><span class="n">agent_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_MODEL_SELECTION&quot;</span>
    <span class="n">agent_override</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">agent_override_key</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">agent_override</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">enable_dynamic_selection</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">agent_override</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="n">enable_dynamic_selection</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Apply dynamic model selection based on task complexity</span>
    <span class="k">if</span> <span class="n">enable_dynamic_selection</span> <span class="ow">and</span> <span class="n">complexity_analysis</span><span class="p">:</span>
        <span class="n">recommended_model</span> <span class="o">=</span> <span class="n">complexity_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recommended_model&#39;</span><span class="p">,</span> <span class="n">ModelType</span><span class="o">.</span><span class="n">SONNET</span><span class="p">)</span>
        <span class="n">selected_model</span> <span class="o">=</span> <span class="n">MODEL_NAME_MAPPINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">recommended_model</span><span class="p">,</span> <span class="n">default_model</span><span class="p">)</span>
        
        <span class="c1"># METRICS: Track complexity scores for distribution analysis</span>
        <span class="n">complexity_score</span> <span class="o">=</span> <span class="n">complexity_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;_metrics&#39;</span><span class="p">):</span>
            <span class="n">loader</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;complexity_scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">complexity_score</span><span class="p">)</span>
            <span class="c1"># Keep only last 1000 scores for memory efficiency</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;complexity_scores&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">loader</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;complexity_scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;complexity_scores&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1000</span><span class="p">:]</span>
        
        <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="s2">&quot;dynamic_complexity_based&quot;</span><span class="p">,</span>
            <span class="s2">&quot;complexity_score&quot;</span><span class="p">:</span> <span class="n">complexity_score</span><span class="p">,</span>
            <span class="s2">&quot;complexity_level&quot;</span><span class="p">:</span> <span class="n">complexity_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complexity_level&#39;</span><span class="p">,</span> <span class="n">ComplexityLevel</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">),</span>
            <span class="s2">&quot;optimal_prompt_size&quot;</span><span class="p">:</span> <span class="n">complexity_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimal_prompt_size&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)),</span>
            <span class="s2">&quot;default_model&quot;</span><span class="p">:</span> <span class="n">default_model</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use agent&#39;s default model when dynamic selection is disabled</span>
        <span class="n">selected_model</span> <span class="o">=</span> <span class="n">default_model</span>
        <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="s2">&quot;agent_default&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;dynamic_selection_disabled&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">enable_dynamic_selection</span> <span class="k">else</span> <span class="s2">&quot;no_complexity_analysis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default_model&quot;</span><span class="p">:</span> <span class="n">default_model</span>
        <span class="p">}</span>
    
    <span class="c1"># METRICS: Track model selection distribution</span>
    <span class="c1"># This helps understand model usage patterns and costs</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="s1">&#39;_metrics&#39;</span><span class="p">):</span>
        <span class="n">loader</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;model_selections&#39;</span><span class="p">][</span><span class="n">selected_model</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">loader</span><span class="o">.</span><span class="n">_metrics</span><span class="p">[</span><span class="s1">&#39;model_selections&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_model</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">selected_model</span><span class="p">,</span> <span class="n">model_config</span>


<div class="viewcode-block" id="get_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_agent_prompt</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">return_model_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get agent prompt with optional dynamic model selection and base instructions.</span>
<span class="sd">    </span>
<span class="sd">    This is the primary interface for retrieving agent prompts. It handles:</span>
<span class="sd">    1. Loading the agent&#39;s instructions from the registry</span>
<span class="sd">    2. Optionally analyzing task complexity for model selection</span>
<span class="sd">    3. Prepending base instructions for consistency</span>
<span class="sd">    4. Adding metadata about model selection decisions</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_name: Agent name in any format (e.g., &quot;Engineer&quot;, &quot;research_agent&quot;, &quot;QA&quot;)</span>
<span class="sd">        force_reload: Force reload from source, bypassing cache</span>
<span class="sd">        return_model_info: If True, returns extended info tuple</span>
<span class="sd">        **kwargs: Additional arguments:</span>
<span class="sd">            - task_description: Description for complexity analysis</span>
<span class="sd">            - context_size: Size of context in characters</span>
<span class="sd">            - enable_complexity_analysis: Toggle complexity analysis (default: True)</span>
<span class="sd">            - Additional task-specific parameters</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        If return_model_info=False: Complete agent prompt string</span>
<span class="sd">        If return_model_info=True: Tuple of (prompt, selected_model, model_config)</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the requested agent is not found</span>
<span class="sd">        </span>
<span class="sd">    Processing Flow:</span>
<span class="sd">    1. Normalize agent name to correct agent ID</span>
<span class="sd">    2. Load agent instructions (with caching)</span>
<span class="sd">    3. Analyze task complexity (if enabled and task_description provided)</span>
<span class="sd">    4. Determine optimal model based on complexity</span>
<span class="sd">    5. Add model selection metadata to prompt</span>
<span class="sd">    6. Prepend base instructions</span>
<span class="sd">    7. Return appropriate format based on return_model_info</span>
<span class="sd">    </span>
<span class="sd">    WHY: This comprehensive approach ensures:</span>
<span class="sd">    - Consistent prompt structure across all agents</span>
<span class="sd">    - Optimal model selection for cost/performance</span>
<span class="sd">    - Transparency in model selection decisions</span>
<span class="sd">    - Flexibility for different use cases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize the agent name to handle various formats</span>
    <span class="c1"># Convert names like &quot;Engineer&quot;, &quot;Research&quot;, &quot;QA&quot; to the correct agent IDs</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">AgentNameNormalizer</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    
    <span class="c1"># First check if agent exists with exact name</span>
    <span class="k">if</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">):</span>
        <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="n">agent_name</span>
    <span class="c1"># Then check with _agent suffix</span>
    <span class="k">elif</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">_agent&quot;</span><span class="p">):</span>
        <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">_agent&quot;</span>
    <span class="c1"># Check if this looks like it might already be an agent ID</span>
    <span class="k">elif</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_agent&quot;</span><span class="p">):</span>
        <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="n">agent_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get the normalized key (e.g., &quot;engineer&quot;, &quot;research&quot;, &quot;qa&quot;)</span>
        <span class="c1"># First check if the agent name is recognized by the normalizer</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if this is a known alias or canonical name</span>
        <span class="k">if</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">ALIASES</span> <span class="ow">or</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">CANONICAL_NAMES</span><span class="p">:</span>
            <span class="n">agent_key</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">to_key</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
            <span class="c1"># Try both with and without _agent suffix</span>
            <span class="k">if</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">agent_key</span><span class="p">):</span>
                <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="n">agent_key</span>
            <span class="k">elif</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_key</span><span class="si">}</span><span class="s2">_agent&quot;</span><span class="p">):</span>
                <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_key</span><span class="si">}</span><span class="s2">_agent&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="n">agent_key</span>  <span class="c1"># Use normalized key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown agent name - check both variations</span>
            <span class="k">if</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">cleaned</span><span class="p">):</span>
                <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="n">cleaned</span>
            <span class="k">elif</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cleaned</span><span class="si">}</span><span class="s2">_agent&quot;</span><span class="p">):</span>
                <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cleaned</span><span class="si">}</span><span class="s2">_agent&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actual_agent_id</span> <span class="o">=</span> <span class="n">cleaned</span>  <span class="c1"># Use cleaned name</span>
    
    <span class="c1"># Log the normalization for debugging</span>
    <span class="k">if</span> <span class="n">agent_name</span> <span class="o">!=</span> <span class="n">actual_agent_id</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalized agent name &#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">actual_agent_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load from JSON template via the loader</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">load_agent_prompt_from_md</span><span class="p">(</span><span class="n">actual_agent_id</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No agent found with name: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> (normalized to: </span><span class="si">{</span><span class="n">actual_agent_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Analyze task complexity if task description is provided</span>
    <span class="n">complexity_analysis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">task_description</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">enable_analysis</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable_complexity_analysis&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">task_description</span> <span class="ow">and</span> <span class="n">enable_analysis</span><span class="p">:</span>
        <span class="c1"># Extract relevant kwargs for complexity analysis</span>
        <span class="n">complexity_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                           <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;task_description&#39;</span><span class="p">,</span> <span class="s1">&#39;context_size&#39;</span><span class="p">,</span> <span class="s1">&#39;enable_complexity_analysis&#39;</span><span class="p">]}</span>
        <span class="n">complexity_analysis</span> <span class="o">=</span> <span class="n">_analyze_task_complexity</span><span class="p">(</span>
            <span class="n">task_description</span><span class="o">=</span><span class="n">task_description</span><span class="p">,</span>
            <span class="n">context_size</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="o">**</span><span class="n">complexity_kwargs</span>
        <span class="p">)</span>
    
    <span class="c1"># Get model configuration based on agent and complexity</span>
    <span class="c1"># Pass the normalized agent ID to _get_model_config</span>
    <span class="n">selected_model</span><span class="p">,</span> <span class="n">model_config</span> <span class="o">=</span> <span class="n">_get_model_config</span><span class="p">(</span><span class="n">actual_agent_id</span><span class="p">,</span> <span class="n">complexity_analysis</span><span class="p">)</span>
    
    <span class="c1"># Add model selection metadata to prompt for transparency</span>
    <span class="c1"># This helps with debugging and understanding model choices</span>
    <span class="k">if</span> <span class="n">selected_model</span> <span class="ow">and</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selection_method&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;dynamic_complexity_based&#39;</span><span class="p">:</span>
        <span class="n">model_metadata</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&lt;!-- Model Selection: </span><span class="si">{</span><span class="n">selected_model</span><span class="si">}</span><span class="s2"> (Complexity: </span><span class="si">{</span><span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complexity_level&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) --&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">model_metadata</span> <span class="o">+</span> <span class="n">prompt</span>
    
    <span class="c1"># Prepend base instructions with dynamic template based on complexity</span>
    <span class="c1"># The base instructions provide common guidelines all agents should follow</span>
    <span class="n">complexity_score</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complexity_score&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="k">if</span> <span class="n">model_config</span> <span class="k">else</span> <span class="mi">50</span>
    <span class="n">final_prompt</span> <span class="o">=</span> <span class="n">prepend_base_instructions</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">complexity_score</span><span class="o">=</span><span class="n">complexity_score</span><span class="p">)</span>
    
    <span class="c1"># Return format based on caller&#39;s needs</span>
    <span class="k">if</span> <span class="n">return_model_info</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_prompt</span><span class="p">,</span> <span class="n">selected_model</span><span class="p">,</span> <span class="n">model_config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_prompt</span></div>



<span class="c1"># Backward-compatible functions</span>
<span class="c1"># WHY: These functions exist to maintain backward compatibility with existing code</span>
<span class="c1"># that expects agent-specific getter functions. New code should use get_agent_prompt()</span>
<span class="c1"># directly with the agent_id parameter for more flexibility.</span>
<span class="c1">#</span>
<span class="c1"># DEPRECATION NOTE: These functions may be removed in a future major version.</span>
<span class="c1"># They add maintenance overhead and limit extensibility compared to the generic interface.</span>

<div class="viewcode-block" id="get_documentation_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_documentation_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_documentation_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Documentation Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;documentation_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;documentation_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_version_control_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_version_control_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_version_control_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Version Control Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;version_control_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;version_control_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_qa_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_qa_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_qa_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete QA Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;qa_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;qa_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_research_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_research_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_research_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Research Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;research_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;research_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_ops_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_ops_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ops_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Ops Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;ops_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;ops_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_security_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_security_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_security_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Security Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;security_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;security_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_engineer_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_engineer_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_engineer_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Engineer Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;engineer_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;engineer_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_data_engineer_agent_prompt">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_data_engineer_agent_prompt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data_engineer_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete Data Engineer Agent prompt with base instructions.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Complete prompt string ready for use with Claude API</span>
<span class="sd">        </span>
<span class="sd">    DEPRECATED: Use get_agent_prompt(&quot;data_engineer_agent&quot;) instead</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="s2">&quot;data_engineer_agent&quot;</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Expected string when return_model_info=False&quot;</span>
    <span class="k">return</span> <span class="n">prompt</span></div>



<div class="viewcode-block" id="get_agent_prompt_with_model_info">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_agent_prompt_with_model_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_agent_prompt_with_model_info</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience wrapper to always get agent prompt with model selection information.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_name: Agent ID (e.g., &quot;research_agent&quot;)</span>
<span class="sd">        force_reload: Force reload from source, bypassing cache</span>
<span class="sd">        **kwargs: Additional arguments for prompt generation and model selection</span>
<span class="sd">            - task_description: For complexity analysis</span>
<span class="sd">            - context_size: For complexity scoring</span>
<span class="sd">            - Other task-specific parameters</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (prompt, selected_model, model_config) where:</span>
<span class="sd">            - prompt: Complete agent prompt with base instructions</span>
<span class="sd">            - selected_model: Claude API model identifier</span>
<span class="sd">            - model_config: Dictionary with selection metadata</span>
<span class="sd">            </span>
<span class="sd">    WHY: This dedicated function ensures type safety for callers that always</span>
<span class="sd">    need model information, avoiding the need to handle Union types.</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">        prompt, model, config = get_agent_prompt_with_model_info(</span>
<span class="sd">            &quot;research_agent&quot;,</span>
<span class="sd">            task_description=&quot;Analyze Python codebase architecture&quot;</span>
<span class="sd">        )</span>
<span class="sd">        print(f&quot;Using model: {model} (method: {config[&#39;selection_method&#39;]})&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">get_agent_prompt</span><span class="p">(</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">force_reload</span><span class="p">,</span> <span class="n">return_model_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="c1"># Type narrowing - we know this returns a tuple when return_model_info=True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="c1"># Fallback (shouldn&#39;t happen with current implementation)</span>
    <span class="c1"># This defensive code ensures we always return the expected tuple format</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    <span class="n">agent_data</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
    <span class="n">default_model</span> <span class="o">=</span> <span class="s2">&quot;claude-sonnet-4-20250514&quot;</span>
    <span class="k">if</span> <span class="n">agent_data</span><span class="p">:</span>
        <span class="n">default_model</span> <span class="o">=</span> <span class="n">agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;capabilities&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">default_model</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">default_model</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">}</span></div>



<span class="c1"># Utility functions for agent management</span>

<div class="viewcode-block" id="list_available_agents">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.list_available_agents">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_available_agents</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all available agents with their key metadata.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping agent IDs to their metadata summaries</span>
<span class="sd">        </span>
<span class="sd">    The returned dictionary provides a comprehensive view of all registered</span>
<span class="sd">    agents, useful for:</span>
<span class="sd">    - UI agent selection interfaces</span>
<span class="sd">    - Documentation generation</span>
<span class="sd">    - System introspection and debugging</span>
<span class="sd">    - Programmatic agent discovery</span>
<span class="sd">    </span>
<span class="sd">    Example Return Value:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;research_agent&quot;: {</span>
<span class="sd">                &quot;name&quot;: &quot;Research Agent&quot;,</span>
<span class="sd">                &quot;description&quot;: &quot;Analyzes codebases...&quot;,</span>
<span class="sd">                &quot;category&quot;: &quot;analysis&quot;,</span>
<span class="sd">                &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="sd">                &quot;model&quot;: &quot;claude-opus-4-20250514&quot;,</span>
<span class="sd">                &quot;resource_tier&quot;: &quot;standard&quot;,</span>
<span class="sd">                &quot;tools&quot;: [&quot;code_analysis&quot;, &quot;search&quot;]</span>
<span class="sd">            },</span>
<span class="sd">            ...</span>
<span class="sd">        }</span>
<span class="sd">        </span>
<span class="sd">    WHY: This aggregated view is more useful than raw agent data because:</span>
<span class="sd">    - It provides a consistent interface regardless of schema changes</span>
<span class="sd">    - It includes only the fields relevant for agent selection</span>
<span class="sd">    - It&#39;s optimized for UI display and decision making</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    <span class="n">agents</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">agent_info</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">list_agents</span><span class="p">():</span>
        <span class="n">agent_id</span> <span class="o">=</span> <span class="n">agent_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_agent_metadata</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="c1"># Extract and flatten key information for easy consumption</span>
            <span class="n">agents</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">),</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;capabilities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;resource_tier&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;capabilities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource_tier&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;capabilities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">agents</span></div>



<div class="viewcode-block" id="clear_agent_cache">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.clear_agent_cache">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_agent_cache</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear cached agent prompts for development or after updates.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_name: Specific agent ID to clear, or None to clear all agents</span>
<span class="sd">        </span>
<span class="sd">    This function is useful for:</span>
<span class="sd">    - Development when modifying agent prompts</span>
<span class="sd">    - Forcing reload after agent template updates</span>
<span class="sd">    - Troubleshooting caching issues</span>
<span class="sd">    - Memory management in long-running processes</span>
<span class="sd">    </span>
<span class="sd">    Examples:</span>
<span class="sd">        # Clear specific agent cache</span>
<span class="sd">        clear_agent_cache(&quot;research_agent&quot;)</span>
<span class="sd">        </span>
<span class="sd">        # Clear all agent caches</span>
<span class="sd">        clear_agent_cache()</span>
<span class="sd">        </span>
<span class="sd">    WHY: Manual cache management is important because:</span>
<span class="sd">    - Agent prompts have a 1-hour TTL but may need immediate refresh</span>
<span class="sd">    - Development requires seeing changes without waiting for TTL</span>
<span class="sd">    - System administrators need cache control for troubleshooting</span>
<span class="sd">    </span>
<span class="sd">    Error Handling: Failures are logged but don&#39;t raise exceptions to ensure</span>
<span class="sd">    the system remains operational even if cache clearing fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">SharedPromptCache</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">agent_name</span><span class="p">:</span>
            <span class="c1"># Clear specific agent&#39;s cache entry</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGENT_CACHE_PREFIX</span><span class="si">}{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache cleared for agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Clear all agent caches by iterating through registry</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">agent_id</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AGENT_CACHE_PREFIX</span><span class="si">}{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All agent caches cleared&quot;</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log but don&#39;t raise - cache clearing shouldn&#39;t break the system</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clearing agent cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="list_agents_by_tier">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.list_agents_by_tier">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_agents_by_tier</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List available agents organized by their tier.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping tier names to lists of agent IDs available in that tier</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;project&quot;: [&quot;engineer_agent&quot;, &quot;custom_agent&quot;],</span>
<span class="sd">            &quot;user&quot;: [&quot;research_agent&quot;],</span>
<span class="sd">            &quot;system&quot;: [&quot;engineer_agent&quot;, &quot;research_agent&quot;, &quot;qa_agent&quot;, ...]</span>
<span class="sd">        }</span>
<span class="sd">    </span>
<span class="sd">    This is useful for:</span>
<span class="sd">    - Understanding which agents are available at each level</span>
<span class="sd">    - Debugging agent precedence issues</span>
<span class="sd">    - UI display of agent sources</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    
    <span class="c1"># Group agents by their loaded tier</span>
    <span class="k">for</span> <span class="n">agent_id</span><span class="p">,</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result</span><span class="p">[</span><span class="n">tier</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span>
    
    <span class="c1"># Sort each list for consistent output</span>
    <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="validate_agent_files">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.validate_agent_files">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_agent_files</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate all agent template files against the schema.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping agent names to validation results</span>
<span class="sd">        </span>
<span class="sd">    This function performs comprehensive validation of all agent files,</span>
<span class="sd">    checking for:</span>
<span class="sd">    - JSON syntax errors</span>
<span class="sd">    - Schema compliance</span>
<span class="sd">    - Required fields presence</span>
<span class="sd">    - Data type correctness</span>
<span class="sd">    - Constraint violations</span>
<span class="sd">    </span>
<span class="sd">    Return Format:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;agent_name&quot;: {</span>
<span class="sd">                &quot;valid&quot;: bool,</span>
<span class="sd">                &quot;errors&quot;: [list of error messages],</span>
<span class="sd">                &quot;warnings&quot;: [list of warning messages],</span>
<span class="sd">                &quot;file_path&quot;: &quot;/full/path/to/file.json&quot;</span>
<span class="sd">            },</span>
<span class="sd">            ...</span>
<span class="sd">        }</span>
<span class="sd">        </span>
<span class="sd">    Use Cases:</span>
<span class="sd">    - Pre-deployment validation in CI/CD</span>
<span class="sd">    - Development-time agent verification  </span>
<span class="sd">    - Troubleshooting agent loading issues</span>
<span class="sd">    - Automated testing of agent configurations</span>
<span class="sd">    </span>
<span class="sd">    WHY: Separate validation allows checking agents without loading them,</span>
<span class="sd">    useful for CI/CD pipelines and development workflows where we want to</span>
<span class="sd">    catch errors before runtime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">AgentValidator</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">json_file</span> <span class="ow">in</span> <span class="n">AGENT_TEMPLATES_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
        <span class="c1"># Skip the schema definition file itself</span>
        <span class="k">if</span> <span class="n">json_file</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;agent_schema.json&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">validation_result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_file</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">json_file</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">warnings</span><span class="p">,</span>
            <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="reload_agents">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.reload_agents">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reload_agents</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Force reload all agents from disk, clearing the registry and cache.</span>
<span class="sd">    </span>
<span class="sd">    This function completely resets the agent loader state, causing:</span>
<span class="sd">    1. The global loader instance to be destroyed</span>
<span class="sd">    2. All cached agent prompts to be invalidated</span>
<span class="sd">    3. Fresh agent discovery on next access across all tiers</span>
<span class="sd">    </span>
<span class="sd">    Use Cases:</span>
<span class="sd">    - Hot-reloading during development</span>
<span class="sd">    - Picking up new agent files without restart</span>
<span class="sd">    - Recovering from corrupted state</span>
<span class="sd">    - Testing agent loading logic</span>
<span class="sd">    - Switching between projects with different agents</span>
<span class="sd">    </span>
<span class="sd">    WHY: Hot-reloading is essential for development productivity and</span>
<span class="sd">    allows dynamic agent updates in production without service restart.</span>
<span class="sd">    </span>
<span class="sd">    Implementation Note: We simply clear the global loader reference.</span>
<span class="sd">    The next call to _get_loader() will create a fresh instance that</span>
<span class="sd">    re-discovers and re-validates all agents across all tiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_loader</span>
    <span class="n">_loader</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Agent registry cleared, will reload on next access&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_agent_tier">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.agent_loader.get_agent_tier">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_agent_tier</span><span class="p">(</span><span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the tier from which an agent was loaded.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_name: Agent name or ID</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tier name (&quot;project&quot;, &quot;user&quot;, or &quot;system&quot;) or None if not found</span>
<span class="sd">        </span>
<span class="sd">    This is useful for debugging and understanding which version of an</span>
<span class="sd">    agent is being used when multiple versions exist across tiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">_get_loader</span><span class="p">()</span>
    
    <span class="c1"># Check if agent exists with exact name</span>
    <span class="k">if</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">:</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tier</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">tier</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="c1"># Try with _agent suffix</span>
    <span class="n">agent_with_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">_agent&quot;</span>
    <span class="k">if</span> <span class="n">agent_with_suffix</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">:</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">agent_with_suffix</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tier</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">tier</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="c1"># Try normalizing the name</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">AgentNameNormalizer</span><span class="p">()</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">agent_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">ALIASES</span> <span class="ow">or</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">CANONICAL_NAMES</span><span class="p">:</span>
        <span class="n">agent_key</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">to_key</span><span class="p">(</span><span class="n">agent_name</span><span class="p">)</span>
        <span class="c1"># Try both with and without suffix</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">[</span><span class="n">agent_key</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent_key</span><span class="si">}</span><span class="s2">_agent&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">:</span>
                <span class="n">tier</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">tier</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">tier</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="c1"># Try cleaned name with and without suffix</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cleaned</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cleaned</span><span class="si">}</span><span class="s2">_agent&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">_agent_tiers</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">tier</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">tier</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="kc">None</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>