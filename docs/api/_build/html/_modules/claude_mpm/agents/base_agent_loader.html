

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>claude_mpm.agents.base_agent_loader &mdash; Claude MPM API Reference 3.8.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=dbb19ff3" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=070f1fcc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Claude MPM API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agents/index.html">Agents API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hooks/index.html">Hooks API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">CLI API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">claude_mpm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search.html">Search Page</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Claude MPM API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">claude_mpm.agents.base_agent_loader</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for claude_mpm.agents.base_agent_loader</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base Agent Loader Utility</span>
<span class="sd">========================</span>

<span class="sd">Provides functionality to load and prepend base agent instructions to all agent prompts.</span>
<span class="sd">Integrates with SharedPromptCache for performance optimization.</span>

<span class="sd">Key Features:</span>
<span class="sd">- Load base_agent.md content with caching</span>
<span class="sd">- Prepend base instructions to agent prompts</span>
<span class="sd">- Thread-safe operations</span>
<span class="sd">- Error handling for missing base instructions</span>
<span class="sd">- Integration with SharedPromptCache</span>
<span class="sd">- Dynamic prompt templates based on task complexity</span>

<span class="sd">Usage:</span>
<span class="sd">    from claude_pm.agents.base_agent_loader import prepend_base_instructions</span>
<span class="sd">    </span>
<span class="sd">    # Get agent prompt with base instructions prepended</span>
<span class="sd">    full_prompt = prepend_base_instructions(get_documentation_agent_prompt())</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">claude_mpm.services.memory.cache.shared_prompt_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">SharedPromptCache</span>

<span class="c1"># Module-level logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Cache key for base agent instructions</span>
<span class="n">BASE_AGENT_CACHE_KEY</span> <span class="o">=</span> <span class="s2">&quot;base_agent:instructions&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_base_agent_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the base agent file path.&quot;&quot;&quot;</span>
    <span class="c1"># Check if we&#39;re running from a wheel installation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">claude_mpm</span>
        <span class="n">package_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">claude_mpm</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">path_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">package_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;site-packages&#39;</span> <span class="ow">in</span> <span class="n">path_str</span> <span class="ow">or</span> <span class="s1">&#39;dist-packages&#39;</span> <span class="ow">in</span> <span class="n">path_str</span><span class="p">:</span>
            <span class="c1"># For wheel installations, check data directory</span>
            <span class="n">data_base_agent</span> <span class="o">=</span> <span class="n">package_path</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;base_agent.json&quot;</span>
            <span class="k">if</span> <span class="n">data_base_agent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using wheel installation base_agent: </span><span class="si">{</span><span class="n">data_base_agent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data_base_agent</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="c1"># Use the base_agent.json in the agents directory</span>
    <span class="n">base_agent_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;base_agent.json&quot;</span>
    <span class="k">if</span> <span class="n">base_agent_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using base agent template: </span><span class="si">{</span><span class="n">base_agent_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_agent_path</span>
    
    <span class="c1"># Fallback error</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Base agent template file not found&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;base_agent.json not found in agents directory&quot;</span><span class="p">)</span>


<span class="c1"># Base agent file path (dynamically determined)</span>
<span class="n">BASE_AGENT_FILE</span> <span class="o">=</span> <span class="n">_get_base_agent_file</span><span class="p">()</span>


<div class="viewcode-block" id="PromptTemplate">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.base_agent_loader.PromptTemplate">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PromptTemplate</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dynamic prompt template levels.&quot;&quot;&quot;</span>
    <span class="n">MINIMAL</span> <span class="o">=</span> <span class="s2">&quot;MINIMAL&quot;</span>    <span class="c1"># Core instructions only (~300 chars)</span>
    <span class="n">STANDARD</span> <span class="o">=</span> <span class="s2">&quot;STANDARD&quot;</span>  <span class="c1"># Core + context + basic integration (~700 chars)</span>
    <span class="n">FULL</span> <span class="o">=</span> <span class="s2">&quot;FULL&quot;</span>         <span class="c1"># All sections including escalation (~1500 chars)</span></div>



<span class="c1"># Template section definitions</span>
<span class="c1"># Optimized to reduce STANDARD template size while maintaining essential guidance</span>
<span class="n">TEMPLATE_SECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;core_principles&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MINIMAL&quot;</span><span class="p">,</span> <span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Core Agent Principles&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;communication_standards&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MINIMAL&quot;</span><span class="p">,</span> <span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Communication Standards&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;test_protocols&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Moved to FULL only - not needed for most tasks</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Test Response Protocol&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;reporting_requirements&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Reporting Requirements&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;error_handling&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Error Handling&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;security_awareness&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Security Awareness&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;temporal_context&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Moved to FULL - not essential for STANDARD</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Temporal Context Integration&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;quality_standards&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Quality Standards&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;tool_usage&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Moved to FULL - agent-specific guidance suffices</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Tool Usage Guidelines&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;collaboration_protocols&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Keep for STANDARD - essential</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Collaboration Protocols&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;cross_agent_dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Only needed for complex multi-agent tasks</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Cross-Agent Dependencies&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;performance_optimization&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Performance Optimization&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;escalation_triggers&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Escalation Triggers&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;output_formatting&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Moved to FULL - basic formatting in STANDARD suffices</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Output Formatting Standards&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;framework_integration&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Framework Integration&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MINIMAL&quot;</span><span class="p">,</span> <span class="s2">&quot;STANDARD&quot;</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">],</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Universal Constraints&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;success_criteria&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FULL&quot;</span><span class="p">],</span>  <span class="c1"># Moved to FULL - implicit for simpler tasks</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Success Criteria&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>


<div class="viewcode-block" id="load_base_agent_instructions">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.base_agent_loader.load_base_agent_instructions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_base_agent_instructions</span><span class="p">(</span><span class="n">force_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load base agent instructions from base_agent.json with caching.</span>
<span class="sd">    Conditionally includes test-mode instructions based on CLAUDE_PM_TEST_MODE.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        force_reload: Force reload from file, bypassing cache</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Base agent instructions content, or None if file not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if we&#39;re in test mode</span>
        <span class="n">test_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLAUDE_PM_TEST_MODE&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]</span>
        
        <span class="c1"># Get cache instance</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">SharedPromptCache</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        
        <span class="c1"># Different cache keys for test mode vs normal mode</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_AGENT_CACHE_KEY</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="s1">&#39;test&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">test_mode</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Check cache first (unless force reload)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="n">cached_content</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent instructions loaded from cache (test_mode=</span><span class="si">{</span><span class="n">test_mode</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cached_content</span><span class="p">)</span>
        
        <span class="c1"># Get fresh base agent file path</span>
        <span class="n">base_agent_file</span> <span class="o">=</span> <span class="n">_get_base_agent_file</span><span class="p">()</span>
        
        <span class="c1"># Load from file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_agent_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent instructions file not found: </span><span class="si">{</span><span class="n">base_agent_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading base agent instructions from: </span><span class="si">{</span><span class="n">base_agent_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load JSON and extract instructions</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">base_agent_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">base_agent_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Extract instructions from the JSON structure</span>
        <span class="k">if</span> <span class="s1">&#39;narrative_fields&#39;</span> <span class="ow">in</span> <span class="n">base_agent_data</span> <span class="ow">and</span> <span class="s1">&#39;instructions&#39;</span> <span class="ow">in</span> <span class="n">base_agent_data</span><span class="p">[</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">]:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">base_agent_data</span><span class="p">[</span><span class="s1">&#39;narrative_fields&#39;</span><span class="p">][</span><span class="s1">&#39;instructions&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback for older format</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">base_agent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instructions&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No instructions found in base agent JSON&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># If NOT in test mode, remove test-specific instructions to save context</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">_remove_test_mode_instructions</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Test-mode instructions removed (not in test mode)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test-mode instructions included (CLAUDE_PM_TEST_MODE is enabled)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Cache the content with 1 hour TTL</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent instructions cached successfully (test_mode=</span><span class="si">{</span><span class="n">test_mode</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">content</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading base agent instructions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_remove_test_mode_instructions</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove test-mode specific instructions from base agent content.</span>
<span class="sd">    </span>
<span class="sd">    This removes the &quot;Standard Test Response Protocol&quot;</span>
<span class="sd">    sections to save context when not in test mode.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        content: Full base agent instructions content</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Content with test-mode instructions removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">filtered_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">skip_section</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Check if we&#39;re entering the test response protocol section</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;## Standard Test Response Protocol&#39;</span><span class="p">:</span>
            <span class="n">skip_section</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
            
        <span class="c1"># Check if we&#39;re in the test section and need to continue skipping</span>
        <span class="k">if</span> <span class="n">skip_section</span><span class="p">:</span>
            <span class="c1"># Check if we&#39;ve reached a section that&#39;s NOT part of test protocol</span>
            <span class="c1"># This includes any heading that&#39;s not a subsection of the test protocol</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;####&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;###&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;##&#39;</span><span class="p">))</span> <span class="ow">and</span> \
               <span class="s1">&#39;Standard Test Response Protocol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">skip_section</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Don&#39;t skip this line - it&#39;s the start of a new section</span>
                <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="c1"># Skip this line as we&#39;re still in test section</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
            
        <span class="c1"># Not in test section, keep the line</span>
        <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Join back and clean up extra blank lines</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_lines</span><span class="p">)</span>
    
    <span class="c1"># Replace multiple consecutive newlines with double newlines</span>
    <span class="k">while</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_dynamic_prompt</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="n">PromptTemplate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a dynamic prompt based on the template level.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        content: Full base agent content</span>
<span class="sd">        template: Template level to use</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Filtered content based on template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">template</span> <span class="o">==</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">FULL</span><span class="p">:</span>
        <span class="c1"># Return full content for FULL template</span>
        <span class="k">return</span> <span class="n">content</span>
    
    <span class="c1"># Parse content into sections</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="n">_parse_content_sections</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    
    <span class="c1"># Build prompt based on template sections</span>
    <span class="n">filtered_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# Base Agent Instructions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;## 🤖 Agent Framework Context</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;You are operating as a specialized agent within the Claude PM Framework. You have been delegated a specific task by the PM Orchestrator and must complete it according to your specialized role and authority.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Add sections based on template</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">section_key</span><span class="p">,</span> <span class="n">section_config</span> <span class="ow">in</span> <span class="n">TEMPLATE_SECTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="n">section_config</span><span class="p">[</span><span class="s2">&quot;templates&quot;</span><span class="p">]:</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="n">section_config</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Section name must be string&quot;</span>
            <span class="k">if</span> <span class="n">section_name</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
                <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sections</span><span class="p">[</span><span class="n">section_name</span><span class="p">])</span>
    
    <span class="c1"># Clean up multiple newlines</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_lines</span><span class="p">)</span>
    <span class="k">while</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_content_sections</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse content into named sections.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        content: Full content to parse</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict mapping section names to their content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_content</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># Check if this is a section header</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;### &#39;</span><span class="p">):</span>
            <span class="c1"># Save previous section if exists</span>
            <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
                <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_content</span><span class="p">)</span>
                <span class="n">current_content</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Extract section name</span>
            <span class="n">current_section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">current_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;## &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Agent Framework Context&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="c1"># Handle ## level sections (skip the main header)</span>
            <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
                <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_content</span><span class="p">)</span>
                <span class="n">current_content</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">current_section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">current_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#### &#39;</span><span class="p">):</span>
            <span class="c1"># Handle #### level subsections</span>
            <span class="k">if</span> <span class="n">current_section</span><span class="p">:</span>
                <span class="c1"># Check for PM Orchestrator Integration vs PM Workflow Integration</span>
                <span class="n">subsection_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">subsection_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PM Orchestrator Integration&quot;</span><span class="p">,</span> <span class="s2">&quot;PM Workflow Integration&quot;</span><span class="p">]:</span>
                    <span class="c1"># Merge these redundant sections under &quot;Collaboration Protocols&quot;</span>
                    <span class="k">if</span> <span class="n">current_section</span> <span class="o">!=</span> <span class="s2">&quot;Collaboration Protocols&quot;</span><span class="p">:</span>
                        <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;PM Integration&quot;</span>
                <span class="n">current_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">current_section</span><span class="p">:</span>
            <span class="n">current_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
    <span class="c1"># Save final section</span>
    <span class="k">if</span> <span class="n">current_section</span> <span class="ow">and</span> <span class="n">current_content</span><span class="p">:</span>
        <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_content</span><span class="p">)</span>
    
    <span class="c1"># Merge redundant PM sections if both exist</span>
    <span class="k">if</span> <span class="s2">&quot;PM Orchestrator Integration&quot;</span> <span class="ow">in</span> <span class="n">sections</span> <span class="ow">and</span> <span class="s2">&quot;PM Workflow Integration&quot;</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="c1"># Combine into single PM Integration section</span>
        <span class="n">sections</span><span class="p">[</span><span class="s2">&quot;PM Integration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;#### PM Integration</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="n">sections</span><span class="p">[</span><span class="s2">&quot;PM Orchestrator Integration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#### PM Orchestrator Integration&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span>
            <span class="n">sections</span><span class="p">[</span><span class="s2">&quot;PM Workflow Integration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#### PM Workflow Integration&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Remove redundant sections</span>
        <span class="k">del</span> <span class="n">sections</span><span class="p">[</span><span class="s2">&quot;PM Orchestrator Integration&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">sections</span><span class="p">[</span><span class="s2">&quot;PM Workflow Integration&quot;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">sections</span>


<div class="viewcode-block" id="prepend_base_instructions">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.base_agent_loader.prepend_base_instructions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepend_base_instructions</span><span class="p">(</span>
    <span class="n">agent_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptTemplate</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">complexity_score</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepend base agent instructions to an agent-specific prompt.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        agent_prompt: The agent-specific prompt to prepend to</span>
<span class="sd">        separator: String to separate base instructions from agent prompt</span>
<span class="sd">        template: Optional template level to use (auto-selected if not provided)</span>
<span class="sd">        complexity_score: Optional complexity score for template selection</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Combined prompt with base instructions prepended</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Auto-select template based on complexity if not provided</span>
    <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complexity_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">complexity_score</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">MINIMAL</span>
            <span class="k">elif</span> <span class="n">complexity_score</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">STANDARD</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">FULL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default to STANDARD if no complexity info</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">STANDARD</span>
    
    <span class="c1"># Check if we&#39;re in test mode - always use FULL template for tests</span>
    <span class="n">test_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLAUDE_PM_TEST_MODE&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">test_mode</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">FULL</span>
    
    <span class="c1"># Get cache instance</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">SharedPromptCache</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
    
    <span class="c1"># Different cache keys for different templates and test mode</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_AGENT_CACHE_KEY</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="s1">&#39;test&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">test_mode</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Check cache first</span>
    <span class="n">cached_content</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent instructions loaded from cache (template=</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, test_mode=</span><span class="si">{</span><span class="n">test_mode</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">base_instructions</span> <span class="o">=</span> <span class="n">cached_content</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load full content</span>
        <span class="n">full_content</span> <span class="o">=</span> <span class="n">load_base_agent_instructions</span><span class="p">()</span>
        
        <span class="c1"># If no base instructions, return original prompt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_content</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No base instructions available, returning original prompt&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">agent_prompt</span>
        
        <span class="c1"># Build dynamic prompt based on template</span>
        <span class="n">base_instructions</span> <span class="o">=</span> <span class="n">_build_dynamic_prompt</span><span class="p">(</span><span class="n">full_content</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        
        <span class="c1"># Cache the filtered content</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">base_instructions</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dynamic base agent instructions cached (template=</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Log template selection</span>
    <span class="k">if</span> <span class="n">complexity_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> prompt template &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(complexity_score=</span><span class="si">{</span><span class="n">complexity_score</span><span class="si">}</span><span class="s2">, size=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base_instructions</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars)&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># Combine base instructions with agent prompt</span>
    <span class="n">combined_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_instructions</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">agent_prompt</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">return</span> <span class="n">combined_prompt</span></div>



<div class="viewcode-block" id="clear_base_agent_cache">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.base_agent_loader.clear_base_agent_cache">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_base_agent_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the cached base agent instructions for all templates and modes.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">SharedPromptCache</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span>
        <span class="c1"># Clear caches for all template levels and modes</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">PromptTemplate</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">]:</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_AGENT_CACHE_KEY</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        
        <span class="c1"># Also clear the old-style caches for backward compatibility</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_AGENT_CACHE_KEY</span><span class="si">}</span><span class="s2">:normal&quot;</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_AGENT_CACHE_KEY</span><span class="si">}</span><span class="s2">:test&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Base agent cache cleared (all templates and modes)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clearing base agent cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_base_agent_path">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.base_agent_loader.get_base_agent_path">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_base_agent_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the path to the base agent instructions file.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">BASE_AGENT_FILE</span></div>



<div class="viewcode-block" id="validate_base_agent_file">
<a class="viewcode-back" href="../../../services/agent_services.html#claude_mpm.agents.base_agent_loader.validate_base_agent_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_base_agent_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that base agent file exists and is readable.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True if file exists and is readable, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">BASE_AGENT_FILE</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent file does not exist: </span><span class="si">{</span><span class="n">BASE_AGENT_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">BASE_AGENT_FILE</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent path is not a file: </span><span class="si">{</span><span class="n">BASE_AGENT_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="c1"># Try to read the file</span>
        <span class="n">BASE_AGENT_FILE</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base agent file validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<span class="c1"># Module initialization - validate base agent file on import</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">validate_base_agent_file</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Base agent file validation failed during module import&quot;</span><span class="p">)</span>


<span class="c1"># Export key components</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;prepend_base_instructions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;load_base_agent_instructions&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;clear_base_agent_cache&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_base_agent_path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;validate_base_agent_file&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PromptTemplate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TEMPLATE_SECTIONS&#39;</span>
<span class="p">]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Claude MPM Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>